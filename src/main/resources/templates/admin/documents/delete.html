<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Xóa Tài liệu - EduShare Admin</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;700&family=Open+Sans:wght@400;500;600&family=Playfair+Display:wght@700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" th:href="@{/css/main.css}" />
    <link rel="stylesheet" th:href="@{/css/admin/admin.css}" />
    <link rel="stylesheet" th:href="@{/css/admin/toast.css}" />
    <link rel="stylesheet" th:href="@{/css/admin/notifications.css}"/>
    <style>
      .delete-container {
        max-width: 900px;
        margin: 0 auto;
      }
      .delete-card {
        background: #ffffff;
        border: 1px solid #e0e4e8;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      .delete-header {
        text-align: center;
        margin-bottom: 24px;
      }
      .warning-icon {
        width: 64px;
        height: 64px;
        background: linear-gradient(135deg, #ff6b6b, #ee5a52);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 16px;
        color: white;
        font-size: 24px;
      }
      .delete-header h2 {
        color: #2d3748;
        margin-bottom: 8px;
        font-size: 1.5rem;
      }
      .delete-header p {
        color: #718096;
        font-size: 1rem;
      }
      .document-info-section {
        background: #f8fafc;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 24px;
      }
      .document-info-section h3 {
        color: #2d3748;
        margin-bottom: 16px;
        font-size: 1.1rem;
      }
      .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      .info-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #e2e8f0;
      }
      .info-label {
        font-weight: 500;
        color: #64748b;
      }
      .info-value {
        font-weight: 600;
        color: #1e293b;
      }
      .file-info {
        background: #f0f9ff;
        border: 1px solid #bae6fd;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .file-info i {
        font-size: 24px;
        color: #0284c7;
      }
      .file-details h4 {
        margin: 0 0 4px 0;
        color: #0c4a6e;
        font-size: 1rem;
      }
      .file-details p {
        margin: 0;
        color: #0369a1;
        font-size: 0.9rem;
      }
      .warning-section {
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 24px;
      }
      .warning-message h3 {
        color: #dc2626;
        margin-bottom: 12px;
        font-size: 1.1rem;
      }
      .warning-message ul {
        color: #7f1d1d;
        margin: 0;
        padding-left: 20px;
      }
      .warning-message li {
        margin-bottom: 8px;
      }
      .alternatives-section {
        background: #f0fdf4;
        border: 1px solid #bbf7d0;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 24px;
      }
      .alternatives-section h3 {
        color: #16a34a;
        margin-bottom: 16px;
        font-size: 1.1rem;
      }
      .alternatives-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 16px;
      }
      .alternative-item {
        background: white;
        border: 1px solid #d1fae5;
        border-radius: 6px;
        padding: 16px;
        text-align: center;
      }
      .alternative-item h4 {
        color: #16a34a;
        margin-bottom: 8px;
        font-size: 1rem;
      }
      .alternative-item p {
        color: #15803d;
        font-size: 0.9rem;
        margin-bottom: 12px;
      }
      .form-section {
        border-top: 1px solid #e2e8f0;
        padding-top: 24px;
      }
      .form-section h3 {
        color: #2d3748;
        margin-bottom: 16px;
        font-size: 1.1rem;
      }
      .form-group {
        margin-bottom: 16px;
      }
      .form-group label {
        display: block;
        font-weight: 500;
        color: #374151;
        margin-bottom: 6px;
      }
      .form-textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 14px;
        resize: vertical;
      }
      .form-textarea:focus {
        outline: none;
        border-color: #4361ee;
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
      }
      .form-help {
        font-size: 0.85rem;
        color: #6b7280;
        margin-top: 4px;
      }
      .checkbox-label {
        display: flex;
        align-items: center;
        cursor: pointer;
        font-size: 0.9rem;
        color: #374151;
      }
      .checkbox-label input[type="checkbox"] {
        margin-right: 8px;
      }
      .form-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 24px;
      }
      .secondary-btn,
      .danger-btn {
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        border: none;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .secondary-btn {
        background: #f8f9fa;
        color: #6c757d;
        border: 1px solid #dee2e6;
      }
      .secondary-btn:hover {
        background: #e9ecef;
      }
      .danger-btn {
        background: #dc3545;
        color: white;
      }
      .danger-btn:hover:not(:disabled) {
        background: #c82333;
      }
      .danger-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }
      .required {
        color: #dc2626;
      }
      .status-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 500;
      }
      .status-badge.published {
        background: #d1fae5;
        color: #16a34a;
      }
      .status-badge.draft {
        background: #fef3c7;
        color: #d97706;
      }
      .status-badge.pending {
        background: #dbeafe;
        color: #2563eb;
      }
      .status-badge.archived {
        background: #f3f4f6;
        color: #6b7280;
      }
      .categories-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 8px;
      }
      .category-tag,
      .tag-item {
        background: #e0e7ff;
        color: #3730a3;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
      }
      .tag-item {
        background: #ecfdf5;
        color: #166534;
      }
      @media (max-width: 768px) {
        .info-grid {
          grid-template-columns: 1fr;
        }
        .alternatives-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body class="admin-body">
    <!-- Admin Header -->
    <div th:replace="~{fragments/admin/layout :: header}"></div>

    <!-- Admin Container -->
    <div class="admin-container">
      <!-- Sidebar -->
      <div th:replace="~{fragments/admin/sidebar :: admin-sidebar}"></div>

      <!-- Main Content -->
      <main class="admin-content">
        <!-- Error Message -->
        <div th:if="${error}" class="error-message">
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i>
            <span th:text="${error}">Lỗi</span>
          </div>
        </div>

        <!-- Admin Content Header -->
        <div class="admin-content-header">
          <div>
            <h1 class="admin-page-title">Xóa Tài liệu</h1>
            <div class="admin-breadcrumbs">
              <a th:href="@{/admin/dashboard}">Admin</a>
              <span>/</span>
              <a th:href="@{/admin/documents}">Quản lý Tài liệu</a>
              <span>/</span>
              <span th:text="${document != null ? document.title : 'Tài liệu'}"
                >Document Title</span
              >
              <span>/</span>
              <span>Xóa</span>
            </div>
          </div>
          <div class="dashboard-actions">
            <a th:href="@{/admin/documents}" class="secondary-btn">
              <i class="fas fa-arrow-left"></i> Quay lại
            </a>
          </div>
        </div>

        <!-- Delete Confirmation -->
        <div class="delete-container" th:if="${document != null}">
          <div class="delete-card">
            <div class="delete-header">
              <div class="warning-icon">
                <i class="fas fa-exclamation-triangle"></i>
              </div>
              <h2>Xác nhận xóa tài liệu</h2>
              <p>
                Bạn sắp xóa tài liệu
                <strong th:text="${document.title}">Document Title</strong>
              </p>
            </div>

            <!-- Document Information -->
            <div class="document-info-section">
              <h3>Thông tin tài liệu sẽ bị xóa:</h3>

              <!-- File Information -->
              <div class="file-info" th:if="${document.fileName}">
                <i
                  class="fas fa-file-pdf"
                  th:if="${#strings.endsWith(document.fileName, '.pdf')}"
                ></i>
                <i
                  class="fas fa-file-word"
                  th:if="${#strings.endsWith(document.fileName, '.doc') or #strings.endsWith(document.fileName, '.docx')}"
                ></i>
                <i
                  class="fas fa-file-powerpoint"
                  th:if="${#strings.endsWith(document.fileName, '.ppt') or #strings.endsWith(document.fileName, '.pptx')}"
                ></i>
                <i
                  class="fas fa-file-excel"
                  th:if="${#strings.endsWith(document.fileName, '.xls') or #strings.endsWith(document.fileName, '.xlsx')}"
                ></i>
                <i
                  class="fas fa-file"
                  th:unless="${#strings.endsWith(document.fileName, '.pdf') or #strings.endsWith(document.fileName, '.doc') or #strings.endsWith(document.fileName, '.docx') or #strings.endsWith(document.fileName, '.ppt') or #strings.endsWith(document.fileName, '.pptx') or #strings.endsWith(document.fileName, '.xls') or #strings.endsWith(document.fileName, '.xlsx')}"
                ></i>
                <div class="file-details">
                  <h4 th:text="${document.fileName}">document.pdf</h4>
                  <p
                    th:text="${document.fileSize != null ? (document.fileSize / 1024 / 1024) + ' MB' : 'N/A'}"
                  >
                    2.5 MB
                  </p>
                </div>
              </div>

              <div class="info-grid">
                <div class="info-item">
                  <span class="info-label">Tiêu đề:</span>
                  <span class="info-value" th:text="${document.title}"
                    >Document Title</span
                  >
                </div>
                <div class="info-item">
                  <span class="info-label">Tác giả:</span>
                  <span class="info-value" th:text="${document.authorName}"
                    >Author Name</span
                  >
                </div>
                <div class="info-item">
                  <span class="info-label">Trạng thái:</span>
                  <span
                    class="status-badge"
                    th:classappend="${#strings.toLowerCase(document.status)}"
                  >
                    <span
                      th:text="${document.status == 'PUBLISHED' ? 'Đã xuất bản' : 
                                                   document.status == 'DRAFT' ? 'Bản nháp' : 
                                                   document.status == 'PENDING' ? 'Chờ duyệt' : 
                                                   document.status == 'ARCHIVED' ? 'Đã lưu trữ' : 
                                                   document.status == 'APPROVED' ? 'Đã duyệt' : 
                                                   document.status == 'SUSPENDED' ? 'Tạm ngưng' : document.status}"
                      >Trạng thái</span
                    >
                  </span>
                </div>
                <div class="info-item">
                  <span class="info-label">Giá:</span>
                  <span
                    class="info-value"
                    th:text="${document.price != null and document.price > 0 ? document.price + ' coin' : 'Miễn phí'}"
                    >Miễn phí</span
                  >
                </div>
                <div class="info-item">
                  <span class="info-label">Lượt xem:</span>
                  <span class="info-value" th:text="${document.viewsCount ?: 0}"
                    >0</span
                  >
                </div>
                <div class="info-item">
                  <span class="info-label">Lượt tải:</span>
                  <span
                    class="info-value"
                    th:text="${document.downloadsCount ?: 0}"
                    >0</span
                  >
                </div>
                <div class="info-item">
                  <span class="info-label">Ngày tạo:</span>
                  <span
                    class="info-value"
                    th:text="${#temporals.format(document.createdAt, 'dd/MM/yyyy HH:mm')}"
                    >01/01/2024 10:30</span
                  >
                </div>
                <div class="info-item">
                  <span class="info-label">Cập nhật cuối:</span>
                  <span
                    class="info-value"
                    th:text="${#temporals.format(document.updatedAt, 'dd/MM/yyyy HH:mm')}"
                    >01/01/2024 10:30</span
                  >
                </div>
              </div>

              <!-- Categories and Tags -->
              <div
                class="info-item"
                style="flex-direction: column; align-items: flex-start"
              >
                <span class="info-label">Danh mục:</span>
                <div class="categories-tags">
                  <span
                    th:each="categoryName : ${document.categoryNames}"
                    class="category-tag"
                    th:text="${categoryName}"
                    >Category</span
                  >
                  <span
                    th:if="${#lists.isEmpty(document.categoryNames)}"
                    class="text-muted"
                    >Chưa phân loại</span
                  >
                </div>
              </div>

              <div
                class="info-item"
                style="flex-direction: column; align-items: flex-start"
              >
                <span class="info-label">Tags:</span>
                <div class="categories-tags">
                  <span
                    th:each="tagName : ${document.tagNames}"
                    class="tag-item"
                    th:text="${tagName}"
                    >Tag</span
                  >
                  <span
                    th:if="${#lists.isEmpty(document.tagNames)}"
                    class="text-muted"
                    >Không có tag</span
                  >
                </div>
              </div>
            </div>

            <!-- Warning Messages -->
            <div class="warning-section">
              <div class="warning-message">
                <h3>
                  <i class="fas fa-exclamation-circle"></i> Cảnh báo quan trọng
                </h3>
                <ul>
                  <li>
                    Hành động này sẽ xóa vĩnh viễn tài liệu và không thể hoàn
                    tác
                  </li>
                  <li>File đính kèm sẽ bị xóa khỏi hệ thống</li>
                  <li>Tất cả bình luận và đánh giá liên quan sẽ bị xóa</li>
                  <li>
                    Lịch sử tải xuống và giao dịch sẽ được lưu trữ nhưng không
                    hiển thị
                  </li>
                  <li>Báo cáo thống kê có thể bị ảnh hưởng</li>
                  <li>Người dùng đã mua tài liệu sẽ không thể truy cập</li>
                </ul>
              </div>
            </div>

            <!-- Alternative Actions -->
            <div class="alternatives-section">
              <h3>Hành động thay thế:</h3>
              <div class="alternatives-grid">
                <div class="alternative-item">
                  <h4><i class="fas fa-archive"></i> Lưu trữ</h4>
                  <p>Lưu trữ tài liệu thay vì xóa vĩnh viễn</p>
                  <a
                    th:href="@{/admin/documents/{id}/archive(id=${document.id})}"
                    class="secondary-btn"
                    >Lưu trữ</a
                  >
                </div>
                <div class="alternative-item">
                  <h4><i class="fas fa-edit"></i> Chỉnh sửa</h4>
                  <p>Chỉnh sửa thông tin tài liệu thay vì xóa</p>
                  <a
                    th:href="@{/admin/documents/{id}/edit(id=${document.id})}"
                    class="secondary-btn"
                    >Chỉnh sửa</a
                  >
                </div>
                <div class="alternative-item">
                  <h4><i class="fas fa-pause-circle"></i> Tạm ngưng</h4>
                  <p>Tạm ngưng tài liệu thay vì xóa vĩnh viễn</p>
                  <a
                    th:href="@{/admin/documents/{id}/hide(id=${document.id})}"
                    class="secondary-btn"
                    >Tạm ngưng</a
                  >
                </div>
              </div>
            </div>

            <!-- Delete Form -->
            <form
              th:action="@{/admin/documents/{id}/delete(id=${document.id})}"
              method="post"
              id="deleteDocumentForm"
            >
              <div class="form-section">
                <h3>Xác nhận xóa</h3>
                <div class="form-group">
                  <label for="reason"
                    >Lý do xóa <span class="required">*</span></label
                  >
                  <textarea
                    id="reason"
                    name="reason"
                    class="form-textarea"
                    placeholder="Nhập lý do xóa tài liệu (vi phạm bản quyền, nội dung không phù hợp, yêu cầu của tác giả...)..."
                    rows="3"
                    required
                  ></textarea>
                  <div class="form-help">
                    Lý do xóa sẽ được ghi lại trong lịch sử và thông báo cho tác
                    giả
                  </div>
                </div>
                <div class="form-group">
                  <label class="checkbox-label">
                    <input type="checkbox" id="confirmDelete" required />
                    Tôi hiểu rằng hành động này không thể hoàn tác và đồng ý xóa
                    tài liệu
                  </label>
                </div>
                <div class="form-group">
                  <label class="checkbox-label">
                    <input type="checkbox" id="notifyAuthor" />
                    Gửi thông báo cho tác giả về việc xóa tài liệu
                  </label>
                </div>
              </div>

              <!-- Form Actions -->
              <div class="form-actions">
                <button type="button" class="secondary-btn" id="cancelBtn">
                  <i class="fas fa-times"></i> Hủy bỏ
                </button>
                <button
                  type="submit"
                  class="danger-btn"
                  id="confirmDeleteBtn"
                  disabled
                >
                  <i class="fas fa-trash"></i> Xác nhận xóa
                </button>
              </div>
            </form>
          </div>
        </div>
      </main>
    </div>

    <!-- Modal xác nhận -->
    <div id="confirmModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
      <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
        <div style="color: #f59e0b; font-size: 48px; margin-bottom: 20px;">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <h3 style="color: #1f2937; margin-bottom: 16px; font-size: 20px;">Xác nhận chuyển vào thùng rác</h3>
        <p style="color: #6b7280; margin-bottom: 24px; line-height: 1.5;">
          Bạn có chắc chắn muốn chuyển tài liệu này vào thùng rác không?<br>
          Tài liệu có thể được khôi phục sau này.
        </p>
        <div style="display: flex; gap: 12px; justify-content: center;">
          <button type="button" onclick="hideConfirmModal()" style="padding: 10px 20px; background: #f3f4f6; color: #374151; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
            <i class="fas fa-times"></i> Hủy
          </button>
          <button type="button" onclick="confirmDelete()" style="padding: 10px 20px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
            <i class="fas fa-trash"></i> Chuyển vào thùng rác
          </button>
        </div>
      </div>
    </div>

    <script th:src="@{/js/main.js}"></script>
    <script th:src="@{/js/admin/admin.js}"></script>
    <script th:src="@{/js/admin/notifications.js}"></script>
    <script>
      // Global functions for modal
      let isSubmitting = false;
      
      function showConfirmModal() {
        document.getElementById("confirmModal").style.display = "flex";
      }

      function hideConfirmModal() {
        document.getElementById("confirmModal").style.display = "none";
      }

      function confirmDelete() {
        if (isSubmitting) return; // Prevent double submission
        
        isSubmitting = true;
        hideConfirmModal();
        
        // Submit form directly without triggering event listener
        const form = document.getElementById("deleteDocumentForm");
        const formData = new FormData(form);
        
        fetch(form.action, {
          method: 'POST',
          body: formData
        }).then(response => {
          if (response.ok) {
            window.location.href = '/admin/documents?tab=deleted';
          } else {
            alert('Có lỗi xảy ra khi xóa tài liệu!');
            isSubmitting = false;
          }
        }).catch(error => {
          console.error('Error:', error);
          alert('Có lỗi xảy ra khi xóa tài liệu!');
          isSubmitting = false;
        });
      }

      document.addEventListener("DOMContentLoaded", function () {
        const confirmCheckbox = document.getElementById("confirmDelete");
        const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
        const cancelBtn = document.getElementById("cancelBtn");
        const reasonTextarea = document.getElementById("reason");

        // Enable/disable delete button based on checkbox and reason
        function updateDeleteButton() {
          const isChecked = confirmCheckbox.checked;
          const hasReason = reasonTextarea.value.trim().length > 0;
          confirmDeleteBtn.disabled = !(isChecked && hasReason);
        }

        confirmCheckbox.addEventListener("change", updateDeleteButton);
        reasonTextarea.addEventListener("input", updateDeleteButton);

        // Cancel button
        cancelBtn.addEventListener("click", function () {
          window.location.href = "/admin/documents";
        });

        // Form submission with modal confirmation
        document
          .getElementById("deleteDocumentForm")
          .addEventListener("submit", function (e) {
            if (isSubmitting) return; // Prevent double submission
            e.preventDefault(); // Ngăn submit form ngay lập tức
            showConfirmModal(); // Hiển thị modal xác nhận
          });
      });
    </script>
  </body>
</html>