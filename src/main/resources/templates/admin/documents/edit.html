<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chỉnh sửa tài liệu - EduShare Admin</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700&family=Open+Sans:wght@400;500;600&family=Playfair+Display:wght@700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" th:href="@{/css/main.css}" />
    <link rel="stylesheet" th:href="@{/css/admin/admin.css}" />
    <link rel="stylesheet" th:href="@{/css/admin/toast.css}" />
    <link rel="stylesheet" th:href="@{/css/admin/admin_documents.css}" />
     <link rel="stylesheet" th:href="@{/css/admin/notifications.css}"/>
    <style>
      /* CSS từ create.html */
      .content-container {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 30px 60px rgba(0, 0, 0, 0.2);
        width: 100%;
        max-width: 900px;
        padding: 24px;
        margin: 20px auto;
      }
      .content-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 16px;
        border-bottom: 1px solid #eee;
      }
      .content-header h3 {
        font-size: 1.75rem;
        font-weight: 700;
        color: #222;
        margin: 0;
      }
      .modal-tabs .tab-nav {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
      }
      .tab-btn {
        padding: 10px 16px;
        border: 1px solid #ddd;
        border-radius: 6px;
        background: #f9f9f9;
        font-weight: 600;
        color: #555;
        transition: background 0.2s, color 0.2s, border-color 0.2s;
      }
      .tab-btn.active {
        background: #4f46e5;
        color: #fff;
        border-color: #4f46e5;
      }
      .tab-btn:hover {
        background: #eee;
      }
      .form-row {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        margin-bottom: 12px;
      }
      .form-group {
        flex: 1 1 48%;
        display: flex;
        flex-direction: column;
      }
      .form-group label {
        font-weight: 600;
        margin-bottom: 6px;
        color: #333;
      }
      input,
      select,
      textarea {
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 1rem;
        transition: border-color 0.2s;
      }
      input:focus,
      select:focus,
      textarea:focus {
        border-color: #4f46e5;
        outline: none;
      }
      .file-upload {
        border: 2px dashed #ccc;
        padding: 20px;
        text-align: center;
        border-radius: 6px;
        transition: border-color 0.2s, background-color 0.2s;
        cursor: pointer;
        position: relative;
      }
      .file-upload:hover {
        border-color: #4f46e5;
        background-color: #f8f9ff;
      }
      .file-upload.drag-over {
        border-color: #4f46e5;
        background-color: #f0f4ff;
        border-style: solid;
      }
      .file-upload input[type="file"] {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
      }
      .file-info {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        margin-top: 8px;
      }
      .file-info i {
        color: #6c757d;
        font-size: 1.2rem;
      }
      .file-info .file-name {
        flex: 1;
        font-weight: 500;
        color: #333;
      }
      .file-info .file-size {
        color: #6c757d;
        font-size: 0.9rem;
      }
      .file-upload-label i {
        font-size: 2rem;
        color: #aaa;
      }
      .file-upload-label span {
        display: block;
        font-weight: 500;
        margin-top: 8px;
      }
      .btn-remove {
        background: none;
        border: none;
        color: #dc2626;
        cursor: pointer;
      }
      .btn-remove:hover {
        color: #991b1b;
      }
      .form-help {
        font-size: 0.85rem;
        color: #666;
      }
      .required {
        color: #dc2626;
      }
      .form-section {
        margin-bottom: 24px;
      }
      .form-section h5 {
        font-size: 1.1rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 1px solid #e5e7eb;
      }
      .form-check {
        margin-bottom: 8px;
        display: flex;
        align-items: center;
      }
      .form-check-input {
        margin-right: 8px;
        width: 16px;
        height: 16px;
      }
      .form-check-label {
        cursor: pointer;
        margin-bottom: 0;
      }
      .form-check-label .text-muted {
        font-size: 0.85em;
        font-style: italic;
      }
      .categories-container {
        display: flex;
        gap: 16px;
        margin-bottom: 16px;
      }
      @media (max-width: 768px) {
        .categories-container {
          flex-direction: column;
          gap: 12px;
        }
      }
      .category-section {
        flex: 1;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        background: #f8f9fa;
      }
      .category-section-title {
        font-size: 1rem;
        font-weight: 600;
        color: #495057;
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 1px solid #dee2e6;
      }
      .category-section-title i {
        margin-right: 8px;
        width: 16px;
      }
      .category-group {
        background: white;
        border-radius: 6px;
        padding: 10px;
        max-height: 150px;
        overflow-y: auto;
      }
      .category-group .form-check {
        margin-bottom: 8px;
        padding: 4px 8px;
        border-radius: 4px;
        transition: background-color 0.2s;
      }
      .category-group .form-check:hover {
        background-color: #f1f3f4;
      }
      .category-group .form-check-label i {
        margin-right: 8px;
        width: 16px;
      }
      .general-category:checked + label {
        font-weight: 600;
        color: #0d6efd;
      }
      .specific-category:checked + label {
        font-weight: 600;
        color: #198754;
      }
      .invalid-feedback {
        display: none;
        width: 100%;
        margin-top: 0.25rem;
        font-size: 0.875rem;
        color: #dc3545;
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        border-radius: 0.375rem;
        padding: 0.5rem 0.75rem;
      }
      .invalid-feedback.show {
        display: block;
      }
      .form-control.is-invalid {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
      }
      .categories-container.is-invalid {
        border: 2px solid #dc3545;
        border-radius: 8px;
      }
      .content-footer {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        padding-top: 16px;
        border-top: 1px solid #eee;
      }
      .tab-panel {
        display: none;
      }
      .tab-panel.active {
        display: block;
      }
      html {
        scroll-behavior: auto;
      }

      /* Info box styling - THÊM MỚI */
      .info-box {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 20px;
      }
      .info-box h5 {
        color: #495057;
        margin-bottom: 12px;
        font-size: 1rem;
        font-weight: 600;
      }
      .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
      }
      .info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #e9ecef;
      }
      .info-item:last-child {
        border-bottom: none;
      }
      .info-label {
        font-weight: 500;
        color: #6c757d;
        font-size: 0.9rem;
      }
      .info-value {
        font-weight: 600;
        color: #495057;
        font-size: 0.9rem;
      }
      .status-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 500;
        text-transform: uppercase;
      }
      .status-badge.draft {
        background: #fef3c7;
        color: #d97706;
      }
      .status-badge.pending {
        background: #dbeafe;
        color: #2563eb;
      }
      .status-badge.published {
        background: #d1fae5;
        color: #16a34a;
      }
      .status-badge.archived {
        background: #f3f4f6;
        color: #6b7280;
      }
      .category-display {
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 10px;
}
.category-list .list-group-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px;
  border-bottom: 1px solid #e9ecef;
}
.category-list .list-group-item:last-child {
  border-bottom: none;
}

/* Tag Selector Styles */
.selected-tags-container {
    margin-bottom: 15px;
    border: 1px solid #e1e5e9;
    border-radius: 8px;
    background: #f8f9fa;
    min-height: 60px;
}

.selected-tags-header {
    padding: 10px 15px;
    border-bottom: 1px solid #e1e5e9;
    background: #fff;
    border-radius: 8px 8px 0 0;
    font-size: 14px;
    color: #6c757d;
    font-weight: 500;
}

.selected-tags {
    padding: 15px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    min-height: 40px;
    align-items: flex-start;
}

.selected-tag {
    display: inline-flex;
    align-items: center;
    background: #e3f2fd;
    color: #1976d2;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 500;
    border: 1px solid #bbdefb;
    transition: all 0.2s ease;
}

.selected-tag:hover {
    background: #bbdefb;
    transform: translateY(-1px);
}

.selected-tag .remove-tag {
    margin-left: 8px;
    cursor: pointer;
    color: #1976d2;
    font-weight: bold;
    font-size: 16px;
    line-height: 1;
}

.selected-tag .remove-tag:hover {
    color: #d32f2f;
}

.tag-search-container {
    position: relative;
    margin-bottom: 10px;
}

.tag-search-input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
}

.tag-search-input {
    width: 100%;
    padding: 12px 40px 12px 16px;
    border: 2px solid #e1e5e9;
    border-radius: 8px;
    font-size: 14px;
    transition: all 0.2s ease;
    background: #fff;
}

.tag-search-input:focus {
    outline: none;
    border-color: #4285f4;
    box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
}

.tag-dropdown-icon {
    position: absolute;
    right: 16px;
    color: #6c757d;
    pointer-events: none;
    transition: transform 0.2s ease;
}

.tag-search-input:focus + .tag-dropdown-icon {
    transform: rotate(180deg);
}

.tag-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: #fff;
    border: 1px solid #e1e5e9;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    max-height: 300px;
    overflow-y: auto;
    display: none;
}

.tag-dropdown.show {
    display: block;
}

.tag-results {
    padding: 8px 0;
}

.tag-results-header {
    padding: 12px 16px;
    background-color: #f8f9fa;
    border-bottom: 1px solid #e1e5e9;
    font-size: 13px;
    color: #6c757d;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.tag-result-item {
    padding: 12px 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: background-color 0.2s ease;
    border-bottom: 1px solid #f1f3f4;
}

.tag-result-item:last-child {
    border-bottom: none;
}

.tag-result-item:hover {
    background-color: #f8f9fa;
}

.tag-result-item.selected {
    background-color: #e3f2fd;
    color: #1976d2;
}

.tag-result-name {
    font-size: 14px;
    font-weight: 500;
}

.tag-result-count {
    font-size: 12px;
    color: #6c757d;
    background: #f1f3f4;
    padding: 2px 8px;
    border-radius: 12px;
}

.create-new-tag {
    background-color: #f8f9fa;
    border-top: 1px solid #e1e5e9;
    color: #1976d2;
    font-weight: 500;
}

.create-new-tag:hover {
    background-color: #e3f2fd;
}

.create-new-tag .fas {
    margin-right: 8px;
    color: #4caf50;
}

.popular-tags {
    margin-top: 15px;
}

.popular-tags-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 8px;
}

.popular-tag-badge {
    display: inline-flex;
    align-items: center;
    background: #f1f3f4;
    color: #5f6368;
    padding: 6px 12px;
    border-radius: 16px;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 1px solid #e1e5e9;
}

.popular-tag-badge:hover {
    background: #e8f0fe;
    color: #1976d2;
    border-color: #4285f4;
    transform: translateY(-1px);
}

.no-results {
    padding: 20px;
    text-align: center;
    color: #6c757d;
    font-style: italic;
}

/* Animation for tag addition */
@keyframes tagAdded {
    0% {
        transform: scale(0.8);
        opacity: 0;
    }
    50% {
        transform: scale(1.1);
    }
    100% {
        transform: scale(1);
        opacity: 1;
    }
}

.selected-tag.new-tag {
    animation: tagAdded 0.3s ease-out;
}

/* Loading and error states */
.loading-state, .error-state {
    padding: 20px;
    text-align: center;
    color: #6c757d;
}

.loading-state i, .error-state i {
    font-size: 24px;
    margin-bottom: 10px;
    display: block;
}

.loading-state i {
    color: #4285f4;
}

.error-state i {
    color: #dc3545;
}

.form-hint {
    font-size: 0.85rem;
    color: #6c757d;
    margin-top: 4px;
}
    </style>
  </head>

  <body class="admin-page">
    <!-- Admin Header -->
    <div th:replace="~{fragments/admin/layout :: header}"></div>

    <!-- Admin Container -->
    <div class="admin-container">
      <!-- Sidebar -->
     <div th:replace="~{fragments/admin/sidebar :: admin-sidebar}"></div>

      <!-- Main Content -->
      <main class="admin-content">
        <div class="admin-content-header">
          <h1 class="admin-page-title">Chỉnh sửa tài liệu</h1>
          <div class="admin-breadcrumbs">
            <a href="/admin/documents">Admin</a>
            <span>/</span>
            <a href="/admin/documents">Tài liệu</a>
            <span>/</span>
            <span th:text="${document.title}">Tài liệu</span>
            <span>/</span>
            <span>Chỉnh sửa</span>
          </div>
        </div>

        <div class="content-container">
          <div class="content-header">
            <h3>Chỉnh sửa tài liệu</h3>
          </div>

          <!-- Hiển thị thông báo -->
          <div th:if="${success}" class="alert alert-success" role="alert">
            <i class="fas fa-check-circle"></i>
            <span th:text="${success}"></span>
          </div>
          <div th:if="${error}" class="alert alert-danger" role="alert">
            <i class="fas fa-exclamation-circle"></i>
            <span th:text="${error}"></span>
          </div>

          <!-- THÔNG TIN BỔ SUNG - Thông tin tài liệu hiện tại -->
          <div class="info-box">
            <h5>
              <i class="fas fa-info-circle"></i> Thông tin tài liệu hiện tại
            </h5>
            <div class="info-grid">
              <div class="info-item">
                <span class="info-label">ID:</span>
                <span class="info-value" th:text="${document.id}">1</span>
              </div>
              <div class="info-item">
                <span class="info-label">Trạng thái:</span>
                <span
                  class="status-badge"
                  th:classappend="${#strings.toLowerCase(document.status)}"
                  th:text="${document.status == 'DRAFT' ? 'Bản nháp' : 
                                document.status == 'PENDING' ? 'Chờ duyệt' : 
                                document.status == 'PUBLISHED' ? 'Đã xuất bản' : 
                                document.status == 'ARCHIVED' ? 'Đã lưu trữ' : document.status}"
                  >PENDING</span
                >
              </div>
              <div class="info-item">
                <span class="info-label">Ngày tạo:</span>
                <span
                  class="info-value"
                  th:text="${#temporals.format(document.createdAt, 'dd/MM/yyyy HH:mm')}"
                  >01/01/2024 10:30</span
                >
              </div>
              <div class="info-item">
                <span class="info-label">Cập nhật lần cuối:</span>
                <span
                  class="info-value"
                  th:text="${#temporals.format(document.updatedAt, 'dd/MM/yyyy HH:mm')}"
                  >01/01/2024 10:30</span
                >
              </div>
            </div>
          </div>

          <div class="modal-body">
            <div class="modal-tabs">
              <div class="tab-nav">
                <button type="button" class="tab-btn active" data-tab="basic">
                  <i class="fas fa-info-circle"></i>
                  <span>Thông tin cơ bản</span>
                </button>
                <button type="button" class="tab-btn" data-tab="media">
                  <i class="fas fa-file-upload"></i>
                  <span>File & Media</span>
                </button>
                <button type="button" class="tab-btn" data-tab="advanced">
                  <i class="fas fa-cogs"></i>
                  <span>Cài đặt nâng cao</span>
                </button>
              </div>
            </div>

            <form
              id="documentForm"
              th:action="@{/admin/documents/{id}(id=${document.id})}"
              th:object="${document}"
              method="post"
              enctype="multipart/form-data"
              novalidate
            >
              <div class="tab-content">
                <!-- Tab 1: Basic Information -->
                <div class="tab-panel active" id="tabBasic">
                  <div class="form-section">
                    <h4><i class="fas fa-info-circle"></i> Thông tin cơ bản</h4>
                    <div class="form-row">
                      <div class="form-group">
                        <label for="documentTitle"
                          >Tiêu đề <span class="required">*</span></label
                        >
                        <input
                          type="text"
                          id="documentTitle"
                          name="title"
                          th:field="*{title}"
                          required
                          placeholder="Nhập tiêu đề tài liệu"
                          class="form-control"
                        />
                        <div
                          class="invalid-feedback"
                          id="titleError"
                          style="display: none"
                        >
                          Vui lòng nhập tiêu đề tài liệu
                        </div>
                        <div
                          class="invalid-feedback"
                          th:errors="*{title}"
                        ></div>
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label for="documentDescription">Mô tả</label>
                        <textarea
                          id="documentDescription"
                          name="description"
                          th:field="*{description}"
                          rows="4"
                          placeholder="Mô tả chi tiết về tài liệu..."
                          class="form-control"
                        ></textarea>
                      </div>
                    </div>
                    <!-- Phân loại tài liệu -->
<div class="form-row">
  <div class="form-group" style="flex: 1 1 100%">
    <label for="documentCategory">Phân loại tài liệu <span class="required">*</span></label>

    <div class="category-display" id="categoryDisplay">
      <div class="category-list" th:unless="${#lists.isEmpty(document.categoryIds)}">
        <h6 class="category-section-title">
          <i class="fas fa-folder"></i> Danh mục đã chọn
        </h6>
        <ul class="list-group" th:each="categoryId : ${document.categoryIds}">
          <li class="list-group-item" th:each="category : ${categories}" th:if="${category.id == categoryId}">
            <i class="fas fa-folder-open text-primary" th:if="${category.parentId == null}"></i>
            <i class="fas fa-tag text-success" th:unless="${category.parentId == null}"></i>
            <span th:text="${category.name}"></span>
            <span th:if="${category.parentName != null}" class="text-muted small">
              (thuộc: <span th:text="${category.parentName}"></span>)
            </span>
          </li>
        </ul>
      </div>
      <div class="alert alert-info" th:if="${#lists.isEmpty(document.categoryIds)}" role="alert">
        <i class="fas fa-info-circle"></i> Chưa có danh mục nào được chọn cho tài liệu này.
      </div>
    </div>

   
    <small class="form-text text-muted">
      <i class="fas fa-info-circle"></i> Danh sách danh mục hiện tại của tài liệu. Để chỉnh sửa, hãy liên hệ quản trị viên.
    </small>
   
  </div>
</div>
                   <div class="form-row">
  <div class="form-group full-width">
    <label>Chọn danh mục cha <span class="required">*</span></label>

    <!-- Level 1: Root categories -->
    <div class="category-level" id="level1">
      <label for="level1Select" class="level-label">Cấp 1 - Danh mục gốc:</label>
      <select id="level1Select" class="form-select level-select" onchange="onLevelChange(1)">
        <option value="0">🏠 Danh mục gốc (không có cha)</option>
        <option th:each="parent : ${rootCategories}"
                th:value="${parent.id}"
                th:text="'📂 ' + ${parent.name}"
                th:attr="data-subcategories=${parent.subcategories}"
                th:selected="${parent.id == document.parentId}">
        </option>
      </select>
    </div>

    <!-- Level 2: Subcategories -->
    <div class="category-level" id="level2" style="display: none;">
      <label for="level2Select" class="level-label">Cấp 2 - Danh mục con:</label>
      <select id="level2Select" class="form-select level-select" onchange="onLevelChange(2)">
        <option value="">Chọn danh mục con...</option>
      </select>
    </div>

    <!-- Level 3: Sub-subcategories -->
    <div class="category-level" id="level3" style="display: none;">
      <label for="level3Select" class="level-label">Cấp 3 - Danh mục con cấp 2:</label>
      <select id="level3Select" class="form-select level-select" onchange="onLevelChange(3)">
        <option value="">Chọn danh mục con cấp 2...</option>
      </select>
    </div>

    <!-- Hidden input cho categoryIdsString -->
    <input type="hidden" id="categoryIdsString" name="categoryIdsString" value="">

    <!-- Hidden input cho parentId cuối cùng (nếu cần) -->
    <input type="hidden" id="finalParentId" name="parentId" th:value="${documentDTO != null and documentDTO.parentId != null ? documentDTO.parentId : 0}">

    <!-- Breadcrumb hiển thị đường dẫn đã chọn -->
    <div id="categoryBreadcrumb" style="margin-top: 10px; display: none;">
      <div style="padding: 8px 12px; background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 4px;">
        <strong>Đường dẫn đã chọn:</strong>
        <div id="breadcrumbPath" style="margin-top: 5px; font-family: monospace;"></div>
      </div>
    </div>
    <div class="invalid-feedback" id="categoryError" style="display: none;">
      Vui lòng chọn ít nhất một danh mục
    </div>
    <small class="form-text text-muted">Chọn từ 1-3 cấp độ danh mục để phân loại chi tiết.</small>
  </div>
</div>
                   <!-- Tag - Xuống dưới riêng -->
                    <div class="form-row">
    <div class="form-group">
        <label for="documentTags">Từ khóa (tối đa 20)</label>
        
        <!-- Selected Tags Display -->
        <div id="selectedTagsContainer" class="selected-tags-container">
            <div class="selected-tags-header">
                <span class="selected-count">Danh sách từ khóa (<span id="tagCount">0</span>/20)</span>
            </div>
            <div id="selectedTags" class="selected-tags"></div>
        </div>
        
        <!-- Tag Search Input -->
        <div class="tag-search-container">
            <div class="tag-search-input-wrapper">
                <input type="text" id="tagSearchInput" class="tag-search-input" placeholder="Tìm kiếm từ khóa..." autocomplete="off">
                <i class="fas fa-chevron-down tag-dropdown-icon"></i>
            </div>
            
            <!-- Dropdown Results -->
            <div id="tagDropdown" class="tag-dropdown">
                <div id="tagResults" class="tag-results"></div>
            </div>
        </div>
        
        <div class="form-hint">Thêm từ khóa giúp tài liệu của bạn dễ dàng được tìm thấy hơn</div>
        
        <!-- Popular Tags -->
        <div id="popularTags" class="popular-tags" style="margin-top: 15px;">
            <strong>Từ khóa phổ biến:</strong>
            <div class="popular-tags-list">
                <div th:if="${popularTags != null and not #lists.isEmpty(popularTags)}" th:each="tag : ${popularTags}" class="popular-tag-item">
                    <span class="popular-tag-badge" th:attr="data-tag=${tag.name}" onclick="addTagFromPopular(this.getAttribute('data-tag'))">
                        <span th:text="${tag.name}"></span>
                    </span>
                </div>
                <div th:unless="${popularTags != null and not #lists.isEmpty(popularTags)}" style="color: #888;">Không có từ khóa phổ biến.</div>
            </div>
        </div>
        
        <input type="hidden" id="tagNames" name="tagNames" th:value="${#strings.listJoin(document.tagNames, ', ')}" value="">
    </div>
</div>
                    <div class="form-row">
                      <div class="form-group">
                        <label for="documentPrice">Giá (coin)</label>
                        <input
                          type="number"
                          id="documentPrice"
                          name="price"
                          th:field="*{price}"
                          min="0"
                          placeholder="0 = Miễn phí"
                          class="form-control"
                        />
                      </div>
                      <div class="form-group">
                        <label for="documentStatus">Trạng thái</label>
                        <select
                          id="documentStatus"
                          name="status"
                          th:field="*{status}"
                          class="form-control"
                        >
                          <option value="DRAFT">Bản nháp</option>
                          <option value="PENDING">Chờ duyệt</option>
                          <option value="PUBLISHED">Đã xuất bản</option>
                          <option value="ARCHIVED">Đã lưu trữ</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Tab 2: File & Media -->
                <div class="tab-panel" id="tabMedia">
                  <div class="form-section">
                    <h4><i class="fas fa-file-upload"></i> File và Media</h4>

                    <!-- Hiển thị file hiện tại nếu có -->
                    <div
                      th:if="${document.fileName}"
                      class="file-info"
                      style="display: block"
                    >
                      <i
                        class="fas fa-file-pdf"
                        th:if="${#strings.endsWith(document.fileName, '.pdf')}"
                      ></i>
                      <i
                        class="fas fa-file-word"
                        th:if="${#strings.endsWith(document.fileName, '.doc') or #strings.endsWith(document.fileName, '.docx')}"
                      ></i>
                      <i
                        class="fas fa-file-powerpoint"
                        th:if="${#strings.endsWith(document.fileName, '.ppt') or #strings.endsWith(document.fileName, '.pptx')}"
                      ></i>
                      <i
                        class="fas fa-file-excel"
                        th:if="${#strings.endsWith(document.fileName, '.xls') or #strings.endsWith(document.fileName, '.xlsx')}"
                      ></i>
                      <i
                        class="fas fa-file"
                        th:unless="${#strings.endsWith(document.fileName, '.pdf') or #strings.endsWith(document.fileName, '.doc') or #strings.endsWith(document.fileName, '.docx') or #strings.endsWith(document.fileName, '.ppt') or #strings.endsWith(document.fileName, '.pptx') or #strings.endsWith(document.fileName, '.xls') or #strings.endsWith(document.fileName, '.xlsx')}"
                      ></i>
                      <span class="file-name" th:text="${document.fileName}"
                        >document.pdf</span
                      >
                      <span
                        class="file-size"
                        th:text="${document.fileSize != null ? document.fileSize + ' KB' : 'N/A'}"
                        >2.5 MB</span
                      >
                      <small class="text-muted">(File hiện tại)</small>
                    </div>

                    <div class="form-row">
                      <div class="form-group">
                        <label for="documentFile"
                          >Thay đổi file tài liệu (tùy chọn)</label
                        >
                        <div class="file-upload">
                          <input
                            type="file"
                            id="documentFile"
                            name="file"
                            accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx"
                            class="form-control"
                          />
                          <div class="file-upload-label">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <span>Chọn file mới hoặc kéo thả vào đây</span>
                            <small
                              >Hỗ trợ: PDF, Word, PowerPoint, Excel (tối đa
                              100MB)</small
                            >
                          </div>
                        </div>
                        <div
                          class="file-info"
                          id="fileInfo"
                          style="display: none"
                        >
                          <i class="fas fa-file"></i>
                          <span class="file-name"></span>
                          <span class="file-size"></span>
                          <button
                            type="button"
                            class="btn-remove"
                            title="Xóa file"
                          >
                            <i class="fas fa-times"></i>
                          </button>
                        </div>
                        <small class="form-text text-muted">
                          <i class="fas fa-info-circle"></i>
                          Để trống nếu không muốn thay đổi file hiện tại
                        </small>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Tab 3: Advanced Settings -->
                <div class="tab-panel" id="tabAdvanced">
                  <div class="form-section">
                    <h4><i class="fas fa-cogs"></i> Cài đặt nâng cao</h4>
                    <p class="text-muted">
                      Các tính năng nâng cao sẽ được bổ sung trong phiên bản
                      tương lai.
                    </p>
                  </div>
                </div>
              </div>
              <input type="hidden" id="documentId" name="id" th:field="*{id}" />
            </form>
          </div>
          <div class="content-footer">
            <a th:href="@{/admin/documents}" class="btn btn-outline">Hủy</a>
            <button type="submit" class="btn btn-primary" form="documentForm">
              <i class="fas fa-save"></i>
              <span>Cập nhật tài liệu</span>
            </button>
          </div>
        </div>
      </main>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
     <script th:src="@{/js/admin/notifications.js}"></script>
    <script th:src="@{/js/admin/documents.js}"></script>
  
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("documentForm");
        const documentFile = document.getElementById("documentFile");
        const fileInfo = document.getElementById("fileInfo");

        // Tab switching functionality
        const tabBtns = document.querySelectorAll(".tab-btn");
        const tabPanels = document.querySelectorAll(".tab-panel");

        tabBtns.forEach((btn) => {
            btn.addEventListener("click", function () {
                const targetTab = this.getAttribute("data-tab");
                tabBtns.forEach((b) => b.classList.remove("active"));
                tabPanels.forEach((p) => p.classList.remove("active"));
                this.classList.add("active");
                document.getElementById("tab" + targetTab.charAt(0).toUpperCase() + targetTab.slice(1)).classList.add("active");
            });
        });

        // File upload handling
        if (documentFile) {
            documentFile.addEventListener("change", function () {
                const file = this.files[0];
                if (file) {
                    const fileName = file.name;
                    const fileSize = (file.size / 1024 / 1024).toFixed(2) + " MB";
                    fileInfo.querySelector(".file-name").textContent = fileName;
                    fileInfo.querySelector(".file-size").textContent = fileSize;
                    fileInfo.style.display = "flex";

                    const extension = fileName.split(".").pop().toLowerCase();
                    const icon = fileInfo.querySelector("i");
                    icon.className = "fas fa-file";
                    switch (extension) {
                        case "pdf": icon.className = "fas fa-file-pdf"; break;
                        case "doc": case "docx": icon.className = "fas fa-file-word"; break;
                        case "ppt": case "pptx": icon.className = "fas fa-file-powerpoint"; break;
                        case "xls": case "xlsx": icon.className = "fas fa-file-excel"; break;
                    }
                } else {
                    fileInfo.style.display = "none";
                }
            });

            const removeBtn = fileInfo.querySelector(".btn-remove");
            if (removeBtn) {
                removeBtn.addEventListener("click", function () {
                    documentFile.value = "";
                    fileInfo.style.display = "none";
                });
            }
        }

        // Form validation
        if (form) {
            form.addEventListener("submit", function (e) {
                let isValid = true;
                const title = document.getElementById("documentTitle");
                const titleError = document.getElementById("titleError");
                if (title && !title.value.trim()) {
                    if (titleError) titleError.style.display = "block";
                    title.classList.add("is-invalid");
                    isValid = false;
                } else if (title && titleError) {
                    titleError.style.display = "none";
                    title.classList.remove("is-invalid");
                }

                if (!isValid) {
                    e.preventDefault();
                    const basicTab = document.querySelector('[data-tab="basic"]');
                    if (basicTab) basicTab.click();
                }
            });
        }

        // Drag and drop for file upload
        const fileUpload = document.querySelector(".file-upload");
        if (fileUpload) {
            ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
                fileUpload.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }

            ["dragenter", "dragover"].forEach((eventName) => {
                fileUpload.addEventListener(eventName, () => fileUpload.classList.add("drag-over"), false);
            });

            ["dragleave", "drop"].forEach((eventName) => {
                fileUpload.addEventListener(eventName, () => fileUpload.classList.remove("drag-over"), false);
            });

            fileUpload.addEventListener("drop", function(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files.length > 0) {
                    documentFile.files = files;
                    documentFile.dispatchEvent(new Event("change"));
                }
            }, false);
        }

        // Initialize category selector
        initializeCategorySelector();
      });

      // Category selector functionality
      let originalCategoryIds = '';
      function initializeCategorySelector() {
          const existingCategoryIds = document.getElementById('categoryIdsString')?.value;
          originalCategoryIds = existingCategoryIds || ''; // Lưu category IDs ban đầu
          console.log('Original categoryIds:', originalCategoryIds);
          
          if (existingCategoryIds) {
              const categoryIds = existingCategoryIds.split(',').filter(id => id.trim());
              if (categoryIds.length > 0) {
                  loadExistingCategoryPath(categoryIds);
              }
          }
      }

      async function loadExistingCategoryPath(categoryIds) {
          try {
              for (let i = 0; i < categoryIds.length; i++) {
                  const categoryId = categoryIds[i];
                  const levelSelect = document.getElementById(`level${i + 1}Select`);
                  
                  if (levelSelect) {
                      levelSelect.value = categoryId;
                      if (i < categoryIds.length - 1) {
                          await loadSubcategories(categoryId, `level${i + 2}Select`);
                      }
                  }
              }
              updateBreadcrumb();
              updateFinalParentId();
          } catch (error) {
              console.error('Error loading existing category path:', error);
          }
      }

      async function loadSubcategories(parentId, targetSelectId) {
          try {
              const response = await fetch(`/admin/documents/categories/${parentId}/subcategories`);
              const subcategories = await response.json();
              
              const targetSelect = document.getElementById(targetSelectId);
              if (targetSelect) {
                  targetSelect.innerHTML = '<option value="">Chọn danh mục con...</option>';
                  
                  subcategories.forEach(category => {
                      const option = document.createElement('option');
                      option.value = category.id;
                      option.textContent = `📁 ${category.name}`;
                      targetSelect.appendChild(option);
                  });
                  
                  const targetDiv = document.getElementById(targetSelectId.replace('Select', ''));
                  if (targetDiv) targetDiv.style.display = 'block';
              }
          } catch (error) {
              console.error('Error loading subcategories:', error);
          }
      }

      function onLevelChange(level) {
          const currentSelect = document.getElementById(`level${level}Select`);
          if (!currentSelect) return;
          
          const selectedValue = currentSelect.value;
          
          // Hide and reset subsequent levels
          for (let i = level + 1; i <= 3; i++) {
              const levelDiv = document.getElementById(`level${i}`);
              const levelSelect = document.getElementById(`level${i}Select`);
              if (levelDiv) levelDiv.style.display = 'none';
              if (levelSelect) levelSelect.innerHTML = '<option value="">Chọn...</option>';
          }
          
          updateCategoryIdsString();
          updateFinalParentId();
          
          if (selectedValue && selectedValue !== '0') {
              loadSubcategories(selectedValue, `level${level + 1}Select`);
          }
          
          updateBreadcrumb();
      }

      function updateCategoryIdsString() {
          const categoryIds = [];
          for (let i = 1; i <= 3; i++) {
              const select = document.getElementById(`level${i}Select`);
              if (select && select.value && select.value !== '0' && select.value !== '') {
                  categoryIds.push(select.value);
              }
          }
          
          const categoryIdsStringInput = document.getElementById('categoryIdsString');
          if (categoryIdsStringInput) {
              // Nếu không có category nào được chọn, giữ nguyên giá trị ban đầu
              if (categoryIds.length === 0) {
                  categoryIdsStringInput.value = originalCategoryIds;
                  console.log('No categories selected, keeping original:', originalCategoryIds);
              } else {
                  categoryIdsStringInput.value = categoryIds.join(',');
                  console.log('Updated categoryIds:', categoryIds.join(','));
              }
          }
      }

      function updateFinalParentId() {
          let finalParentId = '0';
          for (let i = 3; i >= 1; i--) {
              const select = document.getElementById(`level${i}Select`);
              if (select && select.value && select.value !== '0' && select.value !== '') {
                  finalParentId = select.value;
                  break;
              }
          }
          
          const finalParentIdInput = document.getElementById('finalParentId');
          if (finalParentIdInput) {
              finalParentIdInput.value = finalParentId;
          }
      }

      function updateBreadcrumb() {
          const breadcrumb = document.getElementById('categoryBreadcrumb');
          const breadcrumbPath = document.getElementById('breadcrumbPath');
          
          if (!breadcrumb || !breadcrumbPath) return;
          
          let path = [];
          for (let i = 1; i <= 3; i++) {
              const select = document.getElementById(`level${i}Select`);
              if (select && select.value && select.value !== '0') {
                  const selectedOption = select.options[select.selectedIndex];
                  path.push(selectedOption.textContent);
              } else {
                  break;
              }
          }
          
          if (path.length > 0) {
              breadcrumbPath.textContent = path.join(' → ');
              breadcrumb.style.display = 'block';
          } else {
              breadcrumb.style.display = 'none';
          }
      }

      document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("documentForm");
        const documentFile = document.getElementById("documentFile");
        const fileInfo = document.getElementById("fileInfo");

        // Tab switching functionality
        const tabBtns = document.querySelectorAll(".tab-btn");
        const tabPanels = document.querySelectorAll(".tab-panel");

        tabBtns.forEach((btn) => {
          btn.addEventListener("click", function () {
            const targetTab = this.getAttribute("data-tab");

            // Remove active class from all tabs and panels
            tabBtns.forEach((b) => b.classList.remove("active"));
            tabPanels.forEach((p) => p.classList.remove("active"));

            // Add active class to clicked tab and corresponding panel
            this.classList.add("active");
            document
              .getElementById(
                "tab" + targetTab.charAt(0).toUpperCase() + targetTab.slice(1)
              )
              .classList.add("active");
          });
        });

        // File upload handling
        if (documentFile) {
          documentFile.addEventListener("change", function () {
            const file = this.files[0];
            if (file) {
              const fileName = file.name;
              const fileSize = (file.size / 1024 / 1024).toFixed(2) + " MB";

              fileInfo.querySelector(".file-name").textContent = fileName;
              fileInfo.querySelector(".file-size").textContent = fileSize;
              fileInfo.style.display = "flex";

              // Update file icon based on extension
              const extension = fileName.split(".").pop().toLowerCase();
              const icon = fileInfo.querySelector("i");
              icon.className = "fas fa-file";

              switch (extension) {
                case "pdf":
                  icon.className = "fas fa-file-pdf";
                  break;
                case "doc":
                case "docx":
                  icon.className = "fas fa-file-word";
                  break;
                case "ppt":
                case "pptx":
                  icon.className = "fas fa-file-powerpoint";
                  break;
                case "xls":
                case "xlsx":
                  icon.className = "fas fa-file-excel";
                  break;
              }
            } else {
              fileInfo.style.display = "none";
            }
          });

          // Remove file button
          const removeBtn = fileInfo.querySelector(".btn-remove");
          if (removeBtn) {
            removeBtn.addEventListener("click", function () {
              documentFile.value = "";
              fileInfo.style.display = "none";
            });
          }
        }

        // Function để hiển thị lỗi inline
        function showInlineError(errorId, message) {
          const errorDiv = document.getElementById(errorId);
          if (errorDiv) {
            errorDiv.textContent = message;
            errorDiv.style.display = "block";
            // Tự động ẩn sau 3 giây
            setTimeout(() => {
              errorDiv.style.display = "none";
            }, 3000);
          }
        }

        // Function để ẩn lỗi inline
        function hideInlineError(errorId) {
          const errorDiv = document.getElementById(errorId);
          if (errorDiv) {
            errorDiv.style.display = "none";
          }
        }

        // Category selection handling
        const categoryCheckboxes =
          document.querySelectorAll(".category-checkbox");
        const selectedCategoryIds = document.getElementById(
          "selectedCategoryIds"
        );

        function updateSelectedCategories() {
          const selected = [];
          categoryCheckboxes.forEach((checkbox) => {
            if (checkbox.checked) {
              selected.push(checkbox.value);
            }
          });
          selectedCategoryIds.value = selected.join(",");
        }

        // Enhanced category selection with general category restriction
        categoryCheckboxes.forEach((checkbox) => {
          checkbox.addEventListener("change", function () {
            const isChecked = this.checked;

            if (isChecked) {
              const checkedBoxes = document.querySelectorAll(
                ".category-checkbox:checked"
              );

              // Kiểm tra số lượng danh mục tổng cộng
              if (checkedBoxes.length > 15) {
                this.checked = false;
                showInlineError(
                  "categoryError",
                  "Bạn chỉ có thể chọn ( Danh mục Tổng quát(1) + Chuyên mục(14) ) tối đa là 15 danh mục!"
                );
                return;
              }

              // Logic đặc biệt: Chỉ cho phép chọn 1 danh mục tổng quát
              if (this.classList.contains("general-category")) {
                const otherGeneralChecked = document.querySelectorAll(
                  ".general-category:checked"
                );
                if (otherGeneralChecked.length > 1) {
                  // Bỏ chọn các danh mục tổng quát khác
                  otherGeneralChecked.forEach((cb) => {
                    if (cb !== this) {
                      cb.checked = false;
                    }
                  });
                }
              }
            }

            // Cập nhật hidden field
            updateSelectedCategories();
          });
        });

        // Initialize selected categories
        updateSelectedCategories();

        // Form validation
        form.addEventListener("submit", function (e) {
          let isValid = true;

          // Validate title
          const title = document.getElementById("documentTitle");
          const titleError = document.getElementById("titleError");
          if (!title.value.trim()) {
            titleError.style.display = "block";
            title.classList.add("is-invalid");
            isValid = false;
          } else {
            titleError.style.display = "none";
            title.classList.remove("is-invalid");
          }

          // Validate categories
          const categoryError = document.getElementById("categoryError");
          const selectedCategories = selectedCategoryIds.value
            .split(",")
            .filter((id) => id.trim());
          if (selectedCategories.length === 0) {
            categoryError.style.display = "block";
            document
              .querySelector(".categories-container")
              .classList.add("is-invalid");
            isValid = false;
          } else if (selectedCategories.length > 15) {
            categoryError.textContent = "Bạn chỉ có thể chọn ( Danh mục Tổng quát(1) + Chuyên mục(14) ) tối đa là 15 danh mục!";
            categoryError.style.display = "block";
            document
              .querySelector(".categories-container")
              .classList.add("is-invalid");
            isValid = false;
          } else {
            categoryError.style.display = "none";
            document
              .querySelector(".categories-container")
              .classList.remove("is-invalid");
          }

          if (!isValid) {
            e.preventDefault();
            // Switch to basic tab if validation fails
            document.querySelector('[data-tab="basic"]').click();
          }
        });

        // Drag and drop for file upload
        const fileUpload = document.querySelector(".file-upload");
        if (fileUpload) {
          ["dragenter", "dragover", "dragleave", "drop"].forEach(
            (eventName) => {
              fileUpload.addEventListener(eventName, preventDefaults, false);
            }
          );

          function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
          }

          ["dragenter", "dragover"].forEach((eventName) => {
            fileUpload.addEventListener(eventName, highlight, false);
          });

          ["dragleave", "drop"].forEach((eventName) => {
            fileUpload.addEventListener(eventName, unhighlight, false);
          });

          function highlight(e) {
            fileUpload.classList.add("drag-over");
          }

          function unhighlight(e) {
            fileUpload.classList.remove("drag-over");
          }

          fileUpload.addEventListener("drop", handleDrop, false);

          function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;

            if (files.length > 0) {
              documentFile.files = files;
              documentFile.dispatchEvent(new Event("change"));
            }
          }
        }
      });

      // Toast notification function
      function showNotification(message, type = "info") {
        const toast = document.createElement("div");
        toast.className = `alert alert-${
          type === "success" ? "success" : "danger"
        } alert-dismissible fade show`;

        const bgColor = type === "success" ? "#d1e7dd" : "#f8d7da";
        const borderColor = type === "success" ? "#badbcc" : "#f5c2c7";
        const textColor = type === "success" ? "#0f5132" : "#842029";

        toast.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          z-index: 9999;
          min-width: 300px;
          padding: 12px 16px;
          margin-bottom: 1rem;
          border: 1px solid ${borderColor};
          border-radius: 8px;
          background-color: ${bgColor};
          color: ${textColor};
          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
          font-size: 14px;
          line-height: 1.5;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
          display: flex;
          align-items: center;
          gap: 8px;
          animation: slideIn 0.3s ease-out;
        `;

        const icon = type === "success" ? "✓" : "⚠";
        toast.innerHTML = `
          <span style="font-weight: bold; font-size: 16px;">${icon}</span>
          <span>${message}</span>
          <button type="button" class="btn-close" style="margin-left: auto; background: none; border: none; font-size: 18px; cursor: pointer; color: ${textColor};" onclick="this.parentElement.remove()">×</button>
        `;

        // Add keyframe animation
        if (!document.getElementById("toast-animations")) {
          const style = document.createElement("style");
          style.id = "toast-animations";
          style.textContent = `
            @keyframes slideIn {
              from { transform: translateX(100%); opacity: 0; }
              to { transform: translateX(0); opacity: 1; }
            }
          `;
          document.head.appendChild(style);
        }

        document.body.appendChild(toast);

        // Auto remove after 5 seconds
        setTimeout(() => {
          if (toast.parentElement) {
            toast.remove();
          }
        }, 5000);
      }
let selectedPath = [];
      let currentCategoryId = /*[[${document.id != null ? document.id : null}]]*/ null;
      let currentParentId = /*[[${document.parentId != null ? document.parentId : 0}]]*/ 0;
      

      function onLevelChange(level) {
    const currentSelect = document.getElementById(`level${level}Select`);
    const selectedValue = currentSelect.value;
    const selectedText = currentSelect.options[currentSelect.selectedIndex].text;

    // Clear subsequent levels
    for (let i = level + 1; i <= 3; i++) {
        const nextLevel = document.getElementById(`level${i}`);
        const nextSelect = document.getElementById(`level${i}Select`);
        nextLevel.style.display = 'none';
        nextSelect.innerHTML = '<option value="">Chọn danh mục con...</option>';
    }

    // Update selected path
    selectedPath = selectedPath.slice(0, level - 1);
    if (selectedValue && selectedValue !== '0') {
        selectedPath[level - 1] = {
            id: selectedValue,
            name: selectedText.replace(/^[📂📁🏠]\s*/, ''),
            level: level
        };
        loadNextLevel(selectedValue, level + 1);
    } else if (level === 1 && selectedValue === '0') {
        selectedPath = [];
    }

    // Cập nhật categoryIdsString với danh sách ID
    const categoryIdsStringInput = document.getElementById('categoryIdsString');
    categoryIdsStringInput.value = selectedPath.map(item => item.id).join(',');
    console.log("Updated categoryIdsString:", categoryIdsStringInput.value); // Debug

    updateFinalSelection();
    updateBreadcrumb();
}

      function loadNextLevel(parentId, targetLevel) {
          if (targetLevel > 3) return;

          fetch(`/admin/categories/${parentId}/subcategories`)
              .then(response => response.json())
              .then(data => {
                  if (data && data.length > 0) {
                      const targetSelect = document.getElementById(`level${targetLevel}Select`);
                      const targetDiv = document.getElementById(`level${targetLevel}`);

                      // Clear and populate options
                      targetSelect.innerHTML = '<option value="">Chọn danh mục con...</option>';
                      data.forEach(sub => {
                          // Exclude current category from options (nếu đang edit)
                          if (!currentCategoryId || sub.id != currentCategoryId) {
                              const option = document.createElement('option');
                              option.value = sub.id;
                              option.textContent = `📁 ${sub.name}`;
                              option.setAttribute('data-subcategories', sub.subcategories || 0);
                              targetSelect.appendChild(option);
                          }
                      });

                      targetDiv.style.display = 'block';
                  }
              })
              .catch(error => {
                  console.error('Error loading subcategories:', error);
              });
      }

      function updateFinalSelection() {
    const finalParentId = document.getElementById('finalParentId');
    const finalParentIdInput = document.getElementById('finalParentId');
    if (selectedPath.length > 0) {
        finalParentIdInput.value = selectedPath[selectedPath.length - 1].id;
    } else {
        finalParentIdInput.value = '0';
    }
    if (selectedPath.length === 0) {
        finalParentId.value = '0'; // Root category
    } else {
        const lastSelected = selectedPath[selectedPath.length - 1];
        finalParentId.value = lastSelected.id;
    }
    // Xóa các tham số parentId dư thừa từ các select
    const selects = document.querySelectorAll('.level-select');
    selects.forEach(select => select.removeAttribute('name'));
}

      function updateBreadcrumb() {
          const breadcrumb = document.getElementById('categoryBreadcrumb');
          const breadcrumbPath = document.getElementById('breadcrumbPath');

          if (selectedPath.length === 0) {
              breadcrumb.style.display = 'none';
              return;
          }

          let pathHtml = '<span class="breadcrumb-item">🏠 Gốc</span>';
          selectedPath.forEach((item, index) => {
              pathHtml += '<span class="breadcrumb-arrow">→</span>';
              pathHtml += `<span class="breadcrumb-item">📁 ${item.name}</span>`;
          });

          breadcrumbPath.innerHTML = pathHtml;
          breadcrumb.style.display = 'block';
      }



         let allTags = [];

    // Hàm tải danh sách tag từ API
    function loadTags(searchQuery = '') {
        fetch(`/admin/documents/tags?q=${encodeURIComponent(searchQuery)}`)
            .then(response => response.json())
            .then(data => {
                allTags = data;
                renderTags(searchQuery);
            })
            .catch(error => {
                console.error('Error loading tags:', error);
                document.getElementById('tagList').innerHTML = '<li class="list-group-item text-danger">Lỗi khi tải danh sách tag</li>';
            });
    }

    // Hàm render danh sách tag
    function renderTags(searchQuery = '') {
        const tagList = document.getElementById('tagList');
        tagList.innerHTML = '';

        const filteredTags = searchQuery
            ? allTags.filter(tag => tag.name.toLowerCase().includes(searchQuery.toLowerCase()))
            : allTags;

        if (filteredTags.length === 0) {
            tagList.innerHTML = '<li class="list-group-item text-muted">Không tìm thấy tag nào</li>';
            return;
        }

        filteredTags.forEach(tag => {
            const li = document.createElement('li');
            li.className = 'list-group-item';
            li.textContent = `${tag.name} (ID: ${tag.id})`;
            li.addEventListener('click', () => {
                const currentTags = document.getElementById('documentTags').value.split(',').map(t => t.trim()).filter(t => t);
                if (!currentTags.includes(tag.name)) {
                    currentTags.push(tag.name);
                    document.getElementById('documentTags').value = currentTags.join(', ');
                }
            });
            tagList.appendChild(li);
        });
    }

    // Xử lý sự kiện tìm kiếm
    document.getElementById('searchTagButton').addEventListener('click', () => {
        const searchQuery = document.getElementById('tagSearch').value.trim();
        renderTags(searchQuery);
    });

    // Xử lý tìm kiếm khi nhấn Enter
    document.getElementById('tagSearch').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            const searchQuery = e.target.value.trim();
            renderTags(searchQuery);
        }
    });
    

      // Show flash messages as toast notifications
      document.addEventListener("DOMContentLoaded", function () {
        // Success messages
        const successMessage = /*[[${success}]]*/ null;
        if (successMessage) {
          showNotification(successMessage, "success");
        }
    loadTags();
        // Error messages
        const errorMessage = /*[[${error}]]*/ null;
        if (errorMessage) {
          showNotification(errorMessage, "error");
        }
          if (currentParentId && currentParentId !== 0) {
              loadCurrentParentPath(currentParentId);
          }
      });
    
     
    </script>
  </body>
</html>