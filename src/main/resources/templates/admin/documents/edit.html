<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ch·ªânh s·ª≠a t√†i li·ªáu - EduShare Admin</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700&family=Open+Sans:wght@400;500;600&family=Playfair+Display:wght@700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" th:href="@{/css/main.css}" />
    <link rel="stylesheet" th:href="@{/css/admin/admin.css}" />
    <link rel="stylesheet" th:href="@{/css/admin/toast.css}" />
    <link rel="stylesheet" th:href="@{/css/admin/admin_documents.css}" />
     <link rel="stylesheet" th:href="@{/css/admin/notifications.css}"/>
    <style>
      /* CSS t·ª´ create.html */
      .content-container {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 30px 60px rgba(0, 0, 0, 0.2);
        width: 100%;
        max-width: 900px;
        padding: 24px;
        margin: 20px auto;
      }
      .content-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 16px;
        border-bottom: 1px solid #eee;
      }
      .content-header h3 {
        font-size: 1.75rem;
        font-weight: 700;
        color: #222;
        margin: 0;
      }
      .modal-tabs .tab-nav {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
      }
      .tab-btn {
        padding: 10px 16px;
        border: 1px solid #ddd;
        border-radius: 6px;
        background: #f9f9f9;
        font-weight: 600;
        color: #555;
        transition: background 0.2s, color 0.2s, border-color 0.2s;
      }
      .tab-btn.active {
        background: #4f46e5;
        color: #fff;
        border-color: #4f46e5;
      }
      .tab-btn:hover {
        background: #eee;
      }
      .form-row {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        margin-bottom: 12px;
      }
      .form-group {
        flex: 1 1 48%;
        display: flex;
        flex-direction: column;
      }
      .form-group label {
        font-weight: 600;
        margin-bottom: 6px;
        color: #333;
      }
      input,
      select,
      textarea {
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 1rem;
        transition: border-color 0.2s;
      }
      input:focus,
      select:focus,
      textarea:focus {
        border-color: #4f46e5;
        outline: none;
      }
      .file-upload {
        border: 2px dashed #ccc;
        padding: 20px;
        text-align: center;
        border-radius: 6px;
        transition: border-color 0.2s, background-color 0.2s;
        cursor: pointer;
        position: relative;
      }
      .file-upload:hover {
        border-color: #4f46e5;
        background-color: #f8f9ff;
      }
      .file-upload.drag-over {
        border-color: #4f46e5;
        background-color: #f0f4ff;
        border-style: solid;
      }
      .file-upload input[type="file"] {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
      }
      .file-info {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        margin-top: 8px;
      }
      .file-info i {
        color: #6c757d;
        font-size: 1.2rem;
      }
      .file-info .file-name {
        flex: 1;
        font-weight: 500;
        color: #333;
      }
      .file-info .file-size {
        color: #6c757d;
        font-size: 0.9rem;
      }
      .file-upload-label i {
        font-size: 2rem;
        color: #aaa;
      }
      .file-upload-label span {
        display: block;
        font-weight: 500;
        margin-top: 8px;
      }
      .btn-remove {
        background: none;
        border: none;
        color: #dc2626;
        cursor: pointer;
      }
      .btn-remove:hover {
        color: #991b1b;
      }
      .form-help {
        font-size: 0.85rem;
        color: #666;
      }
      .required {
        color: #dc2626;
      }
      .form-section {
        margin-bottom: 24px;
      }
      .form-section h5 {
        font-size: 1.1rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 1px solid #e5e7eb;
      }
      .form-check {
        margin-bottom: 8px;
        display: flex;
        align-items: center;
      }
      .form-check-input {
        margin-right: 8px;
        width: 16px;
        height: 16px;
      }
      .form-check-label {
        cursor: pointer;
        margin-bottom: 0;
      }
      .form-check-label .text-muted {
        font-size: 0.85em;
        font-style: italic;
      }
      .categories-container {
        display: flex;
        gap: 16px;
        margin-bottom: 16px;
      }
      @media (max-width: 768px) {
        .categories-container {
          flex-direction: column;
          gap: 12px;
        }
      }
      .category-section {
        flex: 1;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        background: #f8f9fa;
      }
      .category-section-title {
        font-size: 1rem;
        font-weight: 600;
        color: #495057;
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 1px solid #dee2e6;
      }
      .category-section-title i {
        margin-right: 8px;
        width: 16px;
      }
      .category-group {
        background: white;
        border-radius: 6px;
        padding: 10px;
        max-height: 150px;
        overflow-y: auto;
      }
      .category-group .form-check {
        margin-bottom: 8px;
        padding: 4px 8px;
        border-radius: 4px;
        transition: background-color 0.2s;
      }
      .category-group .form-check:hover {
        background-color: #f1f3f4;
      }
      .category-group .form-check-label i {
        margin-right: 8px;
        width: 16px;
      }
      .general-category:checked + label {
        font-weight: 600;
        color: #0d6efd;
      }
      .specific-category:checked + label {
        font-weight: 600;
        color: #198754;
      }
      .invalid-feedback {
        display: none;
        width: 100%;
        margin-top: 0.25rem;
        font-size: 0.875rem;
        color: #dc3545;
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        border-radius: 0.375rem;
        padding: 0.5rem 0.75rem;
      }
      .invalid-feedback.show {
        display: block;
      }
      .form-control.is-invalid {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
      }
      .categories-container.is-invalid {
        border: 2px solid #dc3545;
        border-radius: 8px;
      }
      .content-footer {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        padding-top: 16px;
        border-top: 1px solid #eee;
      }
      .tab-panel {
        display: none;
      }
      .tab-panel.active {
        display: block;
      }
      html {
        scroll-behavior: auto;
      }

      /* Info box styling - TH√äM M·ªöI */
      .info-box {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 20px;
      }
      .info-box h5 {
        color: #495057;
        margin-bottom: 12px;
        font-size: 1rem;
        font-weight: 600;
      }
      .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
      }
      .info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #e9ecef;
      }
      .info-item:last-child {
        border-bottom: none;
      }
      .info-label {
        font-weight: 500;
        color: #6c757d;
        font-size: 0.9rem;
      }
      .info-value {
        font-weight: 600;
        color: #495057;
        font-size: 0.9rem;
      }
      .status-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 500;
        text-transform: uppercase;
      }
      .status-badge.draft {
        background: #fef3c7;
        color: #d97706;
      }
      .status-badge.pending {
        background: #dbeafe;
        color: #2563eb;
      }
      .status-badge.published {
        background: #d1fae5;
        color: #16a34a;
      }
      .status-badge.archived {
        background: #f3f4f6;
        color: #6b7280;
      }
    </style>
  </head>

  <body class="admin-page">
    <!-- Admin Header -->
    <div th:replace="~{fragments/admin/layout :: header}"></div>

    <!-- Admin Container -->
    <div class="admin-container">
      <!-- Sidebar -->
     <div th:replace="~{fragments/admin/sidebar :: admin-sidebar}"></div>

      <!-- Main Content -->
      <main class="admin-content">
        <div class="admin-content-header">
          <h1 class="admin-page-title">Ch·ªânh s·ª≠a t√†i li·ªáu</h1>
          <div class="admin-breadcrumbs">
            <a href="/admin/documents">Admin</a>
            <span>/</span>
            <a href="/admin/documents">T√†i li·ªáu</a>
            <span>/</span>
            <span th:text="${document.title}">T√†i li·ªáu</span>
            <span>/</span>
            <span>Ch·ªânh s·ª≠a</span>
          </div>
        </div>

        <div class="content-container">
          <div class="content-header">
            <h3>Ch·ªânh s·ª≠a t√†i li·ªáu</h3>
          </div>

          <!-- Hi·ªÉn th·ªã th√¥ng b√°o -->
          <div th:if="${success}" class="alert alert-success" role="alert">
            <i class="fas fa-check-circle"></i>
            <span th:text="${success}"></span>
          </div>
          <div th:if="${error}" class="alert alert-danger" role="alert">
            <i class="fas fa-exclamation-circle"></i>
            <span th:text="${error}"></span>
          </div>

          <!-- TH√îNG TIN B·ªî SUNG - Th√¥ng tin t√†i li·ªáu hi·ªán t·∫°i -->
          <div class="info-box">
            <h5>
              <i class="fas fa-info-circle"></i> Th√¥ng tin t√†i li·ªáu hi·ªán t·∫°i
            </h5>
            <div class="info-grid">
              <div class="info-item">
                <span class="info-label">ID:</span>
                <span class="info-value" th:text="${document.id}">1</span>
              </div>
              <div class="info-item">
                <span class="info-label">Tr·∫°ng th√°i:</span>
                <span
                  class="status-badge"
                  th:classappend="${#strings.toLowerCase(document.status)}"
                  th:text="${document.status == 'DRAFT' ? 'B·∫£n nh√°p' : 
                                document.status == 'PENDING' ? 'Ch·ªù duy·ªát' : 
                                document.status == 'PUBLISHED' ? 'ƒê√£ xu·∫•t b·∫£n' : 
                                document.status == 'ARCHIVED' ? 'ƒê√£ l∆∞u tr·ªØ' : document.status}"
                  >PENDING</span
                >
              </div>
              <div class="info-item">
                <span class="info-label">Ng√†y t·∫°o:</span>
                <span
                  class="info-value"
                  th:text="${#temporals.format(document.createdAt, 'dd/MM/yyyy HH:mm')}"
                  >01/01/2024 10:30</span
                >
              </div>
              <div class="info-item">
                <span class="info-label">C·∫≠p nh·∫≠t l·∫ßn cu·ªëi:</span>
                <span
                  class="info-value"
                  th:text="${#temporals.format(document.updatedAt, 'dd/MM/yyyy HH:mm')}"
                  >01/01/2024 10:30</span
                >
              </div>
            </div>
          </div>

          <div class="modal-body">
            <div class="modal-tabs">
              <div class="tab-nav">
                <button type="button" class="tab-btn active" data-tab="basic">
                  <i class="fas fa-info-circle"></i>
                  <span>Th√¥ng tin c∆° b·∫£n</span>
                </button>
                <button type="button" class="tab-btn" data-tab="media">
                  <i class="fas fa-file-upload"></i>
                  <span>File & Media</span>
                </button>
                <button type="button" class="tab-btn" data-tab="advanced">
                  <i class="fas fa-cogs"></i>
                  <span>C√†i ƒë·∫∑t n√¢ng cao</span>
                </button>
              </div>
            </div>

            <form
              id="documentForm"
              th:action="@{/admin/documents/{id}(id=${document.id})}"
              th:object="${document}"
              method="post"
              enctype="multipart/form-data"
              novalidate
            >
              <div class="tab-content">
                <!-- Tab 1: Basic Information -->
                <div class="tab-panel active" id="tabBasic">
                  <div class="form-section">
                    <h4><i class="fas fa-info-circle"></i> Th√¥ng tin c∆° b·∫£n</h4>
                    <div class="form-row">
                      <div class="form-group">
                        <label for="documentTitle"
                          >Ti√™u ƒë·ªÅ <span class="required">*</span></label
                        >
                        <input
                          type="text"
                          id="documentTitle"
                          name="title"
                          th:field="*{title}"
                          required
                          placeholder="Nh·∫≠p ti√™u ƒë·ªÅ t√†i li·ªáu"
                          class="form-control"
                        />
                        <div
                          class="invalid-feedback"
                          id="titleError"
                          style="display: none"
                        >
                          Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ t√†i li·ªáu
                        </div>
                        <div
                          class="invalid-feedback"
                          th:errors="*{title}"
                        ></div>
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label for="documentDescription">M√¥ t·∫£</label>
                        <textarea
                          id="documentDescription"
                          name="description"
                          th:field="*{description}"
                          rows="4"
                          placeholder="M√¥ t·∫£ chi ti·∫øt v·ªÅ t√†i li·ªáu..."
                          class="form-control"
                        ></textarea>
                      </div>
                    </div>
                <!--    <div class="info-box">
  <h5><i class="fas fa-list"></i> Danh s√°ch danh m·ª•c hi·ªán t·∫°i</h5>
  <div class="info-grid">
    <div th:each="categoryId : ${document.categoryIds}" th:if="${not #lists.isEmpty(categories)}" class="info-item">
      <span class="info-label">Danh m·ª•c:</span>
      <span class="info-value" th:text="${T(com.example.demo.utils.CategoryUtils).findCategoryById(categories, categoryId)?.name ?: 'Kh√¥ng t√¨m th·∫•y'}">T√™n danh m·ª•c</span>
    </div>
    <div class="info-item" th:unless="${not #lists.isEmpty(categories) and not #lists.isEmpty(document?.categoryIds)}">
      <span class="info-label">Danh m·ª•c:</span>
      <span class="info-value">Ch∆∞a c√≥ danh m·ª•c n√†o</span>
    </div>
  </div>
  <small class="form-text text-muted">Danh s√°ch c√°c danh m·ª•c ƒë√£ g√°n cho t√†i li·ªáu.</small>
</div>-->
                      <!-- Ph√¢n lo·∫°i t√†i li·ªáu -->
                    <div class="form-row">
                      <!-- Ph√¢n lo·∫°i t√†i li·ªáu (ƒêa c·∫•p v·ªõi API) -->
                                    <div class="form-group full-width">
                                        <label>Ch·ªçn danh m·ª•c cha <span class="required">*</span></label>
                                        
                                        <!-- Level 1: Root categories -->
                                        <div class="category-level" id="level1">
                                            <label for="level1Select" class="level-label">C·∫•p 1 - Danh m·ª•c g·ªëc:</label>
                                            <select id="level1Select" class="form-select level-select" onchange="onLevelChange(1)" th:name="parentId">
                                                <option value="0">üè† Danh m·ª•c g·ªëc (kh√¥ng c√≥ cha)</option>
                                                <option th:each="parent : ${rootCategories}"
                                                        th:value="${parent.id}"
                                                        th:text="'üìÇ ' + ${parent.name}"
                                                        th:attr="data-subcategories=${parent.subcategories}">
                                                </option>
                                            </select>
                                        </div>
                                        
                                        <!-- Level 2: Subcategories -->
                                        <div class="category-level" id="level2" style="display: none;">
                                            <label for="level2Select" class="level-label">C·∫•p 2 - Danh m·ª•c con:</label>
                                            <select id="level2Select" class="form-select level-select" onchange="onLevelChange(2)" th:name="parentId">
                                                <option value="">Ch·ªçn danh m·ª•c con...</option>
                                            </select>
                                        </div>
                                        
                                        <!-- Level 3: Sub-subcategories -->
                                        <div class="category-level" id="level3" style="display: none;">
                                            <label for="level3Select" class="level-label">C·∫•p 3 - Danh m·ª•c con c·∫•p 2:</label>
                                            <select id="level3Select" class="form-select level-select" onchange="onLevelChange(3)" th:name="parentId">
                                                <option value="">Ch·ªçn danh m·ª•c con c·∫•p 2...</option>
                                            </select>
                                        </div>
                                        
                                        <!-- Hidden input for final parent selection -->
                                         <input type="hidden" id="categoryIdsString" name="categoryIdsString" value="">
                                        <input type="hidden" id="finalParentId" name="parentId" th:value="${documentDTO != null and documentDTO.parentId != null ? documentDTO.parentId : 0}">
                                        
                                        <!-- Breadcrumb hi·ªÉn th·ªã ƒë∆∞·ªùng d·∫´n ƒë√£ ch·ªçn -->
                                        <div id="categoryBreadcrumb" style="margin-top: 10px; display: none;">
                                            <div style="padding: 8px 12px; background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 4px;">
                                                <strong>ƒê∆∞·ªùng d·∫´n ƒë√£ ch·ªçn:</strong>
                                                <div id="breadcrumbPath" style="margin-top: 5px; font-family: monospace;"></div>
                                            </div>
                                        </div>
                                        <div class="invalid-feedback" id="categoryError" style="display: none;">
        Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt danh m·ª•c
    </div>
                                        <span class="error" th:if="${#fields.hasErrors('parentId')}" th:errors="*{parentId}">Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt danh m·ª•c</span>
                                        <small class="form-text text-muted">Ch·ªçn t·ª´ 1-3 c·∫•p ƒë·ªô danh m·ª•c ƒë·ªÉ ph√¢n lo·∫°i chi ti·∫øt.</small>
                                    </div>
                    </div>

                    <!-- Tag - Xu·ªëng d∆∞·ªõi ri√™ng -->
                    <div class="form-row">
    <div class="form-group">
        <label for="documentTags">
            <i class="fas fa-hashtag"></i>
            Tag (nh·∫≠p t√™n tag, c√°ch nhau b·∫±ng d·∫•u ph·∫©y)
        </label>
        <input
            type="text"
            id="documentTags"
            name="tagNames"
            th:value="${#strings.listJoin(document.tagNames, ', ')}"
            placeholder="java, spring-boot, tutorial, backend"
            class="form-control"
        />
        <small class="form-text text-muted">
            <i class="fas fa-lightbulb"></i>
            V√≠ d·ª•: java, spring-boot, tutorial, backend (gi√∫p t√¨m ki·∫øm d·ªÖ d√†ng h∆°n)
        </small>
    </div>
</div>

<!-- Th√™m ph·∫ßn m·ªõi: Hi·ªÉn th·ªã t·∫•t c·∫£ tag v√† t√¨m ki·∫øm -->
<div class="form-row">
    <div class="form-group">
        <label>
            <i class="fas fa-tags"></i>
            Danh s√°ch t·∫•t c·∫£ Tag
        </label>
        <div class="input-group mb-3">
            <input
                type="text"
                id="tagSearch"
                class="form-control"
                placeholder="T√¨m ki·∫øm tag..."
            />
            <button
                class="btn btn-primary"
                type="button"
                id="searchTagButton"
            >
                <i class="fas fa-search"></i> T√¨m ki·∫øm
            </button>
        </div>
        <div
            id="tagListContainer"
            class="tag-list-container"
            style="max-height: 200px; overflow-y: auto; border: 1px solid #ccc; border-radius: 6px; padding: 10px; background: #fff;"
        >
            <ul id="tagList" class="list-group"></ul>
        </div>
    </div>
</div>
                    <div class="form-row">
                      <div class="form-group">
                        <label for="documentPrice">Gi√° (coin)</label>
                        <input
                          type="number"
                          id="documentPrice"
                          name="price"
                          th:field="*{price}"
                          min="0"
                          placeholder="0 = Mi·ªÖn ph√≠"
                          class="form-control"
                        />
                      </div>
                      <div class="form-group">
                        <label for="documentStatus">Tr·∫°ng th√°i</label>
                        <select
                          id="documentStatus"
                          name="status"
                          th:field="*{status}"
                          class="form-control"
                        >
                          <option value="DRAFT">B·∫£n nh√°p</option>
                          <option value="PENDING">Ch·ªù duy·ªát</option>
                          <option value="PUBLISHED">ƒê√£ xu·∫•t b·∫£n</option>
                          <option value="ARCHIVED">ƒê√£ l∆∞u tr·ªØ</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Tab 2: File & Media -->
                <div class="tab-panel" id="tabMedia">
                  <div class="form-section">
                    <h4><i class="fas fa-file-upload"></i> File v√† Media</h4>

                    <!-- Hi·ªÉn th·ªã file hi·ªán t·∫°i n·∫øu c√≥ -->
                    <div
                      th:if="${document.fileName}"
                      class="file-info"
                      style="display: block"
                    >
                      <i
                        class="fas fa-file-pdf"
                        th:if="${#strings.endsWith(document.fileName, '.pdf')}"
                      ></i>
                      <i
                        class="fas fa-file-word"
                        th:if="${#strings.endsWith(document.fileName, '.doc') or #strings.endsWith(document.fileName, '.docx')}"
                      ></i>
                      <i
                        class="fas fa-file-powerpoint"
                        th:if="${#strings.endsWith(document.fileName, '.ppt') or #strings.endsWith(document.fileName, '.pptx')}"
                      ></i>
                      <i
                        class="fas fa-file-excel"
                        th:if="${#strings.endsWith(document.fileName, '.xls') or #strings.endsWith(document.fileName, '.xlsx')}"
                      ></i>
                      <i
                        class="fas fa-file"
                        th:unless="${#strings.endsWith(document.fileName, '.pdf') or #strings.endsWith(document.fileName, '.doc') or #strings.endsWith(document.fileName, '.docx') or #strings.endsWith(document.fileName, '.ppt') or #strings.endsWith(document.fileName, '.pptx') or #strings.endsWith(document.fileName, '.xls') or #strings.endsWith(document.fileName, '.xlsx')}"
                      ></i>
                      <span class="file-name" th:text="${document.fileName}"
                        >document.pdf</span
                      >
                      <span
                        class="file-size"
                        th:text="${document.fileSize != null ? document.fileSize + ' KB' : 'N/A'}"
                        >2.5 MB</span
                      >
                      <small class="text-muted">(File hi·ªán t·∫°i)</small>
                    </div>

                    <div class="form-row">
                      <div class="form-group">
                        <label for="documentFile"
                          >Thay ƒë·ªïi file t√†i li·ªáu (t√πy ch·ªçn)</label
                        >
                        <div class="file-upload">
                          <input
                            type="file"
                            id="documentFile"
                            name="file"
                            accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx"
                            class="form-control"
                          />
                          <div class="file-upload-label">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <span>Ch·ªçn file m·ªõi ho·∫∑c k√©o th·∫£ v√†o ƒë√¢y</span>
                            <small
                              >H·ªó tr·ª£: PDF, Word, PowerPoint, Excel (t·ªëi ƒëa
                              100MB)</small
                            >
                          </div>
                        </div>
                        <div
                          class="file-info"
                          id="fileInfo"
                          style="display: none"
                        >
                          <i class="fas fa-file"></i>
                          <span class="file-name"></span>
                          <span class="file-size"></span>
                          <button
                            type="button"
                            class="btn-remove"
                            title="X√≥a file"
                          >
                            <i class="fas fa-times"></i>
                          </button>
                        </div>
                        <small class="form-text text-muted">
                          <i class="fas fa-info-circle"></i>
                          ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng mu·ªën thay ƒë·ªïi file hi·ªán t·∫°i
                        </small>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Tab 3: Advanced Settings -->
                <div class="tab-panel" id="tabAdvanced">
                  <div class="form-section">
                    <h4><i class="fas fa-cogs"></i> C√†i ƒë·∫∑t n√¢ng cao</h4>
                    <p class="text-muted">
                      C√°c t√≠nh nƒÉng n√¢ng cao s·∫Ω ƒë∆∞·ª£c b·ªï sung trong phi√™n b·∫£n
                      t∆∞∆°ng lai.
                    </p>
                  </div>
                </div>
              </div>
              <input type="hidden" id="documentId" name="id" th:field="*{id}" />
            </form>
          </div>
          <div class="content-footer">
            <a th:href="@{/admin/documents}" class="btn btn-outline">H·ªßy</a>
            <button type="submit" class="btn btn-primary" form="documentForm">
              <i class="fas fa-save"></i>
              <span>C·∫≠p nh·∫≠t t√†i li·ªáu</span>
            </button>
          </div>
        </div>
      </main>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
     <script th:src="@{/js/admin/notifications.js}"></script>
    <script>
  // Bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u tr·ªØ danh m·ª•c v√† tag
  let categories = [];
  let selectedPath = [];
  let currentCategoryId = /*[[${document.id != null ? document.id : null}]]*/ null;
  let currentParentId = /*[[${document.parentId != null ? document.parentId : 0}]]*/ 0;
  let allTags = [];

  // Kh·ªüi t·∫°o khi DOM load
  document.addEventListener("DOMContentLoaded", function () {
    // Tab switching functionality
    const tabBtns = document.querySelectorAll(".tab-btn");
    const tabPanels = document.querySelectorAll(".tab-panel");

    tabBtns.forEach((btn) => {
      btn.addEventListener("click", function () {
        const targetTab = this.getAttribute("data-tab");

        tabBtns.forEach((b) => b.classList.remove("active"));
        tabPanels.forEach((p) => p.classList.remove("active"));

        this.classList.add("active");
        document
          .getElementById(
            "tab" + targetTab.charAt(0).toUpperCase() + targetTab.slice(1)
          )
          .classList.add("active");
      });
    });

    // File upload handling
    const documentFile = document.getElementById("documentFile");
    const fileInfo = document.getElementById("fileInfo");

    if (documentFile) {
      documentFile.addEventListener("change", function () {
        const file = this.files[0];
        if (file) {
          const fileName = file.name;
          const fileSize = (file.size / 1024 / 1024).toFixed(2) + " MB";

          fileInfo.querySelector(".file-name").textContent = fileName;
          fileInfo.querySelector(".file-size").textContent = fileSize;
          fileInfo.style.display = "flex";

          const extension = fileName.split(".").pop().toLowerCase();
          const icon = fileInfo.querySelector("i");
          icon.className = "fas fa-file";

          switch (extension) {
            case "pdf":
              icon.className = "fas fa-file-pdf";
              break;
            case "doc":
            case "docx":
              icon.className = "fas fa-file-word";
              break;
            case "ppt":
            case "pptx":
              icon.className = "fas fa-file-powerpoint";
              break;
            case "xls":
            case "xlsx":
              icon.className = "fas fa-file-excel";
              break;
          }
        } else {
          fileInfo.style.display = "none";
        }
      });

      const removeBtn = fileInfo.querySelector(".btn-remove");
      if (removeBtn) {
        removeBtn.addEventListener("click", function () {
          documentFile.value = "";
          fileInfo.style.display = "none";
        });
      }
    }

    // Drag and drop for file upload
    const fileUpload = document.querySelector(".file-upload");
    if (fileUpload) {
      ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
        fileUpload.addEventListener(eventName, preventDefaults, false);
      });

      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }

      ["dragenter", "dragover"].forEach((eventName) => {
        fileUpload.addEventListener(eventName, highlight, false);
      });

      ["dragleave", "drop"].forEach((eventName) => {
        fileUpload.addEventListener(eventName, unhighlight, false);
      });

      function highlight(e) {
        fileUpload.classList.add("drag-over");
      }

      function unhighlight(e) {
        fileUpload.classList.remove("drag-over");
      }

      fileUpload.addEventListener("drop", handleDrop, false);

      function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;

        if (files.length > 0) {
          documentFile.files = files;
          documentFile.dispatchEvent(new Event("change"));
        }
      }
    }

    // Function ƒë·ªÉ hi·ªÉn th·ªã l·ªói inline
    function showInlineError(errorId, message) {
      const errorDiv = document.getElementById(errorId);
      if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.style.display = "block";
        setTimeout(() => {
          errorDiv.style.display = "none";
        }, 3000);
      }
    }

    function hideInlineError(errorId) {
      const errorDiv = document.getElementById(errorId);
      if (errorDiv) {
        errorDiv.style.display = "none";
      }
    }

    // Form validation
    const form = document.getElementById("documentForm");
    if (form) {
      form.addEventListener("submit", function (e) {
        let isValid = true;

        // Validate title
        const title = document.getElementById("documentTitle");
        const titleError = document.getElementById("titleError");
        if (!title.value.trim()) {
          titleError.style.display = "block";
          title.classList.add("is-invalid");
          isValid = false;
        } else {
          titleError.style.display = "none";
          title.classList.remove("is-invalid");
        }

        // Validate categories
        const categoryIdsString = document.getElementById("categoryIdsString");
        const categoryError = document.getElementById("categoryError");
        const selectedCategories = categoryIdsString
          ? categoryIdsString.value.split(",").filter((id) => id.trim())
          : [];
        if (selectedCategories.length === 0) {
          categoryError.style.display = "block";
          document
            .querySelector(".categories-container")
            .classList.add("is-invalid");
          isValid = false;
        } else {
          categoryError.style.display = "none";
          document
            .querySelector(".categories-container")
            .classList.remove("is-invalid");
        }

        if (!isValid) {
          e.preventDefault();
          document.querySelector('[data-tab="basic"]').click();
        }
      });
    }

    // Category selection handling (ƒëa c·∫•p)
    const categorySelects = document.querySelectorAll("select[data-level]");
    categorySelects.forEach((select) => {
      select.addEventListener("change", onLevelChange);
    });

    // Kh·ªüi t·∫°o danh m·ª•c ƒëa c·∫•p
    loadCurrentParentPath();
  });

  // H√†m x·ª≠ l√Ω thay ƒë·ªïi c·∫•p ƒë·ªô danh m·ª•c
  function onLevelChange(event) {
    const level = parseInt(event.target.getAttribute("data-level"));
    const selectedId = event.target.value;

    selectedPath = selectedPath.slice(0, level);
    if (selectedId) {
      selectedPath[level] = selectedId;
    }

    loadNextLevel(level + 1);
    updateFinalSelection();
  }

  // H√†m t·∫£i c·∫•p danh m·ª•c ti·∫øp theo
  

  
let selectedPath = [];
      let currentCategoryId = /*[[${document.id != null ? document.id : null}]]*/ null;
      let currentParentId = /*[[${document.parentId != null ? document.parentId : 0}]]*/ 0;
      

      function onLevelChange(level) {
          const currentSelect = document.getElementById(`level${level}Select`);
          const selectedValue = currentSelect.value;
          const selectedText = currentSelect.options[currentSelect.selectedIndex].text;

          // Clear subsequent levels
          for (let i = level + 1; i <= 3; i++) {
              const nextLevel = document.getElementById(`level${i}`);
              const nextSelect = document.getElementById(`level${i}Select`);
              nextLevel.style.display = 'none';
              nextSelect.innerHTML = '<option value="">Ch·ªçn danh m·ª•c con...</option>';
          }

          // Update selected path
          selectedPath = selectedPath.slice(0, level - 1);
          if (selectedValue && selectedValue !== '0') {
              selectedPath[level - 1] = {
                  id: selectedValue,
                  name: selectedText.replace(/^[üìÇüìÅüè†]\s*/, ''),
                  level: level
              };

              // Load next level if available
              loadNextLevel(selectedValue, level + 1);
          } else if (level === 1 && selectedValue === '0') {
              selectedPath = [];
          }
   const categoryIdsStringInput = document.getElementById('categoryIdsString');
    categoryIdsStringInput.value = selectedPath.map(item => item.id).join(',');
          updateFinalSelection();
          updateBreadcrumb();
          // ·∫®n th√¥ng b√°o l·ªói khi ch·ªçn danh m·ª•c
        const categoryContainer = document.querySelector('.full-width');
        if (categoryContainer && selectedPath.length > 0) {
            categoryContainer.classList.remove('is-invalid');
            hideInlineError('categoryError');
        }
       
      }

      function loadNextLevel(parentId, targetLevel) {
          if (targetLevel > 3) return;

          fetch(`/admin/categories/${parentId}/subcategories`)
              .then(response => response.json())
              .then(data => {
                  if (data && data.length > 0) {
                      const targetSelect = document.getElementById(`level${targetLevel}Select`);
                      const targetDiv = document.getElementById(`level${targetLevel}`);

                      // Clear and populate options
                      targetSelect.innerHTML = '<option value="">Ch·ªçn danh m·ª•c con...</option>';
                      data.forEach(sub => {
                          // Exclude current category from options (n·∫øu ƒëang edit)
                          if (!currentCategoryId || sub.id != currentCategoryId) {
                              const option = document.createElement('option');
                              option.value = sub.id;
                              option.textContent = `üìÅ ${sub.name}`;
                              option.setAttribute('data-subcategories', sub.subcategories || 0);
                              targetSelect.appendChild(option);
                          }
                      });

                      targetDiv.style.display = 'block';
                  }
              })
              .catch(error => {
                  console.error('Error loading subcategories:', error);
              });
      }

      function updateFinalSelection() {
    const finalParentId = document.getElementById('finalParentId');
    if (selectedPath.length === 0) {
        finalParentId.value = '0'; // Root category
    } else {
        const lastSelected = selectedPath[selectedPath.length - 1];
        finalParentId.value = lastSelected.id;
    }
    // X√≥a c√°c tham s·ªë parentId d∆∞ th·ª´a t·ª´ c√°c select
    const selects = document.querySelectorAll('.level-select');
    selects.forEach(select => select.removeAttribute('name'));
}

      function updateBreadcrumb() {
          const breadcrumb = document.getElementById('categoryBreadcrumb');
          const breadcrumbPath = document.getElementById('breadcrumbPath');

          if (selectedPath.length === 0) {
              breadcrumb.style.display = 'none';
              return;
          }

          let pathHtml = '<span class="breadcrumb-item">üè† G·ªëc</span>';
          selectedPath.forEach((item, index) => {
              pathHtml += '<span class="breadcrumb-arrow">‚Üí</span>';
              pathHtml += `<span class="breadcrumb-item">üìÅ ${item.name}</span>`;
          });

          breadcrumbPath.innerHTML = pathHtml;
          breadcrumb.style.display = 'block';
      }

      // Initialize form with current parent selection
   

      function loadCurrentParentPath(parentId) {
          // Load the hierarchy path for current parent
          fetch(`/admin/categories/${parentId}/path`)
              .then(response => response.json())
              .then(data => {
                  if (data && data.length > 0) {
                      data.forEach((category, index) => {
                          const level = index + 1;
                          const select = document.getElementById(`level${level}Select`);
                          if (select) {
                              select.value = category.id;
                              onLevelChange(level);
                          }
                      });
                  }
              })
              .catch(error => {
                  console.error('Error loading category path:', error);
              });
      }
       document.addEventListener('DOMContentLoaded', function () {
        if (currentParentId && currentParentId !== 0) {
            loadCurrentParentPath(currentParentId);
        }

    });
  

  // Toast notification function
  function showNotification(message, type = "info") {
    const toast = document.createElement("div");
    toast.className = `alert alert-${
      type === "success" ? "success" : "danger"
    } alert-dismissible fade show`;

    const bgColor = type === "success" ? "#d1e7dd" : "#f8d7da";
    const borderColor = type === "success" ? "#badbcc" : "#f5c2c7";
    const textColor = type === "success" ? "#0f5132" : "#842029";

    toast.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      min-width: 300px;
      padding: 12px 16px;
      margin-bottom: 1rem;
      border: 1px solid ${borderColor};
      border-radius: 8px;
      background-color: ${bgColor};
      color: ${textColor};
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      font-size: 14px;
      line-height: 1.5;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      gap: 8px;
      animation: slideIn 0.3s ease-out;
    `;

    const icon = type === "success" ? "‚úì" : "‚ö†";
    toast.innerHTML = `
      <span style="font-weight: bold; font-size: 16px;">${icon}</span>
      <span>${message}</span>
      <button type="button" class="btn-close" style="margin-left: auto; background: none; border: none; font-size: 18px; cursor: pointer; color: ${textColor};" onclick="this.parentElement.remove()">√ó</button>
    `;

    if (!document.getElementById("toast-animations")) {
      const style = document.createElement("style");
      style.id = "toast-animations";
      style.textContent = `
        @keyframes slideIn {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
      `;
      document.head.appendChild(style);
    }

    document.body.appendChild(toast);

    setTimeout(() => {
      if (toast.parentElement) {
        toast.remove();
      }
    }, 5000);
  }

  // Show flash messages as toast notifications
  document.addEventListener("DOMContentLoaded", function () {
    const successMessage = /*[[${success}]]*/ null;
    if (successMessage) {
      showNotification(successMessage, "success");
    }

    const errorMessage = /*[[${error}]]*/ null;
    if (errorMessage) {
      showNotification(errorMessage, "error");
    }
  });

  // Tag handling
  function loadTags(searchQuery = "") {
    fetch(`/admin/documents/tags?q=${encodeURIComponent(searchQuery)}`)
      .then((response) => {
        if (!response.ok) {
          throw new Error("Network response was not ok");
        }
        return response.json();
      })
      .then((data) => {
        allTags = data;
        renderTags(searchQuery);
      })
      .catch((error) => {
        console.error("Error loading tags:", error);
        document.getElementById("tagList").innerHTML =
          '<li class="list-group-item text-danger">L·ªói khi t·∫£i danh s√°ch tag</li>';
      });
  }

  function renderTags(searchQuery = "") {
    const tagList = document.getElementById("tagList");
    tagList.innerHTML = "";

    const filteredTags = searchQuery
      ? allTags.filter((tag) =>
          tag.name.toLowerCase().includes(searchQuery.toLowerCase())
        )
      : allTags;

    if (filteredTags.length === 0) {
      tagList.innerHTML = '<li class="list-group-item text-muted">Kh√¥ng t√¨m th·∫•y tag n√†o</li>';
      return;
    }

    filteredTags.forEach((tag) => {
      const li = document.createElement("li");
      li.className = "list-group-item";
      li.textContent = `${tag.name} (ID: ${tag.id})`;
      li.addEventListener("click", () => {
        const currentTags = document
          .getElementById("documentTags")
          .value.split(",")
          .map((t) => t.trim())
          .filter((t) => t);
        if (!currentTags.includes(tag.name)) {
          currentTags.push(tag.name);
          document.getElementById("documentTags").value = currentTags.join(", ");
        }
      });
      tagList.appendChild(li);
    });
  }

  document.getElementById("searchTagButton").addEventListener("click", () => {
    const searchQuery = document.getElementById("tagSearch").value.trim();
    renderTags(searchQuery);
  });

  document.getElementById("tagSearch").addEventListener("keypress", (e) => {
    if (e.key === "Enter") {
      const searchQuery = e.target.value.trim();
      renderTags(searchQuery);
    }
  });

  // Kh·ªüi t·∫°o danh s√°ch tag khi trang load
  loadTags();

  
</script>
  </body>
</html>
