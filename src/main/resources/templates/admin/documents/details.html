<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Chi tiết tài liệu - EduShare Admin</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700&family=Open+Sans:wght@400;500;600&family=Playfair+Display:wght@700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" th:href="@{/css/main.css}" />
    <link rel="stylesheet" th:href="@{/css/admin/admin.css}" />
    <link rel="stylesheet" th:href="@{/css/admin/toast.css}" />
    <link rel="stylesheet" th:href="@{/css/admin/admin_documents.css}" />
    <link rel="stylesheet" th:href="@{/css/admin/notifications.css}" />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <style>
      /* 🌟 Modal Wrapper */
      .modal-content.large {
        margin-left: 200px;
      }

      @keyframes modalFadeIn {
        from {
          opacity: 0;
          transform: scale(0.95);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      /* Header */
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 16px;
        border-bottom: 1px solid #eee;
      }
      .modal-header h3 {
        font-size: 1.75rem;
        font-weight: 700;
        color: #222;
        margin: 0;
      }
      .modal-close {
        background: transparent;
        border: none;
        font-size: 1.5rem;
        color: #999;
        cursor: pointer;
        transition: color 0.2s;
      }
      .modal-close:hover {
        color: #333;
      }

      /* Footer */
      .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        padding-top: 16px;
        border-top: 1px solid #eee;
      }

      /* Tabs */
      .modal-tabs .tab-nav {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
      }
      .tab-btn {
        padding: 10px 16px;
        border: 1px solid #ddd;
        border-radius: 6px;
        background: #f9f9f9;
        font-weight: 600;
        color: #555;
        transition: background 0.2s, color 0.2s, border-color 0.2s;
      }
      .tab-btn.active {
        background: #4f46e5;
        color: #fff;
        border-color: #4f46e5;
      }
      .tab-btn:hover {
        background: #eee;
      }

      /* Form */
      .form-row {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        margin-bottom: 12px;
      }
      .form-group {
        flex: 1 1 48%;
        display: flex;
        flex-direction: column;
      }
      .form-group label {
        font-weight: 600;
        margin-bottom: 6px;
        color: #333;
      }
      input,
      select,
      textarea {
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 1rem;
        transition: border-color 0.2s;
      }
      input:focus,
      select:focus,
      textarea:focus {
        border-color: #4f46e5;
        outline: none;
      }

      /* Upload */
      .file-upload {
        border: 2px dashed #ccc;
        padding: 20px;
        text-align: center;
        border-radius: 6px;
        transition: border-color 0.2s;
      }
      .file-upload:hover {
        border-color: #4f46e5;
      }

      .file-upload-label i {
        font-size: 2rem;
        color: #aaa;
      }
      .file-upload-label span {
        display: block;
        font-weight: 500;
        margin-top: 8px;
      }

      .thumbnail-preview img {
        max-width: 100%;
        border-radius: 6px;
        margin-top: 10px;
      }

      .btn-remove {
        background: none;
        border: none;
        color: #dc2626;
        cursor: pointer;
      }
      .btn-remove:hover {
        color: #991b1b;
      }

      /* Helper text */
      .form-help {
        font-size: 0.85rem;
        color: #666;
      }

      .required {
        color: #dc2626;
      }

      /* Comment Management Styles */
      .comment-stats {
        display: flex;
        gap: 20px;
        align-items: center;
      }

      .stat-item {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.9rem;
        color: #666;
      }

      .report-badge {
        font-size: 0.75rem;
        padding: 2px 6px;
        border-radius: 3px;
        font-weight: 500;
        text-transform: uppercase;
      }

      .report-pending {
        background-color: #fef3c7;
        color: #92400e;
      }

      .report-resolved {
        background-color: #d1fae5;
        color: #065f46;
      }

      .report-rejected {
        background-color: #fee2e2;
        color: #991b1b;
      }

      .reply-form {
        border-left: 3px solid #e5e7eb;
        padding-left: 16px;
      }

      /* Report Modal Styles */
      #reportCommentModal .modal-header {
        background-color: #fef2f2;
        border-bottom: 1px solid #fecaca;
      }

      #reportCommentModal .modal-title {
        color: #dc2626;
        font-weight: 600;
      }

      #reportCommentModal .form-label {
        font-weight: 600;
        color: #374151;
      }

      #reportCommentModal .form-select,
      #reportCommentModal .form-control {
        border: 1px solid #d1d5db;
        border-radius: 6px;
        transition: border-color 0.2s, box-shadow 0.2s;
      }

      #reportCommentModal .form-select:focus,
      #reportCommentModal .form-control:focus {
        border-color: #dc2626;
        box-shadow: 0 0 0 0.2rem rgba(220, 38, 38, 0.25);
      }

      #reportCommentModal .alert-info {
        background-color: #eff6ff;
        border-color: #bfdbfe;
        color: #1e40af;
      }

      #reportCommentModal .btn-danger {
        background-color: #dc2626;
        border-color: #dc2626;
        transition: all 0.2s;
      }

      #reportCommentModal .btn-danger:hover {
        background-color: #b91c1c;
        border-color: #b91c1c;
        transform: translateY(-1px);
      }

      #reportCommentModal .btn-secondary {
        transition: all 0.2s;
      }

      #reportCommentModal .btn-secondary:hover {
        transform: translateY(-1px);
      }

      /* Force modal styles to override Bootstrap */
      /* Let Bootstrap handle modal display, just style the content */
      #reportCommentModal .modal-dialog {
        max-width: 500px;
      }

      #reportCommentModal .modal-content {
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      }

      .review-item {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
        background: #fff;
        transition: box-shadow 0.2s;
      }

      .review-item:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .review-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
      }

      .reviewer-info {
        display: flex;
        gap: 12px;
        align-items: flex-start;
      }

      .avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
      }

      .reviewer-details {
        flex: 1;
      }

      .reviewer-name {
        font-size: 1rem;
        color: #374151;
        margin-bottom: 4px;
      }

      .metadata {
        display: flex;
        gap: 10px;
        align-items: center;
        font-size: 0.85rem;
        color: #6b7280;
      }

      .timestamp {
        color: #9ca3af;
      }

      .review-content {
        margin-left: 52px;
        color: #374151;
        line-height: 1.6;
      }

      #commentContent {
        resize: vertical;
        min-height: 80px;
      }

      /* 🎨 New Document Overview Styles */
      .document-overview {
        padding: 0;
      }

      .document-header-card {
        background: linear-gradient(135deg, #667eea 0%, #4f46e5 100%);
        border-radius: 16px;
        padding: 32px;
        margin-bottom: 24px;
        color: white;
        display: flex;
        align-items: center;
        gap: 24px;
        box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
      }

      .document-icon {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 16px;
        padding: 20px;
        backdrop-filter: blur(10px);
      }

      .document-icon i {
        font-size: 2.5rem;
        color: white;
      }

      .document-title-section {
        flex: 1;
      }

      .document-title {
        font-size: 1.8rem;
        font-weight: 700;
        margin: 0 0 12px 0;
        color: white;
      }

      .document-description {
        font-size: 1.1rem;
        margin: 0 0 16px 0;
        opacity: 0.9;
        line-height: 1.5;
      }

      .document-status-badge {
        display: inline-block;
      }

      .status-badge {
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .status-draft {
        background: rgba(156, 163, 175, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
      }

      .status-pending {
        background: rgba(251, 191, 36, 0.2);
        color: #fbbf24;
        border: 1px solid rgba(251, 191, 36, 0.3);
      }

      .status-published {
        background: rgba(34, 197, 94, 0.2);
        color: #22c55e;
        border: 1px solid rgba(34, 197, 94, 0.3);
      }

      .status-archived {
        background: rgba(107, 114, 128, 0.2);
        color: #9ca3af;
        border: 1px solid rgba(107, 114, 128, 0.3);
      }

      .status-rejected {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.3);
      }

      .status-suspended {
        background: rgba(249, 115, 22, 0.2);
        color: #f97316;
        border: 1px solid rgba(249, 115, 22, 0.3);
      }

      .info-cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 20px;
      }

      .info-card {
        background: white;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        overflow: hidden;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      }

      .info-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      }

      .info-card.full-width {
        grid-column: 1 / -1;
      }

      .info-card-header {
        background: #f8fafc;
        padding: 16px 20px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .info-card-header i {
        color: #6366f1;
        font-size: 1.1rem;
      }

      .info-card-header h5 {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
        color: #374151;
      }

      .info-card-body {
        padding: 20px;
      }

      .info-item {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 16px;
        gap: 16px;
      }

      .info-item:last-child {
        margin-bottom: 0;
      }

      .info-label {
        font-weight: 600;
        color: #6b7280;
        font-size: 0.9rem;
        min-width: 80px;
        flex-shrink: 0;
      }

      .info-value {
        color: #374151;
        font-weight: 500;
        text-align: right;
        flex: 1;
      }

      .info-value.file-type {
        background: #eff6ff;
        color: #2563eb;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 600;
      }

      .info-value.price {
        color: #059669;
        font-weight: 600;
      }

      .category-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        justify-content: flex-end;
      }

      .category-tag {
        background: #f3f4f6;
        color: #374151;
        padding: 4px 10px;
        border-radius: 16px;
        font-size: 0.8rem;
        font-weight: 500;
        border: 1px solid #e5e7eb;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }

      .stat-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: #f9fafb;
        border-radius: 8px;
        border: 1px solid #f3f4f6;
      }

      .stat-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
      }

      .stat-icon.views {
        background: #dbeafe;
        color: #2563eb;
      }

      .stat-icon.downloads {
        background: #dcfce7;
        color: #16a34a;
      }

      .stat-content {
        display: flex;
        flex-direction: column;
      }

      .stat-number {
        font-size: 1.4rem;
        font-weight: 700;
        color: #111827;
        line-height: 1;
      }

      .stat-label {
        font-size: 0.8rem;
        color: #6b7280;
        font-weight: 500;
      }

      .tags-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .tag-badge {
        background: linear-gradient(135deg, #667eea, #4f46e5);
        color: white;
        padding: 6px 12px;
        border-radius: 16px;
        font-size: 0.8rem;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }

      .tag-badge:before {
        content: "#";
        opacity: 0.7;
      }

      .timestamps-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
      }

      .timestamp-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .timestamp-label {
        font-size: 0.85rem;
        color: #6b7280;
        font-weight: 600;
      }

      .timestamp-value {
        font-size: 0.95rem;
        color: #374151;
        font-weight: 500;
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        .document-header-card {
          flex-direction: column;
          text-align: center;
          padding: 24px;
        }

        .info-cards-grid {
          grid-template-columns: 1fr;
        }

        .stats-grid {
          grid-template-columns: 1fr;
        }

        .timestamps-grid {
          grid-template-columns: 1fr;
        }

        .info-item {
          flex-direction: column;
          align-items: flex-start;
          gap: 8px;
        }

        .info-value {
          text-align: left;
        }

        .category-tags {
          justify-content: flex-start;
        }
      }
    </style>
  </head>
  <body class="admin-page">
    <!-- Admin Header -->
    <div th:replace="~{fragments/admin/layout :: header}"></div>
    <!-- Admin Container -->
    <div class="admin-container">
      <!-- Sidebar -->
      <div th:replace="~{fragments/admin/sidebar :: admin-sidebar}"></div>
      <!-- Main Content -->
      <main class="admin-content">
        <div class="admin-content-header">
          <h1 class="admin-page-title">Chi tiết tài liệu</h1>
          <div class="admin-breadcrumbs">
            <a href="/admin/documents">Admin</a>
            <span>/</span>
            <a href="/admin/documents">Tài liệu</a>
            <span>/</span>
            <span>Chi tiết</span>
          </div>
        </div>
        <div th:if="${success}" class="alert alert-success" role="alert">
          <i class="fas fa-check-circle"></i> <span th:text="${success}"></span>
        </div>
        <div th:if="${error}" class="alert alert-danger" role="alert">
          <i class="fas fa-exclamation-circle"></i>
          <span th:text="${error}"></span>
        </div>
        <div class="modal-content large">
          <div class="modal-header">
            <h3 th:text="${document.title} ?: 'Chi tiết tài liệu'"></h3>
            <a th:href="@{/admin/documents}" class="modal-close">
              <i class="fas fa-times"></i>
            </a>
          </div>
          <div class="modal-body">
            <!-- Tab Navigation -->
            <div class="modal-tabs">
              <div class="tab-nav">
                <button type="button" class="tab-btn active" data-tab="general">
                  <i class="fas fa-info-circle"></i><span>Thông tin chung</span>
                </button>
                <button type="button" class="tab-btn" data-tab="versions">
                  <i class="fas fa-history"></i><span>Lịch sử phiên bản</span>
                </button>
                <button type="button" class="tab-btn" data-tab="analytics">
                  <i class="fas fa-chart-bar"></i
                  ><span>Thống kê & Phân tích</span>
                </button>
                <button type="button" class="tab-btn" data-tab="reviews">
                  <i class="fas fa-comments"></i><span>Bình luận</span>
                </button>
              </div>
            </div>
            <!-- Tab Content Panels -->
            <div class="tab-content">
              <!-- Tab 1: General Information -->
              <div class="tab-panel active" id="tab-general">
                <div class="document-overview">
                  <!-- Document Header -->
                  <div class="document-header-card">
                    <div class="document-icon">
                      <i class="fas fa-file-alt"></i>
                    </div>
                    <div class="document-title-section">
                      <h3
                        class="document-title"
                        th:text="${document.title} ?: 'Không có tiêu đề'"
                      ></h3>
                      <p
                        class="document-description"
                        th:text="${document.description != null and !document.description.trim().isEmpty()} ? ${document.description} : 'Không có mô tả'"
                      ></p>
                      <div class="document-status-badge">
                        <span
                          th:class="|status-badge status-${document.status != null ? document.status.toLowerCase() : 'draft'}|"
                          th:text="${document.status == 'DRAFT' ? 'Bản nháp' : 
                                       document.status == 'PENDING' ? 'Chờ duyệt' : 
                                       document.status == 'PUBLISHED' ? 'Đã xuất bản' : 
                                       document.status == 'ARCHIVED' ? 'Đã lưu trữ' : 
                                       document.status == 'REJECTED' ? 'Bị từ chối' : 
                                       document.status == 'SUSPENDED' ? 'Đã tạm ngưng' : 'Bản nháp'}"
                        >
                        </span>
                      </div>
                    </div>
                  </div>

                  <!-- Info Cards Grid -->
                  <div class="info-cards-grid">
                    <!-- Author & Categories Card -->
                    <div class="info-card">
                      <div class="info-card-header">
                        <i class="fas fa-user-edit"></i>
                        <h5>Thông tin tác giả</h5>
                      </div>
                      <div class="info-card-body">
                        <div class="info-item">
                          <span class="info-label">Tác giả:</span>
                          <span
                            class="info-value"
                            th:text="${document.authorName != null ? document.authorName : 'Không xác định'}"
                          ></span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Danh mục:</span>
                          <div class="category-tags">
                            <span
                              th:each="category : ${document.categoryNames}"
                              th:if="${document.categoryNames != null and !document.categoryNames.isEmpty()}"
                              class="category-tag"
                              th:text="${category}"
                            ></span>
                            <span
                              th:if="${document.categoryNames == null or document.categoryNames.isEmpty()}"
                              class="text-muted"
                              >Không có danh mục</span
                            >
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- File Info Card -->
                    <div class="info-card">
                      <div class="info-card-header">
                        <i class="fas fa-file-archive"></i>
                        <h5>Thông tin file</h5>
                      </div>
                      <div class="info-card-body">
                        <div class="info-item">
                          <span class="info-label">Loại file:</span>
                          <span
                            class="info-value file-type"
                            th:text="${document.fileType != null ? document.fileType.toUpperCase() : 'Không xác định'}"
                          ></span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Kích thước:</span>
                          <span
                            class="info-value"
                            th:text="${document.fileSize != null ? (#numbers.formatDecimal(document.fileSize / 1024 / 1024, 1, 2) + ' MB') : '0.00 MB'}"
                          ></span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Giá:</span>
                          <span
                            class="info-value price"
                            th:text="${document.price != null and document.price.compareTo(T(java.math.BigDecimal).ZERO) > 0} ? (${#numbers.formatDecimal(document.price, 0, 0)} + ' coin') : 'Miễn phí'"
                          ></span>
                        </div>
                      </div>
                    </div>

                    <!-- Statistics Card -->
                    <div class="info-card">
                      <div class="info-card-header">
                        <i class="fas fa-chart-line"></i>
                        <h5>Thống kê</h5>
                      </div>
                      <div class="info-card-body">
                        <div class="stats-grid">
                          <div class="stat-item">
                            <div class="stat-icon views">
                              <i class="fas fa-eye"></i>
                            </div>
                            <div class="stat-content">
                              <span
                                class="stat-number"
                                th:text="${document.viewsCount != null ? document.viewsCount : '0'}"
                              ></span>
                              <span class="stat-label">Lượt xem</span>
                            </div>
                          </div>
                          <div class="stat-item">
                            <div class="stat-icon downloads">
                              <i class="fas fa-download"></i>
                            </div>
                            <div class="stat-content">
                              <span
                                class="stat-number"
                                th:text="${document.downloadsCount != null ? document.downloadsCount : '0'}"
                              ></span>
                              <span class="stat-label">Lượt tải</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Tags Card -->
                    <div
                      class="info-card full-width"
                      th:if="${document.tagNames != null and !document.tagNames.isEmpty()}"
                    >
                      <div class="info-card-header">
                        <i class="fas fa-hashtag"></i>
                        <h5>Tags</h5>
                      </div>
                      <div class="info-card-body">
                        <div class="tags-container">
                          <span
                            th:each="tag : ${document.tagNames}"
                            class="tag-badge"
                            th:text="${tag}"
                          ></span>
                        </div>
                      </div>
                    </div>

                    <!-- Timestamps Card -->
                    <div class="info-card full-width">
                      <div class="info-card-header">
                        <i class="fas fa-clock"></i>
                        <h5>Thời gian</h5>
                      </div>
                      <div class="info-card-body">
                        <div class="timestamps-grid">
                          <div class="timestamp-item">
                            <span class="timestamp-label">Ngày tạo:</span>
                            <span
                              class="timestamp-value"
                              th:text="${document.createdAt != null} ? ${#temporals.format(document.createdAt, 'dd/MM/yyyy HH:mm')} : 'Chưa xác định'"
                            ></span>
                          </div>
                          <div class="timestamp-item">
                            <span class="timestamp-label">Ngày cập nhật:</span>
                            <span
                              class="timestamp-value"
                              th:text="${document.updatedAt != null} ? ${#temporals.format(document.updatedAt, 'dd/MM/yyyy HH:mm')} : 'Chưa xác định'"
                            ></span>
                          </div>
                          <div
                            class="timestamp-item"
                            th:if="${document.deletedAt != null}"
                          >
                            <span class="timestamp-label text-danger"
                              >Ngày xóa:</span
                            >
                            <span
                              class="timestamp-value text-danger"
                              th:text="${#temporals.format(document.deletedAt, 'dd/MM/yyyy HH:mm')}"
                            ></span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <!-- Tab 2: Version History -->
              <div class="tab-panel" id="tab-versions">
                <div class="versions-container">
                  <div class="versions-header">
                    <h5>Lịch sử phiên bản</h5>
                    <button type="button" class="btn btn-sm btn-outline">
                      <i class="fas fa-plus"></i><span>Tạo phiên bản mới</span>
                    </button>
                  </div>
                  <div class="versions-timeline" id="versionsTimeline">
                    <!-- Sample version item, replace with actual data -->
                    <!--  <div class="version-item" th:each="version : ${document.versions}">
                                        <div class="version-badge" th:text="${version.versionNumber} ?: 'v1.0'"></div>
                                        <div class="version-content">
                                            <div class="version-header">
                                                <strong th:text="${version.title} ?: 'Phiên bản ban đầu'"></strong>
                                                <span class="version-date" th:text="${version.createdAt != null} ? ${#temporals.format(version.createdAt, 'dd/MM/yyyy HH:mm')} : '23/06/2025, 10:30'"></span>
                                            </div>
                                            <p class="version-note" th:text="${version.note} ?: 'Tài liệu được tạo lần đầu'"></p>
                                            <div class="version-actions">
                                                <button type="button" class="btn btn-sm btn-outline">
                                                    <i class="fas fa-download"></i> Tải xuống
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline">
                                                    <i class="fas fa-eye"></i> Xem
                                                </button>
                                            </div>
                                        </div>
                                    </div>-->
                    <!--   <div class="version-item" th:unless="${document.versions}">
                                        <div class="version-badge">v1.0</div>
                                        <div class="version-content">
                                            <div class="version-header">
                                                <strong>Phiên bản ban đầu</strong>
                                                <span class="version-date">23/06/2025, 10:30</span>
                                            </div>
                                            <p class="version-note">Tài liệu được tạo lần đầu</p>
                                            <div class="version-actions">
                                                <button type="button" class="btn btn-sm btn-outline">
                                                    <i class="fas fa-download"></i> Tải xuống
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline">
                                                    <i class="fas fa-eye"></i> Xem
                                                </button>
                                            </div>
                                        </div>
                                    </div>-->
                  </div>
                </div>
              </div>
              <!-- Tab 3: Analytics & Statistics -->
              <div class="tab-panel" id="tab-analytics">
                <div class="analytics-container">
                  <div class="analytics-header">
                    <h5>Thống kê & Phân tích</h5>
                    <div class="chart-info">
                      <small class="text-muted"
                        >Biểu đồ phân bố tương tác</small
                      >
                    </div>
                  </div>
                  <div class="row mb-4">
                    <div class="col-md-3">
                      <div class="stats-card">
                        <div class="stats-icon"><i class="fas fa-eye"></i></div>
                        <div class="stats-content">
                          <h6>Lượt xem</h6>
                          <div
                            class="stats-number"
                            th:text="${document.viewsCount != null ? document.viewsCount : '0'}"
                          ></div>
                          <div class="stats-change positive">
                            +12% từ tuần trước
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="stats-card">
                        <div class="stats-icon">
                          <i class="fas fa-download"></i>
                        </div>
                        <div class="stats-content">
                          <h6>Lượt tải</h6>
                          <div
                            class="stats-number"
                            th:text="${document.downloadsCount != null ? document.downloadsCount : '0'}"
                          ></div>
                          <div class="stats-change positive">
                            +8% từ tuần trước
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="stats-card">
                        <div class="stats-icon">
                          <i class="fas fa-comments"></i>
                        </div>
                        <div class="stats-content">
                          <h6>Bình luận</h6>
                          <div
                            class="stats-number"
                            th:text="${document.comments != null ? document.comments.size() : '0'}"
                          ></div>
                          <div class="stats-change positive">
                            +5% từ tuần trước
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="stats-card">
                        <div class="stats-icon">
                          <i class="fas fa-file-alt"></i>
                        </div>
                        <div class="stats-content">
                          <h6>Kích thước</h6>
                          <div
                            class="stats-number"
                            th:text="${document.fileSize != null ? (#numbers.formatDecimal(document.fileSize / 1024, 1, 1) + ' MB') : '0.0 MB'}"
                          ></div>
                          <div class="stats-change neutral">Không đổi</div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div
                    class="chart-container"
                    style="height: 400px; position: relative"
                  >
                    <canvas id="analyticsChart"></canvas>
                  </div>
                </div>
              </div>
              <!-- Tab 4: Reviews & Comments -->
              <div class="tab-panel" id="tab-reviews">
                <div class="reviews-container">
                  <div class="reviews-header">
                    <h5>Bình luận</h5>
                    <div class="comment-stats">
                      <span class="stat-item">
                        <i class="fas fa-comments text-primary"></i>
                        <span
                          th:text="${document.comments != null ? document.comments.size() : 0}"
                          >0</span
                        >
                        bình luận
                      </span>
                    </div>
                  </div>

                  <!-- Comments list -->
                  <div class="reviews-list" id="reviewsList">
                    <!-- Comments list -->
                    <div id="commentsContainer">
                      <!-- Comments from server -->
                      <div
                        class="review-item"
                        th:each="comment : ${document.comments}"
                        th:if="${document.comments != null and !document.comments.isEmpty()}"
                      >
                        <div class="review-header">
                          <div class="reviewer-info">
                            <img
                              th:src="${comment.userAvatar != null ? comment.userAvatar : 'https://via.placeholder.com/40'}"
                              class="avatar"
                              alt="avatar"
                            />
                            <div class="reviewer-details">
                              <strong
                                class="reviewer-name"
                                th:text="${comment.userName} ?: 'Không xác định'"
                              ></strong>
                              <div class="metadata">
                                <span
                                  class="timestamp"
                                  th:text="${comment.createdAt != null} ? ${#temporals.format(comment.createdAt, 'dd/MM/yyyy HH:mm')} : 'Không xác định'"
                                ></span>
                                <!-- Show report status if comment has been reported -->
                                <span
                                  th:if="${comment.reportStatus != null}"
                                  class="report-badge"
                                  th:class="|report-${comment.reportStatus}|"
                                  th:text="${comment.reportStatus == 'pending' ? 'Đã báo cáo' : 
                                               comment.reportStatus == 'resolved' ? 'Đã xử lý' : 
                                               comment.reportStatus == 'rejected' ? 'Báo cáo bị từ chối' : ''}"
                                >
                                </span>
                              </div>
                            </div>
                          </div>
                          <div class="review-actions">
                             <!--  <button
                              type="button"
                              class="btn btn-sm btn-outline-primary"
                              th:onclick="|replyToComment(${comment.id})|"
                            >
                              <i class="fas fa-reply"></i> Trả lời
                            </button>-->
                            <a
                              th:href="@{/admin/reportcomment(commentId=${comment.id}, documentId=${document.id}, returnUrl='/admin/documents/' + ${document.id} + '/details')}"
                              class="btn btn-sm btn-outline-danger"
                              th:if="${comment.reportStatus == null}"
                            >
                              <i class="fas fa-flag"></i>
                              <span>Báo cáo vi phạm</span>
                            </a>
                            <span
                              th:if="${comment.reportStatus != null}"
                              class="btn btn-sm btn-outline-secondary disabled"
                            >
                              <i class="fas fa-flag"></i>
                              <span>Đã báo cáo</span>
                            </span>
                          </div>
                        </div>
                        <div class="review-content">
                          <p
                            th:text="${comment.content} ?: '[Nội dung bình luận trống]'"
                          ></p>
                        </div>

                        <!-- Reply form (hidden by default) -->
                        <div
                          class="reply-form"
                          th:id="|replyForm-${comment.id}|"
                          style="display: none"
                        >
                          <div class="mt-3 ms-5">
                            <div class="card">
                              <div class="card-body">
                                <form
                                  th:onsubmit="|submitReply(event, ${comment.id})|"
                                >
                                  <div class="mb-3">
                                    <textarea
                                      class="form-control"
                                      rows="2"
                                      placeholder="Nhập phản hồi..."
                                      required
                                    ></textarea>
                                  </div>
                                  <div class="d-flex justify-content-end gap-2">
                                    <button
                                      type="button"
                                      class="btn btn-sm btn-secondary"
                                      th:onclick="|cancelReply(${comment.id})|"
                                    >
                                      Hủy
                                    </button>
                                    <button
                                      type="submit"
                                      class="btn btn-sm btn-primary"
                                    >
                                      <i class="fas fa-paper-plane"></i> Gửi
                                    </button>
                                  </div>
                                </form>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Empty state when no comments -->
                      <div
                        th:if="${document.comments == null or document.comments.isEmpty()}"
                        class="empty-comments-state"
                        id="emptyCommentsState"
                        style="
                          text-align: center;
                          padding: 40px 20px;
                          color: #6b7280;
                        "
                      >
                        <div
                          style="
                            font-size: 48px;
                            margin-bottom: 16px;
                            color: #d1d5db;
                          "
                        >
                          <i class="fas fa-comments"></i>
                        </div>
                        <h4 style="color: #374151; margin-bottom: 8px">
                          Chưa có bình luận nào
                        </h4>
                        <p style="margin: 0">
                          Tài liệu này chưa có bình luận từ người dùng.
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <a th:href="@{/admin/documents}" class="btn btn-outline">Đóng</a>
            <!-- Chỉ hiển thị nút chỉnh sửa khi tài liệu chưa bị xóa -->
            <a
              th:if="${document.deletedAt == null}"
              th:href="@{/admin/documents/{id}/edit(id=${document.id})}"
              class="btn btn-primary"
            >
              <i class="fas fa-edit"></i><span>Chỉnh sửa</span>
            </a>
          </div>
        </div>
      </main>
    </div>
    <!-- Report Comment Modal -->
    <div
      class="modal fade"
      id="reportCommentModal"
      tabindex="-1"
      aria-labelledby="reportCommentModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="reportCommentModalLabel">
              <i class="fas fa-flag text-danger"></i> Báo cáo vi phạm
            </h5>
            <button
              type="button"
              class="btn-close"
              onclick="hideReportModal()"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="reportCommentForm">
              <div class="mb-3">
                <label for="reportReason" class="form-label"
                  >Lý do báo cáo <span class="text-danger">*</span></label
                >
                <select class="form-select" id="reportReason" required>
                  <option value="">Chọn lý do báo cáo</option>
                  <option value="spam">Spam hoặc quảng cáo</option>
                  <option value="harassment">Quấy rối hoặc bắt nạt</option>
                  <option value="hate_speech">Ngôn từ thù địch</option>
                  <option value="inappropriate">Nội dung không phù hợp</option>
                  <option value="misinformation">Thông tin sai lệch</option>
                  <option value="copyright">Vi phạm bản quyền</option>
                  <option value="other">Khác</option>
                </select>
              </div>
              <div class="mb-3" id="customReasonGroup" style="display: none">
                <label for="customReason" class="form-label"
                  >Mô tả chi tiết</label
                >
                <textarea
                  class="form-control"
                  id="customReason"
                  rows="3"
                  placeholder="Vui lòng mô tả chi tiết lý do báo cáo..."
                ></textarea>
              </div>
              <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>Lưu ý:</strong> Báo cáo của bạn sẽ được xem xét và xử lý
                trong vòng 24-48 giờ. Chúng tôi sẽ thông báo kết quả qua email.
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="hideReportModal()"
            >
              <i class="fas fa-times"></i> Hủy
            </button>
            <button type="button" class="btn btn-danger" id="submitReportBtn">
              <i class="fas fa-flag"></i> Gửi báo cáo
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container" id="toastContainer"></div>
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/js/admin/notifications.js}"></script>
    <script th:src="@{/js/reply.js}"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Tab switching
        const tabButtons = document.querySelectorAll(".tab-btn");
        const tabPanels = document.querySelectorAll(".tab-panel");
        tabButtons.forEach((button) => {
          button.addEventListener("click", function () {
            const target = this.dataset.tab;
            tabButtons.forEach((btn) => btn.classList.remove("active"));
            tabPanels.forEach((panel) => panel.classList.remove("active"));
            this.classList.add("active");
            document.getElementById(`tab-${target}`).classList.add("active");
          });
        });
        // Hover effects for buttons
        const buttons = document.querySelectorAll(
          ".btn.btn-outline, .btn.btn-primary"
        );
        if (buttons.length > 0) {
          buttons.forEach((button) => {
            button.addEventListener("mouseenter", function () {
              this.style.transform = "translateY(-3px)";
              if (this.classList.contains("btn-primary")) {
                this.style.boxShadow = "0 5px 15px rgba(79, 70, 229, 0.3)";
              } else {
                this.style.backgroundColor = "rgba(79, 70, 229, 0.1)";
              }
            });
            button.addEventListener("mouseleave", function () {
              this.style.transform = "";
              this.style.boxShadow = "";
              this.style.backgroundColor = "";
            });
          });
        }
        // Comment Management
        initializeCommentManagement();

        // Initialize modal event listeners
        initializeReportModal();

        // Analytics chart
        const ctx = document.getElementById("analyticsChart");
        if (ctx) {
          // Lấy dữ liệu thực từ Thymeleaf
          const viewsCount = [[${document.viewsCount != null ? document.viewsCount : 0}]];
          const downloadsCount = [[${document.downloadsCount != null ? document.downloadsCount : 0}]];
          const commentsCount = [[${document.comments != null ? document.comments.size() : 0}]];

          // Tính tổng để tạo biểu đồ tỷ lệ
          const total = viewsCount + downloadsCount + commentsCount;

          const chart = new Chart(ctx, {
            type: "doughnut",
            data: {
              labels: ["Lượt xem", "Lượt tải", "Bình luận"],
              datasets: [
                {
                  data:
                    total > 0
                      ? [viewsCount, downloadsCount, commentsCount]
                      : [1, 1, 1],
                  backgroundColor: ["#4f46e5", "#10b981", "#f59e0b"],
                  borderColor: ["#4f46e5", "#10b981", "#f59e0b"],
                  borderWidth: 2,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: "bottom",
                  labels: {
                    padding: 20,
                    usePointStyle: true,
                  },
                },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      const label = context.label || "";
                      const value = context.parsed;
                      const percentage =
                        total > 0 ? ((value / total) * 100).toFixed(1) : "0.0";
                      return label + ": " + value + " (" + percentage + "%)";
                    },
                  },
                },
              },
            },
          });
        }

        // Comment Management Functions
        function initializeCommentManagement() {
          // Global functions for comment actions
          window.replyToComment = function (commentId) {
            const replyForm = document.getElementById(`replyForm-${commentId}`);
            if (replyForm) {
              replyForm.style.display =
                replyForm.style.display === "none" ? "block" : "none";
            }
          };

          window.cancelReply = function (commentId) {
            const replyForm = document.getElementById(`replyForm-${commentId}`);
            if (replyForm) {
              replyForm.style.display = "none";
              replyForm.querySelector("textarea").value = "";
            }
          };

          window.submitReply = function (event, commentId) {
            event.preventDefault();
            const textarea = event.target.querySelector("textarea");
            const content = textarea.value.trim();

            if (!content) {
              showToast("error", "Vui lòng nhập nội dung phản hồi");
              return;
            }

            // Here you would typically send the reply to the server
            showToast("success", "Phản hồi đã được gửi thành công");
            cancelReply(commentId);
          };

          window.reportComment = function (commentId) {
            console.log("reportComment called with ID:", commentId);
            console.log("Bootstrap available:", typeof bootstrap !== 'undefined');

            // Store comment ID for later use
            window.currentReportCommentId = commentId;

            // Try existing modal first
            const existingModal = document.getElementById("reportCommentModal");
            if (existingModal) {
              console.log("Trying existing modal");
              // Reset modal content first
              const reasonSelect = existingModal.querySelector('#reportReason');
              const descriptionTextarea = existingModal.querySelector('#reportDescription');
              if (reasonSelect) reasonSelect.value = '';
              if (descriptionTextarea) descriptionTextarea.value = '';

              // Use Bootstrap modal API
              try {
                const bsModal = new bootstrap.Modal(existingModal, {
                  backdrop: true,
                  keyboard: true,
                  focus: true
                });
                bsModal.show();
                console.log("Bootstrap modal shown successfully");
              } catch (error) {
                console.error("Error showing Bootstrap modal:", error);
                // Simple fallback without custom CSS conflicts
                existingModal.style.display = 'block';
                existingModal.classList.add('show');
                document.body.classList.add('modal-open');
                console.log("Fallback modal shown");
              }
            } else {
              console.log("No existing modal, creating new one");
              createDynamicModal(commentId);
            }
          };

          // Create modal dynamically
          function createDynamicModal(commentId) {
            // Remove any existing dynamic modal
            const existingDynamic = document.getElementById("dynamicReportModal");
            if (existingDynamic) {
              existingDynamic.remove();
            }

            // Create modal HTML
            const modalHTML = `
              <div id="dynamicReportModal" style="
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
              ">
                <div style="
                  background: white;
                  border-radius: 8px;
                  padding: 20px;
                  max-width: 500px;
                  width: 90%;
                  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                ">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h5 style="margin: 0; color: #dc2626;">
                      <i class="fas fa-flag"></i> Báo cáo vi phạm
                    </h5>
                    <button onclick="closeDynamicModal()" style="
                      background: none;
                      border: none;
                      font-size: 20px;
                      cursor: pointer;
                      color: #999;
                    ">&times;</button>
                  </div>

                  <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">
                      Lý do báo cáo <span style="color: #dc2626;">*</span>
                    </label>
                    <select id="dynamicReportReason" style="
                      width: 100%;
                      padding: 8px;
                      border: 1px solid #ddd;
                      border-radius: 4px;
                    ">
                      <option value="">Chọn lý do báo cáo</option>
                      <option value="spam">Spam hoặc quảng cáo</option>
                      <option value="harassment">Quấy rối hoặc bắt nạt</option>
                      <option value="hate_speech">Ngôn từ thù địch</option>
                      <option value="inappropriate">Nội dung không phù hợp</option>
                      <option value="misinformation">Thông tin sai lệch</option>
                      <option value="copyright">Vi phạm bản quyền</option>
                      <option value="other">Khác</option>
                    </select>
                  </div>

                  <div id="dynamicCustomReason" style="display: none; margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">
                      Mô tả chi tiết
                    </label>
                    <textarea id="dynamicCustomText" rows="3" style="
                      width: 100%;
                      padding: 8px;
                      border: 1px solid #ddd;
                      border-radius: 4px;
                      resize: vertical;
                    " placeholder="Vui lòng mô tả chi tiết lý do báo cáo..."></textarea>
                  </div>

                  <div style="
                    background: #eff6ff;
                    border: 1px solid #bfdbfe;
                    color: #1e40af;
                    padding: 10px;
                    border-radius: 4px;
                    margin-bottom: 20px;
                    font-size: 14px;
                  ">
                    <i class="fas fa-info-circle"></i>
                    <strong>Lưu ý:</strong> Báo cáo của bạn sẽ được xem xét và xử lý trong vòng 24-48 giờ.
                  </div>

                  <div style="display: flex; justify-content: flex-end; gap: 10px;">
                    <button onclick="closeDynamicModal()" style="
                      padding: 8px 16px;
                      border: 1px solid #ddd;
                      background: #f8f9fa;
                      border-radius: 4px;
                      cursor: pointer;
                    ">
                      <i class="fas fa-times"></i> Hủy
                    </button>
                    <button onclick="submitDynamicReport(${commentId})" style="
                      padding: 8px 16px;
                      border: 1px solid #dc2626;
                      background: #dc2626;
                      color: white;
                      border-radius: 4px;
                      cursor: pointer;
                    ">
                      <i class="fas fa-flag"></i> Gửi báo cáo
                    </button>
                  </div>
                </div>
              </div>
            `;

            // Add to body
            document.body.insertAdjacentHTML('beforeend', modalHTML);

            // Add event listeners
            const reasonSelect = document.getElementById('dynamicReportReason');
            reasonSelect.addEventListener('change', function() {
              const customDiv = document.getElementById('dynamicCustomReason');
              if (this.value === 'other') {
                customDiv.style.display = 'block';
              } else {
                customDiv.style.display = 'none';
              }
            });

            // Close on backdrop click
            document.getElementById('dynamicReportModal').addEventListener('click', function(e) {
              if (e.target === this) {
                closeDynamicModal();
              }
            });

            console.log("Dynamic modal created and shown");
          }

          // Close dynamic modal
          window.closeDynamicModal = function() {
            const modal = document.getElementById('dynamicReportModal');
            if (modal) {
              modal.remove();
            }
          };

          // Submit dynamic report
          window.submitDynamicReport = function(commentId) {
            const reasonSelect = document.getElementById('dynamicReportReason');
            const customText = document.getElementById('dynamicCustomText');

            if (!reasonSelect.value) {
              alert('Vui lòng chọn lý do báo cáo');
              return;
            }

            if (reasonSelect.value === 'other' && !customText.value.trim()) {
              alert('Vui lòng mô tả chi tiết lý do báo cáo');
              return;
            }

            let reason = reasonSelect.options[reasonSelect.selectedIndex].text;
            if (reasonSelect.value === 'other') {
              reason = customText.value.trim();
            }

            // Submit report
            const formData = new FormData();
            formData.append('reason', reason);

            fetch(`/admin/comments/${commentId}/report`, {
              method: 'POST',
              body: formData
            })
            .then(response => response.json())
            .then(data => {
              if (data.error) {
                alert('Lỗi: ' + data.error);
                return;
              }

              alert('Thành công: ' + data.message);
              closeDynamicModal();
              setTimeout(() => {
                location.reload();
              }, 1000);
            })
            .catch(error => {
              console.error('Error reporting comment:', error);
              alert('Không thể gửi báo cáo');
            });
          };

          // Helper function to submit report
          window.submitReport = function (commentId, reason) {
            const formData = new FormData();
            formData.append("reason", reason);

            fetch(`/admin/comments/${commentId}/report`, {
              method: "POST",
              body: formData,
            })
              .then((response) => response.json())
              .then((data) => {
                if (data.error) {
                  alert("Lỗi: " + data.error);
                  return;
                }

                alert("Thành công: " + data.message);
                location.reload();
              })
              .catch((error) => {
                console.error("Error reporting comment:", error);
                alert("Không thể gửi báo cáo");
              });
          };

          // Helper function to hide modal
          window.hideReportModal = function () {
            const modal = document.getElementById("reportCommentModal");
            if (modal) {
              try {
                // Use Bootstrap modal API
                const bsModal = bootstrap.Modal.getInstance(modal);
                if (bsModal) {
                  bsModal.hide();
                } else {
                  // If no instance, create one and hide
                  const newModal = new bootstrap.Modal(modal);
                  newModal.hide();
                }
                console.log("Bootstrap modal hidden");
              } catch (error) {
                console.error("Error hiding Bootstrap modal:", error);
                // Fallback
                modal.classList.remove("show");
                modal.style.display = "none";
                document.body.classList.remove("modal-open");

                // Remove backdrop
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) {
                  backdrop.remove();
                }
              }

              // Reset form
              const form = document.getElementById("reportCommentForm");
              if (form) {
                form.reset();
              }

              const customGroup = document.getElementById("customReasonGroup");
              if (customGroup) {
                customGroup.style.display = "none";
              }

              console.log("Modal hidden successfully");
            }
          };

          function showToast(type, message) {
            // Simple toast implementation
            const toast = document.createElement("div");
            toast.className = `alert alert-${
              type === "success" ? "success" : "danger"
            } position-fixed`;
            toast.style.cssText =
              "top: 20px; right: 20px; z-index: 9999; min-width: 300px;";
            toast.innerHTML = `
              <i class="fas fa-${
                type === "success" ? "check-circle" : "exclamation-circle"
              }"></i>
              ${message}
              <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
            `;

            document.body.appendChild(toast);

            setTimeout(() => {
              if (toast.parentElement) {
                toast.remove();
              }
            }, 5000);
          }
        }

        // Initialize Report Modal
        function initializeReportModal() {
          // Handle ESC key to close modal
          document.addEventListener("keydown", function (event) {
            if (event.key === "Escape") {
              const modal = document.getElementById("reportCommentModal");
              if (modal && modal.style.display === "flex") {
                hideReportModal();
              }
            }
          });

          // Handle click outside modal to close
          const modal = document.getElementById("reportCommentModal");
          if (modal) {
            modal.addEventListener("click", function (event) {
              if (event.target === modal) {
                hideReportModal();
              }
            });
          }
          // Handle report reason change
          const reportReason = document.getElementById("reportReason");
          if (reportReason) {
            reportReason.addEventListener("change", function () {
              const customReasonGroup =
                document.getElementById("customReasonGroup");
              if (this.value === "other") {
                customReasonGroup.style.display = "block";
                document.getElementById("customReason").required = true;
              } else {
                customReasonGroup.style.display = "none";
                document.getElementById("customReason").required = false;
              }
            });
          }

          // Reset modal when closed (both Bootstrap and manual)
          const reportModal = document.getElementById("reportCommentModal");
          if (reportModal) {
            // Bootstrap event
            reportModal.addEventListener("hidden.bs.modal", resetReportModal);

            // Manual close event
            window.resetReportModal = function () {
              document.getElementById("reportCommentForm").reset();
              document.getElementById("customReasonGroup").style.display =
                "none";
              document.getElementById("customReason").required = false;

              // Reset submit button
              const submitBtn = document.getElementById("submitReportBtn");
              submitBtn.disabled = false;
              submitBtn.innerHTML = '<i class="fas fa-flag"></i> Gửi báo cáo';
            };
          }

          function resetReportModal() {
            document.getElementById("reportCommentForm").reset();
            document.getElementById("customReasonGroup").style.display = "none";
            document.getElementById("customReason").required = false;

            // Reset submit button
            const submitBtn = document.getElementById("submitReportBtn");
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-flag"></i> Gửi báo cáo';
          }

          // Handle submit report
          const submitReportBtn = document.getElementById("submitReportBtn");
          if (submitReportBtn) {
            submitReportBtn.addEventListener("click", function () {
              const reasonSelect = document.getElementById("reportReason");
              const customReason = document.getElementById("customReason");

              if (!reasonSelect.value) {
                alert("Vui lòng chọn lý do báo cáo");
                return;
              }

              if (
                reasonSelect.value === "other" &&
                !customReason.value.trim()
              ) {
                alert("Vui lòng mô tả chi tiết lý do báo cáo");
                return;
              }

              let reason =
                reasonSelect.options[reasonSelect.selectedIndex].text;
              if (reasonSelect.value === "other") {
                reason = customReason.value.trim();
              }

              // Disable button to prevent double submission
              this.disabled = true;
              this.innerHTML =
                '<i class="fas fa-spinner fa-spin"></i> Đang gửi...';

              const formData = new FormData();
              formData.append("reason", reason);

              fetch(`/admin/comments/${window.currentReportCommentId}/report`, {
                method: "POST",
                body: formData,
              })
                .then((response) => response.json())
                .then((data) => {
                  if (data.error) {
                    alert("Lỗi: " + data.error);
                    return;
                  }

                  alert("Thành công: " + data.message);

                  // Close modal
                  hideReportModal();

                  // Reload page to show updated report status
                  setTimeout(() => {
                    location.reload();
                  }, 1500);
                })
                .catch((error) => {
                  console.error("Error reporting comment:", error);
                  alert("Không thể gửi báo cáo");
                })
                .finally(() => {
                  // Re-enable button
                  this.disabled = false;
                  this.innerHTML = '<i class="fas fa-flag"></i> Gửi báo cáo';
                });
            });
          }

          // Global showToast function for modal
          window.showToast = function (type, message) {
            const toast = document.createElement("div");
            toast.className = `alert alert-${
              type === "success" ? "success" : "danger"
            } position-fixed`;
            toast.style.cssText =
              "top: 20px; right: 20px; z-index: 9999; min-width: 300px;";
            toast.innerHTML = `
              <i class="fas fa-${
                type === "success" ? "check-circle" : "exclamation-circle"
              }"></i>
              ${message}
              <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
            `;

            document.body.appendChild(toast);

            setTimeout(() => {
              if (toast.parentElement) {
                toast.remove();
              }
            }, 5000);
          };
        }
      });
    </script>
  </body>
</html>
