<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="csrf-token" th:content="${_csrf.token}" />
    <title>Xử lý báo cáo vi phạm - EduShare Admin</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700&family=Open+Sans:wght@400;500;600&family=Playfair+Display:wght@700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" th:href="@{/css/main.css}" />
    <link rel="stylesheet" th:href="@{/css/admin/admin.css}" />
    <link rel="stylesheet" th:href="@{/css/admin/reports.css}" />
    <link rel="stylesheet" th:href="@{/css/admin/toast.css}" />
    <style>
      .form-container {
        max-width: 900px;
        margin: 1rem auto;
        padding: 0 1rem;
        width: 100%;
      }
      .modal-container {
        background: var(--card-bg, #fff);
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        overflow: visible;
        width: 100%;
        min-height: auto;
        display: flex;
        flex-direction: column;
      }
      .modal-header {
        padding: 1.5rem 2rem;
        border-bottom: 1px solid var(--border-color, #eee);
        background: var(--card-bg, #fff);
        border-radius: 8px 8px 0 0;
      }
      .modal-header h3 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
      }
      .modal-body {
        padding: 2rem;
        max-height: none;
        overflow: visible;
        flex: 1;
        background: var(--card-bg, #fff);
      }
      .form-grid {
        display: block;
      }
      .form-fields-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        align-items: start;
        margin-bottom: 1.5rem;
      }
      .form-group.full-width {
        grid-column: 1 / -1;
      }
      .form-group {
        display: flex;
        flex-direction: column;
      }
      .form-group label {
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--text-primary);
      }
      .form-group input,
      .form-group select,
      .form-group textarea {
        padding: 0.75rem;
        border: 1px solid var(--border-color, #ddd);
        border-radius: 4px;
        font-size: 0.9rem;
      }
      .form-group textarea {
        resize: vertical;
        min-height: 100px;
      }
      .modal-footer {
        padding: 1.5rem 2rem !important;
        border-top: 1px solid var(--border-color, #eee) !important;
        background: var(--card-bg, #fff) !important;
        display: flex !important;
        gap: 1rem;
        justify-content: flex-end;
        border-radius: 0 0 8px 8px;
        margin-top: auto;
      }
      .modal-footer .cancel-btn,
      .modal-footer .view-btn,
      .modal-footer .save-btn {
        padding: 0.75rem 1.5rem;
        border-radius: 4px;
        text-decoration: none;
        font-weight: 500;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
      }
      .modal-footer .cancel-btn {
        background: #6c757d;
        color: white;
      }
      .modal-footer .view-btn {
        background: #17a2b8;
        color: white;
      }
      .modal-footer .save-btn {
        background: #28a745;
        color: white;
      }
      .modal-footer .save-btn:hover {
        background: #218838;
      }
      .modal-footer .cancel-btn:hover {
        background: #5a6268;
      }
      .modal-footer .view-btn:hover {
        background: #138496;
      }
      .readonly-field {
        background-color: #f8f9fa !important;
        cursor: not-allowed;
      }
      .error {
        color: #dc3545;
        font-size: 0.875rem;
        margin-top: 0.25rem;
        display: block;
      }
      .required {
        color: #dc3545;
      }
      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
      }
      .form-group input.is-invalid,
      .form-group select.is-invalid,
      .form-group textarea.is-invalid {
        border-color: #dc3545;
      }
      /* Popup notification styles */
      .notification-popup {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      
      .notification-popup.show {
        opacity: 1;
      }
      
      .popup-content {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        max-width: 400px;
        width: 90%;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        position: relative;
        transform: scale(0.8);
        transition: transform 0.3s ease;
      }
      
      .notification-popup.show .popup-content {
        transform: scale(1);
      }
      
      .popup-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
      }
      
      .popup-icon.success {
        color: #28a745;
      }
      
      .popup-icon.error {
        color: #dc3545;
      }
      
      .popup-icon.warning {
        color: #ffc107;
      }
      
      .popup-message {
        font-size: 1.1rem;
        font-weight: 500;
        color: #333;
        margin-bottom: 1.5rem;
        line-height: 1.5;
      }
      
      /* Confirmation popup styles */
      .confirmation-content {
        max-width: 450px;
      }
      
      .popup-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 0.5rem;
      }
      
      .popup-buttons {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 1.5rem;
      }
      
      .btn-cancel,
      .btn-confirm {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        min-width: 100px;
      }
      
      .btn-cancel {
        background: #6c757d;
        color: white;
      }
      
      .btn-cancel:hover {
        background: #5a6268;
      }
      
      .btn-confirm {
        background: #007bff;
        color: white;
      }
      
      .btn-confirm:hover {
        background: #0056b3;
      }
      
      .popup-close {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        font-size: 1.2rem;
        color: #999;
        cursor: pointer;
        padding: 5px;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }
      
      .popup-close:hover {
        background: #f0f0f0;
        color: #666;
      }

      @media (max-width: 768px) {
        .form-container {
          margin: 0.5rem;
          padding: 0;
        }
        .form-grid {
          grid-template-columns: 1fr;
          gap: 1rem;
        }
        .modal-body {
          padding: 1.5rem;
        }
        .modal-footer {
          padding: 1rem 1.5rem;
          flex-direction: column-reverse;
        }
        .popup-content {
          padding: 1.5rem;
          max-width: 350px;
        }
        .popup-icon {
          font-size: 2.5rem;
        }
        .popup-message {
          font-size: 1rem;
        }
      }
    </style>
  </head>
  <body class="admin-body">
    <header class="admin-header">
      <div class="admin-header-content">
        <div class="admin-logo">
          <a th:href="@{/admin/index}" class="logo">
            <div class="logo-icon">E</div>
            <div class="logo-text">EduShare</div>
          </a>
        </div>
        <div class="admin-header-actions">
          <div class="admin-search">
            <input
              type="text"
              placeholder="Tìm kiếm..."
              class="search-input"
              id="headerSearchInput"
            />
            <button id="headerSearchBtn"><i class="fas fa-search"></i></button>
          </div>
          <div class="dark-mode-toggle" id="darkModeToggle"></div>
          <div class="admin-notifications">
            <button class="notification-btn">
              <i class="fas fa-bell"></i>
              <span class="notification-badge">5</span>
            </button>
          </div>
          <div class="admin-profile">
            <div class="admin-avatar">
              <img
                src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?ixlib=rb-1.2.1&auto=format&fit=facearea&facepad=2&w=256&h=256&q=80"
                alt="Admin"
              />
            </div>
            <div class="admin-info">
              <span class="admin-name">Nguyễn Văn Anh</span>
              <span class="admin-role">Quản trị viên</span>
            </div>
            <div class="admin-dropdown">
              <i class="fas fa-chevron-down"></i>
            </div>
          </div>
        </div>
      </div>
    </header>

    <div class="admin-container">
      <aside class="admin-sidebar">
        <nav class="admin-nav">
          <ul class="admin-menu">
            <li class="admin-menu-item">
              <a th:href="@{/admin/index}"
                ><i class="fas fa-tachometer-alt"></i
                ><span>Bảng điều khiển</span></a
              >
            </li>
            <li class="admin-menu-item">
              <a th:href="@{/admin/users}"
                ><i class="fas fa-users"></i><span>Quản lý người dùng</span></a
              >
            </li>
            <li class="admin-menu-item">
              <a th:href="@{/admin/documents}"
                ><i class="fas fa-file-alt"></i><span>Quản lý tài liệu</span></a
              >
            </li>
            <li class="admin-menu-item">
              <a th:href="@{/admin/categories}"
                ><i class="fas fa-folder"></i><span>Quản lý danh mục</span></a
              >
            </li>
            <li class="admin-menu-item">
              <a th:href="@{/admin/tags}"
                ><i class="fas fa-tags"></i><span>Quản lý tags</span></a
              >
            </li>
            <li class="admin-menu-item">
              <a th:href="@{/admin/comments}"
                ><i class="fas fa-comments"></i
                ><span>Quản lý bình luận</span></a
              >
            </li>
            <li class="admin-menu-item active">
              <a th:href="@{/admin/reports}"
                ><i class="fas fa-flag"></i><span>Báo cáo vi phạm</span></a
              >
            </li>
            <li class="admin-menu-item">
              <a th:href="@{/admin/ip-bans}"
                ><i class="fas fa-ban"></i><span>IP bị cấm</span></a
              >
            </li>
            <li class="admin-menu-item">
              <a th:href="@{/admin/statistics}"
                ><i class="fas fa-chart-bar"></i><span>Thống kê</span></a
              >
            </li>
            <li class="admin-menu-item has-submenu">
              <a href="javascript:void(0)">
                <i class="fas fa-coins"></i>
                <span>Quản lý doanh thu</span>
                <i class="fas fa-chevron-down submenu-icon"></i>
              </a>
              <ul class="submenu">
                <li class="submenu-item">
                  <a th:href="@{/admin/coin-packages}"
                    ><i class="fas fa-box"></i><span>Gói xu</span></a
                  >
                </li>
                <li class="submenu-item">
                  <a th:href="@{/admin/transactions}"
                    ><i class="fas fa-exchange-alt"></i
                    ><span>Giao dịch</span></a
                  >
                </li>
                <li class="submenu-item">
                  <a th:href="@{/admin/withdrawals}"
                    ><i class="fas fa-money-bill-wave"></i
                    ><span>Yêu cầu rút tiền</span></a
                  >
                </li>
              </ul>
            </li>
            <li class="admin-menu-item">
              <a th:href="@{/admin/settings}"
                ><i class="fas fa-cog"></i><span>Cài đặt</span></a
              >
            </li>
            <li class="admin-menu-item">
              <a th:href="@{/logout}"
                ><i class="fas fa-sign-out-alt"></i><span>Đăng xuất</span></a
              >
            </li>
          </ul>
        </nav>
      </aside>

      <main class="admin-content">
        <div class="admin-content-header">
          <h1 class="admin-page-title">Xử lý báo cáo vi phạm</h1>
          <p class="admin-page-description">
            Cập nhật trạng thái xử lý báo cáo vi phạm
          </p>
          <div class="admin-breadcrumbs">
            <a th:href="@{/admin/index}">Admin</a>
            <span>/</span>
            <a th:href="@{/admin/reports}">Báo cáo vi phạm</a>
            <span>/</span>
            <span>Xử lý</span>
          </div>
        </div>

        <div class="form-container">
          <div class="modal-container">
            <div class="modal-header">
              <h3 id="modalTitle">Xử lý báo cáo vi phạm</h3>
            </div>
            <div class="modal-body">
              <!-- Popup thông báo ẩn -->
              <div id="notificationPopup" class="notification-popup" style="display: none;">
                <div class="popup-content">
                  <div class="popup-icon">
                    <i id="popupIcon" class="fas"></i>
                  </div>
                  <div class="popup-message" id="popupMessage"></div>
                  <button class="popup-close" onclick="closeNotificationPopup()">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>

              <!-- Confirmation popup -->
              <div id="confirmationPopup" class="notification-popup" style="display: none;">
                <div class="popup-content confirmation-content">
                  <div class="popup-icon warning">
                    <i class="fas fa-question-circle"></i>
                  </div>
                  <div class="popup-title">Xác nhận thay đổi</div>
                  <div class="popup-message" id="confirmMessage"></div>
                  <div class="popup-buttons">
                    <button class="btn-cancel" onclick="closeConfirmationPopup()">Hủy bỏ</button>
                    <button class="btn-confirm" id="confirmBtn">Xác nhận</button>
                  </div>
                </div>
              </div>

              <form
                class="form-grid"
                id="reportForm"
                th:action="@{/admin/reports/edit/{id}(id=${report.id})}"
                th:object="${report}"
                method="post"
              >

                <div class="form-fields-grid">
                  <!-- Thông tin báo cáo (chỉ đọc) -->
                  <div class="form-group full-width">
                    <label>Tài liệu bị báo cáo</label>
                    <input
                      type="text"
                      readonly
                      class="readonly-field"
                      th:value="${report.document?.title ?: 'Không xác định'}"
                    />
                  </div>

                  <div class="form-group">
                    <label>Loại vi phạm</label>
                    <input
                      type="text"
                      readonly
                      class="readonly-field"
                      th:value="${report.type != null ? (
                                 report.type == 'copyright' ? 'Vi phạm bản quyền' : 
                                 report.type == 'inappropriate' ? 'Nội dung không phù hợp' :
                                 report.type == 'spam' ? 'Spam/Quảng cáo' :
                                 report.type == 'fake' ? 'Tài liệu giả mạo' :
                                 report.type == 'other' ? 'Vi phạm khác' : 'Không xác định'
                                 ) : 'Không xác định'}"
                    />
                  </div>

                  <div class="form-group">
                    <label>Người báo cáo</label>
                    <input
                      type="text"
                      readonly
                      class="readonly-field"
                      th:value="${report.reporter?.fullName ?: 'Không xác định'}"
                    />
                  </div>

                  <div class="form-group full-width">
                    <label>Lý do báo cáo</label>
                    <textarea
                      rows="4"
                      readonly
                      class="readonly-field"
                      th:text="${report.reason}"
                    ></textarea>
                  </div>

                  <div class="form-group">
                    <label>Ngày tạo báo cáo</label>
                    <input
                      type="text"
                      readonly
                      class="readonly-field"
                      th:value="${report.createdAt != null ? #temporals.format(report.createdAt, 'dd/MM/yyyy HH:mm') : 'Không có'}"
                    />
                  </div>

                  <!-- Phần có thể chỉnh sửa - chỉ trạng thái -->
                  <div class="form-group">
                    <label for="status">Trạng thái xử lý <span class="required">*</span></label>
                    <select id="status" name="status" required>
                      <option value="new" th:selected="${report.status == 'new'}">Mới</option>
                      <option value="pending" th:selected="${report.status == 'pending'}">Đang chờ xử lý</option>
                      <option value="resolved" th:selected="${report.status == 'resolved'}">Đã giải quyết</option>
                      <option value="rejected" th:selected="${report.status == 'rejected'}">Đã từ chối</option>
                    </select>
                    <div class="error" id="statusError"></div>
                  </div>

                  <div class="form-group">
                    <label>Trạng thái hiện tại</label>
                    <input
                      type="text"
                      readonly
                      class="readonly-field"
                      th:value="${report.status == 'new' ? 'Mới' : 
                                 report.status == 'pending' ? 'Đang chờ xử lý' :
                                 report.status == 'resolved' ? 'Đã giải quyết' :
                                 report.status == 'rejected' ? 'Đã từ chối' : 'Không xác định'}"
                    />
                  </div>
                </div>

                <input
                  type="hidden"
                  id="reportId"
                  name="id"
                  th:value="${report.id}"
                />
              </form>
            </div>
            <div class="modal-footer">
              <a th:href="@{/admin/reports}" class="cancel-btn">Hủy bỏ</a>
              <a
                th:href="@{/admin/reports/details/{id}(id=${report.id})}"
                class="view-btn"
                >Xem chi tiết</a
              >
              <button class="save-btn" type="submit" form="reportForm">
                Xử lý báo cáo
              </button>
            </div>
          </div>
        </div>

        <div class="toast-container" id="toastContainer"></div>
      </main>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script th:src="@{/js/main.js}"></script>
    <script th:src="@{/js/admin/admin.js}"></script>
    <script th:src="@{/js/admin/reports.js}"></script>
    <script>
      // Hiển thị popup thông báo
      function showNotificationPopup(message, type = 'success') {
        const popup = document.getElementById('notificationPopup');
        const icon = document.getElementById('popupIcon');
        const messageEl = document.getElementById('popupMessage');
        const iconContainer = icon.parentElement;
        
        // Set message
        messageEl.textContent = message;
        
        // Set icon and color
        if (type === 'success') {
          icon.className = 'fas fa-check-circle';
          iconContainer.className = 'popup-icon success';
        } else {
          icon.className = 'fas fa-exclamation-circle';
          iconContainer.className = 'popup-icon error';
        }
        
        // Show popup
        popup.style.display = 'flex';
        setTimeout(() => {
          popup.classList.add('show');
        }, 10);
        
        // Auto close after 4 seconds
        setTimeout(() => {
          closeNotificationPopup();
        }, 4000);
      }
      
      // Đóng popup thông báo
      function closeNotificationPopup() {
        const popup = document.getElementById('notificationPopup');
        popup.classList.remove('show');
        setTimeout(() => {
          popup.style.display = 'none';
        }, 300);
      }
      
      // Hiển thị confirmation popup
      function showConfirmationPopup(message, onConfirm) {
        const popup = document.getElementById('confirmationPopup');
        const messageEl = document.getElementById('confirmMessage');
        const confirmBtn = document.getElementById('confirmBtn');
        
        // Set message
        messageEl.textContent = message;
        
        // Set confirm callback
        confirmBtn.onclick = function() {
          closeConfirmationPopup();
          onConfirm();
        };
        
        // Show popup
        popup.style.display = 'flex';
        setTimeout(() => {
          popup.classList.add('show');
        }, 10);
      }
      
      // Đóng confirmation popup
      function closeConfirmationPopup() {
        const popup = document.getElementById('confirmationPopup');
        popup.classList.remove('show');
        setTimeout(() => {
          popup.style.display = 'none';
        }, 300);
      }
      
      // Đóng popup khi click outside
      document.getElementById('notificationPopup').addEventListener('click', function(e) {
        if (e.target === this) {
          closeNotificationPopup();
        }
      });
      
      document.getElementById('confirmationPopup').addEventListener('click', function(e) {
        if (e.target === this) {
          closeConfirmationPopup();
        }
      });

      // Cập nhật trạng thái hiện tại trong form
      function updateCurrentStatusDisplay(status) {
        const statusTexts = {
          'new': 'Mới',
          'pending': 'Đang chờ xử lý',
          'resolved': 'Đã giải quyết',
          'rejected': 'Đã từ chối'
        };
        
        // Tìm input trạng thái hiện tại (input readonly cuối cùng)
        const statusInputs = document.querySelectorAll('input[readonly].readonly-field');
        const currentStatusField = statusInputs[statusInputs.length - 1];
        if (currentStatusField) {
          currentStatusField.value = statusTexts[status] || 'Không xác định';
        }
      }

      // Xử lý submit form với confirmation popup đẹp
      document.getElementById('reportForm').addEventListener('submit', function(e) {
        e.preventDefault(); // Ngăn submit form thông thường
        
        const status = document.getElementById('status').value;
        const statusText = document.getElementById('status').options[document.getElementById('status').selectedIndex].text;
        const reportId = document.getElementById('reportId').value;
        
        // Hiển thị confirmation popup thay vì confirm() mặc định
        showConfirmationPopup(
          `Bạn có chắc chắn muốn thay đổi trạng thái báo cáo thành "${statusText}"?`,
          function() {
            // Callback khi user xác nhận
            processStatusUpdate(reportId, status);
          }
        );
      });

      // Xử lý cập nhật trạng thái
      function processStatusUpdate(reportId, status) {
        // Disable button để tránh double click
        const submitBtn = document.querySelector('.save-btn');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Đang xử lý...';

        // Gửi AJAX request
        $.ajax({
          url: '/admin/reports/edit/' + reportId,
          type: 'POST',
          data: {
            status: status,
            _token: $('meta[name="csrf-token"]').attr('content')
          },
          headers: {
            'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content'),
            'X-Requested-With': 'XMLHttpRequest'
          },
          success: function(response) {
            // Hiển thị popup thành công
            showNotificationPopup('Trạng thái báo cáo đã được cập nhật thành công!', 'success');
            
            // Cập nhật hiển thị trạng thái hiện tại
            updateCurrentStatusDisplay(status);
          },
          error: function(xhr) {
            // Hiển thị popup lỗi
            let errorMessage = 'Có lỗi xảy ra khi cập nhật trạng thái!';
            if (xhr.responseText) {
              errorMessage = xhr.responseText;
            }
            showNotificationPopup(errorMessage, 'error');
          },
          complete: function() {
            // Enable lại button
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
          }
        });
      }
    </script>
  </body>
</html>
