<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chi tiết giao dịch - EduShare Admin</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700&family=Open+Sans:wght@400;500;600&family=Playfair+Display:wght@700&display=swap"
      rel="stylesheet"
    />
       <link rel="stylesheet" th:href="@{/css/main.css}" />
    <link rel="stylesheet" th:href="@{/css/admin/admin.css}" />
    <link rel="stylesheet" th:href="@{/css/admin/toast.css}" />
    <link rel="stylesheet" th:href="@{/css/admin/transactions.css}" />
    <link rel="stylesheet" th:href="@{/css/admin/transactions-detail.css}" />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  </head>

  <body class="admin-body">
    <!-- Admin Header -->
    <header class="admin-header">
      <div class="admin-header-content">
        <div class="admin-logo">
          <a href="../index.html" class="logo">
            <div class="logo-icon">E</div>
            <div class="logo-text">EduShare</div>
          </a>
        </div>

        <div class="admin-header-actions">
          <div class="admin-search">
            <input type="text" placeholder="Tìm kiếm..." />
            <button><i class="fas fa-search"></i></button>
          </div>

          <div class="dark-mode-toggle" id="darkModeToggle"></div>

          <div class="admin-notifications">
            <button class="notification-btn">
              <i class="fas fa-bell"></i>
              <span class="notification-badge">5</span>
            </button>
          </div>

          <div class="admin-profile">
            <div class="admin-avatar">
              <img
                src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?ixlib=rb-1.2.1&auto=format&fit=facearea&facepad=2&w=256&h=256&q=80"
                alt="Admin"
              />
            </div>
            <div class="admin-info">
              <span class="admin-name">Nguyễn Văn A</span>
              <span class="admin-role">Quản trị viên</span>
            </div>
            <div class="admin-dropdown">
              <i class="fas fa-chevron-down"></i>
            </div>
          </div>
        </div>
      </div>
    </header>

    <div class="admin-container">
      <!-- Sidebar -->
      <aside class="admin-sidebar">
        <nav class="admin-nav">
          <ul class="admin-menu">
            <li class="admin-menu-item">
              <a href="../index.html">
                <i class="fas fa-tachometer-alt"></i>
                <span>Bảng điều khiển</span>
              </a>
            </li>
            <li class="admin-menu-item">
              <a href="../users.html">
                <i class="fas fa-users"></i>
                <span>Quản lý người dùng</span>
              </a>
            </li>
            <li class="admin-menu-item">
              <a href="../documents.html">
                <i class="fas fa-file-alt"></i>
                <span>Quản lý tài liệu</span>
              </a>
            </li>
            <li class="admin-menu-item">
              <a href="../categories.html">
                <i class="fas fa-folder"></i>
                <span>Quản lý danh mục</span>
              </a>
            </li>
            <li class="admin-menu-item">
              <a href="../tags.html">
                <i class="fas fa-tags"></i>
                <span>Quản lý tags</span>
              </a>
            </li>
            <li class="admin-menu-item">
              <a href="../comments.html">
                <i class="fas fa-comments"></i>
                <span>Quản lý bình luận</span>
              </a>
            </li>
            <li class="admin-menu-item">
              <a href="../reports.html">
                <i class="fas fa-flag"></i>
                <span>Báo cáo vi phạm</span>
              </a>
            </li>
            <li class="admin-menu-item">
              <a href="../ip-bans.html">
                <i class="fas fa-ban"></i>
                <span>IP bị cấm</span>
              </a>
            </li>
            <li class="admin-menu-item">
              <a href="../statistics.html">
                <i class="fas fa-chart-bar"></i>
                <span>Thống kê</span>
              </a>
            </li>
            <!-- Revenue Management Dropdown -->
            <li class="admin-menu-item has-submenu open">
              <a href="javascript:void(0)">
                <i class="fas fa-coins"></i>
                <span>Quản lý doanh thu</span>
                <i class="fas fa-chevron-down submenu-icon"></i>
              </a>
              <ul class="submenu visible">
                <li class="submenu-item">
                  <a href="../coin-packages.html">
                    <i class="fas fa-box"></i>
                    <span>Gói xu</span>
                  </a>
                </li>
                <li class="submenu-item active">
                  <a href="index.html">
                    <i class="fas fa-exchange-alt"></i>
                    <span>Giao dịch</span>
                  </a>
                </li>
                <li class="submenu-item">
                  <a href="../withdrawals.html">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>Yêu cầu rút tiền</span>
                  </a>
                </li>
              </ul>
            </li>
            <li class="admin-menu-item">
              <a href="../settings.html">
                <i class="fas fa-cog"></i>
                <span>Cài đặt</span>
              </a>
            </li>
            <li class="admin-menu-item">
              <a href="../../index.html">
                <i class="fas fa-sign-out-alt"></i>
                <span>Đăng xuất</span>
              </a>
            </li>
          </ul>
        </nav>
      </aside>

      <!-- Nội dung chính - Chi tiết giao dịch -->
      <main class="admin-content">
        <div class="admin-content-header">
          <h1 class="admin-page-title">Chi tiết giao dịch</h1>
          <div class="admin-breadcrumbs">
            <a href="../index.html">Admin</a>
            <span>/</span>
            <a th:href="@{/admin/transactions}">Quản lý doanh thu</a>
            <span>/</span>
            <a th:href="@{/admin/transactions}">Giao dịch</a>
            <span>/</span>
            <span>Chi tiết</span>
          </div>
        </div>

        <!-- Transaction Detail Content -->
        <div class="transaction-detail" th:if="${transaction != null}">
          <!-- Thanh trạng thái và loại giao dịch -->
          <div class="transaction-type-banner">
            <div class="transaction-type">
              <div class="transaction-icon">
                <i class="fas fa-shopping-cart"></i>
              </div>
              <div>
                <h4
                  class="transaction-type-title"
                  th:text="${transaction.type.displayName}"
                >
                  Mua gói Coin
                </h4>
                <p class="transaction-time">
                  <i class="far fa-clock"></i>
                  <span
                    th:text="${#temporals.format(transaction.createdAt, 'dd/MM/yyyy HH:mm:ss')}"
                    >03/06/2025 14:30:45</span
                  >
                </p>
              </div>
            </div>
            <div class="transaction-status">
              <span
                class="status-badge"
                th:classappend="${transaction.status.value}"
                th:text="${transaction.status.displayName}"
                >Đã hoàn thành</span
              >
            </div>
          </div>

          <!-- Tiến trình trạng thái -->
          <div class="transaction-status-timeline">
            <div class="timeline-header">
              <h4>Tiến trình giao dịch</h4>
            </div>
            <div class="timeline">
              <div class="timeline-step completed">
                <div class="timeline-step-icon">
                  <i class="fas fa-file-invoice"></i>
                </div>
                <div
                  class="timeline-date"
                  th:text="${#temporals.format(transaction.createdAt, 'dd/MM/yyyy HH:mm')}"
                >
                  03/06/2025 14:30:00
                </div>
                <div class="timeline-title">Tạo giao dịch</div>
                <div class="timeline-desc">Giao dịch đã được khởi tạo</div>
              </div>
              <div
                class="timeline-step"
                th:classappend="${transaction.status != 'PENDING' ? 'completed' : ''}"
              >
                <div class="timeline-step-icon">
                  <i class="fas fa-credit-card"></i>
                </div>
                <div
                  class="timeline-date"
                  th:text="${transaction.paymentMethod != null ? #temporals.format(transaction.createdAt.plusMinutes(25), 'dd/MM/yyyy HH:mm') : ''}"
                >
                  03/06/2025 14:30:25
                </div>
                <div class="timeline-title">Thanh toán</div>
                <div
                  class="timeline-desc"
                  th:text="${transaction.status == 'COMPLETED' ? 'Thanh toán thành công' : 'Đang xử lý thanh toán'}"
                >
                  Thanh toán thành công
                </div>
              </div>
              <div
                class="timeline-step"
                th:classappend="${transaction.status == 'COMPLETED' ? 'completed' : ''}"
              >
                <div class="timeline-step-icon">
                  <i class="fas fa-coins"></i>
                </div>
                <div
                  class="timeline-date"
                  th:text="${transaction.status == 'COMPLETED' ? #temporals.format(transaction.updatedAt != null ? transaction.updatedAt : transaction.createdAt.plusMinutes(35), 'dd/MM/yyyy HH:mm') : ''}"
                >
                  03/06/2025 14:30:35
                </div>
                <div class="timeline-title">Phân bổ Coins</div>
                <div
                  class="timeline-desc"
                  th:text="${transaction.status == 'COMPLETED' ? 'Coins đã được cộng vào tài khoản' : 'Chờ xử lý'}"
                >
                  Coins đã được cộng vào tài khoản
                </div>
              </div>
              <div
                class="timeline-step"
                th:classappend="${transaction.status == 'COMPLETED' ? 'completed' : ''}"
              >
                <div class="timeline-step-icon">
                  <i class="fas fa-check-circle"></i>
                </div>
                <div
                  class="timeline-date"
                  th:text="${transaction.status == 'COMPLETED' ? #temporals.format(transaction.updatedAt != null ? transaction.updatedAt : transaction.createdAt.plusMinutes(45), 'dd/MM/yyyy HH:mm') : ''}"
                >
                  03/06/2025 14:30:45
                </div>
                <div class="timeline-title">Hoàn thành</div>
                <div
                  class="timeline-desc"
                  th:text="${transaction.status == 'COMPLETED' ? 'Giao dịch hoàn tất' : 'Chờ hoàn thành'}"
                >
                  Giao dịch hoàn tất
                </div>
              </div>
            </div>
          </div>

          <!-- Bảng thông tin chi tiết -->
          <div class="transaction-info-grid">
            <!-- Thông tin cơ bản -->
            <div class="transaction-info-card">
              <h4><i class="fas fa-info-circle"></i> Thông tin cơ bản</h4>
              <div class="card-content">
                <div class="info-row">
                  <div class="info-label">Mã giao dịch:</div>
                  <div class="info-value" th:text="${transaction.code}">
                    TRX-2025060301
                  </div>
                </div>
                <div class="info-row">
                  <div class="info-label">Loại giao dịch:</div>
                  <div
                    class="info-value"
                    th:text="${transaction.type.displayName}"
                  >
                    Mua gói Coin
                  </div>
                </div>
                <div class="info-row">
                  <div class="info-label">Số tiền:</div>
                  <div
                    class="info-value"
                    th:text="${#numbers.formatDecimal(transaction.amount, 0, 'COMMA', 0, 'POINT')} + ' ₫'"
                  >
                    1.000.000 VNĐ
                  </div>
                </div>
                <div class="info-row">
                  <div class="info-label">Phương thức thanh toán:</div>
                  <div
                    class="info-value"
                    th:text="${transaction.paymentMethod != null ? transaction.paymentMethod : 'Chưa xác định'}"
                  >
                    VNPay
                  </div>
                </div>
                <div class="info-divider"></div>
                <div class="info-row">
                  <div class="info-label">Ngày tạo:</div>
                  <div
                    class="info-value"
                    th:text="${#temporals.format(transaction.createdAt, 'dd/MM/yyyy HH:mm:ss')}"
                  >
                    03/06/2025 14:30:00
                  </div>
                </div>
                <div class="info-row" th:if="${transaction.updatedAt != null}">
                  <div class="info-label">Cập nhật lần cuối:</div>
                  <div
                    class="info-value"
                    th:text="${#temporals.format(transaction.updatedAt, 'dd/MM/yyyy HH:mm:ss')}"
                  >
                    03/06/2025 14:30:45
                  </div>
                </div>
                <div class="info-row">
                  <div class="info-label">Trạng thái:</div>
                  <div class="info-value">
                    <span
                      class="status-badge"
                      th:classappend="${transaction.status.value}"
                      th:text="${transaction.status.displayName}"
                      >Đã hoàn thành</span
                    >
                  </div>
                </div>
              </div>
            </div>

            <!-- Thông tin người dùng -->
            <div class="transaction-info-card">
              <h4><i class="fas fa-user-circle"></i> Thông tin người dùng</h4>
              <div class="card-content">
                <div class="user-profile-info">
                  <div class="user-avatar-container">
                    <img
                      th:src="${transaction.user.avatar != null ? transaction.user.avatar : 'https://randomuser.me/api/portraits/men/32.jpg'}"
                      alt="Avatar"
                      class="large-avatar"
                    />
                    <a
                      th:href="@{/admin/users/{id}/detail(id=${transaction.user.id})}"
                      class="view-profile-btn"
                    >
                      <i class="fas fa-external-link-alt"></i> Xem hồ sơ
                    </a>
                  </div>
                  <div class="user-details">
                    <div class="info-row">
                      <div class="info-label">Họ tên:</div>
                      <div
                        class="info-value"
                        th:text="${transaction.user.fullName}"
                      >
                        Nguyễn Văn A
                      </div>
                    </div>
                    <div class="info-row">
                      <div class="info-label">Email:</div>
                      <div
                        class="info-value"
                        th:text="${transaction.user.email}"
                      >
                        nguyenvana@example.com
                      </div>
                    </div>
                    <div
                      class="info-row"
                      th:if="${transaction.user.phone != null}"
                    >
                      <div class="info-label">SĐT:</div>
                      <div
                        class="info-value"
                        th:text="${transaction.user.phone}"
                      >
                        0912345678
                      </div>
                    </div>
                    <div class="info-row">
                      <div class="info-label">Tham gia:</div>
                      <div
                        class="info-value"
                        th:text="${#temporals.format(transaction.user.createdAt, 'dd/MM/yyyy')}"
                      >
                        15/01/2025
                      </div>
                    </div>
                    <div class="info-row">
                      <div class="info-label">Loại tài khoản:</div>
                      <div class="info-value">
                        <span
                          class="role-badge"
                          th:classappend="${transaction.user.role != null ? transaction.user.role.name.toLowerCase() : 'user'}"
                          th:text="${transaction.user.role != null ? transaction.user.role.displayName : 'Thành viên'}"
                          >Thành viên</span
                        >
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Thông tin thanh toán -->
            <div class="transaction-info-card">
              <h4><i class="fas fa-credit-card"></i> Thông tin thanh toán</h4>
              <div class="card-content">
                <div class="info-row">
                  <div class="info-label">Phương thức:</div>
                  <div
                    class="info-value"
                    th:text="${transaction.paymentMethod != null ? transaction.paymentMethod : 'Chưa xác định'}"
                  >
                    <i class="far fa-credit-card"></i> Thẻ tín dụng/ghi nợ
                  </div>
                </div>
                <div class="info-row">
                  <div class="info-label">Số tiền:</div>
                  <div
                    class="info-value"
                    th:text="${#numbers.formatDecimal(transaction.amount, 0, 'COMMA', 0, 'POINT')} + ' ₫'"
                  >
                    900.000 VNĐ
                  </div>
                </div>
                <div class="info-divider"></div>
                <div class="info-row">
                  <div class="info-label">Trạng thái thanh toán:</div>
                  <div class="info-value">
                    <span
                      class="status-badge"
                      th:classappend="${transaction.status.value}"
                      th:text="${transaction.status.displayName}"
                      >Đã hoàn thành</span
                    >
                  </div>
                </div>
              </div>
            </div>

            <!-- Ghi chú và lịch sử -->
            <div class="transaction-info-card">
              <h4><i class="fas fa-clipboard-list"></i> Ghi chú & Lịch sử</h4>
              <div class="card-content">
                <div class="notes-section">
                  <h5>Ghi chú hệ thống</h5>
                  <div
                    class="system-notes"
                    th:if="${transaction.notes != null && !transaction.notes.isEmpty()}"
                  >
                    <div class="note-item">
                      <div
                        class="note-time"
                        th:text="${#temporals.format(transaction.createdAt, 'dd/MM/yyyy HH:mm:ss')}"
                      >
                        03/06/2025 14:30:45
                      </div>
                      <div class="note-content" th:text="${transaction.notes}">
                        Giao dịch hoàn thành tự động
                      </div>
                    </div>
                  </div>
                  <div
                    class="system-notes"
                    th:if="${transaction.notes == null || transaction.notes.isEmpty()}"
                  >
                    <div class="note-item">
                      <div class="note-content">Không có ghi chú</div>
                    </div>
                  </div>

                  <div class="add-note-section">
                    <h5>Thêm ghi chú</h5>
                    <form
                      th:action="@{/admin/transactions/{id}/add-note(id=${transaction.id})}"
                      method="post"
                      class="note-input-group"
                    >
                      <textarea
                        name="note"
                        placeholder="Nhập ghi chú của bạn..."
                        rows="3"
                      ></textarea>
                      <button type="submit" class="add-note-btn">
                        <i class="fas fa-plus"></i> Thêm ghi chú
                      </button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Action buttons -->
          <div class="transaction-actions">
            <div class="action-group">
              <a th:href="@{/admin/transactions}" class="secondary-btn">
                <i class="fas fa-arrow-left"></i> Quay lại danh sách
              </a>
              <a
                th:href="@{/admin/transactions/{id}/edit(id=${transaction.id})}"
                class="primary-btn"
              >
                <i class="fas fa-edit"></i> Chỉnh sửa
              </a>
            </div>
            <div class="action-group">
              <a
                th:href="@{/admin/transactions/{id}/delete(id=${transaction.id})}"
                class="danger-btn"
                onclick="return confirm('Bạn có chắc chắn muốn xóa giao dịch này?')"
              >
                <i class="fas fa-trash"></i> Xóa
              </a>
              <button class="secondary-btn" id="transactionInvoiceBtn">
                <i class="fas fa-file-invoice"></i> Xuất hóa đơn
              </button>
              <button class="primary-btn" id="transactionEmailBtn">
                <i class="fas fa-envelope"></i> Gửi email
              </button>
            </div>
          </div>
        </div>

        <!-- Error message if transaction not found -->
        <div class="error-message" th:if="${transaction == null}">
          <h3>Không tìm thấy giao dịch</h3>
          <p>Giao dịch bạn đang tìm kiếm không tồn tại hoặc đã bị xóa.</p>
          <a th:href="@{/admin/transactions}" class="primary-btn"
            >Quay lại danh sách</a
          >
        </div>
      </main>
    </div>

    <script src="../../js/main.js"></script>
    <script src="../js/admin.js"></script>
    <script>
      // Handle action buttons
      document
        .getElementById("transactionInvoiceBtn")
        .addEventListener("click", function () {
          // Implement invoice generation
          showToast("Đang tạo hóa đơn...", "info");
        });

      document
        .getElementById("transactionEmailBtn")
        .addEventListener("click", function () {
          // Implement email sending
          showToast("Đang gửi email...", "info");
        });

      function showToast(message, type = "info") {
        // Implement toast notification
        console.log(`${type}: ${message}`);
      }
    </script>
  </body>
</html>
