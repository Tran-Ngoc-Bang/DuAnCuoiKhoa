<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đăng tải tài liệu - EduShare</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700&family=Open+Sans:wght@400;500;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <link rel="stylesheet" th:href="@{/css/responsive.css}">
    <link rel="stylesheet" th:href="@{/css/main-fixes.css}">
    <link rel="stylesheet" th:href="@{/css/upload.css}">
    <link rel="stylesheet" th:href="@{/css/upload-modern.css}">
    <link rel="stylesheet" th:href="@{/css/footer-modern.css}">
    <link rel="stylesheet" th:href="@{/css/client-header.css}">
    <link rel="stylesheet" th:href="@{/css/client-footer.css}">
    <style>
     
    .tag-suggestion {
        padding: 5px;
        cursor: pointer;
    }
    .tag-suggestion:hover {
        background-color: #f0f0f0;
    }
    .tag-badge {
        display: inline-block;
        padding: 2px 8px;
        background-color: #e0e0e0;
        border-radius: 12px;
        cursor: pointer;
    }
    .tag-badge:hover {
        background-color: #d0d0d0;
    }
    .input-group {
    position: relative;
    display: flex;
    align-items: center;
    width: 100%;
    max-width: 300px; /* Điều chỉnh độ rộng tối đa tùy ý */
    margin-bottom: 15px;
}

.input-group .fas {
    position: absolute;
    left: 10px;
    color: #555;
    font-size: 1.2em;
}

.input-group .form-input {
    width: 100%;
    padding: 10px 10px 10px 40px; /* Padding trái để tránh chồng lấp icon */
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 1em;
    box-sizing: border-box;
    transition: border-color 0.3s;
}

.input-group .form-input:focus {
    border-color: #007bff;
    outline: none;
    box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);

}

.input-group .form-input:invalid {
    border-color: #dc3545;
}

.input-group .form-input:invalid + .error-message {
    display: block;
}

.error-message {
    display: none;
    color: #dc3545;
    font-size: 0.9em;
    margin-top: 5px;
}
</style>
       
</head>
<body>
    <!-- Decorative Background Elements -->
    <div class="decorative-shapes">
        <div class="shape shape-1"></div>
        <div class="shape shape-2"></div>
        <div class="shape shape-3"></div>
        <div class="shape shape-4"></div>
    </div>
    <!-- Header -->
    <div th:replace="~{fragments/client/layout :: header}"></div>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <a href="../index.html">
                        <div class="logo-icon">E</div>
                        <span class="logo-text">EduShare</span>
                    </a>
                </div>
                <nav class="main-nav">
                    <a href="../index.html" class="nav-link">Trang chủ</a>
                    <a href="categories.html" class="nav-link">Danh mục</a>
                    <a href="search.html?sort=newest" class="nav-link">Tài liệu mới</a>
                    <a href="search.html?filter=premium" class="nav-link">Cao cấp</a>
                    <a href="about.html" class="nav-link">Giới thiệu</a>
                </nav>
                <div class="header-actions">
                    <div class="search-box">
                        <input type="text" id="headerSearchInput" placeholder="Tìm kiếm tài liệu...">
                        <button id="headerSearchBtn">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                              <button class="dark-mode-toggle" id="darkModeToggle" type="button" aria-label="Toggle dark mode">
            <span class="dark-mode-handle" id="darkModeHandle"></span>
          </button>
                    <a href="login.html" class="login-btn">Đăng nhập</a>
                    <a href="register.html" class="register-btn">Đăng ký</a>
                </div>
                <div class="mobile-menu-toggle" id="mobileMenuBtn">
                    <i class="fas fa-bars"></i>
                </div>
            </div>
        </div>
        <!-- Mobile menu -->
        <div id="mobileMenu" class="mobile-menu">
            <div class="mobile-search">
                <input type="text" placeholder="Tìm kiếm tài liệu...">
                <button>
                    <i class="fas fa-search"></i>
                </button>
            </div>
            <nav class="mobile-nav">
                <a href="../index.html" class="mobile-nav-link">Trang chủ</a>
                <a href="categories.html" class="mobile-nav-link">Danh mục</a>
                <a href="search.html?sort=newest" class="mobile-nav-link">Tài liệu mới</a>
                <a href="search.html?filter=premium" class="mobile-nav-link">Cao cấp</a>
                <a href="#" class="mobile-nav-link">Hướng dẫn</a>
            </nav>
            <div class="mobile-auth">
                <a href="login.html" class="mobile-login-btn">Đăng nhập</a>
                <a href="register.html" class="mobile-register-btn">Đăng ký</a>
            </div>
        </div>
    </header>
    
    <!-- Main Content -->
    <main>
        <section class="upload-section">
            <div class="container">
                <div class="upload-header">
                    <div class="header-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <h1 class="page-title">Đăng tải tài liệu</h1>
                    <p class="page-description">Chia sẻ kiến thức của bạn và giúp đỡ cộng đồng học tập</p>
                     <div class="error-message" th:if="${error}" th:text="${error}"></div>
                    <div class="success-message" th:if="${success}" th:text="${success}"></div> 
                </div>
                
                <div class="upload-container">
                    <div class="upload-steps">
                        <div class="step active"  th:classappend="${currentStep == 1} ? 'active' : ''" data-step="1">
                            <div class="step-number">1</div>
                            <div class="step-label">Tải lên tài liệu</div>
                        </div>
                        <div class="step" th:classappend="${currentStep == 2} ? 'active' : (${currentStep > 2} ? 'completed' : '')" data-step="2">
                            <div class="step-number">2</div>
                            <div class="step-label">Thông tin tài liệu</div>
                        </div>
                        <div class="step" th:classappend="${currentStep == 3} ? 'active' : (${currentStep > 3} ? 'completed' : '')" data-step="3">
                            <div class="step-number">3</div>
                            <div class="step-label">Cài đặt và xem trước</div>
                        </div>
                        <div class="step" th:classappend="${currentStep == 4} ? 'active' : ''" data-step="4">
                            <div class="step-number">4</div>
                            <div class="step-label">Hoàn tất</div>
                        </div>
                    </div>
                    
                    <!-- Step 1: Upload File -->
                    <div class="upload-step-content" th:classappend="${currentStep == 1} ? 'active' : ''" data-step="1">
                        <div class="upload-dropzone" id="uploadDropzone">
                             <form th:action="@{/upload/step1}" method="post" enctype="multipart/form-data">
                            <input type="file" id="fileInput"  name="file" class="file-input" accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx">
                            <div class="dropzone-content">
                                <div class="dropzone-icon">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </div>
                                <h3 class="dropzone-title">Kéo thả tài liệu tại đây</h3>
                                <p class="dropzone-description">hoặc</p>
                                <button type="button" class="btn btn-primary browse-btn">Chọn tài liệu</button>
                                <p class="file-requirements">Hỗ trợ tập tin: PDF, DOC, DOCX, PPT, PPTX, XLS, XLSX <br> Kích thước tối đa: 100MB</p>
                            </div>
                            
                            <div class="upload-preview" th:style="${fileName != null} ? 'display: block;' : 'display: none;'">
                                <div class="preview-header">
                                    <div class="preview-file-info">
                                        <div class="preview-file-icon">
                                            <i th:class="${fileType == 'PDF' ? 'fas fa-file-pdf' : 
               fileType == 'DOC' || fileType == 'DOCX' ? 'fas fa-file-word' : 
               fileType == 'XLS' || fileType == 'XLSX' ? 'fas fa-file-excel' : 
               fileType == 'PPT' || fileType == 'PPTX' ? 'fas fa-file-powerpoint' : 
               'fas fa-file'}"></i>
                                        </div>
                                        <div class="preview-file-details">
                                            <div class="preview-file-name" th:text="${fileName}">document.pdf</div>
                                            <div class="preview-file-meta">
                                                <span class="file-size" th:text="${fileSize != null} ? ${#numbers.formatDecimal(fileSize / 1024.0 / 1024.0, 0, 2, 'COMMA')} + ' MB' : 'N/A'"></span>
                                                <span class="file-type" th:text="${fileType}"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-outline btn-sm change-file-btn">
                                        <i class="fas fa-exchange-alt"></i> Đổi tài liệu
                                    </button>
                                </div>
                                
                                <div class="upload-progress">
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: 65%;"></div>
                                    </div>
                                    <div class="progress-text">Đang tải lên... 65%</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="upload-tips">
                            <h3 class="tips-title"><i class="fas fa-lightbulb"></i> Mẹo đăng tải</h3>
                            <ul class="tips-list">
                                <li>Chỉ đăng tải tài liệu mà bạn có quyền phân phối.</li>
                                <li>Đảm bảo tài liệu không có nội dung vi phạm bản quyền.</li>
                                <li>Chất lượng tài liệu càng cao, xếp hạng và thu nhập của bạn càng tốt.</li>
                                <li>Tài liệu độc quyền (chưa có trên nền tảng) sẽ được ưu tiên hiển thị.</li>
                                <li>Các tài liệu sẽ được kiểm duyệt trước khi xuất bản công khai.</li>
                            </ul>
                        </div>
                        
                        <div class="step-actions">
                            <button type="submit" class="btn btn-primary next-step" id="step1Next" th:disabled="${fileName == null}">Tiếp theo</button>
                        </div>
                        </form>
                    </div>
                    
                 <!-- Step 2: Document Info -->
<div class="upload-step-content" th:classappend="${currentStep == 2} ? 'active' : ''" data-step="2">
    <form class="document-form" th:action="@{/upload/step2}" th:object="${documentDTO}" method="post">
        <div class="form-grid">
            <div class="form-group full-width">
                <label for="docTitle">Tiêu đề tài liệu<span class="required">*</span></label>
                <input type="text" id="docTitle" name="title" class="form-input" th:field="*{title}" placeholder="Nhập tiêu đề mô tả tài liệu" required>
            </div>
             <div class="form-group">
            <!-- Phân loại danh mục đa cấp -->
            <label>Chọn danh mục cha <span class="required">*</span></label>
            
            <!-- Level 1: Root categories -->
            <div class="category-level" id="level1">
                <label for="level1Select" class="level-label">Cấp 1 - Danh mục gốc:</label>
                <select id="level1Select" class="form-select level-select" onchange="onLevelChange(1)" th:name="parentId">
                    <option value="0">🏠 Danh mục gốc (không có cha)</option>
                    <option th:each="parent : ${rootCategories}"
                            th:value="${parent.id}"
                            th:text="'📂 ' + ${parent.name}"
                            th:attr="data-subcategories=${parent.subcategories}">
                    </option>
                </select>
            </div>
            
            <!-- Level 2: Subcategories -->
            <div class="category-level" id="level2" style="display: none;">
                <label for="level2Select" class="level-label">Cấp 2 - Danh mục con:</label>
                <select id="level2Select" class="form-select level-select" onchange="onLevelChange(2)" th:name="parentId">
                    <option value="">Chọn danh mục con...</option>
                </select>
            </div>
            
            <!-- Level 3: Sub-subcategories -->
            <div class="category-level" id="level3" style="display: none;">
                <label for="level3Select" class="level-label">Cấp 3 - Danh mục con cấp 2:</label>
                <select id="level3Select" class="form-select level-select" onchange="onLevelChange(3)" th:name="parentId">
                    <option value="">Chọn danh mục con cấp 2...</option>
                </select>
            </div>
            
            <!-- Hidden input for final parent selection -->
            <input type="hidden" id="finalParentId" name="parentId" th:value="${documentDTO.parentId != null ? documentDTO.parentId : 0}">
            
            <!-- Hidden input for all categoryIds -->
            <input type="hidden" id="categoryIds" name="categoryIds" value="">

            <!-- Breadcrumb hiển thị đường dẫn đã chọn -->
            <div id="categoryBreadcrumb" style="margin-top: 10px; display: none;">
                <div style="padding: 8px 12px; background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 4px;">
                    <strong>Đường dẫn đã chọn:</strong>
                    <div id="breadcrumbPath" style="margin-top: 5px; font-family: monospace;"></div>
                </div>
            </div>
             </div>
            
            <div class="form-group full-width">
                <label for="docDescription">Mô tả tài liệu<span class="required">*</span></label>
                <textarea id="docDescription" name="description" th:field="*{description}" class="form-input" rows="5" placeholder="Mô tả ngắn gọn về nội dung tài liệu" required></textarea>
            </div>
            <!-- Hiển thị tag phổ biến và tìm kiếm tag -->
           <div class="form-group">
                <label for="docTags">Từ khóa</label>
                <input type="text" id="docTags" class="form-input" placeholder="Nhập để tìm hoặc tạo từ khóa, ngăn cách bởi dấu phẩy" oninput="searchTags()">
                <div class="form-hint">Thêm từ khóa giúp tài liệu của bạn dễ dàng được tìm thấy hơn</div>
                <div id="tagSuggestions" class="tag-suggestions" style="display: none; position: absolute; background: white; border: 1px solid #ccc; padding: 5px; z-index: 1000;"></div>
                <div id="popularTags" class="popular-tags" style="margin-top: 10px;">
                    <strong>Tag phổ biến:</strong>
                    <div th:if="${popularTags != null and not #lists.isEmpty(popularTags)}" th:each="tag : ${popularTags}" style="display: inline-block; margin-right: 5px;">
                        <span class="tag-badge" th:attr="data-tag=${tag.name}" onclick="addTag(this.getAttribute('data-tag'))">#<span th:text="${tag.name}"></span></span>
                    </div>
                    <div th:unless="${popularTags != null and not #lists.isEmpty(popularTags)}" style="color: #888;">Không có tag phổ biến.</div>
                </div>
                <input type="hidden" id="tagNames" name="tagNames" value="">
            </div>
        </div>
        
        <div class="step-actions">
            <button type="button" class="btn btn-outline prev-step" data-prev="1">Quay lại</button>
            <button type="submit" class="btn btn-primary next-step" id="step2Next">Tiếp theo</button>
        </div>
    </form>
</div>
                    
                    <!-- Step 3: Settings & Preview -->
                    <div class="upload-step-content"  th:classappend="${currentStep == 3} ? 'active' : ''" data-step="3">
                         <form th:action="@{/upload/step3}" method="post">
                        <div class="setting-sections">
                            <div class="setting-section">
                                <h3 class="section-title">Cài đặt quyền truy cập</h3>
           
                                <div class="form-group">
                                    <label class="setting-label">Loại truy cập</label>
                                    <div class="toggle-options">
                                        <label class="toggle-option">
                                            <input type="radio" name="accessType" value="0" checked>
                                            <span class="option-label"><i class="fas fa-unlock-alt"></i> Miễn phí</span>
                                            <span class="option-description">Ai cũng có thể xem và tải xuống tài liệu này</span>
                                        </label>
                                        <label class="toggle-option">
                                            <input type="radio" name="accessType" value="premium">
                                            <span class="option-label"><i class="fas fa-coins"></i> Trả phí</span>
                                            <span class="option-description">Người dùng phải trả xu để tải xuống tài liệu này</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div id="priceSettings" class="price-settings" style="display: none;">
                                    <div class="price-input">
                                        <label for="docPrice">Giá tài liệu (xu)</label>
                                        <div class="input-group">
                                            <i class="fas fa-coins"></i>
                                            <input type="number" id="docPrice" name="price" class="form-input" placeholder="Nhập số xu" min="10" max="1000" value="50" oninput="validatePrice(this)">
                                            <div id="priceError" class="error-message"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="price-settings-info">
                                        <h4><i class="fas fa-info-circle"></i> Thông tin thu nhập</h4>
                                        <div class="price-calculation">
                                            <span>Giá tài liệu:</span>
                                            <span><span id="priceValue">50</span> xu</span>
                                        </div>
                                        <div class="price-calculation">
                                            <span>Phí nền tảng (30%):</span>
                                            <span>-<span id="platformFee">15</span> xu</span>
                                        </div>
                                        <div class="price-calculation">
                                            <span>Thu nhập của bạn:</span>
                                            <span><span id="authorEarning">35</span> xu</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                        <!--  <div class="setting-section">
                                <h3 class="section-title">Cài đặt xem trước</h3>
                                
                                <div class="form-group">
                                    <label class="setting-label">Cho phép xem trước</label>
                                    <div class="toggle-options">
                                        <label class="toggle-option">
                                            <input type="radio" name="previewType" value="enable" checked>
                                            <span class="option-label"><i class="fas fa-eye"></i> Bật xem trước</span>
                                            <span class="option-description">Người dùng có thể xem trước một số trang của tài liệu</span>
                                        </label>
                                        <label class="toggle-option">
                                            <input type="radio" name="previewType" value="disable">
                                            <span class="option-label"><i class="fas fa-eye-slash"></i> Tắt xem trước</span>
                                            <span class="option-description">Người dùng chỉ thấy thông tin tài liệu mà không xem được nội dung</span>
                                        </label>
                                    </div>
                                </div> 
                                
                              <div id="previewSettings" class="preview-settings">
                                    <label for="previewPages">Số trang xem trước:</label>
                                    <div class="preview-slider">
                                        <div class="slider-container">
                                            <div class="slider">
                                                <div class="slider-track" style="width: 30%"></div>
                                                <div class="slider-thumb" style="left: 30%"></div>
                                            </div>
                                            <div class="slider-value" id="previewPagesValue">3</div>
                                        </div>
                                        <div class="preview-info">
                                            <p class="preview-description">Cho phép người xem đọc trước <strong id="previewCount">3</strong> trang đầu tiên trước khi tải xuống</p>
                                        </div>
                                    </div>
                                </div>
                            </div> --> 
                            
                      <!--     <div class="setting-section">
                                <h3 class="section-title">Tài liệu liên quan</h3>
                                
                                <div class="form-group">
                                    <label class="setting-label">Gợi ý tài liệu</label>
                                    <div class="toggle-options">
                                        <label class="toggle-option">
                                            <input type="radio" name="relatedDocs" value="auto" checked>
                                            <span class="option-label"><i class="fas fa-magic"></i> Tự động</span>
                                            <span class="option-description">Hệ thống tự động gợi ý tài liệu liên quan dựa trên nội dung</span>
                                        </label>
                                        <label class="toggle-option">
                                            <input type="radio" name="relatedDocs" value="manual">
                                            <span class="option-label"><i class="fas fa-edit"></i> Thủ công</span>
                                            <span class="option-description">Bạn tự chọn các tài liệu liên quan từ tài liệu của mình</span>
                                        </label>
                                    </div>
                                </div>
                                
                             <div id="manualRelatedDocs" style="display: none;">
                                    <div class="related-docs-selector">
                                        <div class="search-related">
                                            <input type="text" placeholder="Tìm kiếm tài liệu của bạn...">
                                            <button><i class="fas fa-search"></i></button>
                                        </div>
                                        <div class="related-docs-list">
                                            <p class="empty-state">Bạn chưa có tài liệu nào khác được xuất bản</p>
                                        </div>
                                    </div>
                                </div>
                            </div>-->
                        </div>
                        
                        <div class="step-actions">
                             <a href="/upload" class="btn btn-outline prev-step">Quay lại</a>
                            <button type="submit" class="btn btn-primary next-step" id="publishBtn">Xuất bản</button>
                        </div>
                        </form>
                    </div>
                    
                    <!-- Step 4: Completion -->
                    <div class="upload-step-content" th:classappend="${currentStep == 4} ? 'active' : ''" data-step="4">
                        <div class="completion-message">
                            <div class="completion-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <h2 class="completion-title">Tải lên thành công!</h2>
                            <div class="confetti-container" id="confetti"></div>
                            <p class="completion-description">
                                Tài liệu của bạn đã được tải lên và đang chờ kiểm duyệt. Quá trình này thường mất 24-48 giờ. 
                                Bạn sẽ nhận được thông báo khi tài liệu được duyệt và công khai.
                                <br><br>
                                ID tài liệu: <span class="document-id" th:text="${documentId}" >DOC-2023120001</span>
                            </p>
                            
                            <div class="completion-actions">
                                <a href="account/documents" class="btn btn-outline">
                                    <i class="fas fa-file-alt"></i> Quản lý tài liệu
                                </a>
                                <form th:action="@{/upload/reset}" method="post" style="display: inline;">
                                <button class="btn btn-primary" id="uploadAnotherBtn">
                                    <i class="fas fa-plus"></i> Tải lên tài liệu khác
                                </button>
                                   </form>
                            </div>
                            
                            <div class="completion-stats">
                                <div class="stat-card">
                                    <div class="stat-value" th:text="${#numbers.formatInteger(numDocuments, 0, 'DEFAULT')}">5</div>
                                    <div class="stat-label">Tài liệu đã tải</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" th:text="${#numbers.formatInteger(numDownloads, 0, 'DEFAULT')}">125</div>
                                    <div class="stat-label">Lượt tải xuống</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" th:text="${#numbers.formatInteger(numPoints, 0, 'DEFAULT')}">2,500</div>
                                    <div class="stat-label">Xu đã kiếm được</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <!-- Footer -->
    <div th:replace="~{fragments/client/layout :: footer}"></div>
    
    <!-- Scripts -->
    <script th:src="@{/js/main.js}"></script>
    <script th:src="@{/js/upload.js}"></script>
    <script th:src="@{/js/client-header.js}"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Tạo hiệu ứng confetti khi đến bước hoàn thành
            function createConfetti() {
                const confettiContainer = document.getElementById('confetti');
                if (!confettiContainer) return;
                
                for (let i = 0; i < 100; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti-piece';
                    confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 80%, 60%)`;
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.width = Math.random() * 10 + 5 + 'px';
                    confetti.style.height = Math.random() * 10 + 5 + 'px';
                    confetti.style.animationDuration = Math.random() * 3 + 2 + 's';
                    confetti.style.animationDelay = Math.random() * 2 + 's';
                    confettiContainer.appendChild(confetti);
                }
            }
            
            // Thêm animation cho các shapes
            const shapes = document.querySelectorAll('.shape');
            shapes.forEach((shape, index) => {
                shape.style.animationDelay = `${index * 0.2}s`;
            });
            // File Upload
            const dropzone = document.getElementById('uploadDropzone');
            const fileInput = document.getElementById('fileInput');
            const browseBtn = document.querySelector('.browse-btn');
            const changeFileBtn = document.querySelector('.change-file-btn');
            const uploadPreview = document.querySelector('.upload-preview');
            const dropzoneContent = document.querySelector('.dropzone-content');
            const step1NextBtn = document.getElementById('step1Next');
            
            // Simulate file upload when a file is selected
            fileInput.addEventListener('change', function(e) {
                if (this.files.length > 0) {
                    const file = this.files[0];
                    simulateFileUpload(file);
                }
            });
            
            // Open file browser when browse button is clicked
            browseBtn.addEventListener('click', function(e) {
                e.preventDefault();
                fileInput.click();
            });
            
            // Change file button
            if (changeFileBtn) {
                changeFileBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    resetFileUpload();
                    fileInput.click();
                });
            }
            
            // Handle drag and drop
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropzone.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropzone.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropzone.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                dropzone.classList.add('drag-over');
            }
            
            function unhighlight() {
                dropzone.classList.remove('drag-over');
            }
            
            dropzone.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    simulateFileUpload(files[0]);
                }
            }
            
            function simulateFileUpload(file) {
                // Update file preview
                const fileIcon = document.querySelector('.preview-file-icon i');
                const fileName = document.querySelector('.preview-file-name');
                const fileSize = document.querySelector('.file-size');
                const fileType = document.querySelector('.file-type');
                
                // Set appropriate icon based on file type
                const extension = file.name.split('.').pop().toLowerCase();
                let iconClass = 'fas fa-file';
                
                if (['pdf'].includes(extension)) {
                    iconClass = 'fas fa-file-pdf';
                } else if (['doc', 'docx'].includes(extension)) {
                    iconClass = 'fas fa-file-word';
                } else if (['xls', 'xlsx'].includes(extension)) {
                    iconClass = 'fas fa-file-excel';
                } else if (['ppt', 'pptx'].includes(extension)) {
                    iconClass = 'fas fa-file-powerpoint';
                }
                
                fileIcon.className = iconClass;
                fileName.textContent = file.name;
                fileSize.textContent = formatFileSize(file.size);
                fileType.textContent = extension.toUpperCase();
                
                // Show upload preview and hide dropzone content
                dropzoneContent.style.display = 'none';
                uploadPreview.style.display = 'block';
                
                // Simulate progress
                simulateProgress();
            }
            
            function resetFileUpload() {
                // Reset file input
                fileInput.value = '';
                
                // Hide upload preview and show dropzone content
                dropzoneContent.style.display = 'block';
                uploadPreview.style.display = 'none';
                
                // Reset progress
                const progressFill = document.querySelector('.progress-fill');
                const progressText = document.querySelector('.progress-text');
                
                progressFill.style.width = '0%';
                progressText.textContent = 'Đang tải lên... 0%';
                
                // Disable next button
                step1NextBtn.disabled = true;
            }
            
            function simulateProgress() {
                const progressFill = document.querySelector('.progress-fill');
                const progressText = document.querySelector('.progress-text');
                
                let progress = 0;
                const interval = setInterval(() => {
                    progress += 5;
                    progressFill.style.width = `${progress}%`;
                    progressText.textContent = `Đang tải lên... ${progress}%`;
                    
                    if (progress >= 100) {
                        clearInterval(interval);
                        progressText.textContent = 'Đã tải lên 100%';
                        // Enable next button
                        step1NextBtn.disabled = false;
                    }
                }, 150);
            }
            
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            // Multi-step form navigation
            const steps = document.querySelectorAll('.step');
            const stepContents = document.querySelectorAll('.upload-step-content');
            const nextButtons = document.querySelectorAll('.next-step');
            const prevButtons = document.querySelectorAll('.prev-step');
            
            nextButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Get current step
                    const currentStepContent = document.querySelector('.upload-step-content.active');
                    const currentStepNumber = parseInt(currentStepContent.dataset.step);
                    
                    // Validate current step (if needed)
                    if (currentStepNumber === 2) {
                        const title = document.getElementById('docTitle').value;
                        const category = document.getElementById('docCategory').value;
                        const description = document.getElementById('docDescription').value;
                        
                        if (!title || !category || !description) {
                            alert('Vui lòng điền đầy đủ thông tin bắt buộc.');
                            return;
                        }
                    }
                    
                    // Hide current step
                    currentStepContent.classList.remove('active');
                    document.querySelector(`.step[data-step="${currentStepNumber}"]`).classList.remove('active');
                    document.querySelector(`.step[data-step="${currentStepNumber}"]`).classList.add('completed');
                    
                    // Show next step
                    const nextStepNumber = currentStepNumber + 1;
                    document.querySelector(`.upload-step-content[data-step="${nextStepNumber}"]`).classList.add('active');
                    document.querySelector(`.step[data-step="${nextStepNumber}"]`).classList.add('active');
                    
                    // Tạo hiệu ứng confetti khi đến bước hoàn thành
                    if (nextStepNumber === 4) {
                        createConfetti();
                    }
                });
            });
            
            prevButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Get current step
                    const currentStepContent = document.querySelector('.upload-step-content.active');
                    const currentStepNumber = parseInt(currentStepContent.dataset.step);
                    
                    // Get previous step number (from button data-prev attribute if exists)
                    const prevStepNumber = this.dataset.prev ? parseInt(this.dataset.prev) : currentStepNumber - 1;
                    
                    // Hide current step
                    currentStepContent.classList.remove('active');
                    document.querySelector(`.step[data-step="${currentStepNumber}"]`).classList.remove('active');
                    
                    // Show previous step
                    document.querySelector(`.upload-step-content[data-step="${prevStepNumber}"]`).classList.add('active');
                    document.querySelector(`.step[data-step="${prevStepNumber}"]`).classList.add('active');
                    document.querySelector(`.step[data-step="${prevStepNumber}"]`).classList.remove('completed');
                });
            });
            
            // Upload Another button
            const uploadAnotherBtn = document.getElementById('uploadAnotherBtn');
            if (uploadAnotherBtn) {
                uploadAnotherBtn.addEventListener('click', function() {
                    // Reset everything and go back to step 1
                    resetFileUpload();
                    
                    // Hide current step
                    document.querySelector('.upload-step-content.active').classList.remove('active');
                    document.querySelectorAll('.step').forEach(step => {
                        step.classList.remove('active');
                        step.classList.remove('completed');
                    });
                    
                    // Show step 1
                    document.querySelector('.upload-step-content[data-step="1"]').classList.add('active');
                    document.querySelector('.step[data-step="1"]').classList.add('active');
                });
            }
            
            // Price settings toggle
            const accessTypeRadios = document.querySelectorAll('input[name="accessType"]');
            accessTypeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const priceSettings = document.getElementById('priceSettings');
                    if (this.value === 'premium') {
                        priceSettings.style.display = 'grid';
                    } else {
                        priceSettings.style.display = 'none';
                    }
                });
            });
            
            // Preview settings toggle
            const previewTypeRadios = document.querySelectorAll('input[name="previewType"]');
            previewTypeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const previewSettings = document.getElementById('previewSettings');
                    if (this.value === 'enable') {
                        previewSettings.style.display = 'block';
                    } else {
                        previewSettings.style.display = 'none';
                    }
                });
            });
            
            // Related docs toggle
            const relatedDocsRadios = document.querySelectorAll('input[name="relatedDocs"]');
            relatedDocsRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const manualRelatedDocs = document.getElementById('manualRelatedDocs');
                    if (this.value === 'manual') {
                        manualRelatedDocs.style.display = 'block';
                    } else {
                        manualRelatedDocs.style.display = 'none';
                    }
                });
            });
            
            // Price calculation
            const docPrice = document.getElementById('docPrice');
            if (docPrice) {
                docPrice.addEventListener('input', function() {
                    const price = parseInt(this.value) || 0;
                    const platformFee = Math.round(price * 0.3);
                    const authorEarning = price - platformFee;
                    
                    document.getElementById('priceValue').textContent = price;
                    document.getElementById('platformFee').textContent = platformFee;
                    document.getElementById('authorEarning').textContent = authorEarning;
                });
            }
            
            // Slider for preview pages
            const slider = document.querySelector('.slider');
            const sliderThumb = document.querySelector('.slider-thumb');
            const sliderTrack = document.querySelector('.slider-track');
            const sliderValue = document.getElementById('previewPagesValue');
            const previewCount = document.getElementById('previewCount');
            
            if (slider && sliderThumb && sliderTrack) {
                slider.addEventListener('click', function(e) {
                    updateSlider(e);
                });
                
                sliderThumb.addEventListener('mousedown', function() {
                    document.addEventListener('mousemove', updateSlider);
                    document.addEventListener('mouseup', function() {
                        document.removeEventListener('mousemove', updateSlider);
                    });
                });
            }
            
            function updateSlider(e) {
                const sliderRect = slider.getBoundingClientRect();
                let position = (e.clientX - sliderRect.left) / sliderRect.width;
                
                // Clamp position between 0 and 1
                position = Math.max(0, Math.min(1, position));
                
                // Pages from 1 to 10
                let pages = Math.max(1, Math.min(10, Math.round(position * 10)));
                
                // Update UI
                sliderTrack.style.width = (pages * 10) + '%';
                sliderThumb.style.left = (pages * 10) + '%';
                sliderValue.textContent = pages;
                previewCount.textContent = pages;
            }
            
            // Category-Subcategory relationship
            const categorySelect = document.getElementById('docCategory');
            const subcategorySelect = document.getElementById('docSubcategory');
            
            if (categorySelect && subcategorySelect) {
                // Define subcategories for each category
                const subcategories = {
                    it: [
                        { value: 'programming', text: 'Lập trình' },
                        { value: 'database', text: 'Cơ sở dữ liệu' },
                        { value: 'networking', text: 'Mạng máy tính' },
                        { value: 'security', text: 'Bảo mật' },
                        { value: 'web', text: 'Phát triển web' },
                        { value: 'mobile', text: 'Phát triển ứng dụng di động' }
                    ],
                    business: [
                        { value: 'marketing', text: 'Marketing' },
                        { value: 'finance', text: 'Tài chính' },
                        { value: 'management', text: 'Quản trị' },
                        { value: 'hr', text: 'Nhân sự' },
                        { value: 'economics', text: 'Kinh tế học' }
                    ],
                    language: [
                        { value: 'english', text: 'Tiếng Anh' },
                        { value: 'chinese', text: 'Tiếng Trung' },
                        { value: 'japanese', text: 'Tiếng Nhật' },
                        { value: 'korean', text: 'Tiếng Hàn' },
                        { value: 'french', text: 'Tiếng Pháp' },
                        { value: 'german', text: 'Tiếng Đức' }
                    ],
                    // Add more categories and subcategories as needed
                };
                
                categorySelect.addEventListener('change', function() {
                    const category = this.value;
                    
                    // Clear current options
                    subcategorySelect.innerHTML = '<option value="" disabled selected>Chọn danh mục con</option>';
                    
                    // If category has subcategories, add them and enable the select
                    if (subcategories[category]) {
                        subcategories[category].forEach(subcategory => {
                            const option = document.createElement('option');
                            option.value = subcategory.value;
                            option.textContent = subcategory.text;
                            subcategorySelect.appendChild(option);
                        });
                        
                        subcategorySelect.disabled = false;
                    } else {
                        subcategorySelect.disabled = true;
                    }
                });
            }
        });

   let selectedPath = [];
    let rootCategories = /*[[${rootCategories}]]*/ [];
    let popularTags = /*[[${popularTags}]]*/ []; // Lấy từ model

    function onLevelChange(level) {
        const currentSelect = document.getElementById(`level${level}Select`);
        const selectedValue = currentSelect.value;
        const selectedText = currentSelect.options[currentSelect.selectedIndex].text;

        // Clear subsequent levels
        for (let i = level + 1; i <= 3; i++) {
            const nextLevel = document.getElementById(`level${i}`);
            const nextSelect = document.getElementById(`level${i}Select`);
            nextLevel.style.display = 'none';
            nextSelect.innerHTML = '<option value="">Chọn danh mục con...</option>';
        }

        // Update selected path
        selectedPath = selectedPath.slice(0, level - 1);
        if (selectedValue && selectedValue !== '0') {
            selectedPath.push({
                id: selectedValue,
                name: selectedText.replace(/^[📂📁🏠]\s*/, ''),
                level: level
            });

            // Load next level via API
            loadNextLevel(selectedValue, level + 1);
        } else if (level === 1 && selectedValue === '0') {
            selectedPath = [];
        }

        updateFinalSelection();
        updateBreadcrumb();
    }

    function loadNextLevel(parentId, targetLevel) {
        if (targetLevel > 3) return;

        fetch(`/categories/${parentId}/subcategories`)
            .then(response => response.json())
            .then(data => {
                const targetSelect = document.getElementById(`level${targetLevel}Select`);
                const targetDiv = document.getElementById(`level${targetLevel}`);

                if (data && data.length > 0) {
                    targetSelect.innerHTML = '<option value="">Chọn danh mục con...</option>';
                    data.forEach(sub => {
                        const option = document.createElement('option');
                        option.value = sub.id;
                        option.textContent = `📁 ${sub.name}`;
                        option.setAttribute('data-subcategories', sub.subcategories || 0);
                        targetSelect.appendChild(option);
                    });
                    targetDiv.style.display = 'block';
                } else {
                    targetDiv.style.display = 'none';
                    updateFinalSelection();
                }
            })
            .catch(error => console.error('Error loading subcategories:', error));
    }

    function updateFinalSelection() {
        const finalParentId = document.getElementById('finalParentId');
        const categoryIdsInput = document.getElementById('categoryIds');
        finalParentId.value = selectedPath.length > 0 ? selectedPath[selectedPath.length - 1].id : '0';
        categoryIdsInput.value = selectedPath.map(item => item.id).join(',');
        console.log("Updated parentId:", finalParentId.value);
        console.log("Updated categoryIds:", categoryIdsInput.value);
    }

    function updateBreadcrumb() {
        const breadcrumb = document.getElementById('categoryBreadcrumb');
        const breadcrumbPath = document.getElementById('breadcrumbPath');

        if (selectedPath.length === 0) {
            breadcrumb.style.display = 'none';
            return;
        }

        let pathHtml = '<span class="breadcrumb-item">🏠 Gốc</span>';
        selectedPath.forEach((item, index) => {
            pathHtml += '<span class="breadcrumb-arrow">→</span>';
            pathHtml += `<span class="breadcrumb-item">📁 ${item.name}</span>`;
        });

        breadcrumbPath.innerHTML = pathHtml;
        breadcrumb.style.display = 'block';
    }

    // Logic tìm kiếm và tạo tag
    function searchTags() {
        const input = document.getElementById('docTags');
        const suggestions = document.getElementById('tagSuggestions');
        const query = input.value.trim();

        if (query.length < 1) {
            suggestions.style.display = 'none';
            return;
        }

        fetch(`/tags/search?query=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                suggestions.innerHTML = '';
                data.forEach(tag => {
                    const div = document.createElement('div');
                    div.textContent = `#${tag.name}`;
                    div.className = 'tag-suggestion';
                    div.onclick = () => addTag(tag.name);
                    suggestions.appendChild(div);
                });
                suggestions.style.display = data.length > 0 ? 'block' : 'none';
            })
            .catch(error => console.error('Error searching tags:', error));
    }

    function addTag(tagName) {
        const input = document.getElementById('docTags');
        const tagNamesInput = document.getElementById('tagNames');
        let tags = input.value.split(',').map(t => t.trim()).filter(t => t);
        if (!tags.includes(tagName)) {
            tags.push(tagName);
            input.value = tags.join(', ');
        }
        updateTagNamesInput();
        document.getElementById('tagSuggestions').style.display = 'none';
    }

    function updateTagNamesInput() {
        const input = document.getElementById('docTags');
        const tagNamesInput = document.getElementById('tagNames');
        tagNamesInput.value = input.value.split(',').map(t => t.trim()).filter(t => t).join(',');
        console.log("Updated tagNames:", tagNamesInput.value);
    }

    document.getElementById('docTags').addEventListener('change', updateTagNamesInput);
    document.getElementById('step2Next').addEventListener('click', updateTagNamesInput);

    function validatePrice(input) {
    const errorDiv = document.getElementById('priceError');
    const value = parseInt(input.value);
    const max = parseInt(input.max);
    const min = parseInt(input.min);

    if (value > max) {
        errorDiv.textContent = `Số xu không được vượt quá ${max}!`;
        input.value = max; // Đặt lại giá trị về max nếu vượt quá
    } else if (value < min) {
        errorDiv.textContent = `Số xu phải lớn hơn hoặc bằng ${min}!`;
        input.value = min; // Đặt lại giá trị về min nếu nhỏ hơn
    } else {
        errorDiv.textContent = '';
    }
}
    // Khởi tạo khi tải trang
    document.addEventListener('DOMContentLoaded', function() {
        const initialParentId = /*[[${documentDTO.parentId != null ? documentDTO.parentId : 0}]]*/ 0;
        if (initialParentId > 0) {
            let currentId = initialParentId;
            let level = 1;
            while (currentId > 0 && level <= 3) {
                const select = document.getElementById(`level${level}Select`);
                const category = rootCategories.find(c => c.id == currentId);
                if (category) {
                    select.value = currentId;
                    onLevelChange(level);
                    currentId = category.parentId || 0;
                    level++;
                } else {
                    break;
                }
            }
        }
    });
   
    </script>
</body>
</html>
