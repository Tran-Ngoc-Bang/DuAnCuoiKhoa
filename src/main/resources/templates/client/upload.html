<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒêƒÉng t·∫£i t√†i li·ªáu - EduShare</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700&family=Open+Sans:wght@400;500;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <link rel="stylesheet" th:href="@{/css/responsive.css}">
    <link rel="stylesheet" th:href="@{/css/main-fixes.css}">
    <link rel="stylesheet" th:href="@{/css/upload.css}">
    <link rel="stylesheet" th:href="@{/css/upload-modern.css}">
    <link rel="stylesheet" th:href="@{/css/footer-modern.css}">
    <link rel="stylesheet" th:href="@{/css/client-header.css}">
    <link rel="stylesheet" th:href="@{/css/client-footer.css}">
    <style>
    /* Tag Selector Styles */
    .selected-tags-container {
        margin-bottom: 15px;
        border: 1px solid #e1e5e9;
        border-radius: 8px;
        background: #f8f9fa;
        min-height: 60px;
    }
    
    .selected-tags-header {
        padding: 10px 15px;
        border-bottom: 1px solid #e1e5e9;
        background: #fff;
        border-radius: 8px 8px 0 0;
        font-size: 14px;
        color: #6c757d;
        font-weight: 500;
    }
    
    .selected-tags {
        padding: 15px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        min-height: 40px;
        align-items: flex-start;
    }
    
    .selected-tag {
        display: inline-flex;
        align-items: center;
        background: #e3f2fd;
        color: #1976d2;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 500;
        border: 1px solid #bbdefb;
        transition: all 0.2s ease;
    }
    
    .selected-tag:hover {
        background: #bbdefb;
        transform: translateY(-1px);
    }
    
    .selected-tag .remove-tag {
        margin-left: 8px;
        cursor: pointer;
        color: #1976d2;
        font-weight: bold;
        font-size: 16px;
        line-height: 1;
    }
    
    .selected-tag .remove-tag:hover {
        color: #d32f2f;
    }
    
    .tag-search-container {
        position: relative;
        margin-bottom: 10px;
    }
    
    .tag-search-input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
    }
    
    .tag-search-input {
        width: 100%;
        padding: 12px 40px 12px 16px;
        border: 2px solid #e1e5e9;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.2s ease;
        background: #fff;
    }
    
    .tag-search-input:focus {
        outline: none;
        border-color: #4285f4;
        box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
    }
    
    .tag-dropdown-icon {
        position: absolute;
        right: 16px;
        color: #6c757d;
        pointer-events: none;
        transition: transform 0.2s ease;
    }
    
    .tag-search-input:focus + .tag-dropdown-icon {
        transform: rotate(180deg);
    }
    
    .tag-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #fff;
        border: 1px solid #e1e5e9;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        max-height: 300px;
        overflow-y: auto;
        display: none;
    }
    
    .tag-dropdown.show {
        display: block;
    }
    
    .tag-results {
        padding: 8px 0;
    }
    
    .tag-results-header {
        padding: 12px 16px;
        background-color: #f8f9fa;
        border-bottom: 1px solid #e1e5e9;
        font-size: 13px;
        color: #6c757d;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .tag-result-item {
        padding: 12px 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: background-color 0.2s ease;
        border-bottom: 1px solid #f1f3f4;
    }
    
    .tag-result-item:last-child {
        border-bottom: none;
    }
    
    .tag-result-item:hover {
        background-color: #f8f9fa;
    }
    
    .tag-result-item.selected {
        background-color: #e3f2fd;
        color: #1976d2;
    }
    
    .tag-result-name {
        font-size: 14px;
        font-weight: 500;
    }
    
    .tag-result-count {
        font-size: 12px;
        color: #6c757d;
        background: #f1f3f4;
        padding: 2px 8px;
        border-radius: 12px;
    }
    
    .create-new-tag {
        background-color: #f8f9fa;
        border-top: 1px solid #e1e5e9;
        color: #1976d2;
        font-weight: 500;
    }
    
    .create-new-tag:hover {
        background-color: #e3f2fd;
    }
    
    .create-new-tag .fas {
        margin-right: 8px;
        color: #4caf50;
    }
    
    .popular-tags {
        margin-top: 15px;
    }
    
    .popular-tags-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 8px;
    }
    
    .popular-tag-badge {
        display: inline-flex;
        align-items: center;
        background: #f1f3f4;
        color: #5f6368;
        padding: 6px 12px;
        border-radius: 16px;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid #e1e5e9;
    }
    
    .popular-tag-badge:hover {
        background: #e8f0fe;
        color: #1976d2;
        border-color: #4285f4;
        transform: translateY(-1px);
    }
    
    .no-results {
        padding: 20px;
        text-align: center;
        color: #6c757d;
        font-style: italic;
    }
    
    /* Responsive styles */
    @media (max-width: 768px) {
        .selected-tags {
            padding: 10px;
        }
        
        .selected-tag {
            font-size: 12px;
            padding: 4px 8px;
        }
        
        .tag-search-input {
            padding: 10px 35px 10px 12px;
            font-size: 14px;
        }
        
        .popular-tags-list {
            gap: 6px;
        }
        
        .popular-tag-badge {
            font-size: 12px;
            padding: 4px 8px;
        }
    }
    
    /* Animation for tag addition */
    @keyframes tagAdded {
        0% {
            transform: scale(0.8);
            opacity: 0;
        }
        50% {
            transform: scale(1.1);
        }
        100% {
            transform: scale(1);
            opacity: 1;
        }
    }
    
    .selected-tag.new-tag {
        animation: tagAdded 0.3s ease-out;
    }
    .input-group {
    position: relative;
    display: flex;
    align-items: center;
    width: 100%;
    max-width: 300px; /* ƒêi·ªÅu ch·ªânh ƒë·ªô r·ªông t·ªëi ƒëa t√πy √Ω */
    margin-bottom: 15px;
}

.input-group .fas {
    position: absolute;
    left: 15px;
    color: #555;
    font-size: 1.1em;
    z-index: 1;
    pointer-events: none;
}

.input-group .form-input {
    width: 100%;
    padding: 12px 15px 12px 45px; /* TƒÉng padding tr√°i ƒë·ªÉ tr√°nh ch·ªìng l·∫•p icon */
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 1em;
    box-sizing: border-box;
    transition: border-color 0.3s;
}

.input-group .form-input:focus {
    border-color: #007bff;
    outline: none;
    box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);

}

.input-group .form-input:invalid {
    border-color: #dc3545;
}

.input-group .form-input:invalid + .error-message {
    display: block;
}

.error-message {
    display: none;
    color: #dc3545;
    font-size: 0.9em;
    margin-top: 5px;
}

/* Price Input Specific Styles */
.price-input .input-group {
    max-width: 350px;
    margin: 0 auto;
    position: relative;
}

.price-input .input-group .form-input {
    font-size: 20px;
    font-weight: 600;
    text-align: center;
    padding: 20px 1px;
    height: 70px;
    border: 2px solid #e1e5e9;
    border-radius: 12px;
    background: #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    width: 100%;
    box-sizing: border-box;
}

.price-input .input-group .form-input:focus {
    border-color: #f39c12;
    box-shadow: 0 0 0 3px rgba(243, 156, 18, 0.1);
    outline: none;
}

.price-input .input-group .fas.fa-coins {
    position: absolute;
    left: 20px;
    top: 50%;
    transform: translateY(-50%);
    color: #f39c12;
    font-size: 1.5em;
    z-index: 1;
    pointer-events: none;
}

.price-input label {
    font-size: 18px;
    font-weight: 600;
    color: #374151;
    margin-bottom: 12px;
    display: block;
    text-align: center;
}

#priceError {
    margin-top: 10px;
    font-size: 14px;
    text-align: center;
}
</style>
       
</head>
<body>
    <!-- Decorative Background Elements -->
    <div class="decorative-shapes">
        <div class="shape shape-1"></div>
        <div class="shape shape-2"></div>
        <div class="shape shape-3"></div>
        <div class="shape shape-4"></div>
    </div>
    <!-- Header -->
    <div th:replace="~{fragments/client/layout :: header}"></div>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <a href="../index.html">
                        <div class="logo-icon">E</div>
                        <span class="logo-text">EduShare</span>
                    </a>
                </div>
                <nav class="main-nav">
                    <a href="../index.html" class="nav-link">Trang ch·ªß</a>
                    <a href="categories.html" class="nav-link">Danh m·ª•c</a>
                    <a href="search.html?sort=newest" class="nav-link">T√†i li·ªáu m·ªõi</a>
                    <a href="search.html?filter=premium" class="nav-link">Cao c·∫•p</a>
                    <a href="about.html" class="nav-link">Gi·ªõi thi·ªáu</a>
                </nav>
                <div class="header-actions">
                    <div class="search-box">
                        <input type="text" id="headerSearchInput" placeholder="T√¨m ki·∫øm t√†i li·ªáu...">
                        <button id="headerSearchBtn">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                              <button class="dark-mode-toggle" id="darkModeToggle" type="button" aria-label="Toggle dark mode">
            <span class="dark-mode-handle" id="darkModeHandle"></span>
          </button>
                    <a href="login.html" class="login-btn">ƒêƒÉng nh·∫≠p</a>
                    <a href="register.html" class="register-btn">ƒêƒÉng k√Ω</a>
                </div>
                <div class="mobile-menu-toggle" id="mobileMenuBtn">
                    <i class="fas fa-bars"></i>
                </div>
            </div>
        </div>
        <!-- Mobile menu -->
        <div id="mobileMenu" class="mobile-menu">
            <div class="mobile-search">
                <input type="text" placeholder="T√¨m ki·∫øm t√†i li·ªáu...">
                <button>
                    <i class="fas fa-search"></i>
                </button>
            </div>
            <nav class="mobile-nav">
                <a href="../index.html" class="mobile-nav-link">Trang ch·ªß</a>
                <a href="categories.html" class="mobile-nav-link">Danh m·ª•c</a>
                <a href="search.html?sort=newest" class="mobile-nav-link">T√†i li·ªáu m·ªõi</a>
                <a href="search.html?filter=premium" class="mobile-nav-link">Cao c·∫•p</a>
                <a href="#" class="mobile-nav-link">H∆∞·ªõng d·∫´n</a>
            </nav>
            <div class="mobile-auth">
                <a href="login.html" class="mobile-login-btn">ƒêƒÉng nh·∫≠p</a>
                <a href="register.html" class="mobile-register-btn">ƒêƒÉng k√Ω</a>
            </div>
        </div>
    </header>
    
    <!-- Main Content -->
    <main>
        <section class="upload-section">
            <div class="container">
                <div class="upload-header">
                    <div class="header-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <h1 class="page-title">ƒêƒÉng t·∫£i t√†i li·ªáu</h1>
                    <p class="page-description">Chia s·∫ª ki·∫øn th·ª©c c·ªßa b·∫°n v√† gi√∫p ƒë·ª° c·ªông ƒë·ªìng h·ªçc t·∫≠p</p>
                     <div class="error-message" th:if="${error}" th:text="${error}"></div>
                    <div class="success-message" th:if="${success}" th:text="${success}"></div> 
                </div>
                
                <div class="upload-container">
                    <div class="upload-steps">
                        <div class="step"  th:classappend="${currentStep == 1} ? 'active' : (${currentStep > 1} ? 'completed' : '')" data-step="1">
                            <div class="step-number">1</div>
                            <div class="step-label">T·∫£i l√™n t√†i li·ªáu</div>
                        </div>
                        <div class="step" th:classappend="${currentStep == 2} ? 'active' : (${currentStep > 2} ? 'completed' : '')" data-step="2">
                            <div class="step-number">2</div>
                            <div class="step-label">Th√¥ng tin t√†i li·ªáu</div>
                        </div>
                        <div class="step" th:classappend="${currentStep == 3} ? 'active' : (${currentStep > 3} ? 'completed' : '')" data-step="3">
                            <div class="step-number">3</div>
                            <div class="step-label">Gi√° c·ªßa t√†i li·ªáu</div>
                        </div>
                        <div class="step" th:classappend="${currentStep == 4} ? 'active' : ''" data-step="4">
                            <div class="step-number">4</div>
                            <div class="step-label">Ho√†n t·∫•t</div>
                        </div>
                    </div>
                    
                    <!-- Step 1: Upload File -->
                    <div class="upload-step-content" th:classappend="${currentStep == 1} ? 'active' : ''" data-step="1">
                        <div class="upload-dropzone" id="uploadDropzone">
                             <form th:action="@{/upload/step1}" method="post" enctype="multipart/form-data">
                            <input type="file" id="fileInput"  name="file" class="file-input" accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx">
                            <div class="dropzone-content">
                                <div class="dropzone-icon">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </div>
                                <h3 class="dropzone-title">K√©o th·∫£ t√†i li·ªáu t·∫°i ƒë√¢y</h3>
                                <p class="dropzone-description">ho·∫∑c</p>
                                <button type="button" class="btn btn-primary browse-btn">Ch·ªçn t√†i li·ªáu</button>
                                <p class="file-requirements">H·ªó tr·ª£ t·∫≠p tin: PDF, DOC, DOCX, PPT, PPTX, XLS, XLSX <br> K√≠ch th∆∞·ªõc t·ªëi ƒëa: 100MB</p>
                            </div>
                            
                            <div class="upload-preview" th:style="${fileName != null} ? 'display: block;' : 'display: none;'">
                                <div class="preview-header">
                                    <div class="preview-file-info">
                                        <div class="preview-file-icon">
                                            <i th:class="${fileType == 'PDF' ? 'fas fa-file-pdf' : 
               fileType == 'DOC' || fileType == 'DOCX' ? 'fas fa-file-word' : 
               fileType == 'XLS' || fileType == 'XLSX' ? 'fas fa-file-excel' : 
               fileType == 'PPT' || fileType == 'PPTX' ? 'fas fa-file-powerpoint' : 
               'fas fa-file'}"></i>
                                        </div>
                                        <div class="preview-file-details">
                                            <div class="preview-file-name" th:text="${fileName}">document.pdf</div>
                                            <div class="preview-file-meta">
                                                <span class="file-size" th:text="${fileSize != null} ? ${#numbers.formatDecimal(fileSize / 1024.0 / 1024.0, 0, 2, 'COMMA')} + ' MB' : 'N/A'"></span>
                                                <span class="file-type" th:text="${fileType}"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-outline btn-sm change-file-btn">
                                        <i class="fas fa-exchange-alt"></i> ƒê·ªïi t√†i li·ªáu
                                    </button>
                                </div>
                                
                                <div class="upload-progress">
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: 65%;"></div>
                                    </div>
                                    <div class="progress-text">ƒêang t·∫£i l√™n... 65%</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="upload-tips">
                            <h3 class="tips-title"><i class="fas fa-lightbulb"></i> M·∫πo ƒëƒÉng t·∫£i</h3>
                            <ul class="tips-list">
                                <li>Ch·ªâ ƒëƒÉng t·∫£i t√†i li·ªáu m√† b·∫°n c√≥ quy·ªÅn ph√¢n ph·ªëi.</li>
                                <li>ƒê·∫£m b·∫£o t√†i li·ªáu kh√¥ng c√≥ n·ªôi dung vi ph·∫°m b·∫£n quy·ªÅn.</li>
                                <li>Ch·∫•t l∆∞·ª£ng t√†i li·ªáu c√†ng cao, x·∫øp h·∫°ng v√† thu nh·∫≠p c·ªßa b·∫°n c√†ng t·ªët.</li>
                                <li>T√†i li·ªáu ƒë·ªôc quy·ªÅn (ch∆∞a c√≥ tr√™n n·ªÅn t·∫£ng) s·∫Ω ƒë∆∞·ª£c ∆∞u ti√™n hi·ªÉn th·ªã.</li>
                                <li>C√°c t√†i li·ªáu s·∫Ω ƒë∆∞·ª£c ki·ªÉm duy·ªát tr∆∞·ªõc khi xu·∫•t b·∫£n c√¥ng khai.</li>
                            </ul>
                        </div>
                        
                        <div class="step-actions">
                            <button type="submit" class="btn btn-primary next-step" id="step1Next" th:disabled="${fileName == null}">Ti·∫øp theo</button>
                        </div>
                        </form>
                    </div>
                    
                 <!-- Step 2: Document Info -->
<div class="upload-step-content" th:classappend="${currentStep == 2} ? 'active' : ''" data-step="2">
    <form class="document-form" th:action="@{/upload/step2}" th:object="${documentDTO}" method="post">
        <div class="form-grid">
            <div class="form-group full-width">
                <label for="docTitle">Ti√™u ƒë·ªÅ t√†i li·ªáu<span class="required">*</span></label>
                <input type="text" id="docTitle" name="title" class="form-input" th:field="*{title}" placeholder="Nh·∫≠p ti√™u ƒë·ªÅ m√¥ t·∫£ t√†i li·ªáu" required>
            </div>
             <div class="form-group">
            <!-- Ph√¢n lo·∫°i danh m·ª•c ƒëa c·∫•p -->
            <label>Ch·ªçn danh m·ª•c cha <span class="required">*</span></label>
            
            <!-- Level 1: Root categories -->
            <div class="category-level" id="level1">
                <label for="level1Select" class="level-label">C·∫•p 1 - Danh m·ª•c g·ªëc:</label>
                <select id="level1Select" class="form-select level-select" onchange="onLevelChange(1)" th:name="parentId">
                    <option value="0">üè† Danh m·ª•c g·ªëc (kh√¥ng c√≥ cha)</option>
                    <option th:each="parent : ${rootCategories}"
                            th:value="${parent.id}"
                            th:text="'üìÇ ' + ${parent.name}"
                            th:attr="data-subcategories=${parent.subcategories}">
                    </option>
                </select>
            </div>
            
            <!-- Level 2: Subcategories -->
            <div class="category-level" id="level2" style="display: none;">
                <label for="level2Select" class="level-label">C·∫•p 2 - Danh m·ª•c con:</label>
                <select id="level2Select" class="form-select level-select" onchange="onLevelChange(2)" th:name="parentId">
                    <option value="">Ch·ªçn danh m·ª•c con...</option>
                </select>
            </div>
            
            <!-- Level 3: Sub-subcategories -->
            <div class="category-level" id="level3" style="display: none;">
                <label for="level3Select" class="level-label">C·∫•p 3 - Danh m·ª•c con c·∫•p 2:</label>
                <select id="level3Select" class="form-select level-select" onchange="onLevelChange(3)" th:name="parentId">
                    <option value="">Ch·ªçn danh m·ª•c con c·∫•p 2...</option>
                </select>
            </div>
            
            <!-- Hidden input for final parent selection -->
            <input type="hidden" id="finalParentId" name="parentId" th:value="${documentDTO.parentId != null ? documentDTO.parentId : 0}">
            
            <!-- Hidden input for all categoryIds -->
            <input type="hidden" id="categoryIds" name="categoryIds" value="">

            <!-- Breadcrumb hi·ªÉn th·ªã ƒë∆∞·ªùng d·∫´n ƒë√£ ch·ªçn -->
            <div id="categoryBreadcrumb" style="margin-top: 10px; display: none;">
                <div style="padding: 8px 12px; background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 4px;">
                    <strong>ƒê∆∞·ªùng d·∫´n ƒë√£ ch·ªçn:</strong>
                    <div id="breadcrumbPath" style="margin-top: 5px; font-family: monospace;"></div>
                </div>
            </div>
             </div>
            
            <div class="form-group full-width">
                <label for="docDescription">M√¥ t·∫£ t√†i li·ªáu<span class="required">*</span></label>
                <textarea id="docDescription" name="description" th:field="*{description}" class="form-input" rows="5" placeholder="M√¥ t·∫£ ng·∫Øn g·ªçn v·ªÅ n·ªôi dung t√†i li·ªáu" required></textarea>
            </div>
            <!-- Hi·ªÉn th·ªã tag ph·ªï bi·∫øn v√† t√¨m ki·∫øm tag -->
           <div class="form-group">
                <label for="docTags">Ch·ªçn t·ª´ kh√≥a tags (t·ªëi ƒëa 20)</label>
                <!-- Tag Search Input -->
                <div class="tag-search-container">
                    <div class="tag-search-input-wrapper">
                        <input type="text" id="tagSearchInput" class="tag-search-input" placeholder="T√¨m ki·∫øm t·ª´ kh√≥a..." autocomplete="off">
                        <i class="fas fa-chevron-down tag-dropdown-icon"></i>
                    </div>
                    
                    <!-- Dropdown Results -->
                    <div id="tagDropdown" class="tag-dropdown">
                        <div id="tagResults" class="tag-results"></div>
                    </div>
                </div>
                <!-- Selected Tags Display -->
                <div id="selectedTagsContainer" class="selected-tags-container">
                    <div class="selected-tags-header">
                        <span class="selected-count">Danh s√°ch t·ª´ kh√≥a (<span id="tagCount">0</span>/20)</span>
                    </div>
                    <div id="selectedTags" class="selected-tags"></div>
                </div>
                
                
                
                <div class="form-hint">Th√™m t·ª´ kh√≥a gi√∫p t√†i li·ªáu c·ªßa b·∫°n d·ªÖ d√†ng ƒë∆∞·ª£c t√¨m th·∫•y h∆°n</div>
                
                <!-- Popular Tags 
                <div id="popularTags" class="popular-tags" style="margin-top: 15px;">
                    <strong>T·ª´ kh√≥a ph·ªï bi·∫øn:</strong>
                    <div class="popular-tags-list">
                        <div th:if="${popularTags != null and not #lists.isEmpty(popularTags)}" th:each="tag : ${popularTags}" class="popular-tag-item">
                            <span class="popular-tag-badge" th:attr="data-tag=${tag.name}" onclick="addTagFromPopular(this.getAttribute('data-tag'))">
                                <span th:text="${tag.name}"></span>
                            </span>
                        </div>
                        <div th:unless="${popularTags != null and not #lists.isEmpty(popularTags)}" style="color: #888;">Kh√¥ng c√≥ t·ª´ kh√≥a ph·ªï bi·∫øn.</div>
                    </div>
                </div>-->
                
                <input type="hidden" id="tagNames" name="tags" value="">
            </div>
        </div>
        
        <div class="step-actions">
            <button type="button" class="btn btn-outline prev-step" data-prev="1">Quay l·∫°i</button>
            <button type="submit" class="btn btn-primary next-step" id="step2Next" onclick="updateHiddenInput()">Ti·∫øp theo</button>
        </div>
    </form>
</div>
                    
                    <!-- Step 3: Settings & Preview -->
                    <div class="upload-step-content"  th:classappend="${currentStep == 3} ? 'active' : ''" data-step="3">
                         <form th:action="@{/upload/step3}" method="post">
                        <div class="setting-sections">
                            <div class="setting-section">
                                <h3 class="section-title">C√†i ƒë·∫∑t quy·ªÅn truy c·∫≠p</h3>
           
                                <div class="form-group">
                                    <label class="setting-label">Lo·∫°i truy c·∫≠p</label>
                                    <div class="toggle-options">
                                        <label class="toggle-option">
                                            <input type="radio" name="accessType" value="0" checked>
                                            <span class="option-label"><i class="fas fa-unlock-alt"></i> Mi·ªÖn ph√≠</span>
                                            <span class="option-description">Ai c≈©ng c√≥ th·ªÉ xem v√† t·∫£i xu·ªëng t√†i li·ªáu n√†y</span>
                                        </label>
                                        <label class="toggle-option">
                                            <input type="radio" name="accessType" value="premium">
                                            <span class="option-label"><i class="fas fa-coins"></i> Tr·∫£ ph√≠</span>
                                            <span class="option-description">Ng∆∞·ªùi d√πng ph·∫£i tr·∫£ xu ƒë·ªÉ t·∫£i xu·ªëng t√†i li·ªáu n√†y</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div id="priceSettings" class="price-settings" style="display: none;">
                                    <div class="price-input">
                                        <label for="docPrice">Gi√° t√†i li·ªáu (xu)</label>
                                        <div class="input-group">
                                         
                                            <input type="number" id="docPrice" name="price" class="form-input" placeholder="Nh·∫≠p s·ªë xu" min="10" max="1000" value="50" oninput="validatePrice(this)">
                                            <div id="priceError" class="error-message"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="price-settings-info">
                                        <h4><i class="fas fa-info-circle"></i> Th√¥ng tin thu nh·∫≠p</h4>
                                        <div class="price-calculation">
                                            <span>Gi√° t√†i li·ªáu:</span>
                                            <span><span id="priceValue">50</span> xu</span>
                                        </div>
                                        <div class="price-calculation">
                                            <span>Ph√≠ n·ªÅn t·∫£ng (30%):</span>
                                            <span>-<span id="platformFee">15</span> xu</span>
                                        </div>
                                        <div class="price-calculation">
                                            <span>Thu nh·∫≠p c·ªßa b·∫°n:</span>
                                            <span><span id="authorEarning">35</span> xu</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                        <!--  <div class="setting-section">
                                <h3 class="section-title">C√†i ƒë·∫∑t xem tr∆∞·ªõc</h3>
                                
                                <div class="form-group">
                                    <label class="setting-label">Cho ph√©p xem tr∆∞·ªõc</label>
                                    <div class="toggle-options">
                                        <label class="toggle-option">
                                            <input type="radio" name="previewType" value="enable" checked>
                                            <span class="option-label"><i class="fas fa-eye"></i> B·∫≠t xem tr∆∞·ªõc</span>
                                            <span class="option-description">Ng∆∞·ªùi d√πng c√≥ th·ªÉ xem tr∆∞·ªõc m·ªôt s·ªë trang c·ªßa t√†i li·ªáu</span>
                                        </label>
                                        <label class="toggle-option">
                                            <input type="radio" name="previewType" value="disable">
                                            <span class="option-label"><i class="fas fa-eye-slash"></i> T·∫Øt xem tr∆∞·ªõc</span>
                                            <span class="option-description">Ng∆∞·ªùi d√πng ch·ªâ th·∫•y th√¥ng tin t√†i li·ªáu m√† kh√¥ng xem ƒë∆∞·ª£c n·ªôi dung</span>
                                        </label>
                                    </div>
                                </div> 
                                
                              <div id="previewSettings" class="preview-settings">
                                    <label for="previewPages">S·ªë trang xem tr∆∞·ªõc:</label>
                                    <div class="preview-slider">
                                        <div class="slider-container">
                                            <div class="slider">
                                                <div class="slider-track" style="width: 30%"></div>
                                                <div class="slider-thumb" style="left: 30%"></div>
                                            </div>
                                            <div class="slider-value" id="previewPagesValue">3</div>
                                        </div>
                                        <div class="preview-info">
                                            <p class="preview-description">Cho ph√©p ng∆∞·ªùi xem ƒë·ªçc tr∆∞·ªõc <strong id="previewCount">3</strong> trang ƒë·∫ßu ti√™n tr∆∞·ªõc khi t·∫£i xu·ªëng</p>
                                        </div>
                                    </div>
                                </div>
                            </div> --> 
                            
                      <!--     <div class="setting-section">
                                <h3 class="section-title">T√†i li·ªáu li√™n quan</h3>
                                
                                <div class="form-group">
                                    <label class="setting-label">G·ª£i √Ω t√†i li·ªáu</label>
                                    <div class="toggle-options">
                                        <label class="toggle-option">
                                            <input type="radio" name="relatedDocs" value="auto" checked>
                                            <span class="option-label"><i class="fas fa-magic"></i> T·ª± ƒë·ªông</span>
                                            <span class="option-description">H·ªá th·ªëng t·ª± ƒë·ªông g·ª£i √Ω t√†i li·ªáu li√™n quan d·ª±a tr√™n n·ªôi dung</span>
                                        </label>
                                        <label class="toggle-option">
                                            <input type="radio" name="relatedDocs" value="manual">
                                            <span class="option-label"><i class="fas fa-edit"></i> Th·ªß c√¥ng</span>
                                            <span class="option-description">B·∫°n t·ª± ch·ªçn c√°c t√†i li·ªáu li√™n quan t·ª´ t√†i li·ªáu c·ªßa m√¨nh</span>
                                        </label>
                                    </div>
                                </div>
                                
                             <div id="manualRelatedDocs" style="display: none;">
                                    <div class="related-docs-selector">
                                        <div class="search-related">
                                            <input type="text" placeholder="T√¨m ki·∫øm t√†i li·ªáu c·ªßa b·∫°n...">
                                            <button><i class="fas fa-search"></i></button>
                                        </div>
                                        <div class="related-docs-list">
                                            <p class="empty-state">B·∫°n ch∆∞a c√≥ t√†i li·ªáu n√†o kh√°c ƒë∆∞·ª£c xu·∫•t b·∫£n</p>
                                        </div>
                                    </div>
                                </div>
                            </div>-->
                        </div>
                        
                        <div class="step-actions">
                             <a href="/upload" class="btn btn-outline prev-step">Quay l·∫°i</a>
                            <button type="submit" class="btn btn-primary next-step" id="publishBtn">Xu·∫•t b·∫£n</button>
                        </div>
                        </form>
                    </div>
                    
                    <!-- Step 4: Completion -->
                    <div class="upload-step-content" th:classappend="${currentStep == 4} ? 'active' : ''" data-step="4">
                        <div class="completion-message">
                            <div class="completion-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <h2 class="completion-title">T·∫£i l√™n th√†nh c√¥ng!</h2>
                            <div class="confetti-container" id="confetti"></div>
                            <p class="completion-description">
                                T√†i li·ªáu c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c t·∫£i l√™n v√† ƒëang ch·ªù ki·ªÉm duy·ªát. Qu√° tr√¨nh n√†y th∆∞·ªùng m·∫•t 24-48 gi·ªù. 
                                B·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o khi t√†i li·ªáu ƒë∆∞·ª£c duy·ªát v√† c√¥ng khai.
                                <br><br>
                                ID t√†i li·ªáu: <span class="document-id" th:text="${documentId}" >DOC-2023120001</span>
                            </p>
                            
                            <div class="completion-actions">
                                <a href="account/documents" class="btn btn-outline">
                                    <i class="fas fa-file-alt"></i> Qu·∫£n l√Ω t√†i li·ªáu
                                </a>
                                <form th:action="@{/upload/reset}" method="post" style="display: inline;">
                                <button class="btn btn-primary" id="uploadAnotherBtn">
                                    <i class="fas fa-plus"></i> T·∫£i l√™n t√†i li·ªáu kh√°c
                                </button>
                                   </form>
                            </div>
                            
                          <!--  <div class="completion-stats">
                                <div class="stat-card">
                                    <div class="stat-value" th:text="${#numbers.formatInteger(numDocuments, 0, 'DEFAULT')}">5</div>
                                    <div class="stat-label">T√†i li·ªáu ƒë√£ t·∫£i</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" th:text="${#numbers.formatInteger(numDownloads, 0, 'DEFAULT')}">125</div>
                                    <div class="stat-label">L∆∞·ª£t t·∫£i xu·ªëng</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" th:text="${#numbers.formatInteger(numPoints, 0, 'DEFAULT')}">2,500</div>
                                    <div class="stat-label">Xu ƒë√£ ki·∫øm ƒë∆∞·ª£c</div>
                                </div>
                            </div> -->
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <!-- Footer -->
    <div th:replace="~{fragments/client/layout :: footer}"></div>
    
    <!-- Scripts -->
    <script th:src="@{/js/main.js}"></script>
    <script th:src="@{/js/upload.js}"></script>
    <script th:src="@{/js/client-header.js}"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // T·∫°o hi·ªáu ·ª©ng confetti khi ƒë·∫øn b∆∞·ªõc ho√†n th√†nh
            function createConfetti() {
                const confettiContainer = document.getElementById('confetti');
                if (!confettiContainer) return;
                
                for (let i = 0; i < 100; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti-piece';
                    confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 80%, 60%)`;
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.width = Math.random() * 10 + 5 + 'px';
                    confetti.style.height = Math.random() * 10 + 5 + 'px';
                    confetti.style.animationDuration = Math.random() * 3 + 2 + 's';
                    confetti.style.animationDelay = Math.random() * 2 + 's';
                    confettiContainer.appendChild(confetti);
                }
            }
            
            // Th√™m animation cho c√°c shapes
            const shapes = document.querySelectorAll('.shape');
            shapes.forEach((shape, index) => {
                shape.style.animationDelay = `${index * 0.2}s`;
            });
            // File Upload
            const dropzone = document.getElementById('uploadDropzone');
            const fileInput = document.getElementById('fileInput');
            const browseBtn = document.querySelector('.browse-btn');
            const changeFileBtn = document.querySelector('.change-file-btn');
            const uploadPreview = document.querySelector('.upload-preview');
            const dropzoneContent = document.querySelector('.dropzone-content');
            const step1NextBtn = document.getElementById('step1Next');
            
            // Simulate file upload when a file is selected
            fileInput.addEventListener('change', function(e) {
                if (this.files.length > 0) {
                    const file = this.files[0];
                    simulateFileUpload(file);
                }
            });
            
            // Open file browser when browse button is clicked
            browseBtn.addEventListener('click', function(e) {
                e.preventDefault();
                fileInput.click();
            });
            
            // Change file button
            if (changeFileBtn) {
                changeFileBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    resetFileUpload();
                    fileInput.click();
                });
            }
            
            // Handle drag and drop
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropzone.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropzone.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropzone.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                dropzone.classList.add('drag-over');
            }
            
            function unhighlight() {
                dropzone.classList.remove('drag-over');
            }
            
            dropzone.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    simulateFileUpload(files[0]);
                }
            }
            
            function simulateFileUpload(file) {
                // Update file preview
                const fileIcon = document.querySelector('.preview-file-icon i');
                const fileName = document.querySelector('.preview-file-name');
                const fileSize = document.querySelector('.file-size');
                const fileType = document.querySelector('.file-type');
                
                // Set appropriate icon based on file type
                const extension = file.name.split('.').pop().toLowerCase();
                let iconClass = 'fas fa-file';
                
                if (['pdf'].includes(extension)) {
                    iconClass = 'fas fa-file-pdf';
                } else if (['doc', 'docx'].includes(extension)) {
                    iconClass = 'fas fa-file-word';
                } else if (['xls', 'xlsx'].includes(extension)) {
                    iconClass = 'fas fa-file-excel';
                } else if (['ppt', 'pptx'].includes(extension)) {
                    iconClass = 'fas fa-file-powerpoint';
                }
                
                fileIcon.className = iconClass;
                fileName.textContent = file.name;
                fileSize.textContent = formatFileSize(file.size);
                fileType.textContent = extension.toUpperCase();
                
                // Show upload preview and hide dropzone content
                dropzoneContent.style.display = 'none';
                uploadPreview.style.display = 'block';
                
                // Simulate progress
                simulateProgress();
            }
            
            function resetFileUpload() {
                // Reset file input
                fileInput.value = '';
                
                // Hide upload preview and show dropzone content
                dropzoneContent.style.display = 'block';
                uploadPreview.style.display = 'none';
                
                // Reset progress
                const progressFill = document.querySelector('.progress-fill');
                const progressText = document.querySelector('.progress-text');
                
                progressFill.style.width = '0%';
                progressText.textContent = 'ƒêang t·∫£i l√™n... 0%';
                
                // Disable next button
                step1NextBtn.disabled = true;
            }
            
            function simulateProgress() {
                const progressFill = document.querySelector('.progress-fill');
                const progressText = document.querySelector('.progress-text');
                
                let progress = 0;
                const interval = setInterval(() => {
                    progress += 5;
                    progressFill.style.width = `${progress}%`;
                    progressText.textContent = `ƒêang t·∫£i l√™n... ${progress}%`;
                    
                    if (progress >= 100) {
                        clearInterval(interval);
                        progressText.textContent = 'ƒê√£ t·∫£i l√™n 100%';
                        // Enable next button
                        step1NextBtn.disabled = false;
                    }
                }, 150);
            }
            
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            // Multi-step form navigation
            const steps = document.querySelectorAll('.step');
            const stepContents = document.querySelectorAll('.upload-step-content');
            const nextButtons = document.querySelectorAll('.next-step');
            const prevButtons = document.querySelectorAll('.prev-step');
            
            nextButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Get current step
                    const currentStepContent = document.querySelector('.upload-step-content.active');
                    const currentStepNumber = parseInt(currentStepContent.dataset.step);
                    
                    // Validate current step (if needed)
                    if (currentStepNumber === 2) {
                        const title = document.getElementById('docTitle').value;
                        const category = document.getElementById('docCategory').value;
                        const description = document.getElementById('docDescription').value;
                        
                        if (!title || !category || !description) {
                            alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc.');
                            return;
                        }
                    }
                    
                    // Hide current step
                    currentStepContent.classList.remove('active');
                    document.querySelector(`.step[data-step="${currentStepNumber}"]`).classList.remove('active');
                    document.querySelector(`.step[data-step="${currentStepNumber}"]`).classList.add('completed');
                    
                    // Show next step
                    const nextStepNumber = currentStepNumber + 1;
                    document.querySelector(`.upload-step-content[data-step="${nextStepNumber}"]`).classList.add('active');
                    document.querySelector(`.step[data-step="${nextStepNumber}"]`).classList.add('active');
                    
                    // T·∫°o hi·ªáu ·ª©ng confetti khi ƒë·∫øn b∆∞·ªõc ho√†n th√†nh
                    if (nextStepNumber === 4) {
                        createConfetti();
                    }
                });
            });
            
            prevButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Get current step
                    const currentStepContent = document.querySelector('.upload-step-content.active');
                    const currentStepNumber = parseInt(currentStepContent.dataset.step);
                    
                    // Get previous step number (from button data-prev attribute if exists)
                    const prevStepNumber = this.dataset.prev ? parseInt(this.dataset.prev) : currentStepNumber - 1;
                    
                    // Hide current step
                    currentStepContent.classList.remove('active');
                    document.querySelector(`.step[data-step="${currentStepNumber}"]`).classList.remove('active');
                    
                    // Show previous step
                    document.querySelector(`.upload-step-content[data-step="${prevStepNumber}"]`).classList.add('active');
                    document.querySelector(`.step[data-step="${prevStepNumber}"]`).classList.add('active');
                    document.querySelector(`.step[data-step="${prevStepNumber}"]`).classList.remove('completed');
                });
            });
            
            // Upload Another button
            const uploadAnotherBtn = document.getElementById('uploadAnotherBtn');
            if (uploadAnotherBtn) {
                uploadAnotherBtn.addEventListener('click', function() {
                    // Reset everything and go back to step 1
                    resetFileUpload();
                    
                    // Hide current step
                    document.querySelector('.upload-step-content.active').classList.remove('active');
                    document.querySelectorAll('.step').forEach(step => {
                        step.classList.remove('active');
                        step.classList.remove('completed');
                    });
                    
                    // Show step 1
                    document.querySelector('.upload-step-content[data-step="1"]').classList.add('active');
                    document.querySelector('.step[data-step="1"]').classList.add('active');
                });
            }
            
            // Price settings toggle
            const accessTypeRadios = document.querySelectorAll('input[name="accessType"]');
            accessTypeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const priceSettings = document.getElementById('priceSettings');
                    if (this.value === 'premium') {
                        priceSettings.style.display = 'grid';
                    } else {
                        priceSettings.style.display = 'none';
                    }
                });
            });
            
            // Preview settings toggle
            const previewTypeRadios = document.querySelectorAll('input[name="previewType"]');
            previewTypeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const previewSettings = document.getElementById('previewSettings');
                    if (this.value === 'enable') {
                        previewSettings.style.display = 'block';
                    } else {
                        previewSettings.style.display = 'none';
                    }
                });
            });
            
            // Related docs toggle
            const relatedDocsRadios = document.querySelectorAll('input[name="relatedDocs"]');
            relatedDocsRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const manualRelatedDocs = document.getElementById('manualRelatedDocs');
                    if (this.value === 'manual') {
                        manualRelatedDocs.style.display = 'block';
                    } else {
                        manualRelatedDocs.style.display = 'none';
                    }
                });
            });
            
            // Price calculation
            const docPrice = document.getElementById('docPrice');
            if (docPrice) {
                docPrice.addEventListener('input', function() {
                    const price = parseInt(this.value) || 0;
                    const platformFee = Math.round(price * 0.3);
                    const authorEarning = price - platformFee;
                    
                    document.getElementById('priceValue').textContent = price;
                    document.getElementById('platformFee').textContent = platformFee;
                    document.getElementById('authorEarning').textContent = authorEarning;
                });
            }
            
            // Slider for preview pages
            const slider = document.querySelector('.slider');
            const sliderThumb = document.querySelector('.slider-thumb');
            const sliderTrack = document.querySelector('.slider-track');
            const sliderValue = document.getElementById('previewPagesValue');
            const previewCount = document.getElementById('previewCount');
            
            if (slider && sliderThumb && sliderTrack) {
                slider.addEventListener('click', function(e) {
                    updateSlider(e);
                });
                
                sliderThumb.addEventListener('mousedown', function() {
                    document.addEventListener('mousemove', updateSlider);
                    document.addEventListener('mouseup', function() {
                        document.removeEventListener('mousemove', updateSlider);
                    });
                });
            }
            
            function updateSlider(e) {
                const sliderRect = slider.getBoundingClientRect();
                let position = (e.clientX - sliderRect.left) / sliderRect.width;
                
                // Clamp position between 0 and 1
                position = Math.max(0, Math.min(1, position));
                
                // Pages from 1 to 10
                let pages = Math.max(1, Math.min(10, Math.round(position * 10)));
                
                // Update UI
                sliderTrack.style.width = (pages * 10) + '%';
                sliderThumb.style.left = (pages * 10) + '%';
                sliderValue.textContent = pages;
                previewCount.textContent = pages;
            }
            
            // Category-Subcategory relationship
            const categorySelect = document.getElementById('docCategory');
            const subcategorySelect = document.getElementById('docSubcategory');
            
            if (categorySelect && subcategorySelect) {
                // Define subcategories for each category
                const subcategories = {
                    it: [
                        { value: 'programming', text: 'L·∫≠p tr√¨nh' },
                        { value: 'database', text: 'C∆° s·ªü d·ªØ li·ªáu' },
                        { value: 'networking', text: 'M·∫°ng m√°y t√≠nh' },
                        { value: 'security', text: 'B·∫£o m·∫≠t' },
                        { value: 'web', text: 'Ph√°t tri·ªÉn web' },
                        { value: 'mobile', text: 'Ph√°t tri·ªÉn ·ª©ng d·ª•ng di ƒë·ªông' }
                    ],
                    business: [
                        { value: 'marketing', text: 'Marketing' },
                        { value: 'finance', text: 'T√†i ch√≠nh' },
                        { value: 'management', text: 'Qu·∫£n tr·ªã' },
                        { value: 'hr', text: 'Nh√¢n s·ª±' },
                        { value: 'economics', text: 'Kinh t·∫ø h·ªçc' }
                    ],
                    language: [
                        { value: 'english', text: 'Ti·∫øng Anh' },
                        { value: 'chinese', text: 'Ti·∫øng Trung' },
                        { value: 'japanese', text: 'Ti·∫øng Nh·∫≠t' },
                        { value: 'korean', text: 'Ti·∫øng H√†n' },
                        { value: 'french', text: 'Ti·∫øng Ph√°p' },
                        { value: 'german', text: 'Ti·∫øng ƒê·ª©c' }
                    ],
                    // Add more categories and subcategories as needed
                };
                
                categorySelect.addEventListener('change', function() {
                    const category = this.value;
                    
                    // Clear current options
                    subcategorySelect.innerHTML = '<option value="" disabled selected>Ch·ªçn danh m·ª•c con</option>';
                    
                    // If category has subcategories, add them and enable the select
                    if (subcategories[category]) {
                        subcategories[category].forEach(subcategory => {
                            const option = document.createElement('option');
                            option.value = subcategory.value;
                            option.textContent = subcategory.text;
                            subcategorySelect.appendChild(option);
                        });
                        
                        subcategorySelect.disabled = false;
                    } else {
                        subcategorySelect.disabled = true;
                    }
                });
            }
        });

   let selectedPath = [];
    let rootCategories = /*[[${rootCategories}]]*/ [];
    let popularTags = /*[[${popularTags}]]*/ []; // L·∫•y t·ª´ model

    function onLevelChange(level) {
        const currentSelect = document.getElementById(`level${level}Select`);
        const selectedValue = currentSelect.value;
        const selectedText = currentSelect.options[currentSelect.selectedIndex].text;

        // Clear subsequent levels
        for (let i = level + 1; i <= 3; i++) {
            const nextLevel = document.getElementById(`level${i}`);
            const nextSelect = document.getElementById(`level${i}Select`);
            nextLevel.style.display = 'none';
            nextSelect.innerHTML = '<option value="">Ch·ªçn danh m·ª•c con...</option>';
        }

        // Update selected path
        selectedPath = selectedPath.slice(0, level - 1);
        if (selectedValue && selectedValue !== '0') {
            selectedPath.push({
                id: selectedValue,
                name: selectedText.replace(/^[üìÇüìÅüè†]\s*/, ''),
                level: level
            });

            // Load next level via API
            loadNextLevel(selectedValue, level + 1);
        } else if (level === 1 && selectedValue === '0') {
            selectedPath = [];
        }

        updateFinalSelection();
        updateBreadcrumb();
    }

    function loadNextLevel(parentId, targetLevel) {
        if (targetLevel > 3) return;

        fetch(`/categories/${parentId}/subcategories`)
            .then(response => response.json())
            .then(data => {
                const targetSelect = document.getElementById(`level${targetLevel}Select`);
                const targetDiv = document.getElementById(`level${targetLevel}`);

                if (data && data.length > 0) {
                    targetSelect.innerHTML = '<option value="">Ch·ªçn danh m·ª•c con...</option>';
                    data.forEach(sub => {
                        const option = document.createElement('option');
                        option.value = sub.id;
                        option.textContent = `üìÅ ${sub.name}`;
                        option.setAttribute('data-subcategories', sub.subcategories || 0);
                        targetSelect.appendChild(option);
                    });
                    targetDiv.style.display = 'block';
                } else {
                    targetDiv.style.display = 'none';
                    updateFinalSelection();
                }
            })
            .catch(error => console.error('Error loading subcategories:', error));
    }

    function updateFinalSelection() {
        const finalParentId = document.getElementById('finalParentId');
        const categoryIdsInput = document.getElementById('categoryIds');
        finalParentId.value = selectedPath.length > 0 ? selectedPath[selectedPath.length - 1].id : '0';
        categoryIdsInput.value = selectedPath.map(item => item.id).join(',');
        console.log("Updated parentId:", finalParentId.value);
        console.log("Updated categoryIds:", categoryIdsInput.value);
    }

    function updateBreadcrumb() {
        const breadcrumb = document.getElementById('categoryBreadcrumb');
        const breadcrumbPath = document.getElementById('breadcrumbPath');

        if (selectedPath.length === 0) {
            breadcrumb.style.display = 'none';
            return;
        }

        let pathHtml = '<span class="breadcrumb-item">üè† G·ªëc</span>';
        selectedPath.forEach((item, index) => {
            pathHtml += '<span class="breadcrumb-arrow">‚Üí</span>';
            pathHtml += `<span class="breadcrumb-item">üìÅ ${item.name}</span>`;
        });

        breadcrumbPath.innerHTML = pathHtml;
        breadcrumb.style.display = 'block';
    }

    // Tag Selector Logic
    let selectedTags = [];
    let searchTimeout;
    const MAX_TAGS = 20;

    function initTagSelector() {
        const searchInput = document.getElementById('tagSearchInput');
        const dropdown = document.getElementById('tagDropdown');
        
        // Search input events
        searchInput.addEventListener('input', handleTagSearch);
        searchInput.addEventListener('focus', function() {
            if (searchInput.value.trim() === '') {
                showAllTags(); // Hi·ªÉn th·ªã t·∫•t c·∫£ tags khi ch∆∞a nh·∫≠p g√¨
            } else {
                showDropdown();
            }
        });
        searchInput.addEventListener('keydown', handleKeyDown);
        
        // Click outside to close dropdown
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.tag-search-container')) {
                hideDropdown();
            }
        });
        
        updateTagDisplay();
    }

    function handleTagSearch(e) {
        const query = e.target.value.trim();
        
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            if (query.length > 0) {
                // T√¨m ki·∫øm trong T·∫§T C·∫¢ tags
                searchAllTags(query);
            } else {
                // Hi·ªÉn th·ªã t·∫•t c·∫£ tags khi ch∆∞a nh·∫≠p g√¨
                showAllTags();
            }
        }, 300);
    }

    function searchAllTags(query) {
        fetch(`/tags/search?query=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                displaySearchResults(data, query);
            })
            .catch(error => {
                console.error('Error searching tags:', error);
                displaySearchResults([], query);
            });
    }

    function displaySearchResults(tags, query) {
        const resultsContainer = document.getElementById('tagResults');
        resultsContainer.innerHTML = '';
        
        // Th√™m header cho k·∫øt qu·∫£ t√¨m ki·∫øm
        const headerDiv = document.createElement('div');
        headerDiv.className = 'tag-results-header';
        headerDiv.innerHTML = `<strong>K·∫øt qu·∫£ t√¨m ki·∫øm cho "${query}"</strong>`;
        resultsContainer.appendChild(headerDiv);
        
        // Filter out already selected tags
        const availableTags = tags.filter(tag => !selectedTags.includes(tag.name));
        
        if (availableTags.length > 0) {
            availableTags.forEach(tag => {
                const item = createTagResultItem(tag.name, tag.documentCount || 0, false);
                resultsContainer.appendChild(item);
            });
        }
        
        // Add "Create new tag" option if query doesn't match any existing tag
        const exactMatch = tags.find(tag => tag.name.toLowerCase() === query.toLowerCase());
        if (!exactMatch && query.length > 0 && !selectedTags.includes(query)) {
            const createItem = createTagResultItem(query, 0, true);
            resultsContainer.appendChild(createItem);
        }
        
        if (availableTags.length === 0 && (!exactMatch || selectedTags.includes(query))) {
            if (!exactMatch && query.length > 0 && !selectedTags.includes(query)) {
                // Ch·ªâ hi·ªÉn th·ªã option t·∫°o m·ªõi
            } else {
                resultsContainer.innerHTML += '<div class="no-results">Kh√¥ng t√¨m th·∫•y t·ª´ kh√≥a ph√π h·ª£p</div>';
            }
        }
        
        showDropdown();
    }

    function createTagResultItem(tagName, count, isNew) {
        const item = document.createElement('div');
        item.className = `tag-result-item ${isNew ? 'create-new-tag' : ''}`;
        
        if (isNew) {
            item.innerHTML = `
                <span class="tag-result-name">
                    <i class="fas fa-plus"></i>
                    Th√™m "${tagName}"
                </span>
            `;
        } else {
            item.innerHTML = `
                <span class="tag-result-name">${tagName}</span>
                <span class="tag-result-count">${count} t√†i li·ªáu</span>
            `;
        }
        
        item.addEventListener('click', () => addTagToSelection(tagName));
        return item;
    }

    function showAllTags() {
        // L·∫•y t·∫•t c·∫£ tags t·ª´ server
        fetch('/tags/all')
            .then(response => response.json())
            .then(data => {
                displayAllTags(data);
            })
            .catch(error => {
                console.error('Error loading all tags:', error);
                // Fallback to popular tags if error
                showPopularTagsFallback();
            });
    }

    function displayAllTags(tags) {
        const resultsContainer = document.getElementById('tagResults');
        resultsContainer.innerHTML = '';
        
        // Th√™m header cho t·∫•t c·∫£ tags
        const headerDiv = document.createElement('div');
        headerDiv.className = 'tag-results-header';
        headerDiv.innerHTML = '<strong>T·∫•t c·∫£ t·ª´ kh√≥a</strong>';
        resultsContainer.appendChild(headerDiv);
        
        if (tags && tags.length > 0) {
            const availableTags = tags.filter(tag => !selectedTags.includes(tag.name));
            
            if (availableTags.length > 0) {
                availableTags.forEach(tag => {
                    const item = createTagResultItem(tag.name, tag.documentCount || 0, false);
                    resultsContainer.appendChild(item);
                });
            } else {
                resultsContainer.innerHTML += '<div class="no-results">T·∫•t c·∫£ t·ª´ kh√≥a ƒë√£ ƒë∆∞·ª£c ch·ªçn</div>';
            }
        } else {
            resultsContainer.innerHTML += '<div class="no-results">Ch∆∞a c√≥ t·ª´ kh√≥a n√†o</div>';
        }
        
        showDropdown();
    }

    function showPopularTagsFallback() {
        const resultsContainer = document.getElementById('tagResults');
        resultsContainer.innerHTML = '';
        
        // Th√™m header cho tag ph·ªï bi·∫øn
        const headerDiv = document.createElement('div');
        headerDiv.className = 'tag-results-header';
        headerDiv.innerHTML = '<strong>T·ª´ kh√≥a ph·ªï bi·∫øn</strong>';
        resultsContainer.appendChild(headerDiv);
        
        if (popularTags && popularTags.length > 0) {
            const availableTags = popularTags.filter(tag => !selectedTags.includes(tag.name));
            
            if (availableTags.length > 0) {
                availableTags.slice(0, 10).forEach(tag => {
                    const item = createTagResultItem(tag.name, tag.documentCount || 0, false);
                    resultsContainer.appendChild(item);
                });
            } else {
                resultsContainer.innerHTML += '<div class="no-results">T·∫•t c·∫£ t·ª´ kh√≥a ph·ªï bi·∫øn ƒë√£ ƒë∆∞·ª£c ch·ªçn</div>';
            }
        } else {
            resultsContainer.innerHTML += '<div class="no-results">Ch∆∞a c√≥ t·ª´ kh√≥a ph·ªï bi·∫øn</div>';
        }
        
        showDropdown();
    }

    function addTagToSelection(tagName) {
        if (selectedTags.length >= MAX_TAGS) {
            alert(`B·∫°n ch·ªâ c√≥ th·ªÉ ch·ªçn t·ªëi ƒëa ${MAX_TAGS} t·ª´ kh√≥a`);
            return;
        }
        
        if (!selectedTags.includes(tagName)) {
            selectedTags.push(tagName);
            updateTagDisplay(tagName); // Pass the new tag for animation
            updateHiddenInput();
            
            // Clear search input
            document.getElementById('tagSearchInput').value = '';
            hideDropdown();
        }
    }

    function addTagFromPopular(tagName) {
        addTagToSelection(tagName);
    }

    function removeTag(tagName) {
        selectedTags = selectedTags.filter(tag => tag !== tagName);
        updateTagDisplay();
        updateHiddenInput();
    }

    function updateTagDisplay(newTag = null) {
        const container = document.getElementById('selectedTags');
        const countElement = document.getElementById('tagCount');
        
        container.innerHTML = '';
        countElement.textContent = selectedTags.length;
        
        if (selectedTags.length === 0) {
            container.innerHTML = '<div style="color: #6c757d; font-style: italic;">Ch∆∞a c√≥ t·ª´ kh√≥a n√†o ƒë∆∞·ª£c ch·ªçn</div>';
        } else {
            selectedTags.forEach(tagName => {
                const tagElement = document.createElement('div');
                tagElement.className = 'selected-tag';
                
                // Add animation class for new tags
                if (tagName === newTag) {
                    tagElement.classList.add('new-tag');
                }
                
                tagElement.innerHTML = `
                    <span>${tagName}</span>
                    <span class="remove-tag" onclick="removeTag('${tagName}')">&times;</span>
                `;
                container.appendChild(tagElement);
            });
        }
    }

    function updateHiddenInput() {
        const hiddenInput = document.getElementById('tagNames');
        hiddenInput.value = selectedTags.join(',');
    }

    function showDropdown() {
        document.getElementById('tagDropdown').classList.add('show');
    }

    function hideDropdown() {
        document.getElementById('tagDropdown').classList.remove('show');
    }

    function handleKeyDown(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const query = e.target.value.trim();
            if (query) {
                addTagToSelection(query);
            }
        } else if (e.key === 'Escape') {
            hideDropdown();
        }
    }

    function validatePrice(input) {
    const errorDiv = document.getElementById('priceError');
    const value = parseInt(input.value);
    const max = parseInt(input.max);
    const min = parseInt(input.min);

    if (value > max) {
        errorDiv.textContent = `S·ªë xu kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° ${max}!`;
        input.value = max; // ƒê·∫∑t l·∫°i gi√° tr·ªã v·ªÅ max n·∫øu v∆∞·ª£t qu√°
    } else if (value < min) {
        errorDiv.textContent = `S·ªë xu ph·∫£i l·ªõn h∆°n ho·∫∑c b·∫±ng ${min}!`;
        input.value = min; // ƒê·∫∑t l·∫°i gi√° tr·ªã v·ªÅ min n·∫øu nh·ªè h∆°n
    } else {
        errorDiv.textContent = '';
    }
}
    // Kh·ªüi t·∫°o khi t·∫£i trang
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize tag selector
        initTagSelector();
        
        const initialParentId = /*[[${documentDTO.parentId != null ? documentDTO.parentId : 0}]]*/ 0;
        if (initialParentId > 0) {
            let currentId = initialParentId;
            let level = 1;
            while (currentId > 0 && level <= 3) {
                const select = document.getElementById(`level${level}Select`);
                const category = rootCategories.find(c => c.id == currentId);
                if (category) {
                    select.value = currentId;
                    onLevelChange(level);
                    currentId = category.parentId || 0;
                    level++;
                } else {
                    break;
                }
            }
        }
    });
   
    </script>
</body>
</html>
