<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <title th:text="${document != null ? document.title + ' - EduShare' : 'Chi tiết tài liệu - EduShare'}">Chi tiết tài
    liệu - EduShare</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Open+Sans:wght@400;500;600&family=Playfair+Display:wght@700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" th:href="@{/css/main.css}">
  <link rel="stylesheet" th:href="@{/css/responsive.css}">
  <link rel="stylesheet" th:href="@{/css/main-fixes.css}">
  <link rel="stylesheet" th:href="@{/css/document-detail.css}">
  <link rel="stylesheet" th:href="@{/css/document-detail-enhanced.css}">
  <link rel="stylesheet" th:href="@{/css/document-preview.css}">
  <link rel="stylesheet" th:href="@{/css/footer-modern.css}">
  <link rel="stylesheet" th:href="@{/css/client-header.css}">
  <link rel="stylesheet" th:href="@{/css/client-footer.css}">
  <link rel="stylesheet" th:href="@{/css/comment-actions.css}">
  <meta name="_csrf" th:content="${_csrf.token}" />
  <meta name="_csrf_header" th:content="${_csrf.headerName}" />

  <!-- Hidden data for JavaScript updates -->
  <div th:if="${updatedCommentId}" th:attr="data-updated-comment-id=${updatedCommentId},
                data-updated-likes-count=${updatedLikesCount},
                data-updated-dislikes-count=${updatedDislikesCount},
                data-updated-action=${updatedAction}" style="display: none;"></div>

  <!-- Hidden data for toast messages -->
  <div th:if="${toastMessage}" th:attr="data-toast-message=${toastMessage},
                data-toast-type=${toastType}" style="display: none;"></div>

  <!-- Hidden data for new comment -->
  <div th:if="${newCommentId}" th:attr="data-new-comment-id=${newCommentId}" style="display: none;"></div>
</head>

<body>
  <!-- Header -->
  <div th:replace="~{fragments/client/layout :: header}"></div>
  <div class="container">
    <div class="header-content">
      <div class="logo">
        <a href="../index.html">
          <div class="logo-icon">E</div>
          <span class="logo-text">EduShare</span>
        </a>
      </div>
      <nav class="main-nav">
        <a href="../index.html" class="nav-link">Trang chủ</a>
        <a href="categories.html" class="nav-link active">Danh mục</a>
        <a href="search.html?sort=newest" class="nav-link">Tài liệu mới</a>
        <a href="search.html?filter=premium" class="nav-link">Cao cấp</a>
        <a href="about.html" class="nav-link">Giới thiệu</a>
      </nav>
      <div class="header-actions">
        <!-- Đã xóa ô tìm kiếm theo yêu cầu -->
        <button class="dark-mode-toggle" id="darkModeToggle" type="button" aria-label="Toggle dark mode">
          <span class="dark-mode-handle" id="darkModeHandle"></span>
        </button>
        <a href="login.html" class="login-btn">
          <i class="fas fa-sign-in-alt"></i> Đăng nhập
        </a>
        <a href="register.html" class="register-btn">
          <i class="fas fa-user-plus"></i> Đăng ký
        </a>
      </div>
      <div class="mobile-menu-toggle" id="mobileMenuBtn">
        <i class="fas fa-bars"></i>
      </div>
    </div>
  </div>
  <!-- Mobile menu -->
  <div id="mobileMenu" class="mobile-menu">
    <div class="mobile-search">
      <input type="text" placeholder="Tìm kiếm tài liệu...">
      <button>
        <i class="fas fa-search"></i>
      </button>
    </div>
    <nav class="mobile-nav">
      <a href="../index.html" class="mobile-nav-link">Trang chủ</a>
      <a href="categories.html" class="mobile-nav-link active">Danh mục</a>
      <a href="search.html?sort=newest" class="mobile-nav-link">Tài liệu mới</a>
      <a href="search.html?filter=premium" class="mobile-nav-link">Cao cấp</a>
      <a href="#" class="mobile-nav-link">Hướng dẫn</a>
    </nav>
    <div class="mobile-auth">
      <a href="login.html" class="mobile-login-btn">Đăng nhập</a>
      <a href="register.html" class="mobile-register-btn">Đăng ký</a>
    </div>
  </div>
  </header>

  <!-- Document Hero -->
  <section class="document-hero" th:attr="data-document-id=${document.id}">
    <div class="container">
      <div class="document-hero-content">
        <div class="document-breadcrumbs">
          <a href="../index.html">Trang chủ</a>
          <span class="separator">/</span>
          <a href="categories.html">Danh mục</a>
          <span class="separator">/</span>
          <a th:if="${document.categoryNames != null and !document.categoryNames.isEmpty()}"
            th:href="@{/search(category=${document.categoryNames[0]})}" th:text="${document.categoryNames[0]}">Công nghệ
            thông tin</a>
          <a th:if="${document.categoryNames == null or document.categoryNames.isEmpty()}" href="categories.html">Tài
            liệu</a>
          <span class="separator">/</span>
          <span class="current" th:text="${document.title}">Lập trình ứng dụng web với React và NodeJS</span>
        </div>

        <div class="document-header">
          <div class="document-info">
            <div class="document-category">
              <i class="fas fa-folder"></i>
              <span th:if="${document.categoryNames != null and !document.categoryNames.isEmpty()}"
                th:text="${document.categoryNames[0]}">Công nghệ thông tin</span>
              <span th:if="${document.categoryNames == null or document.categoryNames.isEmpty()}">Tài liệu</span>
            </div>
            <hr>
            <h1 class="document-title" th:text="${document.title}">Lập trình ứng dụng web với React và NodeJS: Từ cơ bản
              đến nâng cao</h1>

            <div class="document-meta">
              <div class="meta-item" th:if="${document.createdAt != null}">
                <i class="fas fa-calendar-alt"></i> Cập nhật: <span
                  th:text="${#temporals.format(document.createdAt, 'dd/MM/yyyy')}">15/05/2023</span>
              </div>
              <div class="meta-item" th:if="${document.createdAt == null}">
                <i class="fas fa-calendar-alt"></i> Cập nhật: Không có thông tin
              </div>
              <div class="meta-item">
                <i class="fas fa-eye"></i> <span
                  th:text="${document.viewsCount != null ? #numbers.formatInteger(document.viewsCount, 1, 'COMMA') : '0'}">0</span> lượt xem
              </div>
              <div class="meta-item">
                <i class="fas fa-download"></i> <span
                  th:text="${document.downloadsCount != null ? #numbers.formatInteger(document.downloadsCount, 1, 'COMMA') : '0'}">0</span> lượt tải
              </div>
              <div class="meta-item">
                <i class="fas fa-star"></i>
                <span
                  th:text="${document.averageRating != null ? T(java.lang.Math).round(document.averageRating) : 0}">0</span>/5
                (<span th:text="${document.comments != null ? document.comments.size() : 0}">0</span> đánh giá)
              </div>
            </div>

            <p class="document-description" th:text="${document.description}">
              Tài liệu này cung cấp hướng dẫn toàn diện về cách phát triển ứng dụng web full-stack
              hiện đại sử dụng React cho phần giao diện và NodeJS cho phần backend. Bao gồm các kiến thức
              từ căn bản đến nâng cao, giúp bạn làm chủ hai công nghệ phổ biến nhất hiện nay.
            </p>

            <div class="document-tags-inline">
              <a th:each="tag : ${document.tagNames}" th:href="@{/search(tag=${tag})}" th:text="${tag}"
                class="document-tag-badge">React</a>
              <span th:if="${document.tagNames == null or document.tagNames.isEmpty()}" class="no-tags">Chưa có
                thẻ</span>
            </div>

            <div class="document-author">
              <div class="author-avatar">
                <img
                  src="https://images.unsplash.com/photo-1568602471122-7832951cc4c5?ixlib=rb-1.2.1&auto=format&fit=facearea&facepad=2&w=256&h=256&q=80"
                  alt="Author">
              </div>
              <div class="author-info">
                <div class="author-label">Tác giả</div>
                <div class="author-name" th:text="${document.authorName != null ? document.authorName : 'Admin'}">Nguyễn
                  Văn A</div>
              </div>
            </div>
          </div>

          <div class="document-preview">



            <div class="download-card">
              <div class="download-header">
                <div class="download-title">Thông tin tài liệu</div>
                <div class="document-format" th:if="${document.fileType != null}"
                  th:classappend="${document.fileType != null ? document.fileType.toLowerCase() : 'pdf'}">
                  <i class="fas"
                    th:classappend="${document.fileType != null and document.fileType.toLowerCase() == 'pdf' ? 'fa-file-pdf' : 'fa-file'}"></i>
                  <span th:text="${document.fileType != null ? document.fileType.toUpperCase() : 'PDF'}">PDF</span>
                </div>
                <div class="document-format" th:if="${document.fileType == null and document.fileName != null}">
                  <i class="fas fa-file"></i> Không xác định
                </div>
                <div class="document-format" th:if="${document.fileType == null and document.fileName == null}">
                  <i class="fas fa-exclamation-triangle"></i> Không có file đính kèm
                </div>
              </div>

              <div class="download-info">
                <div class="download-info-item" th:if="${document.fileSize != null}">
                  <div class="info-value" data-info="size" th:text="${document.fileSize + ' KB'}">5.2 MB</div>
                  <div class="info-label">Kích thước</div>
                </div>
                <div class="download-info-item" th:if="${document.fileSize == null}">
                  <div class="info-value" data-info="size">Không có thông tin</div>
                  <div class="info-label">Kích thước</div>
                </div>
                <div class="download-info-item">
                  <div class="info-value" data-info="rating"
                    th:text="${document.averageRating != null ? T(java.lang.Math).round(document.averageRating) + '/5' : '0/5'}">
                    0/5</div>
                  <div class="info-label">Đánh giá</div>
                </div>
                <div class="download-info-item" th:if="${document.createdAt != null}">
                  <div class="info-value" data-info="date"
                    th:text="${#temporals.format(document.createdAt, 'dd/MM/yyyy')}">15/05/2023</div>
                  <div class="info-label">Cập nhật</div>
                </div>
                <div class="download-info-item">
                  <div class="info-value" data-info="views"
                    th:text="${document.viewsCount != null ? #numbers.formatInteger(document.viewsCount, 1, 'COMMA') : '0'}">0</div>
                  <div class="info-label">Lượt xem</div>
                </div>
                <div class="download-info-item">
                  <div class="info-value" data-info="downloads"
                    th:text="${document.downloadsCount != null ? #numbers.formatInteger(document.downloadsCount, 1, 'COMMA') : '0'}">0</div>
                  <div class="info-label">Lượt tải</div>
                </div>
              </div>

              <!-- Conditional price display in download card -->
              <div th:if="${document.price != null and document.price > 0}" class="document-price premium">
                <i class="fas fa-coins"></i>
                <span th:text="${#numbers.formatDecimal(document.price, 1, 'COMMA', 0, 'POINT')}"></span> xu

              </div>
              <div th:if="${document.price == null or document.price == 0}" class="document-price free">
                <i class="fas fa-gift"></i> Miễn phí
              </div>

              <div class="download-actions">
                <!-- Conditional download button text based on price and ownership -->
                <div th:if="${isOwned}">
                  <a th:href="@{/documents/{id}/download(id=${document.id})}" class="action-button download-button" data-premium="false">
                    <i class="fas fa-download"></i> Tải xuống
                  </a>
                </div>
                <div th:if="${!isOwned}">
                  <a th:if="${document.price == null or document.price == 0}"
                     th:href="@{/documents/{id}/download(id=${document.id})}" class="action-button download-button" data-premium="false">
                    <i class="fas fa-download"></i> Tải xuống
                  </a>
                  <button th:if="${document.price != null and document.price > 0}"
                          type="button" class="action-button download-button" data-premium="true"
                          id="buy-now-btn"
                          onclick="showPurchaseConfirmationModal()"
                          th:attr="data-id=${document.id},data-price=${document.price}">
                    <i class="fas fa-shopping-cart"></i> Mua bằng xu
                    <span class="price-badge" th:text="${document.price} + ' xu'">0 xu</span>
                  </button>
                </div>
                 <!-- <form th:action="@{/documents/{id}/view(id=${document.id})}" method="post" style="display: inline;"> -->
                 <!-- <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" /> -->
                 <!-- </form> -->
                 <div class="secondary-actions">
                                       <button class="action-button bookmark-button favorite-btn" th:attr="data-document-id=${document.id}" th:classappend="${isFavorited ? 'favorited' : ''}">
                      <i th:class="${isFavorited ? 'fas fa-heart' : 'far fa-heart'}"></i> <span th:text="${isFavorited ? 'Đã lưu' : 'Lưu'}">Lưu</span>
                    </button>
                                        <button class="action-button share-button" onclick="shareDocument()">
                       <i class="fas fa-share-alt"></i> Chia sẻ
                     </button>
                   <button class="report-button action-button" onclick="openReportModal()">
                     <i class="fas fa-flag"></i> Báo cáo
                   </button>
                 </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Document Main Content -->
  <section class="document-main-content">
    <div class="container">
      <div class="document-content-grid">
        <div class="document-content-tab">
          <!-- Flash Messages -->
          <div th:if="${viewCountUpdated}" class="alert alert-success">
            <i class="fas fa-check-circle"></i> Đã cập nhật lượt xem thành công!
          </div>
          <div th:if="${downloadCountUpdated}" class="alert alert-success">
            <i class="fas fa-check-circle"></i> Đã cập nhật lượt tải thành công!
          </div>

          <div class="content-tabs">
            <div class="content-tab active" data-tab="description">Mô tả</div>
            <div class="content-tab" data-tab="preview">Xem trước</div>
            <div class="content-tab" data-tab="reviews">Đánh giá</div>
            <div class="content-tab" data-tab="details">Chi tiết</div>
          </div>

          <!-- Description Tab -->
          <div id="description-content" class="tab-content active">
            <div class="document-description">
              <p th:text="${document.description}">
                Tài liệu "Lập trình ứng dụng web với React và NodeJS: Từ cơ bản đến nâng cao" cung cấp
              </p>
            </div>
          </div>

          <!-- Preview Tab -->
          <div id="preview-content" class="tab-content">
            <div class="document-preview-reader">
              <!-- Hidden PDF source for real preview -->
              <div id="pdfSource" th:if="${document != null and document.fileName != null}"
                th:attr="data-src=@{/documents/{file}(file=${document.filePath})}" style="display:none"></div>
              <div class="preview-controls" style="margin-bottom:12px;">
                <button id="prevPage" class="prev-page preview-control-btn"><i class="fas fa-chevron-left"></i> Trang trước</button>
                <span style="margin:0 8px;">Trang <span class="current-page">1</span>/<span class="total-pages">1</span></span>
                <button id="nextPage" class="next-page preview-control-btn">Trang sau <i class="fas fa-chevron-right"></i></button>
                <span class="preview-page-input">
                  <input id="pageInput" type="number" class="page-input" min="1" value="1" />
                  <button id="goToPage" class="go-to-page-btn">Đi</button>
                </span>
              </div>
              <div class="preview-container"
                th:attr="data-has-file=${document != null and document.fileName != null ? '1' : '0'}">
                <div class="preview-page-view active" data-page="1">
                  <div class="preview-page-content">
                    <div class="preview-page-header">
                      <h1>Lập trình ứng dụng web với React và NodeJS</h1>
                      <h2>Từ cơ bản đến nâng cao</h2>
                      <p class="preview-author">Nguyễn Văn A</p>
                    </div>
                    <div class="preview-page-image">
                      <img
                        src="https://images.unsplash.com/photo-1633356122544-f134324a6cee?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80"
                        alt="Cover">
                    </div>
                    <div class="watermark">Bản xem trước</div>
                  </div>
                </div>

                <div class="preview-page-view" data-page="3">
                  <div class="preview-page-content">
                    <h2>Lời nói đầu</h2>
                    <p>Chào mừng bạn đến với cuốn sách "Lập trình ứng dụng web với React và NodeJS: Từ cơ bản đến nâng
                      cao". Cuốn sách này được viết với mục tiêu cung cấp cho bạn kiến thức toàn diện về cách xây dựng
                      ứng dụng web hiện đại sử dụng hai công nghệ rất phổ biến hiện nay: React và NodeJS.</p>
                    <p>Trong những năm gần đây, JavaScript đã phát triển từ một ngôn ngữ lập trình đơn giản dùng để thêm
                      tính năng tương tác cho trang web trở thành một công nghệ mạnh mẽ có thể được sử dụng trong toàn
                      bộ stack phát triển web, từ front-end đến back-end, từ ứng dụng web đến ứng dụng di động và
                      desktop.</p>
                    <p>Với sự xuất hiện của React - một thư viện JavaScript do Facebook phát triển - việc xây dựng giao
                      diện người dùng trở nên hiệu quả và dễ dàng quản lý hơn. Mặt khác, NodeJS đã mở ra khả năng sử
                      dụng JavaScript ở phía server, tạo ra một hệ sinh thái thống nhất cho các nhà phát triển.</p>
                    <div class="watermark">Bản xem trước</div>
                  </div>
                </div>

                <div class="preview-page-view" data-page="4">
                  <div class="preview-page-content">
                    <p>Cuốn sách này được thiết kế để hướng dẫn bạn từng bước một, từ những khái niệm cơ bản nhất đến
                      các kỹ thuật nâng cao trong việc phát triển ứng dụng web full-stack. Bạn sẽ học cách xây dựng các
                      component React, quản lý state, tạo API với NodeJS và Express, kết nối với cơ sở dữ liệu, và cuối
                      cùng là triển khai ứng dụng lên môi trường production.</p>
                    <p>Mỗi chương sẽ cung cấp kiến thức lý thuyết cần thiết kèm theo các ví dụ thực tế và bài tập để bạn
                      có thể áp dụng ngay những gì đã học. Cuối cùng, bạn sẽ xây dựng một dự án hoàn chỉnh từ đầu đến
                      cuối, tích hợp tất cả các kỹ năng đã học.</p>
                    <p>Dù bạn là người mới bắt đầu hay đã có kinh nghiệm trong lập trình web, tôi tin rằng cuốn sách này
                      sẽ cung cấp cho bạn những kiến thức quý giá để nâng cao kỹ năng và sự tự tin trong việc phát triển
                      ứng dụng web hiện đại.</p>
                    <p>Hãy sẵn sàng cho một hành trình học tập thú vị phía trước!</p>
                    <div class="preview-author-signature">
                      <p>Nguyễn Văn A</p>
                      <p>Hà Nội, tháng 5 năm 2023</p>
                    </div>
                    <div class="watermark">Bản xem trước</div>
                  </div>
                </div>

                <div class="preview-page-view" data-page="5">
                  <div class="preview-page-content">
                    <h2>Cách sử dụng cuốn sách</h2>
                    <p>Để tận dụng tối đa cuốn sách này, dưới đây là một số gợi ý:</p>
                    <ol>
                      <li><strong>Thực hành code:</strong> Tất cả các ví dụ trong sách đều có mã nguồn đi kèm. Hãy tự
                        tay gõ lại mã thay vì chỉ đọc hoặc sao chép.</li>
                      <li><strong>Hoàn thành bài tập:</strong> Sau mỗi phần đều có các bài tập để bạn thực hành. Hãy cố
                        gắng hoàn thành chúng trước khi xem đáp án.</li>
                      <li><strong>Xây dựng dự án riêng:</strong> Áp dụng kiến thức học được vào các dự án cá nhân. Đây
                        là cách tốt nhất để củng cố kiến thức.</li>
                      <li><strong>Tham gia cộng đồng:</strong> Tham gia các cộng đồng React và NodeJS để học hỏi thêm và
                        nhận sự hỗ trợ.</li>
                      <li><strong>Cập nhật kiến thức:</strong> Công nghệ luôn thay đổi, hãy theo dõi các tài nguyên được
                        đề xuất ở cuối sách để cập nhật kiến thức mới nhất.</li>
                    </ol>
                    <p>Cuốn sách được thiết kế để đọc từ đầu đến cuối, nhưng bạn cũng có thể sử dụng nó như một tài liệu
                      tham khảo, tập trung vào các chương cụ thể tùy theo nhu cầu.</p>
                    <div class="watermark">Bản xem trước</div>
                  </div>
                </div>

                <div class="preview-page-view" data-page="6">
                  <div class="preview-page-content">
                    <h1>Phần 1: Nền tảng React</h1>
                    <h2>Chương 1: Giới thiệu về React</h2>
                    <h3>1.1 React là gì?</h3>
                    <p>React là một thư viện JavaScript do Facebook phát triển để xây dựng giao diện người dùng (UI). Nó
                      cho phép bạn tạo ra các UI component có thể tái sử dụng, giúp quản lý trạng thái (state) của ứng
                      dụng một cách hiệu quả.</p>
                    <p>Không giống như các framework toàn diện như Angular, React tập trung vào một việc duy nhất và làm
                      điều đó thật tốt: rendering components. Đây là lý do tại sao React thường được gọi là "thư viện"
                      thay vì "framework".</p>
                    <h3>1.2 Triết lý của React</h3>
                    <p>React được xây dựng dựa trên một số nguyên tắc và triết lý cốt lõi:</p>
                    <div class="watermark">Bản xem trước</div>
                  </div>
                </div>

                <div class="preview-page-view" data-page="7">
                  <div class="preview-page-content">
                    <h3>1.2 Triết lý của React (tiếp)</h3>
                    <ul>
                      <li><strong>Declarative:</strong> React giúp bạn tạo UI tương tác một cách dễ dàng. Thiết kế các
                        view đơn giản cho từng trạng thái trong ứng dụng, và React sẽ cập nhật và render đúng component
                        khi dữ liệu thay đổi.</li>
                      <li><strong>Component-Based:</strong> Xây dựng các component độc lập, quản lý trạng thái riêng,
                        sau đó kết hợp chúng để tạo UI phức tạp.</li>
                      <li><strong>Learn Once, Write Anywhere:</strong> React không giả định về phần còn lại của tech
                        stack, nên bạn có thể phát triển tính năng mới trong React mà không cần viết lại code hiện có.
                      </li>
                    </ul>
                    <h3>1.3 Virtual DOM</h3>
                    <p>Một trong những đặc điểm quan trọng nhất của React là khái niệm Virtual DOM (DOM ảo). Thay vì cập
                      nhật trực tiếp DOM (điều này có thể gây tốn kém về mặt hiệu suất), React xây dựng một biểu diễn
                      nhẹ của DOM trong bộ nhớ, được gọi là Virtual DOM.</p>
                    <p>Khi trạng thái của component thay đổi, React tạo một cây Virtual DOM mới và so sánh với cây trước
                      đó. Sau đó, nó tính toán cách hiệu quả nhất để cập nhật DOM thật, giảm thiểu các thao tác cập nhật
                      DOM cần thiết.</p>
                    <div class="watermark">Bản xem trước</div>
                  </div>
                </div>

                <div class="preview-page-view" data-page="8">
                  <div class="preview-page-content">
                    <h3>1.4 Cài đặt React</h3>
                    <p>Có nhiều cách để bắt đầu với React, nhưng cách phổ biến nhất là sử dụng Create React App - một
                      công cụ chính thức từ team React để thiết lập nhanh chóng một project React với cấu hình tốt nhất.
                    </p>
                    <p>Để tạo một ứng dụng React mới, chạy lệnh sau trong terminal:</p>
                    <div class="code-block">
                      <pre><code>npx create-react-app my-app
cd my-app
npm start</code></pre>
                    </div>
                    <p>Lệnh này sẽ tạo một thư mục mới có tên "my-app" với cấu trúc project React chuẩn và cài đặt tất
                      cả các phụ thuộc cần thiết. Sau đó, bạn có thể chạy ứng dụng bằng lệnh <code>npm start</code>.</p>
                    <h3>1.5 JSX - JavaScript XML</h3>
                    <p>React sử dụng JSX, một cú pháp mở rộng cho JavaScript, để mô tả UI. JSX trông giống HTML, nhưng
                      thực ra là một cú pháp đặc biệt cho phép bạn viết HTML trong JavaScript.</p>
                    <div class="code-block">
                      <pre><code>const element = &lt;h1>Hello, world!&lt;/h1>;</code></pre>
                    </div>
                    <div class="watermark">Bản xem trước</div>
                  </div>
                </div>

                <div class="preview-page-view" data-page="9">
                  <div class="preview-page-content">
                    <h3>1.5 JSX - JavaScript XML (tiếp)</h3>
                    <p>JSX cho phép bạn kết hợp logic và markup trong cùng một file, giúp code rõ ràng hơn và dễ bảo trì
                      hơn. Dưới đây là một ví dụ phức tạp hơn về JSX:</p>
                    <div class="code-block">
                      <pre><code>function Greeting(props) {
  return (
    &lt;div className="greeting">
      &lt;h1>Hello, {props.name}!&lt;/h1>
      {props.showMessage && (
        &lt;p>Welcome to React&lt;/p>
      )}
    &lt;/div>
  );
}</code></pre>
                    </div>
                    <p>Trong ví dụ trên, chúng ta đã:</p>
                    <ul>
                      <li>Định nghĩa một component <code>Greeting</code></li>
                      <li>Sử dụng <code>props</code> để truyền dữ liệu vào component</li>
                      <li>Sử dụng biểu thức JavaScript (trong dấu ngoặc {}) bên trong JSX</li>
                      <li>Sử dụng câu lệnh điều kiện để render có điều kiện</li>
                    </ul>
                    <p>Lưu ý rằng trong JSX, bạn sử dụng <code>className</code> thay vì <code>class</code> trong HTML
                      thông thường (vì <code>class</code> là từ khóa dành riêng trong JavaScript).</p>
                    <div class="watermark">Bản xem trước</div>
                  </div>
                </div>

                <div class="preview-page-view" data-page="10">
                  <div class="preview-page-content">
                    <h3>1.6 Components và Props</h3>
                    <p>Components là khối xây dựng cơ bản của ứng dụng React. Một component React là một function hoặc
                      class JavaScript trả về một phần tử React (thường là thông qua JSX).</p>
                    <h4>Function Components</h4>
                    <div class="code-block">
                      <pre><code>function Welcome(props) {
  return &lt;h1>Hello, {props.name}&lt;/h1>;
}</code></pre>
                    </div>
                    <h4>Class Components</h4>
                    <div class="code-block">
                      <pre><code>class Welcome extends React.Component {
  render() {
    return &lt;h1>Hello, {this.props.name}&lt;/h1>;
  }
}</code></pre>
                    </div>
                    <p>Cả hai loại component đều chấp nhận props (properties) - các giá trị được truyền vào component.
                      Props cho phép bạn truyền dữ liệu từ component cha xuống component con.</p>
                    <p>Để sử dụng component, bạn có thể tham chiếu đến nó trong JSX như một thẻ HTML:</p>
                    <div class="code-block">
                      <pre><code>&lt;Welcome name="John" /></code></pre>
                    </div>
                    <div class="watermark">Bản xem trước</div>
                  </div>
                </div>
              </div>

              <div class="preview-footer">
                <p class="preview-notice">
                  Đây là bản xem trước, chỉ hiển thị <span id="preview-limit-count">5</span> trang đầu tiên của tài
                  liệu.
                  Để xem toàn bộ <span id="preview-total-pages">?</span> trang, vui lòng tải xuống.
                </p>
                <button class="download-button-small" data-premium="true">
                  <i class="fas fa-download"></i> Tải xuống đầy đủ
                </button>
              </div>
            </div>
          </div>

          <!-- Reviews Tab -->
          <div id="reviews-content" class="tab-content">
            <div class="review-section">
              <div class="section-header">
                <h3 class="section-title">Đánh giá từ người dùng</h3>
                <a href="#reviewForm" class="section-action">
                  <i class="fas fa-pencil-alt"></i> Viết đánh giá
                </a>
              </div>

              <div class="rating-overview">
                <div class="rating-score">
                  <div class="rating-value"
                    th:text="${document.averageRating != null ? T(java.lang.Math).round(document.averageRating) : 0}">
                    0</div>
                  <div class="rating-stars">
                    <i th:each="i : ${#numbers.sequence(1, 5)}"
                      th:class="${i <= (document.averageRating != null ? T(java.lang.Math).round(document.averageRating) : 0) ? 'fas fa-star' : 'far fa-star'}"></i>
                  </div>
                  <div class="rating-count"
                    th:text="${document.comments != null ? document.comments.size() : 0} + ' đánh giá'">0 đánh giá</div>
                </div>

                <div class="rating-distribution">
                  <div class="rating-bar">
                    <div class="bar-label">
                      <i class="fas fa-star"></i> 5
                    </div>
                    <div class="bar-container">
                      <div class="bar-fill"
                        th:style="'width: ' + ${document.ratingDistribution != null and document.ratingDistribution.containsKey('5') ? document.ratingDistribution.get('5') : 0} + '%'">
                      </div>
                    </div>
                    <div class="bar-percent"
                      th:text="${document.ratingDistribution != null and document.ratingDistribution.containsKey('5') ? document.ratingDistribution.get('5') : 0} + '%'">
                      0%</div>
                  </div>
                  <div class="rating-bar">
                    <div class="bar-label">
                      <i class="fas fa-star"></i> 4
                    </div>
                    <div class="bar-container">
                      <div class="bar-fill"
                        th:style="'width: ' + ${document.ratingDistribution != null and document.ratingDistribution.containsKey('4') ? document.ratingDistribution.get('4') : 0} + '%'">
                      </div>
                    </div>
                    <div class="bar-percent"
                      th:text="${document.ratingDistribution != null and document.ratingDistribution.containsKey('4') ? document.ratingDistribution.get('4') : 0} + '%'">
                      0%</div>
                  </div>
                  <div class="rating-bar">
                    <div class="bar-label">
                      <i class="fas fa-star"></i> 3
                    </div>
                    <div class="bar-container">
                      <div class="bar-fill"
                        th:style="'width: ' + ${document.ratingDistribution != null and document.ratingDistribution.containsKey('3') ? document.ratingDistribution.get('3') : 0} + '%'">
                      </div>
                    </div>
                    <div class="bar-percent"
                      th:text="${document.ratingDistribution != null and document.ratingDistribution.containsKey('3') ? document.ratingDistribution.get('3') : 0} + '%'">
                      0%</div>
                  </div>
                  <div class="rating-bar">
                    <div class="bar-label">
                      <i class="fas fa-star"></i> 2
                    </div>
                    <div class="bar-container">
                      <div class="bar-fill"
                        th:style="'width: ' + ${document.ratingDistribution != null and document.ratingDistribution.containsKey('2') ? document.ratingDistribution.get('2') : 0} + '%'">
                      </div>
                    </div>
                    <div class="bar-percent"
                      th:text="${document.ratingDistribution != null and document.ratingDistribution.containsKey('2') ? document.ratingDistribution.get('2') : 0} + '%'">
                      0%</div>
                  </div>
                  <div class="rating-bar">
                    <div class="bar-label">
                      <i class="fas fa-star"></i> 1
                    </div>
                    <div class="bar-container">
                      <div class="bar-fill"
                        th:style="'width: ' + ${document.ratingDistribution != null and document.ratingDistribution.containsKey('1') ? document.ratingDistribution.get('1') : 0} + '%'">
                      </div>
                    </div>
                    <div class="bar-percent"
                      th:text="${document.ratingDistribution != null and document.ratingDistribution.containsKey('1') ? document.ratingDistribution.get('1') : 0} + '%'">
                      0%</div>
                  </div>
                </div>
              </div>

              <!-- Comment Permission Check -->
              <div th:if="${commentPermission != null and !commentPermission.canComment}"
                class="comment-permission-alert">
                <div class="alert alert-warning">
                  <i class="fas fa-exclamation-triangle"></i>
                  <span th:text="${commentPermission.message}">Bạn cần mua tài liệu này để có thể bình luận</span>
                  <div th:if="${commentPermission.action == 'purchase'}" class="permission-actions">
                    <a th:href="@{/documents/{id}/purchase(id=${document.id})}" class="btn btn-primary btn-sm">
                      <i class="fas fa-shopping-cart"></i> Mua tài liệu
                    </a>
                  </div>
                  <div th:if="${commentPermission.action == 'login'}" class="permission-actions">
                    <a href="/login" class="btn btn-primary btn-sm">
                      <i class="fas fa-sign-in-alt"></i> Đăng nhập
                    </a>
                  </div>
                </div>
              </div>

              <form id="reviewForm" class="review-form" th:action="@{/documents/{id}/review(id=${document.id})}"
                method="post"
                th:class="${commentPermission != null and !commentPermission.canComment ? 'review-form disabled' : 'review-form'}">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <h4 class="form-title">Đánh giá của bạn</h4>
                <div class="form-group">
                  <div class="form-rating"
                    th:class="${commentPermission != null and !commentPermission.canComment ? 'form-rating disabled' : 'form-rating'}">
                    <div class="rate-star" data-value="1">
                      <i class="far fa-star"></i>
                    </div>
                    <div class="rate-star" data-value="2">
                      <i class="far fa-star"></i>
                    </div>
                    <div class="rate-star" data-value="3">
                      <i class="far fa-star"></i>
                    </div>
                    <div class="rate-star" data-value="4">
                      <i class="far fa-star"></i>
                    </div>
                    <div class="rate-star" data-value="5">
                      <i class="far fa-star"></i>
                    </div>
                    <input type="hidden" id="ratingInput" name="rating" value="">
                  </div>
                </div>

                <div class="form-group">
                  <label for="reviewText" class="form-label">Nội dung đánh giá</label>
                  <textarea id="reviewText" name="review" class="form-control" rows="4"
                    placeholder="Chia sẻ ý kiến của bạn về tài liệu này..."
                    th:disabled="${commentPermission != null and !commentPermission.canComment}"></textarea>
                  <span class="form-text">Đánh giá của bạn sẽ giúp người khác quyết định có nên tải tài liệu này hay
                    không.</span>
                </div>

                <button type="submit" class="form-submit"
                  th:disabled="${commentPermission != null and !commentPermission.canComment}">
                  <i class="fas fa-paper-plane" id="reviews"></i> Gửi đánh giá
                </button>
              </form>

              <form class="review-filter" th:action="@{/documents/{id}/filter(id=${document.id})}" method="get">
                <span class="filter-label">Lọc đánh giá:</span>
                <select name="rating" class="filter-select">
                  <option value="">Tất cả</option>
                  <option value="5" th:selected="${currentRating == 5}">5 sao</option>
                  <option value="4" th:selected="${currentRating == 4}">4 sao</option>
                  <option value="3" th:selected="${currentRating == 3}">3 sao</option>
                  <option value="2" th:selected="${currentRating == 2}">2 sao</option>
                  <option value="1" th:selected="${currentRating == 1}">1 sao</option>
                </select>
                <select name="sortBy" class="sort-select">
                  <option value="recent" th:selected="${currentSortBy == 'recent'}">Mới nhất</option>
                  <option value="helpful" th:selected="${currentSortBy == 'helpful'}">Hữu ích nhất</option>
                  <option value="high" th:selected="${currentSortBy == 'high'}">Đánh giá cao nhất</option>
                  <option value="low" th:selected="${currentSortBy == 'low'}">Đánh giá thấp nhất</option>
                </select>
                <input type="hidden" name="page" value="0">
                <input type="hidden" name="size" th:value="${currentSize != null ? currentSize : 10}">
                <button type="submit" class="filter-submit">
                  <i class="fas fa-filter"></i> Lọc
                </button>
              </form>

              <div class="review-list">
                <!-- Dynamic comments from database -->
                <div th:each="comment : ${comments != null ? comments : document.comments}" class="review-item"
                  th:data-comment-id="${comment.id}" th:id="'comment-' + ${comment.id}">
                  <div class="review-header">
                    <div class="reviewer-info">
                      <div class="reviewer-avatar">
                        <img
                          src="https://images.unsplash.com/photo-1494790108377-be9c29b29330?ixlib=rb-1.2.1&auto=format&fit=crop&w=256&h=256&q=80"
                          alt="Reviewer">
                      </div>
                      <div class="reviewer-details">
                        <div class="reviewer-name" th:text="${comment.userName}">Tên người dùng</div>
                        <div class="review-date" th:text="${#temporals.format(comment.createdAt, 'dd/MM/yyyy')}">Ngày
                          bình luận</div>
                      </div>
                    </div>
                    <div class="review-rating">
                      <i th:each="i : ${#numbers.sequence(1, 5)}"
                        th:class="${i <= (comment.rating != null ? comment.rating : 0) ? 'fas fa-star' : 'far fa-star'}"></i>
                    </div>
                  </div>

                  <div class="review-body">
                    <p th:text="${comment.content}">
                      Nội dung bình luận sẽ hiển thị ở đây
                    </p>
                  </div>

                  <div class="review-footer">
                    <div class="review-actions">
                      <div class="review-action like-action" th:data-comment-id="${comment.id}">
                        <i
                          th:class="${comment.isLikedByCurrentUser ? 'fas fa-thumbs-up liked' : 'far fa-thumbs-up'}"></i>
                        <span class="like-text" th:text="${comment.isLikedByCurrentUser ? 'Đã thích' : 'Hữu ích'}">Hữu
                          ích</span>
                        <span class="like-count"
                          th:text="${comment.likesCount != null ? comment.likesCount : 0}">0</span>
                      </div>
                      <div class="review-action dislike-action" th:data-comment-id="${comment.id}">
                        <i
                          th:class="${comment.isDislikedByCurrentUser ? 'fas fa-thumbs-down disliked' : 'far fa-thumbs-down'}"></i>
                        <span class="dislike-text"
                          th:text="${comment.isDislikedByCurrentUser ? 'Đã không thích' : 'Không hữu ích'}">Không hữu
                          ích</span>
                        <span class="dislike-count"
                          th:text="${comment.dislikesCount != null ? comment.dislikesCount : 0}">0</span>
                      </div>
                      <div class="review-action report-action" th:data-comment-id="${comment.id}">
                        <i class="far fa-flag"></i> Báo cáo
                      </div>
                    </div>
                    <div class="review-helpful">
                      <span th:text="${comment.likesCount != null ? comment.likesCount : 0}">0</span> người thấy hữu ích
                    </div>
                  </div>
                </div>

                <!-- Empty state when no comments -->
                <div
                  th:if="${(comments == null or comments.isEmpty()) and (document.comments == null or document.comments.isEmpty())}"
                  class="no-comments">
                  <div class="no-comments-icon">
                    <i class="far fa-comment"></i>
                  </div>
                  <div class="no-comments-text">
                    <h4>Chưa có bình luận nào</h4>
                    <p>Hãy là người đầu tiên chia sẻ ý kiến về tài liệu này!</p>
                  </div>
                </div>
              </div>

              <!-- Pagination controls -->
              <div th:if="${totalPages != null and totalPages > 1}" class="review-pagination">
                <div class="pagination-info">
                  <span
                    th:text="'Trang ' + ${currentPage != null ? currentPage + 1 : 1} + ' / ' + ${totalPages} + ' (' + ${totalElements != null ? totalElements : 0} + ' đánh giá)'">Trang
                    1 / 1 (0 đánh giá)</span>
                </div>
                <div class="pagination-controls">
                  <a th:if="${hasPrevious != null and hasPrevious}"
                    th:href="@{/documents/{id}/filter(id=${document.id}, rating=${currentRating}, sortBy=${currentSortBy}, page=${currentPage != null ? currentPage - 1 : 0}, size=${currentSize != null ? currentSize : 10})}"
                    class="pagination-btn">
                    <i class="fas fa-chevron-left"></i> Trước
                  </a>
                  <a th:if="${hasNext != null and hasNext}"
                    th:href="@{/documents/{id}/filter(id=${document.id}, rating=${currentRating}, sortBy=${currentSortBy}, page=${currentPage != null ? currentPage + 1 : 1}, size=${currentSize != null ? currentSize : 10})}"
                    class="pagination-btn">
                    Sau <i class="fas fa-chevron-right"></i>
                  </a>
                </div>
              </div>

              <!-- Load more button (for backward compatibility) -->
              <button th:if="${hasNext != null and hasNext and totalPages != null and totalPages > 1}"
                class="review-load-more">
                <i class="fas fa-plus"></i> Xem thêm đánh giá
              </button>
            </div>
          </div>

          <!-- Details Tab -->
          <div id="details-content" class="tab-content">
            <div class="document-details-tab">
              <h3>Thông tin chi tiết</h3>
              <div class="details-list">
                <div class="details-item" th:if="${document.authorName != null}">
                  <div class="details-label">Tác giả</div>
                  <div class="details-value" th:text="${document.authorName}">Tác giả</div>
                </div>
                <div class="details-item" th:if="${document.createdAt != null}">
                  <div class="details-label">Ngày tạo</div>
                  <div class="details-value" th:text="${#temporals.format(document.createdAt, 'dd/MM/yyyy')}">Ngày tạo
                  </div>
                </div>
                <div class="details-item" th:if="${document.updatedAt != null}">
                  <div class="details-label">Cập nhật lần cuối</div>
                  <div class="details-value" th:text="${#temporals.format(document.updatedAt, 'dd/MM/yyyy')}">Cập nhật
                    lần cuối</div>
                </div>
                <div class="details-item" th:if="${document.publishedAt != null}">
                  <div class="details-label">Ngày xuất bản</div>
                  <div class="details-value" th:text="${#temporals.format(document.publishedAt, 'dd/MM/yyyy')}">Ngày
                    xuất bản</div>
                </div>
                <div class="details-item" th:if="${document.fileType != null}">
                  <div class="details-label">Định dạng</div>
                  <div class="details-value" th:text="${document.fileType.toUpperCase()}">Định dạng</div>
                </div>
                <div class="details-item" th:if="${document.fileSize != null}">
                  <div class="details-label">Dung lượng</div>
                  <div class="details-value" th:text="${#numbers.formatDecimal(document.fileSize, 1, 2)} + ' KB'">Dung
                    lượng</div>
                </div>
                <div class="details-item" th:if="${document.fileName != null}">
                  <div class="details-label">Tên file</div>
                  <div class="details-value" th:text="${document.fileName}">Tên file</div>
                </div>
                <div class="details-item" th:if="${document.status != null}">
                  <div class="details-label">Trạng thái</div>
                  <div class="details-value" th:text="${document.status}">Trạng thái</div>
                </div>
                <div class="details-item" th:if="${document.visibility != null}">
                  <div class="details-label">Quyền truy cập</div>
                  <div class="details-value" th:text="${document.visibility}">Quyền truy cập</div>
                </div>
                <div class="details-item">
                  <div class="details-label">Lượt xem</div>
                  <div class="details-value" th:text="${document.viewsCount != null ? document.viewsCount : 0}">0</div>
                </div>
                <div class="details-item">
                  <div class="details-label">Lượt tải</div>
                  <div class="details-value" th:text="${document.downloadsCount != null ? document.downloadsCount : 0}">
                    0</div>
                </div>
                <div class="details-item" th:if="${document.averageRating != null}">
                  <div class="details-label">Đánh giá trung bình</div>
                  <div class="details-value"
                    th:text="${(document.averageRating != null ? T(java.lang.Math).round(document.averageRating) : 0)} + '/5 (' + ${(document.comments != null ? document.comments.size() : 0)} + ' đánh giá)'">
                    0/5 (0 đánh giá)</div>
                </div>
                <div class="details-item"
                  th:if="${document.categoryNames != null and !document.categoryNames.isEmpty()}">
                  <div class="details-label">Danh mục</div>
                  <div class="details-value" th:text="${#strings.listJoin(document.categoryNames, ', ')}">Danh mục</div>
                </div>
                <div class="details-item" th:if="${document.id != null}">
                  <div class="details-label">Mã tài liệu</div>
                  <div class="details-value" th:text="'DOC-' + ${document.id}">Mã tài liệu</div>
                </div>
              </div>
              <!-- Hiển thị thông báo nếu không có tags -->
              <div th:if="${document.tagNames == null or document.tagNames.isEmpty()}" class="no-tags">
                <p>Chưa có tags cho tài liệu này.</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Document Sidebar -->
        <div class="document-sidebar">
          <!-- Author Widget -->
          <div class="sidebar-widget">
            <div class="widget-header">
              <h3 class="widget-title">
                <i class="fas fa-user"></i> Tác giả
              </h3>
            </div>
            <div class="author-widget-content">
              <div class="author-large-avatar">
                <img
                  src="https://images.unsplash.com/photo-1568602471122-7832951cc4c5?ixlib=rb-1.2.1&auto=format&fit=crop&w=256&h=256&q=80"
                  alt="Author">
              </div>
              <h3 class="author-name-large" th:text="${document.authorName != null ? document.authorName : 'Admin'}">Tác
                giả</h3>
              <p class="author-bio">
                Tác giả của tài liệu này. Chia sẻ kiến thức và kinh nghiệm để giúp cộng đồng học tập.
              </p>

              <div class="author-stats">
                <div class="author-stat">
                  <div class="stat-number">1</div>
                  <div class="stat-label">Tài liệu</div>
                </div>
                <div class="author-stat">
                  <div class="stat-number"
                    th:text="${document.averageRating != null ? T(java.lang.Math).round(document.averageRating) : 0}">
                    0</div>
                  <div class="stat-label">Đánh giá</div>
                </div>
                <div class="author-stat">
                  <div class="stat-number" th:text="${document.downloadsCount != null ? document.downloadsCount : 0}">0
                  </div>
                  <div class="stat-label">Lượt tải</div>
                </div>
              </div>

              <!--
              <button class="author-follow-btn">
                <i class="fas fa-user-plus"></i> Theo dõi tác giả
              </button>-->

              <!-- Contact Widget 
              <div class="author-contact">
                <a href="#" class="author-contact-link">
                  <i class="fab fa-facebook-f"></i>
                </a>
                <a href="#" class="author-contact-link">
                  <i class="fab fa-twitter"></i>
                </a>
                <a href="#" class="author-contact-link">
                  <i class="fab fa-linkedin-in"></i>
                </a>
                <a href="#" class="author-contact-link">
                  <i class="fas fa-globe"></i>
                </a>
              </div>
              -->
            </div>
          </div>

          <!-- Related Documents Widget -->
          <div class="sidebar-widget">
            <div class="widget-header">
              <h3 class="widget-title">
                <i class="fas fa-file-alt"></i> Tài liệu liên quan
              </h3>
            </div>
            <div class="widget-content">
              <div >
                <div th:each="relatedDoc : ${relatedDocuments}" class="related-document">
                  <div class="related-document-thumbnail">
                    <img
                      src="https://images.unsplash.com/photo-1587620962725-abab7fe55159?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80"
                      alt="Document">
                  </div>
                  <div class="related-document-info">
                    <a th:href="@{/documents/{id}(id=${relatedDoc.id})}" th:text="${relatedDoc.title}"
                      class="related-document-title">Tài liệu liên quan</a>
                    <div class="related-document-meta">
                      <div class="document-rating">
                        <i class="fas fa-star"></i>
                        <span
                          th:text="${relatedDoc.averageRating != null ? #numbers.formatDecimal(relatedDoc.averageRating, 1, 1) : '0.0'}">0.0</span>
                      </div>
                      <div th:if="${relatedDoc.price != null and relatedDoc.price > 0}" class="document-price-small"
                        th:text="${#numbers.formatDecimal(relatedDoc.price, 1, 'COMMA', 0, 'POINT')} + ' xu'">0 xu</div>
                      <div th:if="${relatedDoc.price == null or relatedDoc.price == 0}"
                        class="document-price-small free">Miễn phí</div>
                    </div>
                  </div>
                </div>

                <div th:if="${relatedDocuments == null or relatedDocuments.isEmpty()}" class="no-related-documents">
                  <p>Chưa có tài liệu liên quan</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Tags Widget -->
          <div class="sidebar-widget">
            <div class="widget-header">
              <h3 class="widget-title">
                <i class="fas fa-tags"></i> Tags
              </h3>
            </div>
            <div class="widget-content">
              <div class="document-tags">
                <a th:each="tag : ${document.tagNames}" th:href="@{/search(tag=${tag})}" th:text="${tag}"
                  class="document-tag">Tag</a>
                <span th:if="${document.tagNames == null or document.tagNames.isEmpty()}" class="no-tags">Chưa có
                  tags</span>
              </div>
            </div>
          </div>

          <!-- Recommended Widget -->
          <div class="sidebar-widget">
            <div class="widget-header">
              <h3 class="widget-title">
                <i class="fas fa-thumbs-up"></i> Đề xuất cho bạn
              </h3>
            </div>
            <div class="widget-content">
              <div class="recommendation-list">
                <div th:each="relatedDoc : ${relatedDocuments}" class="recommendation-item">
                  <div class="recommendation-image">
                    <img
                      src="https://images.unsplash.com/photo-1517694712202-14dd9538aa97?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80"
                      alt="Document">
                  </div>
                  <div class="recommendation-info">
                    <div class="recommendation-category">
                      <i class="fas fa-folder"></i>
                      <span
                        th:text="${relatedDoc.categoryNames != null and !relatedDoc.categoryNames.isEmpty() ? relatedDoc.categoryNames[0] : 'Tài liệu'}">Công
                        nghệ thông tin</span>
                    </div>
                    <a th:href="@{/documents/{id}(id=${relatedDoc.id})}" th:text="${relatedDoc.title}"
                      class="recommendation-title">Tài liệu đề xuất</a>
                    <div class="recommendation-meta">
                      <div class="recommendation-rating">
                        <i class="fas fa-star"></i>
                        <span
                          th:text="${relatedDoc.averageRating != null ? #numbers.formatDecimal(relatedDoc.averageRating, 1, 1) : '0.0'}">0.0</span>
                      </div>
                      <div th:if="${relatedDoc.price != null and relatedDoc.price > 0}" class="document-price-small"
                        th:text="${#numbers.formatDecimal(relatedDoc.price, 1, 'COMMA', 0, 'POINT')} + ' xu'">0 xu</div>
                      <div th:if="${relatedDoc.price == null or relatedDoc.price == 0}"
                        class="document-price-small free">Miễn phí</div>
                    </div>
                  </div>
                </div>

                <div th:if="${relatedDocuments == null or relatedDocuments.isEmpty()}" class="no-recommendations">
                  <p>Chưa có tài liệu đề xuất</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Share Modal -->
  <div id="shareModal" class="share-modal-overlay">
    <div class="share-modal">
      <div class="share-modal-header">
        <h3 class="share-modal-title">Chia sẻ tài liệu</h3>
        <button class="share-modal-close">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="share-modal-body">
        <div class="share-options">
          <div class="share-option" data-type="facebook">
            <div class="share-icon facebook">
              <i class="fab fa-facebook-f"></i>
            </div>
            <div class="share-label">Facebook</div>
          </div>

          <div class="share-option" data-type="twitter">
            <div class="share-icon twitter">
              <i class="fab fa-twitter"></i>
            </div>
            <div class="share-label">Twitter</div>
          </div>

          <div class="share-option" data-type="linkedin">
            <div class="share-icon linkedin">
              <i class="fab fa-linkedin-in"></i>
            </div>
            <div class="share-label">LinkedIn</div>
          </div>

          <div class="share-option" data-type="email">
            <div class="share-icon email">
              <i class="fas fa-envelope"></i>
            </div>
            <div class="share-label">Email</div>
          </div>
        </div>

        <div class="share-link">
          <div class="share-link-label">Hoặc sao chép liên kết:</div>
          <div class="share-link-container">
            <input type="text" id="shareLink" class="share-link-input" value="" readonly>
            <button id="shareLinkCopy" class="share-link-copy">
              <i class="far fa-copy"></i> Sao chép
            </button>
          </div>
        </div>

        <div class="share-embed">
          <div class="share-embed-label">Mã nhúng <span>HTML</span></div>
          <textarea id="shareEmbedCode" class="share-embed-code" readonly></textarea>
          <button id="shareEmbedCopy" class="share-embed-copy">
            <i class="far fa-copy"></i> Sao chép mã nhúng
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div th:replace="~{fragments/client/layout :: footer}"></div>

  <!-- Back To Top Button -->
  <button id="backToTop" class="back-to-top">
    <i class="fas fa-arrow-up"></i>
  </button>

  <script th:src="@{/js/main.js}"></script>
  <script th:src="@{/js/document-detail.js}"></script>
  <script th:src="@{/js/document-detail-enhanced.js}"></script>
  <script th:src="@{/js/client-header.js}"></script>
  <script th:src="@{/js/comment-actions.js}"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.7.107/pdf.min.js"></script>
  <script>
    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.7.107/pdf.worker.min.js';
    }
  </script>
  <script th:src="@{/js/document-detail-preview.js}"></script>
  <script>
    // Document Detail Preview Page JavaScript
    document.addEventListener('DOMContentLoaded', function () {
      // Preview Tab Navigation
      const prevPageBtn = document.getElementById('prevPage');
      const nextPageBtn = document.getElementById('nextPage');
      const pageInput = document.getElementById('pageInput');
      const goToPageBtn = document.getElementById('goToPage');
      const previewPages = document.querySelectorAll('.preview-page-view');
      const currentPageDisplay = document.querySelector('.current-page');
      const totalPagesDisplay = document.querySelector('.total-pages');

      if (previewPages.length) {
        let currentPageIndex = 0;
        const totalPages = previewPages.length;

        // Set total pages display
        if (totalPagesDisplay) {
          totalPagesDisplay.textContent = totalPages;
        }

        // Function to show a specific page
        function showPage(index) {
          if (index < 0 || index >= totalPages) return;

          // Hide all pages
          previewPages.forEach(page => page.classList.remove('active'));

          // Show selected page
          previewPages[index].classList.add('active');

          // Update current page display
          if (currentPageDisplay) {
            currentPageDisplay.textContent = index + 1;
          }

          // Update page input
          if (pageInput) {
            pageInput.value = index + 1;
          }

          // Update buttons state
          if (prevPageBtn) {
            prevPageBtn.disabled = index === 0;
          }

          if (nextPageBtn) {
            nextPageBtn.disabled = index === totalPages - 1;
          }

          // Save current page to sessionStorage
          sessionStorage.setItem('previewCurrentPage', index);

          // Update current page index
          currentPageIndex = index;
        }

        // Initialize first page or restore from sessionStorage
        const savedPage = sessionStorage.getItem('previewCurrentPage');
        const initialPage = savedPage ? parseInt(savedPage, 10) : 0;
        showPage(initialPage);

        // Previous page button
        if (prevPageBtn) {
          prevPageBtn.addEventListener('click', () => {
            showPage(currentPageIndex - 1);
          });
        }

        // Next page button
        if (nextPageBtn) {
          nextPageBtn.addEventListener('click', () => {
            showPage(currentPageIndex + 1);
          });
        }

        // Go to specific page
        if (goToPageBtn && pageInput) {
          goToPageBtn.addEventListener('click', () => {
            const pageNumber = parseInt(pageInput.value, 10);
            if (!isNaN(pageNumber) && pageNumber >= 1 && pageNumber <= totalPages) {
              showPage(pageNumber - 1);
            } else {
              // Reset to current page if invalid input
              pageInput.value = currentPageIndex + 1;
            }
          });

          // Allow Enter key to navigate to page
          pageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
              goToPageBtn.click();
            }
          });
        }

        // Document Type Selection
        const documentTypes = document.querySelectorAll('.document-type');

        if (documentTypes.length) {
          documentTypes.forEach(type => {
            type.addEventListener('click', function () {
              // Remove active class from all types
              documentTypes.forEach(t => t.classList.remove('active'));

              // Add active class to clicked type
              this.classList.add('active');

              // You could update the document preview or download options here
              // based on the selected document type
            });
          });
        }

        // Preview Carousel Navigation
        const previewNextBtn = document.querySelector('.preview-carousel .next-btn');
        const previewPrevBtn = document.querySelector('.preview-carousel .prev-btn');
        const previewPages2 = document.querySelector('.preview-pages');

        if (previewNextBtn && previewPrevBtn && previewPages2) {
          // Next button
          previewNextBtn.addEventListener('click', () => {
            previewPages2.scrollBy({
              left: 200,
              behavior: 'smooth'
            });
          });

          // Previous button
          previewPrevBtn.addEventListener('click', () => {
            previewPages2.scrollBy({
              left: -200,
              behavior: 'smooth'
            });
          });
        }

        // Preview button in download card
        const previewButton = document.querySelector('.preview-button');
        const previewTab = document.querySelector('.content-tab[data-tab="preview"]');

        if (previewButton && previewTab) {
          previewButton.addEventListener('click', () => {
            previewTab.click();

            // Scroll to the preview content
            const previewContent = document.getElementById('preview-content');
            if (previewContent) {
              previewContent.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
              });
            }
          });
        }

        // Download button in preview footer
        const previewDownloadBtn = document.querySelector('.download-button-small');
        const mainDownloadBtn = document.querySelector('.download-button');

        if (previewDownloadBtn && mainDownloadBtn) {
          previewDownloadBtn.addEventListener('click', () => {
            // Trigger the main download button's click event
            mainDownloadBtn.click();
          });
        }

        // Comment actions are now handled by comment-actions.js
        console.log('Document preview initialized');
      }
    });
  </script>

  <!-- Report Modal -->
  <div id="reportModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Báo cáo vi phạm</h3>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body">
        <form id="reportForm" data-ajax="true">
          <div class="form-group">
            <label for="reportType">Loại vi phạm:</label>
            <select id="reportType" name="type" required>
              <option value="">Chọn loại vi phạm</option>
              <option value="copyright">Vi phạm bản quyền</option>
              <option value="inappropriate">Nội dung không phù hợp</option>
              <option value="spam">Spam</option>
              <option value="fake">Thông tin giả mạo</option>
              <option value="other">Khác</option>
            </select>
          </div>
          <div class="form-group">
            <label for="reportReason">Lý do báo cáo:</label>
            <textarea id="reportReason" name="reason" rows="4" placeholder="Mô tả chi tiết lý do báo cáo..." required></textarea>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-danger">Gửi báo cáo</button>
          </div>
        </form>
      </div>
    </div>
  </div>



  <script>
    // Toast notification function
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 5px;
        color: white;
        font-weight: 500;
        z-index: 10000;
        animation: slideIn 0.3s ease;
      `;
      
      if (type === 'success') {
        toast.style.backgroundColor = '#28a745';
      } else if (type === 'error') {
        toast.style.backgroundColor = '#dc3545';
      } else {
        toast.style.backgroundColor = '#17a2b8';
      }
      
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => document.body.removeChild(toast), 300);
      }, 3000);
    }
      
      // Toast notification function
      function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 12px 20px;
          border-radius: 5px;
          color: white;
          font-weight: 500;
          z-index: 10000;
          animation: slideIn 0.3s ease;
        `;
        
        if (type === 'success') {
          toast.style.backgroundColor = '#28a745';
        } else if (type === 'error') {
          toast.style.backgroundColor = '#dc3545';
        } else {
          toast.style.backgroundColor = '#17a2b8';
        }
        
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
          toast.style.animation = 'slideOut 0.3s ease';
          setTimeout(() => document.body.removeChild(toast), 300);
        }, 3000);
      }
      
      // Add CSS animations
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideIn {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
          from { transform: translateX(0); opacity: 1; }
          to { transform: translateX(100%); opacity: 0; }
        }
        
        .price-badge {
          background: #ff6b35;
          color: white;
          padding: 2px 8px;
          border-radius: 12px;
          font-size: 0.8em;
          font-weight: 600;
          margin-left: 8px;
        }
        
        .purchase-details {
          margin: 15px 0;
        }
        
        .purchase-info p {
          margin: 8px 0;
          font-size: 1.1em;
        }
        
        .commission-info {
          border-left: 3px solid #17a2b8;
        }
        
        /* Purchase modal styles */
        .purchase-info {
          margin: 15px 0;
        }
        
        .purchase-info-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin: 10px 0;
          padding: 8px 0;
          border-bottom: 1px solid #eee;
        }
        
        .purchase-info-label {
          font-weight: 600;
          color: #333;
        }
        
        .purchase-info-value {
          font-weight: 500;
          color: #4361ee;
        }
        
        .commission-info {
          margin-top: 15px;
          padding: 10px;
          background-color: #f8f9fa;
          border-radius: 5px;
          font-size: 0.9em;
          border-left: 3px solid #17a2b8;
          color: #666;
        }
        
        .insufficient-balance {
          margin-top: 10px;
          padding: 10px;
          background-color: #fff3cd;
          border: 1px solid #ffeaa7;
          border-radius: 5px;
          color: #856404;
        }
        
        .download-recharge-btn {
          display: inline-block;
          padding: 10px 20px;
          margin: 5px;
          background-color: #6c757d;
          color: white;
          text-decoration: none;
          border-radius: 5px;
          font-size: 14px;
        }
        
        .download-recharge-btn:hover {
          background-color: #5a6268;
          color: white;
          text-decoration: none;
        }
      `;
      document.head.appendChild(style);
    })();
  </script>

  <script>
    (function() {
      // Preview tab controls init
      const previewTabContent = document.querySelector('#preview-content');
      const prevPageBtn = previewTabContent ? previewTabContent.querySelector('.prev-page') : null;
      const nextPageBtn = previewTabContent ? previewTabContent.querySelector('.next-page') : null;
      const currentPageDisplay = previewTabContent ? previewTabContent.querySelector('.current-page') : null;
      const totalPagesDisplay = previewTabContent ? previewTabContent.querySelector('.total-pages') : null;
      const pageInput = previewTabContent ? previewTabContent.querySelector('.page-input') : null;
      const goToPageBtn = previewTabContent ? previewTabContent.querySelector('.go-to-page-btn') : null;
      const previewPages = previewTabContent ? previewTabContent.querySelectorAll('.preview-page') : [];
      let currentPageIndex = 0;
      const totalPages = previewPages.length || (totalPagesDisplay ? parseInt(totalPagesDisplay.textContent || '1', 10) : 1);
      if (totalPagesDisplay) totalPagesDisplay.textContent = String(totalPages);

      function showPage(index){/* giữ nguyên phần logic hiện có ở dưới */}
    })();
  </script>

  <script>
    // Share functionality
    function shareDocument() {
      const documentTitle = document.querySelector('.document-title').textContent;
      const shareUrl = window.location.origin + window.location.pathname;
      const shareText = `Tôi đã tìm thấy tài liệu "${documentTitle}" trên EduShare: ${shareUrl}`;
      
      if (navigator.share) {
        navigator.share({
          title: documentTitle,
          text: shareText,
          url: shareUrl
        });
      } else {
        // Fallback: copy to clipboard
        navigator.clipboard.writeText(shareUrl).then(() => {
          showToast('Đã sao chép link chia sẻ!', 'success');
        });
      }
    }

    // Report functionality
    function openReportModal() {
      document.getElementById('reportModal').style.display = 'block';
      // Set default action for document-level report to avoid posting to current URL
      const form = document.getElementById('reportForm');
      if (form && !form.hasAttribute('data-mode')) {
        const documentId = window.location.pathname.split('/').pop();
        form.setAttribute('action', `/documents/${documentId}/report`);
        form.setAttribute('method', 'post');
      }
    }

    function closeReportModal() {
      document.getElementById('reportModal').style.display = 'none';
    }

    // Handle report form submission
    document.getElementById('reportForm').addEventListener('submit', function(e) {
      // Nếu đang báo cáo bình luận, cho submit native để server redirect và flash toast
      if (this.getAttribute('data-mode') === 'comment') {
        return; // Allow native submit
      }
      e.preventDefault();
      
      const formData = new FormData(this);
      const documentId = window.location.pathname.split('/').pop();
      const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
      const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

      // Auto-fill reason by selected type text if no custom reason provided
      const typeSelect = document.getElementById('reportType');
      const reasonTextarea = document.getElementById('reportReason');
      if (typeSelect && reasonTextarea && !reasonTextarea.value.trim() && typeSelect.value) {
        const selectedText = typeSelect.options[typeSelect.selectedIndex].text;
        reasonTextarea.value = selectedText;
        formData.set('reason', selectedText);
      }
      
      // Determine endpoint: prefer explicit form.action, fallback to document report
      const actionUrl = this.action && this.action.trim().length > 0
        ? this.action
        : `/documents/${documentId}/report`;
      // Ensure form attribute also reflects the target (prevent accidental native submit elsewhere)
      this.action = actionUrl;
      
      fetch(actionUrl, {
        method: 'POST',
        headers: csrfToken && csrfHeader ? { [csrfHeader]: csrfToken } : {},
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showToast(data.message, 'success');
          closeReportModal();
          this.reset();
        } else {
          showToast(data.error || 'Có lỗi xảy ra', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showToast('Có lỗi xảy ra khi gửi báo cáo', 'error');
      });
    });

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('reportModal');
      if (event.target === modal) {
        closeReportModal();
      }
    }

    // Close modal when clicking X
    document.querySelector('.close').onclick = function() {
      closeReportModal();
    }
  </script>
</body>

</html>