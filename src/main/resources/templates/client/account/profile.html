<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle} + ' - EduShare'">Thông tin cá nhân - EduShare</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link th:href="@{/css/account.css}" rel="stylesheet">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body>
    <div th:replace="~{fragments/client/layout :: header}"></div>
    
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 p-0">
                <div th:replace="~{fragments/client/account-sidebar :: sidebar}"></div>
            </div>
            
            <!-- Main Content -->
            <div class="col-md-9 col-lg-10">
                <div class="account-content">
                    <div class="content-header">
                        <h2><i class="fas fa-user me-2"></i>Thông tin cá nhân</h2>
                        <p class="text-muted">Quản lý thông tin cá nhân và cài đặt tài khoản của bạn</p>
                    </div>

                    <!-- Flash Messages -->
                    <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="fas fa-check-circle me-2"></i>
                        <span th:text="${success}"></span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    
                    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <span th:text="${error}"></span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>

                    <!-- Profile Form -->
                    <div class="card">
                        <div class="card-body">
                            <form th:action="@{/account/profile/update}" method="post" enctype="multipart/form-data" id="profileForm">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                
                                <!-- Avatar Section -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h5 class="mb-3"><i class="fas fa-image me-2"></i>Ảnh đại diện</h5>
                                        <div class="avatar-section">
                                            <div class="current-avatar">
                                                <img th:src="${currentUser.avatarUrl != null ? currentUser.avatarUrl : '/images/default-avatar.png'}" 
                                                     alt="Avatar" class="avatar-preview" id="avatarPreview">
                                            </div>
                                            <div class="avatar-upload">
                                                <label for="avatarFile" class="btn btn-outline-primary">
                                                    <i class="fas fa-camera me-2"></i>Thay đổi ảnh
                                                </label>
                                                <input type="file" id="avatarFile" name="avatarFile" accept="image/*" style="display: none;">
                                                <small class="text-muted d-block mt-2">
                                                    Chấp nhận: JPG, PNG, GIF. Tối đa 5MB.
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <hr>

                                <!-- Personal Information -->
                                <h5 class="mb-3"><i class="fas fa-user me-2"></i>Thông tin cá nhân</h5>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="fullName" class="form-label">Họ và tên <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="fullName" name="fullName" 
                                               th:value="${currentUser.fullName}" required maxlength="255">
                                        <div class="invalid-feedback">Vui lòng nhập họ và tên</div>
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
                                        <input type="email" class="form-control" id="email" name="email" 
                                               th:value="${currentUser.email}" required maxlength="255">
                                        <div class="invalid-feedback">Vui lòng nhập email hợp lệ</div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="phoneNumber" class="form-label">Số điện thoại</label>
                                        <input type="tel" class="form-control" id="phoneNumber" name="phoneNumber" 
                                               th:value="${currentUser.phoneNumber}" pattern="[0-9+\-\s()]{10,15}" maxlength="15">
                                        <div class="invalid-feedback">Số điện thoại không hợp lệ</div>
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="dateOfBirth" class="form-label">Ngày sinh</label>
                                        <input type="date" class="form-control" id="dateOfBirth" name="dateOfBirth" 
                                               th:value="${currentUser.dateOfBirth}">
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="gender" class="form-label">Giới tính</label>
                                        <select class="form-select" id="gender" name="gender">
                                            <option value="">Chọn giới tính</option>
                                            <option value="male" th:selected="${currentUser.gender == 'male'}">Nam</option>
                                            <option value="female" th:selected="${currentUser.gender == 'female'}">Nữ</option>
                                            <option value="other" th:selected="${currentUser.gender == 'other'}">Khác</option>
                                        </select>
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="address" class="form-label">Địa chỉ</label>
                                        <input type="text" class="form-control" id="address" name="address" 
                                               th:value="${currentUser.address}" maxlength="255">
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="bio" class="form-label">Giới thiệu bản thân</label>
                                    <textarea class="form-control" id="bio" name="bio" rows="4" maxlength="500" 
                                              placeholder="Viết vài dòng giới thiệu về bản thân..." th:text="${currentUser.bio}"></textarea>
                                    <div class="form-text">
                                        <span id="bioCount">0</span>/500 ký tự
                                    </div>
                                </div>

                                <hr>

                                <!-- Additional Settings -->
                                <h5 class="mb-3"><i class="fas fa-cog me-2"></i>Cài đặt bổ sung</h5>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="language" class="form-label">Ngôn ngữ</label>
                                        <select class="form-select" id="language" name="language">
                                            <option th:each="lang : ${languages}" 
                                                    th:value="${lang[0]}" 
                                                    th:text="${lang[1]}"
                                                    th:selected="${currentUser.language == lang[0]}"></option>
                                        </select>
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="timezone" class="form-label">Múi giờ</label>
                                        <select class="form-select" id="timezone" name="timezone">
                                            <option value="">Chọn múi giờ</option>
                                            <option th:each="tz : ${timezones}" 
                                                    th:value="${tz}" 
                                                    th:text="${tz}"
                                                    th:selected="${currentUser.timezone == tz}"></option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Submit Button -->
                                <div class="d-flex justify-content-end mt-4">
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="fas fa-save me-2"></i>Lưu thay đổi
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div th:replace="~{fragments/client/layout :: footer}"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Avatar preview
        document.getElementById('avatarFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Validate file type
                if (!file.type.startsWith('image/')) {
                    alert('Chỉ chấp nhận file ảnh!');
                    this.value = '';
                    return;
                }
                
                // Validate file size (5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('Kích thước file không được vượt quá 5MB!');
                    this.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('avatarPreview').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // Bio character count
        const bioTextarea = document.getElementById('bio');
        const bioCount = document.getElementById('bioCount');
        
        function updateBioCount() {
            const count = bioTextarea.value.length;
            bioCount.textContent = count;
            bioCount.className = count > 450 ? 'text-warning' : count > 480 ? 'text-danger' : '';
        }
        
        bioTextarea.addEventListener('input', updateBioCount);
        updateBioCount(); // Initial count

        // Form validation
        document.getElementById('profileForm').addEventListener('submit', function(e) {
            const fullName = document.getElementById('fullName').value.trim();
            const email = document.getElementById('email').value.trim();
            const phoneNumber = document.getElementById('phoneNumber').value.trim();
            const dateOfBirth = document.getElementById('dateOfBirth').value;
            
            let isValid = true;
            
            // Reset validation states
            document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            
            // Validate full name
            if (!fullName) {
                document.getElementById('fullName').classList.add('is-invalid');
                isValid = false;
            }
            
            // Validate email
            const emailRegex = /^[A-Za-z0-9+_.-]+@(.+)$/;
            if (!email || !emailRegex.test(email)) {
                document.getElementById('email').classList.add('is-invalid');
                isValid = false;
            }
            
            // Validate phone number (if provided)
            if (phoneNumber) {
                const phoneRegex = /^[0-9+\-\s()]{10,15}$/;
                if (!phoneRegex.test(phoneNumber)) {
                    document.getElementById('phoneNumber').classList.add('is-invalid');
                    isValid = false;
                }
            }
            
            // Validate age (if date of birth provided)
            if (dateOfBirth) {
                const birthDate = new Date(dateOfBirth);
                const today = new Date();
                const age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                
                if (age < 13) {
                    document.getElementById('dateOfBirth').classList.add('is-invalid');
                    alert('Bạn phải ít nhất 13 tuổi!');
                    isValid = false;
                }
            }
            
            if (!isValid) {
                e.preventDefault();
            }
        });

        // Auto-hide alerts after 5 seconds
        setTimeout(function() {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(function(alert) {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            });
        }, 5000);
    </script>
</body>
</html>