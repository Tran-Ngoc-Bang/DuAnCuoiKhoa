<!DOCTYPE html>
<html
  lang="vi"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
>
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1"
    />
    <title>Lịch sử giao dịch - EduShare</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Open+Sans:wght@400;500;600&family=Playfair+Display:wght@700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link rel="stylesheet" th:href="@{/css/main.css}" />
    <link rel="stylesheet" th:href="@{/css/responsive.css}" />
    <link rel="stylesheet" th:href="@{/css/main-fixes.css}" />
    <link rel="stylesheet" th:href="@{/css/account.css}" />
    <link rel="stylesheet" th:href="@{/css/footer-modern.css}" />
    <link rel="stylesheet" th:href="@{/css/client-header.css}" />
    <link rel="stylesheet" th:href="@{/css/client-footer.css}" />
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <style>
      :root {
        --primary: #4361ee;
        --primary-dark: #3a56d4;
        --primary-light: rgba(67, 97, 238, 0.1);
        --success: #10b981;
        --success-light: rgba(16, 185, 129, 0.1);
        --warning: #f59e0b;
        --warning-light: rgba(245, 158, 11, 0.1);
        --danger: #ef4444;
        --danger-light: rgba(239, 68, 68, 0.1);
        --gray-50: #f9fafb;
        --gray-100: #f3f4f6;
        --gray-200: #e5e7eb;
        --gray-300: #d1d5db;
        --gray-600: #4b5563;
        --gray-700: #374151;
        --gray-900: #111827;
        --white: #ffffff;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --radius: 0.375rem;
        --radius-lg: 0.5rem;
        --radius-xl: 0.75rem;
        --transition: all 0.3s ease;
      }

      body {
        background-color: #f5f7fb;
        min-height: 100vh;
        font-family: "Nunito", sans-serif;
      }

      .dashboard-page {
        padding-top: 2rem;
        padding-bottom: 3rem;
      }

      .dashboard-header {
        margin-top: 10%;
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1.5rem;
      }

      .dashboard-header-actions {
        display: flex;
        align-items: center;
        gap: 1.5rem;
      }

      .date-display {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.95rem;
        color: var(--gray-600);
        background-color: white;
        padding: 0.5rem 1rem;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--gray-200);
      }

      .refresh-button,
      .recharge-button,
      .settings-button {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        font-size: 0.95rem;
        font-weight: 500;
        border: none;
        border-radius: var(--radius-lg);
        cursor: pointer;
        transition: var(--transition);
      }

      .refresh-button {
        color: var(--primary);
        background-color: var(--primary-light);
      }

      .refresh-button:hover {
        background-color: var(--primary);
        color: white;
      }

      .recharge-button {
        background-color: var(--success);
        color: white;
      }

      .recharge-button:hover {
        color: black;
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
      }

      .settings-button {
        background-color: var(--warning);
        color: var(--gray-900);
      }

      .settings-button:hover {
        color: white;
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
      }

      .dashboard-content {
        display: flex;
        flex-wrap: wrap;
        gap: 2rem;
        margin-top: 2rem;
      }

      .dashboard-sidebar {
        width: 280px;
        background-color: white;
        border-radius: var(--radius-xl);
        padding: 0;
        box-shadow: var(--shadow-md);
        position: sticky;
        top: 2rem;
        height: fit-content;
        overflow: hidden;
      }

      .sidebar-header {
        padding: 1.5rem;
        border-bottom: 1px solid var(--gray-200);
        background-color: var(--primary-light);
      }

      .user-profile {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        padding-bottom: 0.5rem;
      }

      .user-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid white;
        box-shadow: var(--shadow-md);
        margin-bottom: 1rem;
      }

      .user-name {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--gray-900);
        margin-bottom: 0.25rem;
      }

      .user-email {
        font-size: 0.875rem;
        color: var(--gray-600);
        margin-bottom: 1rem;
      }

      .user-status {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        background-color: var(--primary-light);
        color: var(--primary);
        border-radius: 1rem;
        font-size: 0.75rem;
        font-weight: 600;
      }

      .user-status-icon {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: var(--primary);
        margin-right: 0.5rem;
      }

      .sidebar-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--gray-800);
        margin-bottom: 0.5rem;
      }

      .sidebar-menu {
        list-style: none;
        padding: 0.75rem 0;
        margin: 0;
      }

      .sidebar-menu-title {
        font-size: 0.75rem;
        text-transform: uppercase;
        color: var(--gray-600);
        margin-top: 1.5rem;
        margin-bottom: 0.5rem;
        font-weight: 600;
        padding-left: 0.5rem;
      }

      .sidebar-menu-item {
        margin-bottom: 0.25rem;
      }

      .sidebar-menu-link {
        display: flex;
        align-items: center;
        padding: 0.75rem 1.5rem;
        color: var(--gray-700);
        text-decoration: none;
        transition: var(--transition);
        position: relative;
        font-size: 0.95rem;
      }

      .sidebar-menu-link:hover {
        color: var(--primary);
        background-color: var(--primary-light);
      }

      .sidebar-menu-link.active {
        color: var(--primary);
        font-weight: 600;
        background-color: var(--primary-light);
      }

      .sidebar-menu-link.active::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background-color: var(--primary);
      }

      .sidebar-icon {
        width: 1.25rem;
        margin-right: 0.75rem;
        text-align: center;
      }

      .dashboard-main {
        flex: 1;
        min-width: 0;
      }

      .dashboard-section {
        background-color: white;
        border-radius: var(--radius-xl);
        padding: 2rem 2rem 5rem;
        box-shadow: var(--shadow-md);
        margin-bottom: 2.5rem;
        border: 1px solid var(--gray-100);
      }

      .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1.25rem;
      }

      .section-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--gray-900);
        display: flex;
        align-items: center;
      }

      .section-title-icon {
        margin-right: 0.75rem;
        color: var(--primary);
        font-size: 1.125rem;
      }

      .tab-buttons {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .tab-button {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: var(--radius);
        background: var(--gray-200);
        color: var(--gray-700);
        cursor: pointer;
        transition: var(--transition);
      }

      .tab-button.active {
        background: var(--primary);
        color: var(--white);
      }

      .tab-button:hover {
        background: var(--primary-light);
        color: var(--primary);
      }

      .tab-navigation {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        border-bottom: 2px solid var(--gray-200);
        padding-bottom: 0;
      }

      .tab-button {
        background: none;
        border: none;
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
        font-weight: 600;
        color: var(--gray-600);
        cursor: pointer;
        border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        transition: var(--transition);
        border-bottom: 3px solid transparent;
      }

      .tab-button.active {
        background: var(--white);
        color: var(--primary);
        border-bottom-color: var(--primary);
      }

      .tab-button:hover:not(.active) {
        background: var(--gray-50);
        color: var(--gray-700);
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .chart-container {
        width: 100%;
        height: 300px;
        margin-top: 1.5rem;
      }

      .transaction-groups {
        margin-top: 1.5rem;
      }

      .transaction-group {
        margin-bottom: 2rem;
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        padding: 1.5rem;
        transition: all 0.3s ease;
      }

      .transaction-group h3 {
        font-size: 1.25rem;
        color: #1f2937;
        margin-bottom: 1rem;
        font-weight: 600;
        border-bottom: 2px solid #e5e7eb;
        padding-bottom: 0.5rem;
      }

      .transaction-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        font-size: 0.875rem;
        color: #374151;
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        overflow: hidden;
      }

      .transaction-table thead {
        background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        color: #4b5563;
      }

      .transaction-table th {
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #d1d5db;
        white-space: nowrap;
      }

      .transaction-table tbody tr {
        transition: background 0.2s ease;
      }
      .transaction-table-container {
        overflow-x: auto;
        border-radius: 8px;
        background: #f9fafb;
      }

      .transaction-table tbody tr:hover {
        background: #f1f5f9;
      }

      .transaction-table td {
        padding: 1rem;
    border-bottom: 1px solid #e5e7eb;
    vertical-align: middle;
    white-space: nowrap;
      }

      .transaction-table td:not(.action-cell) {
        cursor: help;
      }

      .transaction-table td.action-cell {
        overflow: visible; /* Allow buttons to show fully */
        min-width: 120px; /* Minimum width to ensure buttons fit */
      }

      .transaction-table td:first-child {
        padding-left: 1.5rem;
      }

      .transaction-table td:last-child {
        padding-right: 1.5rem;
      }
      .transaction-table tbody tr:last-child td {
        border-bottom: none;
      }

      .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
        color: #ffffff;
        transition: all 0.2s ease;
        white-space: nowrap;
      }

      .status-success {
        background: var(--success-light);
        color: var(--success);
      }

      .status-pending {
        background: var(--warning-light);
        color: var(--warning);
      }

      .status-failed {
        background: var(--danger-light);
        color: var(--danger);
      }

      .status-refunded {
        background: rgba(23, 162, 184, 0.1);
        color: #17a2b8;
      }

      .action-cell {
        display: flex;
        margin-right: 2rem;
        gap: 0.5rem;
        align-items: center;
        flex-wrap: wrap; /* Allow buttons to wrap if space is tight */
      }

      .action-btn,
      .refund-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
        white-space: nowrap;
      }
      .action-btn {
        background: #3b82f6;
        color: #ffffff;
        box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
        padding: 0.5rem 1.5rem;
      }

      .action-btn:hover {
        background: #2563eb;
        transform: translateY(-1px);
        box-shadow: 0 3px 6px rgba(59, 130, 246, 0.3);
      }

      .refund-btn {
        background: #f3f4f6;
        color: #374151;
        border: 1px solid #d1d5db;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .refund-btn:hover {
        background: #e5e7eb;
        border-color: #9ca3af;
        transform: translateY(-1px);
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
      }

      .custom-checkbox {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .custom-checkbox input[type="checkbox"] {
        display: none;
      }

      .custom-checkbox label {
        position: relative;
        cursor: pointer;
        padding-left: 1.5rem;
        font-size: 0.9rem;
        color: var(--gray-700);
      }

      .custom-checkbox label:before {
        content: "";
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 1.2rem;
        height: 1.2rem;
        border: 2px solid var(--gray-300);
        border-radius: 0.3rem;
        background-color: var(--white);
        transition: var(--transition);
      }

      .custom-checkbox input[type="checkbox"]:checked + label:before {
        background-color: var(--primary);
        border-color: var(--primary);
      }

      .custom-checkbox input[type="checkbox"]:checked + label:after {
        content: "\2713";
        position: absolute;
        left: 0.25rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--white);
        font-size: 0.8rem;
      }

      .sidebar-badge {
        margin-left: auto;
        background-color: var(--primary);
        color: white;
        font-size: 0.75rem;
        padding: 0.125rem 0.5rem;
        border-radius: 1rem;
      }

      .support-btn {
        background: #6b7280;
        color: white;
        width: 100%;
        text-align: center;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: var(--radius);
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.95rem;
      }

      .support-btn:hover {
        background: #4b5563;
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
      }

      .download-btn {
        background: #10b981;
        color: white;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: var(--radius);
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.95rem;
      }

      .download-btn:hover {
        background: darken(#10b981, 10%);
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
      }
      #exportBtn {
        background: orange; /* #4361ee - Xanh dương */
        color: white;
      }

      #exportBtn:hover {
        background: var(--primary-dark); /* #3a56d4 - Xanh dương đậm hơn */
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
      }

      .export-btn {
        background: #8b5cf6;
        color: white;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: var(--radius);
        cursor: pointer;
        transition: var(--transition);
      }

      .export-btn:hover {
        background: #7c3aed;
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
      }

      .filters {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
        align-items: end;
      }

      .form-group {
        display: flex;
        flex-direction: column;
      }

      .filters label {
        display: block;
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--gray-700);
        margin-bottom: 0.5rem;
      }

      .filters input,
      .filters select {
        width: 100%;
        padding: 0.875rem 1rem;
        border: 1px solid var(--gray-300);
        border-radius: var(--radius-lg);
        font-family: "Nunito", sans-serif;
        font-size: 0.95rem;
        color: var(--gray-700);
        background-color: var(--white);
        transition: var(--transition);
        box-shadow: var(--shadow-sm);
      }

      .filters input:focus,
      .filters select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px var(--primary-light);
        outline: none;
      }

      .filters button,
      .action-button {
        padding: 0.875rem 1.5rem;
        background: linear-gradient(
          135deg,
          var(--primary),
          var(--primary-dark)
        );
        color: var(--white);
        border: none;
        border-radius: var(--radius-lg);
        cursor: pointer;
        transition: var(--transition);
        font-size: 0.95rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        box-shadow: var(--shadow-md);
      }

      .filters button:hover,
      .action-button:hover {
        background: linear-gradient(
          135deg,
          var(--primary-dark),
          var(--primary)
        );
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
      }

      .section-actions {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .time-range-select {
        padding: 0.5rem 1rem;
        border: 1px solid var(--gray-300);
        border-radius: var(--radius);
        background-color: var(--white);
        color: var(--gray-700);
        font-size: 0.875rem;
        cursor: pointer;
        transition: var(--transition);
      }

      .time-range-select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 2px var(--primary-light);
        outline: none;
      }

      .transaction-count {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.95rem;
        color: var(--gray-600);
        margin-bottom: 1.5rem;
        padding: 0.75rem 1rem;
        background-color: var(--gray-50);
        border-radius: var(--radius-lg);
        border: 1px solid var(--gray-200);
      }

      .documents-grid {
        display: grid;
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .document-card {
        background-color: var(--white);
        border-radius: var(--radius-xl);
        border: 1px solid var(--gray-200);
        box-shadow: var(--shadow-md);
        transition: var(--transition);
        overflow: hidden;
      }

      .document-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
      }

      .document-content {
        padding: 1.5rem;
      }

      .document-title {
        font-size: 1.125rem;
        font-weight: 700;
        color: var(--gray-900);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
      }

      .pagination {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 1.5rem;
      }

      .pagination button {
        padding: 0.5rem 1rem;
        border: 1px solid var(--gray-300);
        border-radius: var(--radius);
        background: var(--white);
        color: var(--gray-700);
        cursor: pointer;
        transition: var(--transition);
      }

      .pagination button.active {
        background: var(--primary);
        color: var(--white);
        border-color: var(--primary);
      }

      .pagination button:hover {
        background: var(--primary-light);
        color: var(--primary);
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      .modal-content {
        background: var(--white);
        padding: 2rem;
        border-radius: var(--radius-lg);
        width: 600px;
        max-width: 95%;
        position: relative;
        box-shadow: var(--shadow-lg);
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .modal-content h2 {
        font-size: 1.5rem;
        margin-bottom: 1.5rem;
        color: var(--gray-900);
        border-bottom: 2px solid var(--primary-light);
        padding-bottom: 0.5rem;
        text-align: center;
      }

      .modal-content p {
        margin-bottom: 1rem;
        color: var(--gray-700);
        font-size: 0.95rem;
        display: flex;
        justify-content: space-between;
      }

      .modal-content p strong {
        font-weight: 600;
        color: var(--gray-900);
        flex: 0 0 40%;
      }

      .modal-content p span {
        flex: 0 0 55%;
        text-align: right;
      }

      .modal-content .close-btn,
      .modal-content .support-btn,
      .modal-content .download-btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: var(--radius);
        cursor: pointer;
        margin-top: 0.5rem;
        width: 100%;
        font-size: 0.95rem;
        transition: all 0.2s ease;
      }

      .modal-content .close-btn {
        background: var(--primary);
        color: var(--white);
      }

      .modal-content .close-btn:hover {
        background: var(--primary-dark);
      }

      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--success);
        color: var(--white);
        padding: 1rem 1.5rem;
        border-radius: var(--radius);
        box-shadow: var(--shadow-md);
        display: none;
        z-index: 1001;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        animation: slideIn 0.3s ease;
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
        }
        to {
          transform: translateX(0);
        }
      }

      .notification.error {
        background: var(--danger);
      }

      @media (max-width: 768px) {
        .dashboard-content {
          flex-direction: column;
        }

        .dashboard-sidebar {
          width: 100%;
          position: static;
          margin-bottom: 2rem;
        }

        .sidebar-menu {
          display: flex;
          flex-wrap: wrap;
          gap: 0.5rem;
        }

        .sidebar-menu-title {
          width: 100%;
        }
      }
      .action-btn i,
      .refund-btn i {
        font-size: 1rem;
      }

      @media (max-width: 768px) {
        .transaction-table {
          font-size: 0.75rem;
        }

        .transaction-table th,
        .transaction-table td {
          padding: 0.75rem;
        }

        .transaction-table td.action-cell {
          min-width: 100px; /* Reduce min-width on mobile */
        }

        .action-btn,
        .refund-btn {
          padding: 0.4rem 0.8rem;
          font-size: 0.75rem;
        }

        .status-badge {
          padding: 0.2rem 0.6rem;
          font-size: 0.65rem;
        }
      }

      @media (max-width: 768px) {
        .filters {
          grid-template-columns: 1fr;
        }

        .chart-container {
          max-height: 300px;
        }

        .transaction-table {
          font-size: 0.85rem;
        }

        .transaction-table th,
        .transaction-table td {
          padding: 0.8rem 1rem;
        }

        .action-cell {
          display: flex;
          gap: 0.5rem;
          align-items: center;
          white-space: normal; /* Allow buttons to wrap if needed */
        }

        .action-btn,
        .refund-btn {
          width: 100%;
          justify-content: center;
        }
      }

      @media (max-width: 576px) {
        .transaction-table {
          display: block;
          overflow-x: auto;
          white-space: nowrap;
        }

        .transaction-table thead,
        .transaction-table tbody,
        .transaction-table tr {
          display: block;
        }

        .transaction-table th,
        .transaction-table td {
          min-width: 120px;
          display: inline-block;
        }
      }

      #exportModal .modal-content {
        max-width: 800px;
        overflow: auto;
      }

      #exportModal .transaction-table {
        font-size: 0.85rem;
        margin-bottom: 1rem;
      }
      .transaction-table th {
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #d1d5db;
        white-space: nowrap;
      }

      #exportModal .transaction-table th,
      #exportModal .transaction-table td {
        padding: 0.75rem;
        min-width: 80px;
      }

      #exportModal .transaction-table tbody tr:hover {
        background: var(--gray-50);
      }

      #exportModal .close-btn,
      #exportModal .export-btn {
        flex: 1;
      }

      #exportModal .export-btn:disabled {
        background: var(--gray-300);
        cursor: not-allowed;
        color: var(--gray-600);
      }

      #exportModal .custom-checkbox {
        display: flex;
        align-items: center;
        justify-content: center;
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <div th:replace="~{fragments/client/layout :: header}"></div>

    <main class="dashboard-page">
      <div class="container">
        <div class="dashboard-header">
          <div class="dashboard-header-actions">
            <button class="refresh-button" id="refreshBtn">
              <i class="fas fa-sync-alt"></i> Làm mới
            </button>
          </div>
        </div>
        <div class="dashboard-content">
          <!-- Sidebar -->
          <div
            th:replace="~{fragments/client/account-sidebar :: account-sidebar}"
          ></div>

          <div class="dashboard-main">
            <!-- Stats Cards -->
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-icon primary">
                  <i class="fas fa-credit-card"></i>
                </div>
                <div class="stat-info">
                  <div class="stat-value" id="totalTransactionsCard">0</div>
                  <div class="stat-label">Tổng giao dịch</div>
                </div>
              </div>

              <div class="stat-card">
                <div class="stat-icon success">
                  <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-info">
                  <div class="stat-value" id="completedTransactionsCard">0</div>
                  <div class="stat-label">Thành công</div>
                </div>
              </div>

              <div class="stat-card">
                <div class="stat-icon warning">
                  <i class="fas fa-clock"></i>
                </div>
                <div class="stat-info">
                  <div class="stat-value" id="pendingTransactionsCard">0</div>
                  <div class="stat-label">Đang xử lý</div>
                </div>
              </div>

              <div class="stat-card">
                <div class="stat-icon danger">
                  <i class="fas fa-coins"></i>
                </div>
                <div class="stat-info">
                  <div class="stat-value" id="totalSpentCard">0đ</div>
                  <div class="stat-label">Tổng chi tiêu</div>
                </div>
              </div>
            </div>

            <!-- Transaction Statistics Section -->
            <div class="dashboard-section">
              <div class="section-header">
                <h2 class="section-title">
                  <i class="fas fa-chart-line section-title-icon"></i>
                  Thống kê giao dịch
                </h2>
                <div class="section-actions">
                  <select class="time-range-select" id="chartTimeRange">
                    <option value="day">Theo ngày</option>
                    <option value="week" selected>Theo tuần</option>
                    <option value="month">Theo tháng</option>
                  </select>
                </div>
              </div>

              <div class="tab-buttons">
                <button class="tab-button active" data-tab="dayChart">
                  Tiêu tiền theo ngày
                </button>
                <button class="tab-button" data-tab="typeChart">
                  Tổng số tiền theo loại
                </button>
              </div>

              <div id="dayChart" class="chart-container" style="display: block">
                <div id="transactionChart"></div>
              </div>
              <div id="typeChart" class="chart-container" style="display: none">
                <div id="typeChartContainer"></div>
              </div>
            </div>

            <!-- Transaction List Section -->
            <div class="dashboard-section">
              <div class="section-header">
                <h2 class="section-title">
                  <i class="fas fa-history section-title-icon"></i>
                  Lịch sử giao dịch
                </h2>
                <!--
                <div class="section-actions">
                  <button class="action-button" id="exportBtn">
                    <i class="fas fa-download"></i>
                    Xuất CSV
                  </button>
                </div>
                -->
              </div>

              <div class="transaction-count" id="totalTransactions">
                <i class="fas fa-list"></i> Tổng:
                <span
                  th:text="${transactionsPage != null ? transactionsPage.totalElements : 0}"
                  >0</span
                >
                giao dịch
                <span
                  th:if="${transactionsPage != null and transactionsPage.totalPages > 1}"
                  style="margin-left: 1rem; color: #6b7280"
                >
                  (Trang
                  <span th:text="${transactionsPage.number + 1}">1</span> /
                  <span th:text="${transactionsPage.totalPages}">1</span>)
                </span>
              </div>

              <!-- Tab Navigation -->
              <div class="tab-navigation" style="margin-bottom: 1.5rem;">
                <button class="tab-button active" data-tab="transactions">
                  <i class="fas fa-history"></i> Lịch sử giao dịch
                </button>
                <button class="tab-button" data-tab="withdraw">
                  <i class="fas fa-money-bill-wave"></i> Rút tiền
                </button>
              </div>

              <!-- Transactions Tab -->
              <div id="transactionsTab" class="tab-content active">
                <div class="documents-grid" style="grid-template-columns: 1fr">
                  <div class="document-card">
                    <div class="document-content" style="padding: 1.25rem">
                      <h3 class="document-title" style="margin-bottom: 1rem">
                        <i class="fas fa-filter" style="margin-right: 0.5rem"></i>
                        Bộ lọc tìm kiếm
                      </h3>
                    <div class="filters">
                      <div class="form-group">
                        <label>Tìm kiếm</label>
                        <input
                          type="text"
                          id="searchInput"
                          placeholder="Mã giao dịch hoặc tài liệu"
                        />
                      </div>
                      <div class="form-group">
                        <label>Trạng thái</label>
                        <select id="statusFilter">
                          <option value="all">Tất cả trạng thái</option>
                          <option
                            value="PENDING"
                            th:selected="${status == 'PENDING'}"
                          >
                            Đang xử lý
                          </option>
                          <option
                            value="PROCESSING"
                            th:selected="${status == 'PROCESSING'}"
                          >
                            Đang xử lý
                          </option>
                          <option
                            value="COMPLETED"
                            th:selected="${status == 'COMPLETED'}"
                          >
                            Thành công
                          </option>
                          <option
                            value="FAILED"
                            th:selected="${status == 'FAILED'}"
                          >
                            Thất bại
                          </option>
                          <option
                            value="CANCELLED"
                            th:selected="${status == 'CANCELLED'}"
                          >
                            Đã hủy
                          </option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label>Loại</label>
                        <select id="typeFilter">
                          <option value="all">Tất cả loại</option>
                          <option
                            value="PURCHASE"
                            th:selected="${type == 'PURCHASE'}"
                          >
                            Nạp tiền
                          </option>
                          <option
                            value="WITHDRAWAL"
                            th:selected="${type == 'WITHDRAWAL'}"
                          >
                            Rút tiền
                          </option>
                          <option
                            value="REFUND"
                            th:selected="${type == 'REFUND'}"
                          >
                            Hoàn tiền
                          </option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label>Từ ngày</label>
                        <input id="dateFrom" type="date" th:value="${from}" />
                      </div>
                      <div class="form-group">
                        <label>Đến ngày</label>
                        <input id="dateTo" type="date" th:value="${to}" />
                      </div>
                      <div class="form-group">
                        <label>Số tiền</label>
                        <select id="amountFilter">
                          <option value="all">Tất cả</option>
                          <option value="0-50000">0 - 50.000 VNĐ</option>
                          <option value="50001-100000">
                            50.001 - 100.000 VNĐ
                          </option>
                          <option value="100001-200000">
                            100.001 - 200.000 VNĐ
                          </option>
                          <option value="200001+">Trên 200.000 VNĐ</option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label>&nbsp;</label>
                        <button
                          id="filterBtn"
                          type="button"
                          class="action-button"
                        >
                          <i class="fas fa-filter"></i> Lọc
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div id="transactionGroups"></div>

              <!-- Server-side rendered transactions list -->
              <div
                th:if="${transactionsPage != null}"
                class="transaction-group"
                style="margin-top: 1.5rem"
              >
                <h3>Giao dịch gần đây</h3>
                <div class="transaction-table-container">
                  <table class="transaction-table">
                    <thead>
                      <tr>
                        <th style="width: 15%">Mã giao dịch</th>
                        <th style="width: 10%">Loại</th>
                        <th style="width: 15%">Số tiền</th>
                        <th style="width: 15%">Trạng thái</th>
                        <th style="width: 10%">Hoàn tiền</th>
                        <th style="width: 15%">Phương thức</th>
                        <th style="width: 15%">Ngày tạo</th>
                        <th style="width: 15%">Ghi chú</th>
                        <th style="width: 15%">Hành động</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr th:each="tx : ${transactionsPage.content}">
                        <td th:text="${tx.code}">TXN000001</td>
                        <td th:text="${tx.type}">PURCHASE</td>
                        <td>
                          <!-- Hiển thị số tiền theo loại giao dịch -->
                          <span th:if="${tx.type.name() == 'PURCHASE' or tx.type.name() == 'REFUND'}">
                            <span th:text="${#numbers.formatDecimal(tx.amount, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></span>
                          </span>
                          <span th:if="${tx.type.name() == 'WITHDRAWAL'}">
                            <span th:text="${#numbers.formatDecimal(tx.amount, 0, 'COMMA', 0, 'POINT')} + ' xu'"></span>
                          </span>
                        </td>
                        <td>
                          <span
                            class="status-badge"
                            th:classappend="${tx.status.name() == 'COMPLETED'} ? ' status-completed' : (${tx.status.name() == 'PENDING'} ? ' status-pending' : (${tx.status.name() == 'PROCESSING'} ? ' status-processing' : (${tx.status.name() == 'CANCELLED'} ? ' status-cancelled' : ' status-failed')))"
                            th:text="${tx.status.displayName}"
                            >Trạng thái</span
                          >
                        </td>
                        <td
                          th:text="${tx.type.name() == 'REFUND' ? 'Có' : 'Không'}"
                        >
                          Không
                        </td>
                        <td th:text="${tx.paymentMethod}">VNPAY</td>
                        <td
                          th:text="${#temporals.format(tx.createdAt, 'dd/MM/yyyy HH:mm')}"
                        >
                          01/01/2025 12:00
                        </td>
                        <td>
                          <div th:if="${tx.type.name() == 'WITHDRAWAL'}">
                            <div class="withdraw-progress">
                              <div class="step" th:classappend="${tx.status.name() == 'PENDING' or tx.status.name() == 'PROCESSING' or tx.status.name() == 'COMPLETED'} ? ' active' : ''">Đã nhận</div>
                              <div class="step" th:classappend="${tx.status.name() == 'PROCESSING' or tx.status.name() == 'COMPLETED'} ? ' active' : ''">Đang xử lý</div>
                              <div class="step" th:classappend="${tx.status.name() == 'COMPLETED'} ? ' active' : ''">Hoàn thành</div>
                            </div>
                            <div class="eta" th:if="${tx.status.name() == 'PENDING' or tx.status.name() == 'PROCESSING'}">
                              Ước tính hoàn tất: trong 24-48 giờ
                            </div>
                            <div class="note-reason" th:if="${(tx.status.name() == 'FAILED' or tx.status.name() == 'CANCELLED') and (tx.notes != null and !#strings.isEmpty(tx.notes))}">
                              <span style="color:#ef4444; font-weight:600;">Lý do:</span>
                              <span th:text="${#strings.abbreviate(tx.notes, 120)}"></span>
                            </div>
                          </div>
                          <div th:if="${tx.type.name() != 'WITHDRAWAL'}" th:text="${tx.notes}">-</div>
                        </td>
                        <td class="action-cell">
                          <button
                            class="action-btn"
                            onclick="openModal(this.dataset.id)"
                            th:attr="data-id=${tx.id}"
                          >
                            <i class="fas fa-eye"></i>&nbsp;Chi tiết
                          </button>
                          <button
                            class="refund-btn"
                            type="button"
                            th:if="${tx.type.name() == 'PURCHASE' and tx.status.name() == 'COMPLETED'}"
                            onclick="confirmRefund(this.dataset.id)"
                            th:attr="data-id=${tx.id}"
                          >
                            <i class="fas fa-undo"></i>&nbsp;Hoàn tiền
                          </button>
                          <button
                            class="cancel-btn"
                            type="button"
                            th:if="${tx.type.name() == 'WITHDRAWAL' and tx.status.name() == 'PENDING'}"
                            onclick="cancelWithdrawal(this.dataset.id)"
                            th:attr="data-id=${tx.id}"
                          >
                            <i class="fas fa-times"></i>&nbsp;Hủy
                          </button>
                        </td>
                      </tr>
                      <tr th:if="${transactionsPage.totalElements == 0}">
                        <td
                          colspan="9"
                          style="text-align: center; color: var(--gray-600)"
                        >
                          Không có giao dịch
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <!-- Pagination -->
                <div
                  class="pagination"
                  th:if="${transactionsPage.totalElements > 0}"
                >
                  <a
                    class="page-link"
                    th:classappend="${transactionsPage.first} ? ' disabled'"
                    th:href="@{'/account/transactions'(page=${transactionsPage.number - 1}, size=${transactionsPage.size})}"
                    >&laquo;</a
                  >

                  <span
                    th:each="i : ${#numbers.sequence(0, transactionsPage.totalPages - 1)}"
                  >
                    <a
                      class="page-link"
                      th:classappend="${i == transactionsPage.number} ? ' active'"
                      th:text="${i + 1}"
                      th:href="@{'/account/transactions'(page=${i}, size=${transactionsPage.size})}"
                      >1</a
                    >
                  </span>

                  <a
                    class="page-link"
                    th:classappend="${transactionsPage.last} ? ' disabled'"
                    th:href="@{'/account/transactions'(page=${transactionsPage.number + 1}, size=${transactionsPage.size})}"
                    >&raquo;</a
                  >
                </div>
              </div>

              <div class="pagination" id="pagination"></div>
            </div>
          </div>

          <!-- Withdraw Tab -->
          <div id="withdrawTab" class="tab-content" style="display: none;">
            <div class="withdraw-container" style="max-width: 800px; margin: 0 auto;">
              <!-- Balance Info -->
              <div class="balance-info" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: var(--white); border-radius: var(--radius-lg); padding: 1.5rem; margin-bottom: 2rem; text-align: center;">
                <div class="balance-amount" style="font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem;" id="withdrawBalance">0 xu</div>
                <div class="balance-label" style="font-size: 1rem; opacity: 0.9;">Số dư xu hiện tại <span id="quickPromo" style="display:none; background: rgba(239,68,68,.15); color:#fff; padding:2px 6px; border-radius: 6px; margin-left:8px;">Giảm phí 50%</span></div>
              </div>

              <!-- Quick Withdraw Form -->
              <div class="withdraw-card" style="background: var(--white); border-radius: var(--radius-xl); box-shadow: var(--shadow-lg); padding: 2rem;">
                <h3 style="margin-bottom: 1.5rem; color: var(--gray-900);">
                  <i class="fas fa-money-bill-wave"></i> Rút tiền nhanh
                </h3>
                
                <form id="quickWithdrawForm" style="display: grid; gap: 1.5rem;" novalidate>
                  <div class="form-group">
                    <label for="quickCoinAmount">
                      <i class="fas fa-coins"></i> Số xu muốn rút
                    </label>
                    <input
                      type="number"
                      id="quickCoinAmount"
                      name="quickCoinAmount"
                      min="50"
                      step="1"
                      placeholder="Nhập số xu muốn rút (tối thiểu 50 xu)"
                      required
                      style="padding: 0.75rem 1rem; border: 2px solid var(--gray-200); border-radius: var(--radius); font-size: 1rem; width: 100%;"
                    />
                  </div>

                  <div class="calculator-section" id="quickCalculatorSection" style="display: none; background: var(--gray-50); border: 2px solid var(--gray-200); border-radius: var(--radius-lg); padding: 1.5rem; margin-bottom: 1rem;">
                    <div class="calculator-title" style="font-weight: 600; color: var(--gray-700); margin-bottom: 1rem;">
                      <i class="fas fa-calculator"></i> Chi tiết tính toán
                    </div>
                    <div class="calculator-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                      <div class="calculator-item" style="background: var(--white); padding: 1rem; border-radius: var(--radius); border: 1px solid var(--gray-200);">
                        <div class="calculator-label" style="font-size: 0.875rem; color: var(--gray-600); margin-bottom: 0.25rem;">Số xu rút</div>
                        <div class="calculator-value" id="quickCalcCoinAmount" style="font-size: 1.125rem; font-weight: 600; color: var(--gray-900);">0 xu</div>
                      </div>
                      <div class="calculator-item">
                        <div class="calculator-label">Phí dịch vụ</div>
                        <div class="calculator-value warning" id="quickCalcFee" style="color: var(--warning);">0 xu (0%)</div>
                      </div>
                      <div class="calculator-item">
                        <div class="calculator-label">Số xu thực nhận</div>
                        <div class="calculator-value success" id="quickCalcNetAmount" style="color: var(--success);">0 xu</div>
                      </div>
                      <div class="calculator-item">
                        <div class="calculator-label">Số tiền VND</div>
                        <div class="calculator-value success" id="quickCalcVndAmount" style="color: var(--success);">0 VND</div>
                      </div>
                    </div>
                  </div>

                  <div class="form-group">
                    <label for="quickPaymentMethod">
                      <i class="fas fa-credit-card"></i> Phương thức rút tiền
                    </label>
                    <select id="quickPaymentMethod" name="quickPaymentMethod" required style="padding: 0.75rem 1rem; border: 2px solid var(--gray-200); border-radius: var(--radius); font-size: 1rem; width: 100%;">
                      <option value="">Chọn phương thức rút tiền</option>
                      <option value="BANK_TRANSFER">Chuyển khoản ngân hàng</option>
                      <option value="E_WALLET">Ví điện tử</option>
                    </select>
                  </div>

                  <div id="quickBankInfoSection" style="display: none;">
                    <div class="form-group">
                      <label for="quickBankName">
                        <i class="fas fa-university"></i> Tên ngân hàng
                      </label>
                      <input
                        type="text"
                        id="quickBankName"
                        name="quickBankName"
                        placeholder="VD: Vietcombank, BIDV, Agribank..."
                        style="padding: 0.75rem 1rem; border: 2px solid var(--gray-200); border-radius: var(--radius); font-size: 1rem; width: 100%;"
                      />
                    </div>

                    <div class="form-group">
                      <label for="quickBankAccount">
                        <i class="fas fa-credit-card"></i> Số tài khoản
                      </label>
                      <input
                        type="text"
                        id="quickBankAccount"
                        name="quickBankAccount"
                        placeholder="Nhập số tài khoản ngân hàng"
                        style="padding: 0.75rem 1rem; border: 2px solid var(--gray-200); border-radius: var(--radius); font-size: 1rem; width: 100%;"
                      />
                    </div>

                    <div class="form-group">
                      <label for="quickAccountHolder">
                        <i class="fas fa-user"></i> Chủ tài khoản
                      </label>
                      <input
                        type="text"
                        id="quickAccountHolder"
                        name="quickAccountHolder"
                        placeholder="Tên chủ tài khoản (phải trùng với CMND/CCCD)"
                        style="padding: 0.75rem 1rem; border: 2px solid var(--gray-200); border-radius: var(--radius); font-size: 1rem; width: 100%;"
                      />
                    </div>
                  </div>

                  <button type="submit" class="submit-button" id="quickSubmitBtn" style="background: linear-gradient(135deg, var(--success), #059669); color: var(--white); border: none; border-radius: var(--radius-lg); padding: 1rem 2rem; font-size: 1.125rem; font-weight: 600; cursor: pointer; width: 100%;">
                    <i class="fas fa-paper-plane"></i> Gửi yêu cầu rút tiền
                  </button>
                </form>

                <div style="margin-top: 2rem; text-align: center;">
                  <a href="/account/withdraw" class="btn btn-primary" style="background: var(--primary); color: var(--white); padding: 0.75rem 1.5rem; border-radius: var(--radius); text-decoration: none; display: inline-block;">
                    <i class="fas fa-external-link-alt"></i> Mở trang rút tiền đầy đủ
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <div class="modal" id="dashboardModal">
      <div class="modal-content">
        <h2>Chi tiết giao dịch</h2>
        <p>
          <strong>Mã giao dịch:</strong> <span id="modalTransactionId"></span>
        </p>
        <p><strong>Loại giao dịch:</strong> <span id="modalType"></span></p>
        <p><strong>Ngày giao dịch:</strong> <span id="modalDate"></span></p>
        <p><strong>Số tiền:</strong> <span id="modalAmount"></span></p>
        <p><strong>Trạng thái:</strong> <span id="modalStatus"></span></p>
        <p><strong>Hoàn tiền:</strong> <span id="modalRefund"></span></p>
        <p>
          <strong>Phương thức thanh toán:</strong>
          <span id="modalMethod"></span>
        </p>
        <button
          class="download-btn"
          id="downloadInvoiceBtn"
          style="display: none"
        >
          Tải hóa đơn
        </button>
        <button class="close-btn" onclick="closeModal()">Đóng</button>
      </div>
    </div>

    <div class="modal" id="supportPopup" style="display: none">
      <div class="modal-content">
        <h2>Hỗ trợ</h2>
        <p>
          Vui lòng liên hệ qua email:
          <a href="mailto:support@edushare.vn">support@edushare.vn</a>
        </p>
        <p>Hoặc gọi hotline: <a href="tel:02412345678">024 1234 5678</a></p>
        <button class="close-btn" onclick="closeSupportPopup()">Đóng</button>
      </div>
    </div>

    <div class="modal" id="exportModal" style="display: none">
      <div class="modal-content">
        <h2>Xác nhận xuất báo cáo</h2>
        <p>Chọn các giao dịch để xuất báo cáo:</p>
        <div class="transaction-table-container">
          <table class="transaction-table" id="exportTable">
            <thead>
              <tr>
                <th style="width: 5%">Chọn</th>
                <th style="width: 20%">Mã giao dịch</th>
                <th style="width: 30%">Tài liệu</th>
                <th style="width: 15%">Số tiền</th>
                <th style="width: 15%">Trạng thái</th>
                <th style="width: 15%">Hoàn tiền</th>
              </tr>
            </thead>
            <tbody id="exportTableBody"></tbody>
          </table>
        </div>
        <div style="display: flex; gap: 1rem; margin-top: 1rem">
          <button class="close-btn" onclick="closeExportModal()">Hủy</button>
          <button
            class="export-btn"
            id="confirmExportBtn"
            disabled
            onclick="window.confirmExport()"
          >
            Xác nhận
          </button>
        </div>
      </div>
    </div>

    <div class="modal" id="refundModal" style="display: none">
      <div class="modal-content">
        <h2>Xác nhận hoàn tiền</h2>
        <p><strong>Mã giao dịch:</strong> <span id="refundTxId"></span></p>
        <p style="margin: 1rem 0; color: #6b7280">
          Bạn có chắc muốn yêu cầu hoàn tiền cho giao dịch này?
        </p>
        <div style="display: flex; gap: 1rem">
          <button class="close-btn" id="refundCancelBtn">Hủy</button>
          <button class="export-btn" id="refundConfirmBtn">Xác nhận</button>
        </div>
      </div>
    </div>

    <div class="notification" id="notification">
      <i class="fas fa-check-circle"></i>
      <span id="notificationMessage"></span>
    </div>

    <!-- Footer -->
    <div th:replace="~{fragments/client/layout :: footer}"></div>

    <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.37.1/dist/apexcharts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script th:src="@{/js/main.js}"></script>
    <script th:src="@{/js/account.js}"></script>
    <script th:src="@{/js/client-header.js}"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Tab navigation
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        tabButtons.forEach(button => {
          button.addEventListener('click', () => {
            const targetTab = button.getAttribute('data-tab');
            
            // Remove active class from all buttons and contents
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.style.display = 'none');
            
            // Add active class to clicked button and show target content
            button.classList.add('active');
            document.getElementById(targetTab + 'Tab').style.display = 'block';
            
            // Load withdraw data if withdraw tab is selected
            if (targetTab === 'withdraw') {
              loadWithdrawData();
              // Show promo badge if active (fetch calculate with 50 xu just to read flags)
              fetch('/account/withdraw/calculate', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded', [document.querySelector('meta[name="_csrf_header"]').getAttribute('content')]: document.querySelector('meta[name="_csrf"]').getAttribute('content') }, body: 'coinAmount=50' })
                .then(r => r.ok ? r.json() : Promise.reject())
                .then(d => { const el = document.getElementById('quickPromo'); if (el) el.style.display = d && d.promoActive ? 'inline-block' : 'none'; })
                .catch(() => {});
            }
          });
        });

        // Withdraw functionality
        function loadWithdrawData() {
          // Load user balance
          fetch("/account/transactions/stats")
            .then(response => response.json())
            .then(data => {
              if (data.stats) {
                const balance = data.stats.coinBalance || 0;
                document.getElementById('withdrawBalance').textContent = new Intl.NumberFormat("vi-VN").format(balance) + " xu";
              }
            })
            .catch(error => console.error("Error loading withdraw data:", error));
        }

        // Quick withdraw form functionality
        const quickCoinAmountInput = document.getElementById('quickCoinAmount');
        const quickPaymentMethodSelect = document.getElementById('quickPaymentMethod');
        const quickBankInfoSection = document.getElementById('quickBankInfoSection');
        const quickCalculatorSection = document.getElementById('quickCalculatorSection');
        const quickWithdrawForm = document.getElementById('quickWithdrawForm');

        if (quickPaymentMethodSelect) {
          quickPaymentMethodSelect.addEventListener("change", function() {
            if (this.value === "BANK_TRANSFER") {
              quickBankInfoSection.style.display = "block";
              document.getElementById('quickBankName')?.setAttribute('required','required');
              document.getElementById('quickBankAccount')?.setAttribute('required','required');
              document.getElementById('quickAccountHolder')?.setAttribute('required','required');
            } else {
              quickBankInfoSection.style.display = "none";
              document.getElementById('quickBankName')?.removeAttribute('required');
              document.getElementById('quickBankAccount')?.removeAttribute('required');
              document.getElementById('quickAccountHolder')?.removeAttribute('required');
            }
          });
        }

        if (quickCoinAmountInput) {
          let calculateTimeout;
          quickCoinAmountInput.addEventListener("input", function() {
            clearTimeout(calculateTimeout);
            calculateTimeout = setTimeout(() => {
              calculateQuickWithdrawal();
            }, 500);
          });
        }

        // Live bank auto-detect for quick withdraw form
        const quickBankAccountInput = document.getElementById('quickBankAccount');
        if (quickBankAccountInput) {
          let quickBankDetectTimer;
          quickBankAccountInput.addEventListener("input", function() {
            if (quickBankDetectTimer) clearTimeout(quickBankDetectTimer);
            quickBankDetectTimer = setTimeout(async () => {
              const acct = quickBankAccountInput.value.trim();
              const quickBankNameField = document.getElementById('quickBankName');
              
              // Clear bank name if account number is empty or too short
              if (!acct || acct.length < 4) {
                if (quickBankNameField) {
                  quickBankNameField.value = "";
                }
                return;
              }
              
              // Only detect if account number starts with known bank prefixes
              const bankPrefixes = ["9704", "9703", "9702", "9701"];
              const hasValidPrefix = bankPrefixes.some(prefix => acct.startsWith(prefix));
              
              if (!hasValidPrefix) {
                return;
              }
              
              try {
                const resp = await fetch("/account/bank/detect", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    [document.querySelector('meta[name="_csrf_header"]').getAttribute('content')]: document.querySelector('meta[name="_csrf"]').getAttribute('content')
                  },
                  body: new URLSearchParams({ accountNumber: acct }),
                });
                const bd = await resp.json();
                if (bd.detected && bd.bankName) {
                  if (quickBankNameField) {
                    quickBankNameField.value = bd.bankName;
                  }
                }
              } catch (e) {
                console.error("Quick bank detection error:", e);
              }
            }, 400);
          });
        }

        function calculateQuickWithdrawal() {
          const coinAmount = parseFloat(quickCoinAmountInput.value);
          
          if (coinAmount < 50) {
            quickCalculatorSection.style.display = "none";
            return;
          }

          fetch("/account/withdraw/calculate", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
              [document.querySelector('meta[name="_csrf_header"]').getAttribute('content')]: document.querySelector('meta[name="_csrf"]').getAttribute('content')
            },
            body: `coinAmount=${coinAmount}`
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              document.getElementById("quickCalcCoinAmount").textContent = data.coinAmount + " xu";
              document.getElementById("quickCalcFee").textContent = data.fee + " xu (" + data.feePercentage + "%)";
              document.getElementById("quickCalcNetAmount").textContent = data.netAmount + " xu";
              document.getElementById("quickCalcVndAmount").textContent = new Intl.NumberFormat("vi-VN", {
                style: "currency",
                currency: "VND"
              }).format(data.vndAmount);
              quickCalculatorSection.style.display = "block";
            } else {
              showNotification(data.message, "error");
              quickCalculatorSection.style.display = "none";
            }
          })
          .catch(error => {
            console.error("Error calculating withdrawal:", error);
            quickCalculatorSection.style.display = "none";
          });
        }

        if (quickWithdrawForm) {
          quickWithdrawForm.addEventListener("submit", async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const coinAmount = formData.get("quickCoinAmount");
            const paymentMethod = formData.get("quickPaymentMethod");
            const bankAccount = formData.get("quickBankAccount");
            const bankName = formData.get("quickBankName");
            const accountHolder = formData.get("quickAccountHolder");

            // Validation
            if (parseFloat(coinAmount) < 50) {
              showNotification("Số xu tối thiểu để rút là 50 xu", "error");
              return;
            }

            if (paymentMethod === "BANK_TRANSFER") {
              if (!bankAccount || !bankName || !accountHolder) {
                showNotification("Vui lòng điền đầy đủ thông tin ngân hàng", "error");
                return;
              }
            }

            // Auto-detect bank name before submit (best-effort)
            if (paymentMethod === "BANK_TRANSFER" && bankAccount && !bankName) {
              try {
                const resp = await fetch("/account/bank/detect", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    [document.querySelector('meta[name="_csrf_header"]').getAttribute('content')]: document.querySelector('meta[name="_csrf"]').getAttribute('content')
                  },
                  body: new URLSearchParams({ accountNumber: bankAccount }),
                });
                const bd = await resp.json();
                if (bd.detected && bd.bankName) {
                  document.getElementById('quickBankName').value = bd.bankName;
                }
              } catch (e) {
                console.error("Quick bank detection error:", e);
              }
            }

            // Submit request
            fetch("/account/withdraw/request", {
              method: "POST",
              headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                [document.querySelector('meta[name="_csrf_header"]').getAttribute('content')]: document.querySelector('meta[name="_csrf"]').getAttribute('content')
              },
              body: new URLSearchParams({
                coinAmount: coinAmount,
                paymentMethod: paymentMethod,
                bankAccount: bankAccount || "",
                bankName: bankName || "",
                accountHolder: accountHolder || "",
                notes: ""
              })
            })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                showNotification("Yêu cầu rút tiền đã được gửi thành công! Mã giao dịch: " + data.withdrawalCode, "success");
                quickWithdrawForm.reset();
                quickCalculatorSection.style.display = "none";
                quickBankInfoSection.style.display = "none";
                
                // Refresh the page to show new transaction
                setTimeout(() => {
                  location.reload();
                }, 2000);
              } else {
                showNotification(data.message, "error");
              }
            })
            .catch(error => {
              console.error("Error submitting withdrawal:", error);
              showNotification("Có lỗi xảy ra, vui lòng thử lại", "error");
            });
          });
        }

        function showNotification(message, type) {
          // Create notification element
          const notification = document.createElement("div");
          notification.className = `alert alert-${type}`;
          notification.style.cssText = `
            padding: 1rem;
            border-radius: var(--radius);
            margin-bottom: 1rem;
            font-weight: 500;
            background: ${type === 'success' ? 'var(--success-light)' : 'var(--danger-light)'};
            color: ${type === 'success' ? 'var(--success)' : 'var(--danger)'};
            border: 1px solid ${type === 'success' ? 'var(--success)' : 'var(--danger)'};
          `;
          notification.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
            ${message}
          `;
          
          // Insert at the top of the form
          if (quickWithdrawForm) {
            quickWithdrawForm.insertBefore(notification, quickWithdrawForm.firstChild);
          }
          
          // Remove after 5 seconds
          setTimeout(() => {
            notification.remove();
          }, 5000);
        }

        // Load real data from backend
        let transactionStats = {};
        let dailyChartData = [];
        let typeChartData = [];

        // Load stats data
        function loadTransactionStats() {
          console.log("Loading transaction stats...");
          fetch("/account/transactions/stats")
            .then((response) => {
              console.log("Response status:", response.status);
              console.log("Response headers:", response.headers);
              if (!response.ok) {
                return response.text().then((text) => {
                  console.log("Error response body:", text);
                  throw new Error(
                    `HTTP ${response.status}: ${response.statusText} - ${text}`
                  );
                });
              }
              return response.json();
            })
            .then((data) => {
              console.log("Received data:", data);
              transactionStats = data.stats || {};
              dailyChartData = data.dailyData || [];
              typeChartData = data.typeData || [];

              console.log("Stats:", transactionStats);
              console.log("Daily data:", dailyChartData);
              console.log("Type data:", typeChartData);

              // Update stats cards
              updateStatsCards();

              // Update charts
              initChart("day", dailyChartData, "transactionChart");
              initChart("type", typeChartData, "typeChartContainer");
            })
            .catch((error) => {
              console.error("Error loading transaction stats:", error);
              // Fallback to default values
              transactionStats = {
                totalTransactions: 0,
                completedTransactions: 0,
                pendingTransactions: 0,
                totalSpent: 0,
              };
              dailyChartData = [];
              typeChartData = [];
              updateStatsCards();
              initChart("day", dailyChartData, "transactionChart");
              initChart("type", typeChartData, "typeChartContainer");
            });
        }

        function updateStatsCards() {
          const totalEl = document.getElementById("totalTransactionsCard");
          const completedEl = document.getElementById(
            "completedTransactionsCard"
          );
          const pendingEl = document.getElementById("pendingTransactionsCard");
          const spentEl = document.getElementById("totalSpentCard");

          if (totalEl) {
            totalEl.textContent = transactionStats.totalTransactions || 0;
          }
          if (completedEl) {
            completedEl.textContent =
              transactionStats.completedTransactions || 0;
          }
          if (pendingEl) {
            pendingEl.textContent = transactionStats.pendingTransactions || 0;
          }
          if (spentEl) {
            const amount = transactionStats.totalSpent || 0;
            spentEl.textContent = new Intl.NumberFormat("vi-VN", {
              style: "currency",
              currency: "VND",
            }).format(amount);
          }
        }

        // Load initial data
        loadTransactionStats();

        let transactionChart, typeChart;
        let currentChartMode = "day";
        const transactionsPerPage = 3;
        let currentPage = 1;
        let filteredTransactions = [];
        let selectedTransactions = [];
        let modalSelectedTransactions = [];

        function normalizeString(str) {
          if (!str) return "";
          return str
            .toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .replace(/\s+/g, " ")
            .trim();
        }

        function aggregateChartData(data, mode) {
          if (!data || data.length === 0) {
            return { labels: [], amounts: [] };
          }

          const grouped = {};
          data.forEach((item) => {
            let key;
            if (mode === "day") {
              key = item.date;
            } else if (mode === "week") {
              // Convert date to week format
              const date = new Date(item.date);
              key = `Tuần ${Math.ceil(date.getDate() / 7)}/${
                date.getMonth() + 1
              }`;
            } else if (mode === "month") {
              const date = new Date(item.date);
              key = `${date.getFullYear()}-${String(
                date.getMonth() + 1
              ).padStart(2, "0")}`;
            }
            if (!grouped[key]) grouped[key] = 0;
            grouped[key] += parseFloat(item.amount || 0);
          });
          const labels = Object.keys(grouped).sort();
          return { labels, amounts: labels.map((key) => grouped[key]) };
        }

        function aggregateTypeData(data) {
          if (!data || data.length === 0) {
            return {
              categories: ["Nạp tiền", "Thanh toán", "Hoàn tiền"],
              amounts: [0, 0, 0],
            };
          }

          const typeMap = {
            PURCHASE: "Nạp tiền",
            WITHDRAWAL: "Thanh toán",
            REFUND: "Hoàn tiền",
          };

          const grouped = { "Nạp tiền": 0, "Thanh toán": 0, "Hoàn tiền": 0 };
          data.forEach((item) => {
            const typeName = typeMap[item.type] || item.type;
            if (grouped[typeName] !== undefined) {
              grouped[typeName] += parseFloat(item.amount || 0);
            }
          });

          return {
            categories: Object.keys(grouped),
            amounts: Object.values(grouped),
          };
        }

        function initChart(mode, data, containerId) {
          let chartData, options;

          if (mode === "day") {
            chartData = aggregateChartData(data, currentChartMode);
            options = {
              series: [{ name: "Số tiền tiêu (VNĐ)", data: chartData.amounts }],
              chart: {
                height: 300,
                type: "area",
                fontFamily: "Nunito, sans-serif",
                toolbar: { show: false },
              },
              colors: ["#4361ee"],
              dataLabels: { enabled: false },
              stroke: { curve: "smooth", width: 2 },
              fill: {
                type: "gradient",
                gradient: {
                  shadeIntensity: 1,
                  opacityFrom: 0.7,
                  opacityTo: 0.3,
                  stops: [0, 90, 100],
                },
              },
              grid: {
                xaxis: { lines: { show: true } },
                yaxis: { lines: { show: true } },
                padding: { top: 0, right: 0, bottom: 0, left: 10 },
              },
              xaxis: {
                categories: chartData.labels,
                labels: {
                  style: {
                    colors: "#6b7280",
                    fontSize: "12px",
                    fontFamily: "Nunito, sans-serif",
                  },
                },
              },
              yaxis: {
                labels: {
                  style: {
                    colors: "#6b7280",
                    fontSize: "12px",
                    fontFamily: "Nunito, sans-serif",
                  },
                  formatter: (value) =>
                    new Intl.NumberFormat("vi-VN", {
                      style: "currency",
                      currency: "VND",
                    }).format(value),
                },
              },
              tooltip: {
                x: {
                  format:
                    currentChartMode === "day"
                      ? "dd/MM/yyyy"
                      : currentChartMode === "week"
                      ? "Tuần t/M"
                      : "MM/yyyy",
                },
                y: {
                  formatter: (value) =>
                    new Intl.NumberFormat("vi-VN", {
                      style: "currency",
                      currency: "VND",
                    }).format(value),
                },
              },
              legend: {
                position: "top",
                horizontalAlign: "right",
                offsetY: -15,
                markers: { width: 12, height: 12, radius: 12 },
                itemMargin: { horizontal: 10 },
              },
            };
          } else {
            chartData = aggregateTypeData(data);
            options = {
              series: [{ name: "Số tiền (VNĐ)", data: chartData.amounts }],
              chart: {
                height: 300,
                type: "bar",
                fontFamily: "Nunito, sans-serif",
                toolbar: { show: false },
              },
              colors: ["#4361ee", "#10b981", "#f59e0b"],
              plotOptions: {
                bar: {
                  horizontal: false,
                  columnWidth: "55%",
                  endingShape: "rounded",
                },
              },
              dataLabels: { enabled: false },
              stroke: { show: true, width: 2, colors: ["transparent"] },
              grid: {
                xaxis: { lines: { show: true } },
                yaxis: { lines: { show: true } },
                padding: { top: 0, right: 0, bottom: 0, left: 10 },
              },
              xaxis: {
                categories: chartData.categories,
                labels: {
                  style: {
                    colors: "#6b7280",
                    fontSize: "12px",
                    fontFamily: "Nunito, sans-serif",
                  },
                },
                title: {
                  text: "",
                  style: {
                    color: "#6b7280",
                    fontSize: "12px",
                    fontFamily: "Nunito, sans-serif",
                  },
                },
              },
              yaxis: {
                labels: {
                  style: {
                    colors: "#6b7280",
                    fontSize: "12px",
                    fontFamily: "Nunito, sans-serif",
                  },
                  formatter: (value) =>
                    new Intl.NumberFormat("vi-VN", {
                      style: "currency",
                      currency: "VND",
                    }).format(value),
                },
                title: {
                  text: "",
                  style: {
                    color: "#6b7280",
                    fontSize: "12px",
                    fontFamily: "Nunito, sans-serif",
                  },
                },
              },
              fill: { opacity: 1 },
              tooltip: {
                y: {
                  formatter: (value) =>
                    new Intl.NumberFormat("vi-VN", {
                      style: "currency",
                      currency: "VND",
                    }).format(value),
                },
              },
              legend: { show: false },
            };
          }

          if (mode === "day" && transactionChart) transactionChart.destroy();
          if (mode === "type" && typeChart) typeChart.destroy();
          const chart = new ApexCharts(
            document.getElementById(containerId),
            options
          );
          if (mode === "day") transactionChart = chart;
          else typeChart = chart;
          chart.render();
        }

        document.querySelectorAll(".tab-button").forEach((button) => {
          button.addEventListener("click", function () {
            document
              .querySelectorAll(".tab-button")
              .forEach((btn) => btn.classList.remove("active"));
            this.classList.add("active");
            document.getElementById("dayChart").style.display =
              this.dataset.tab === "dayChart" ? "block" : "none";
            document.getElementById("typeChart").style.display =
              this.dataset.tab === "typeChart" ? "block" : "none";
            initChart(
              this.dataset.tab === "dayChart" ? "day" : "type",
              this.dataset.tab === "dayChart" ? dailyChartData : typeChartData,
              this.dataset.tab === "dayChart"
                ? "transactionChart"
                : "typeChartContainer"
            );
          });
        });

        // Initialize charts with real data
        initChart("day", dailyChartData, "transactionChart");
        initChart("type", typeChartData, "typeChartContainer");

        function renderTransactions(transactionsToRender) {
          const groupsContainer = document.getElementById("transactionGroups");
          const pagination = document.getElementById("pagination");
          const totalTransactions = document
            .getElementById("totalTransactions")
            .querySelector("span");

          groupsContainer.innerHTML = "";
          totalTransactions.textContent = transactions.length;

          if (!transactionsToRender.length) {
            groupsContainer.innerHTML =
              '<p style="text-align: center; color: var(--gray-600); font-size: 1rem;">Không có giao dịch nào phù hợp.</p>';
            pagination.style.display = "none";
            return;
          }

          const startIndex = (currentPage - 1) * transactionsPerPage;
          const endIndex = startIndex + transactionsPerPage;
          const transactionsSlice = transactionsToRender.slice(
            startIndex,
            endIndex
          );

          const groupedByDate = {};
          transactionsSlice.forEach((t) => {
            const date = t.date.split(" ")[0];
            if (!groupedByDate[date]) groupedByDate[date] = [];
            groupedByDate[date].push(t);
          });

          const sortedDates = Object.keys(groupedByDate).sort(
            (a, b) => new Date(b) - new Date(a)
          );
          sortedDates.forEach((date) => {
            const groupTransactions = groupedByDate[date];
            const groupHTML = `
        <div class="transaction-group">
          <h3>${formatDate(date)}</h3>
          <div class="transaction-table-container">
            <table class="transaction-table">
              <thead>
                <tr>
                  <th style="width: 15%;">Mã giao dịch</th>
                  <th style="width: 25%;">Tài liệu</th>
                  <th style="width: 15%;">Số tiền</th>
                  <th style="width: 15%;">Trạng thái</th>
                  <th style="width: 10%;">Hoàn tiền</th>
                  <th style="width: 20%;">Hành động</th>
                </tr>
              </thead>
              <tbody>
                ${groupTransactions
                  .map(
                    (t) => `
                  <tr data-id="${t.id}">
                    <td>${t.id}</td>
                    <td>${t.document}</td>
                    <td>
                      ${t.type === 'PURCHASE' || t.type === 'REFUND' 
                        ? new Intl.NumberFormat("vi-VN", {
                            style: "currency",
                            currency: "VND",
                          }).format(t.amount)
                        : new Intl.NumberFormat("vi-VN").format(t.amount) + ' xu'
                      }
                    </td>
                    <td><span class="status-badge ${t.statusClass}">${
                      t.status === "success"
                        ? "Thành công"
                        : t.status === "pending"
                        ? "Đang xử lý"
                        : t.status === "failed"
                        ? "Thất bại"
                        : "Hoàn tiền"
                    }</span></td>
                    <td>${t.refund}</td>
                    <td class="action-cell">
                      <button class="action-btn" onclick="openModal('${
                        t.id
                      }')"><i class="fas fa-eye"></i> Chi tiết</button>
                      ${
                        canRefund(t)
                          ? `<button class="refund-btn" onclick="confirmRefund('${t.id}')"><i class="fas fa-undo"></i> Hoàn tiền</button>`
                          : ""
                      }
                    </td>
                  </tr>`
                  )
                  .join("")}
              </tbody>
            </table>
          </div>
        </div>`;
            groupsContainer.insertAdjacentHTML("beforeend", groupHTML);
          });

          const totalPages = Math.ceil(
            transactionsToRender.length / transactionsPerPage
          );
          pagination.innerHTML = "";
          for (let i = 1; i <= totalPages; i++) {
            const button = document.createElement("button");
            button.textContent = i;
            button.className = i === currentPage ? "active" : "";
            button.addEventListener("click", () => {
              currentPage = i;
              renderTransactions(filteredTransactions);
            });
            pagination.appendChild(button);
          }
          pagination.style.display = totalPages > 1 ? "flex" : "none";
        }

        function canRefund(transaction) {
          return (
            (transaction.status === "success" ||
              transaction.status === "pending") &&
            transaction.refund === "Không"
          );
        }

        window.confirmRefund = function (transactionId) {
          const transaction = transactions.find((t) => t.id === transactionId);
          if (transaction) {
            if (
              confirm(
                `Bạn có chắc muốn hoàn tiền cho giao dịch ${transaction.id} (${
                  transaction.document
                }) với số tiền ${transaction.type === 'WITHDRAWAL' 
                  ? new Intl.NumberFormat("vi-VN").format(transaction.amount) + ' xu'
                  : new Intl.NumberFormat("vi-VN", {
                      style: "currency",
                      currency: "VND",
                    }).format(transaction.amount)
                }?`
              )
            ) {
              refundTransaction(transactionId);
            }
          } else {
            showNotification("Không tìm thấy giao dịch!", "error");
          }
        };

        function refundTransaction(transactionId) {
          const transaction = transactions.find((t) => t.id === transactionId);
          if (transaction) {
            transaction.refund = "Đã hoàn 100%";
            transaction.status = "refunded";
            transaction.statusClass = "status-refunded";
            filteredTransactions = transactions;
            renderTransactions(filteredTransactions);
            initChart("day", filteredTransactions, "transactionChart");
            initChart("type", filteredTransactions, "typeChartContainer");
            updateSummaryTable(filteredTransactions);
            showNotification(
              `Giao dịch ${transactionId} đã được hoàn tiền thành công!`,
              "success"
            );
          } else {
            showNotification("Lỗi khi hoàn tiền giao dịch!", "error");
          }
        }

        function formatDate(dateStr) {
          const date = new Date(dateStr);
          return date.toLocaleDateString("vi-VN", {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric",
          });
        }

        function formatDateTime(dateStr) {
          const date = new Date(dateStr);
          return date.toLocaleString("vi-VN", {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
          });
        }

        window.openModal = function (transactionId) {
          const transaction = transactions.find((t) => t.id === transactionId);
          if (transaction) {
            document.getElementById("modalTransactionId").textContent =
              transaction.id;
            document.getElementById("modalType").textContent =
              transaction.type === "recharge"
                ? "Nạp xu"
                : transaction.type === "download"
                ? "Tải tài liệu"
                : "Hoàn tiền";
            document.getElementById("modalDocument").textContent =
              transaction.document;
            document.getElementById("modalDate").textContent = formatDateTime(
              transaction.date
            );
            document.getElementById("modalAmount").textContent =
              transaction.type === 'WITHDRAWAL' 
                ? new Intl.NumberFormat("vi-VN").format(transaction.amount) + ' xu'
                : new Intl.NumberFormat("vi-VN", {
                    style: "currency",
                    currency: "VND",
                  }).format(transaction.amount);
            document.getElementById(
              "modalStatus"
            ).innerHTML = `<span class="status-badge ${
              transaction.statusClass
            }">${
              transaction.status === "success"
                ? "Thành công"
                : transaction.status === "pending"
                ? "Đang xử lý"
                : transaction.status === "failed"
                ? "Thất bại"
                : "Hoàn tiền"
            }</span>`;
            document.getElementById("modalRefund").textContent =
              transaction.refund;
            document.getElementById("modalMethod").textContent =
              transaction.method;
            document.getElementById("downloadInvoiceBtn").style.display =
              "block";
            document.getElementById("dashboardModal").style.display = "flex";
            showNotification(
              `Đã mở chi tiết giao dịch ${transaction.id}`,
              "success"
            );
          } else {
            showNotification("Không tìm thấy giao dịch!", "error");
          }
        };

        window.closeModal = function () {
          document.getElementById("dashboardModal").style.display = "none";
        };

        window.openSupportPopup = function () {
          document.getElementById("supportPopup").style.display = "flex";
          showNotification("Hỗ trợ đã được mở!", "success");
        };

        window.closeSupportPopup = function () {
          document.getElementById("supportPopup").style.display = "none";
        };

        function showNotification(message, type) {
          const notification = document.getElementById("notification");
          const messageElement = document.getElementById("notificationMessage");
          messageElement.textContent = message;
          notification.classList.remove("error");
          if (type === "error") notification.classList.add("error");
          notification.style.display = "flex";
          setTimeout(() => {
            notification.style.display = "none";
          }, 3000);
        }

        // Add event listener for download invoice button
        (function () {
          const downloadBtn = document.getElementById("downloadInvoiceBtn");
          if (downloadBtn) {
            downloadBtn.addEventListener("click", function () {
              const transaction = transactions.find(
                (t) =>
                  t.id ===
                  document.getElementById("modalTransactionId").textContent
              );
              if (transaction) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFontSize(16);
                doc.text("HÓA ĐƠN GIAO DỊCH", 105, 20, { align: "center" });
                doc.setFontSize(12);
                doc.text(`Mã giao dịch: ${transaction.id}`, 20, 40);
                doc.text(
                  `Loại giao dịch: ${
                    transaction.type === "recharge"
                      ? "Nạp xu"
                      : transaction.type === "download"
                      ? "Tải tài liệu"
                      : "Hoàn tiền"
                  }`,
                  20,
                  50
                );
                doc.text(`Tài liệu: ${transaction.document}`, 20, 60);
                doc.text(
                  `Ngày giao dịch: ${formatDateTime(transaction.date)}`,
                  20,
                  70
                );
                doc.text(
                  `Số tiền: ${transaction.type === 'WITHDRAWAL' 
                    ? new Intl.NumberFormat("vi-VN").format(transaction.amount) + ' xu'
                    : new Intl.NumberFormat("vi-VN", {
                        style: "currency",
                        currency: "VND",
                      }).format(transaction.amount)
                  }`,
                  20,
                  80
                );
                doc.text(
                  `Trạng thái: ${
                    transaction.status === "success"
                      ? "Thành công"
                      : transaction.status === "pending"
                      ? "Đang xử lý"
                      : transaction.status === "failed"
                      ? "Thất bại"
                      : "Hoàn tiền"
                  }`,
                  20,
                  90
                );
                doc.text(`Hoàn tiền: ${transaction.refund}`, 20, 100);
                doc.text(
                  `Phương thức thanh toán: ${transaction.method}`,
                  20,
                  110
                );
                doc.save(`invoice_${transaction.id}.pdf`);
                showNotification("Hóa đơn đã được tải xuống!", "success");
              }
            });
          }
        })();

        // Add event listeners for navigation buttons
        (function () {
          const rechargeBtn = document.getElementById("rechargeBtn");
          if (rechargeBtn) {
            rechargeBtn.addEventListener("click", function () {
              window.location.href = "recharge.html";
              showNotification("Chuyển đến trang nạp tiền!", "success");
            });
          }

          const settingsBtn = document.getElementById("settingsBtn");
          if (settingsBtn) {
            settingsBtn.addEventListener("click", function () {
              window.location.href = "payment-settings.html";
              showNotification("Chuyển đến cài đặt thanh toán!", "success");
            });
          }
        })();

        // Add event listener for refresh button
        (function () {
          const refreshBtn = document.getElementById("refreshBtn");
          if (refreshBtn) {
            refreshBtn.addEventListener("click", function () {
              console.log("Refresh button clicked");
              loadTransactionStats();
              showNotification("Đã làm mới dữ liệu!", "success");
            });
          }
        })();

        // Add event listener for chart time range
        (function () {
          const timeRangeSelect = document.getElementById("chartTimeRange");
          if (timeRangeSelect) {
            timeRangeSelect.addEventListener("change", function () {
              currentChartMode = this.value;
              const chartTitle = document.getElementById("chartTitle");
              if (chartTitle) {
                chartTitle.textContent = `Tiêu tiền theo ${
                  this.value === "day"
                    ? "ngày"
                    : this.value === "week"
                    ? "tuần"
                    : "tháng"
                }`;
              }
              initChart("day", dailyChartData, "transactionChart");
            });
          }
        })();

        function updateSummaryTable(transactions) {
          const summary = aggregateTypeData(transactions);
          const tbody = document.getElementById("summaryTableBody");
          if (tbody) {
            tbody.innerHTML = `
        <tr><td>Nạp tiền</td><td>${new Intl.NumberFormat("vi-VN", {
          style: "currency",
          currency: "VND",
        }).format(summary.amounts[0])}</td></tr>
        <tr><td>Thanh toán</td><td>${new Intl.NumberFormat("vi-VN", {
          style: "currency",
          currency: "VND",
        }).format(summary.amounts[1])}</td></tr>
        <tr><td>Hoàn tiền</td><td>${new Intl.NumberFormat("vi-VN", {
          style: "currency",
          currency: "VND",
        }).format(summary.amounts[2])}</td></tr>
      `;
          }
        }

        function updateSelected(checkbox) {
          const transactionId = checkbox.dataset.id;
          if (checkbox.checked) {
            selectedTransactions.push(
              transactions.find((t) => t.id === transactionId)
            );
          } else {
            selectedTransactions = selectedTransactions.filter(
              (t) => t.id !== transactionId
            );
          }
        }

        function updateCheckboxes() {
          const checkboxes = document.querySelectorAll(
            '.custom-checkbox input[type="checkbox"]'
          );
          checkboxes.forEach(
            (cb) =>
              (cb.checked = selectedTransactions.some(
                (t) => t.id === cb.dataset.id
              ))
          );
        }

        // Modal Export CSV Functions
        window.renderExportModalTable = function () {
          const tbody = document.getElementById("exportTableBody");
          const confirmBtn = document.getElementById("confirmExportBtn");
          if (!tbody || !confirmBtn) {
            console.error("DOM elements not found:", { tbody, confirmBtn });
            return;
          }
          tbody.innerHTML = "";
          if (!filteredTransactions || filteredTransactions.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="6" style="text-align: center; color: var(--gray-600);">Không có giao dịch nào.</td></tr>';
            confirmBtn.disabled = true;
            console.log("No transactions to render");
            return;
          }
          filteredTransactions.forEach((t) => {
            const isChecked = modalSelectedTransactions.some(
              (st) => st.id === t.id
            );
            const rowHTML = `
      <tr data-id="${t.id}">
        <td class="custom-checkbox">
          <input type="checkbox" id="export-chk-${t.id}" data-id="${t.id}" ${
              isChecked ? "checked" : ""
            } onchange="window.updateModalSelection(this)">
          <label for="export-chk-${t.id}"></label>
        </td>
        <td>${t.id}</td>
        <td>${t.document}</td>
        <td>${new Intl.NumberFormat("vi-VN", {
          style: "currency",
          currency: "VND",
        }).format(t.amount)}</td>
        <td><span class="status-badge ${t.statusClass}">${
              t.status === "success"
                ? "Thành công"
                : t.status === "pending"
                ? "Đang xử lý"
                : t.status === "failed"
                ? "Thất bại"
                : "Hoàn tiền"
            }</span></td>
        <td>${t.refund}</td>
      </tr>`;
            tbody.insertAdjacentHTML("beforeend", rowHTML);
          });
          console.log(
            "Rendered modal table with",
            filteredTransactions.length,
            "transactions"
          );
          window.updateConfirmButton();
        };

        window.updateModalSelection = function (checkbox) {
          const transactionId = checkbox.dataset.id;
          console.log("Checkbox changed:", transactionId, checkbox.checked);
          const transaction = filteredTransactions.find(
            (t) => t.id === transactionId
          );
          if (!transaction) {
            console.error("Transaction not found for ID:", transactionId);
            return;
          }
          if (checkbox.checked) {
            if (
              !modalSelectedTransactions.some((t) => t.id === transactionId)
            ) {
              modalSelectedTransactions.push(transaction);
            }
          } else {
            modalSelectedTransactions = modalSelectedTransactions.filter(
              (t) => t.id !== transactionId
            );
          }
          console.log("modalSelectedTransactions:", modalSelectedTransactions);
          window.updateConfirmButton();
        };

        window.updateConfirmButton = function () {
          const confirmBtn = document.getElementById("confirmExportBtn");
          if (!confirmBtn) {
            console.error("Confirm button not found");
            return;
          }
          confirmBtn.disabled = modalSelectedTransactions.length === 0;
          console.log(
            "Updating confirm button, selected count:",
            modalSelectedTransactions.length,
            "disabled:",
            confirmBtn.disabled
          );
        };

        window.openExportModal = function () {
          modalSelectedTransactions = [];
          window.renderExportModalTable();
          const modal = document.getElementById("exportModal");
          if (!modal) {
            console.error("Export modal not found");
            return;
          }
          modal.style.display = "flex";
          showNotification("Vui lòng chọn giao dịch để xuất.", "success");
        };

        window.closeExportModal = function () {
          const modal = document.getElementById("exportModal");
          if (!modal) {
            console.error("Export modal not found");
            return;
          }
          modal.style.display = "none";
          modalSelectedTransactions = [];
          console.log("Modal closed, reset modalSelectedTransactions");
        };

        window.confirmExport = function () {
          console.log(
            "Confirm export clicked, selected transactions:",
            modalSelectedTransactions
          );
          if (modalSelectedTransactions.length === 0) {
            showNotification("Vui lòng chọn ít nhất một giao dịch!", "error");
            console.log("No transactions selected");
            return;
          }

          try {
            const csvContent = [
              [
                "Mã giao dịch",
                "Loại giao dịch",
                "Tài liệu",
                "Ngày giao dịch",
                "Số tiền",
                "Trạng thái",
                "Hoàn tiền",
                "Phương thức thanh toán",
              ],
              ...modalSelectedTransactions.map((t) => [
                t.id,
                t.type === "recharge"
                  ? "Nạp xu"
                  : t.type === "download"
                  ? "Tải tài liệu"
                  : "Hoàn tiền",
                t.document,
                t.date,
                t.amount,
                t.status === "success"
                  ? "Thành công"
                  : t.status === "pending"
                  ? "Đang xử lý"
                  : t.status === "failed"
                  ? "Thất bại"
                  : "Hoàn tiền",
                t.refund,
                t.method,
              ]),
            ]
              .map((row) => row.map((cell) => `"${cell}"`).join(","))
              .join("\n");

            const bom = "\uFEFF";
            const blob = new Blob([bom + csvContent], {
              type: "text/csv;charset=utf-8;",
            });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "selected_transactions.csv";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showNotification("Đã xuất báo cáo thành công!", "success");
            window.closeExportModal();
            console.log("CSV file downloaded successfully");
          } catch (error) {
            console.error("Error exporting CSV:", error);
            showNotification("Lỗi khi xuất báo cáo!", "error");
          }
        };

        (function () {
          const btn = document.getElementById("exportBtn");
          if (btn) {
            btn.addEventListener("click", window.openExportModal);
          }
        })();

        // renderTransactions removed; using server-rendered rows

        function openModal(txCode) {
          fetch(`/account/transactions/id/${txCode}`)
            .then((r) => (r.ok ? r.json() : Promise.reject()))
            .then((data) => {
              document.getElementById("modalTransactionId").textContent =
                data.code;
              document.getElementById("modalType").textContent = data.type;
              document.getElementById("modalDate").textContent = new Date(
                data.createdAt
              ).toLocaleString("vi-VN");
              document.getElementById("modalAmount").textContent =
                new Intl.NumberFormat("vi-VN", {
                  style: "currency",
                  currency: "VND",
                }).format(data.amount);
              document.getElementById("modalStatus").textContent = data.status;
              document.getElementById("modalMethod").textContent =
                data.paymentMethod || "-";
              var refundEl = document.getElementById("modalRefund");
              if (refundEl) {
                const isRefund =
                  data &&
                  (data.type === "REFUND" ||
                    (data.type && data.type.value === "refund"));
                refundEl.textContent = isRefund ? "Có" : "Không";
              }
              document.getElementById("dashboardModal").style.display = "flex";
            })
            .catch(() => {
              showNotification("Không tải được chi tiết giao dịch");
            });
        }

        function confirmRefund(txId) {
          const modal = document.getElementById("refundModal");
          if (!modal) return;
          document.getElementById("refundTxId").textContent = txId;
          modal.style.display = "flex";
        }

        // Refund modal buttons handlers
        (function () {
          const cancelBtn = document.getElementById("refundCancelBtn");
          const confirmBtn = document.getElementById("refundConfirmBtn");
          const modal = document.getElementById("refundModal");
          if (cancelBtn) {
            cancelBtn.addEventListener("click", function () {
              if (modal) modal.style.display = "none";
            });
          }
          if (confirmBtn) {
            confirmBtn.addEventListener("click", function () {
              const txCode = document.getElementById("refundTxId").textContent;
              const csrfToken = document
                .querySelector('meta[name="_csrf"]')
                .getAttribute("content");
              const csrfHeader = document
                .querySelector('meta[name="_csrf_header"]')
                .getAttribute("content");
              const headers = {
                Accept: "application/json",
                "Content-Type": "application/x-www-form-urlencoded",
                "X-Requested-With": "XMLHttpRequest",
              };
              if (csrfToken && csrfHeader) headers[csrfHeader] = csrfToken;
              const body = new URLSearchParams({}).toString();
              confirmBtn.disabled = true;
              fetch(`/account/transactions/id/${txCode}/refund`, {
                method: "POST",
                headers,
                credentials: "same-origin",
                body,
              })
                .then(async (r) => {
                  const text = await r.text();
                  let data;
                  try {
                    data = text ? JSON.parse(text) : {};
                  } catch (e) {
                    data = { success: r.ok, message: text || r.statusText };
                  }
                  if (!r.ok)
                    throw new Error(data.message || `HTTP ${r.status}`);
                  return data;
                })
                .then((res) => {
                  if (res.success) {
                    showNotification(
                      "Đã gửi yêu cầu hoàn tiền. Mã: " +
                        (res.withdrawalCode || res.refundCode || "-"),
                      "success"
                    );
                    if (modal) modal.style.display = "none";
                  } else {
                    showNotification(
                      res.message || "Không thể yêu cầu hoàn tiền",
                      "error"
                    );
                  }
                })
                .catch((err) =>
                  showNotification(
                    err.message || "Không thể yêu cầu hoàn tiền",
                    "error"
                  )
                )
                .finally(() => {
                  confirmBtn.disabled = false;
                });
            });
          }
        })();

        // Expose to global so inline onclick works
        window.openModal = openModal;
        window.confirmRefund = confirmRefund;
        
        // Cancel withdrawal function
        window.cancelWithdrawal = function(txId) {
          if (confirm('Bạn có chắc chắn muốn hủy yêu cầu rút tiền này?')) {
            const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
            
            const headers = {
              'Content-Type': 'application/x-www-form-urlencoded',
              'X-Requested-With': 'XMLHttpRequest'
            };
            if (csrfToken && csrfHeader) headers[csrfHeader] = csrfToken;
            
            fetch(`/account/withdraw/${txId}/cancel`, {
              method: 'POST',
              headers: headers,
              credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                showNotification(data.message, 'success');
                // Refresh page after 2 seconds
                setTimeout(() => {
                  location.reload();
                }, 2000);
              } else {
                showNotification(data.message, 'error');
              }
            })
            .catch(error => {
              console.error('Error:', error);
              showNotification('Có lỗi xảy ra, vui lòng thử lại', 'error');
            });
          }
        };
      });
    </script>
    <script>
      // Filter submit
      (function () {
        const btn = document.getElementById("filterBtn");
        if (btn) {
          btn.addEventListener("click", function () {
            const q = encodeURIComponent(
              document.getElementById("searchInput").value || ""
            );
            const st = document.getElementById("statusFilter").value || "";
            const tp = document.getElementById("typeFilter").value || "";
            const from = document.getElementById("dateFrom").value || "";
            const to = document.getElementById("dateTo").value || "";
            const amount =
              document.getElementById("amountFilter").value || "all";
            let min = "",
              max = "";
            if (amount && amount !== "all") {
              if (amount === "200001+") {
                min = "200001";
              } else {
                const parts = amount.split("-");
                min = parts[0];
                max = parts[1];
              }
            }
            const params = new URLSearchParams();
            if (q) params.set("q", q);
            if (st) params.set("status", st);
            if (tp) params.set("type", tp);
            if (from) params.set("from", from);
            if (to) params.set("to", to);
            if (min) params.set("min", min);
            if (max) params.set("max", max);
            window.location.href =
              "/account/transactions" +
              (params.toString() ? "?" + params.toString() : "");
          });
        }
      })();
    </script>
  </body>
</html>
